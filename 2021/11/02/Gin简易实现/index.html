<!DOCTYPE html>












  


<html class="theme-next pisces use-motion" lang="zh-CN">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">


























<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2">

<link rel="stylesheet" href="/css/main.css?v=7.0.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=7.0.0">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=7.0.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=7.0.0">


  <link rel="mask-icon" href="/images/logo.svg?v=7.0.0" color="#222">







<script id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '7.0.0',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="0. 前言各种语言都包含有 http 库，但是在我们真正开发的时候，我们会使用各种 web 框架，有 spring 一样大而全的框架，也有 koa 一样小而美的框架，但他们的核心其实都是一样的，帮助我们解决频繁手动处理的部分，简化我们的开发负担，提升开发体验。本次我们会实现一个简易的 gin，将会有以下功能：   路由树 分组控制 中间件 错误恢复   项目的架构图如下： 其中黑色的为 reque">
<meta name="keywords" content="Golang,Gin,Web Server">
<meta property="og:type" content="article">
<meta property="og:title" content="Gin 简易实现">
<meta property="og:url" content="https://akitaSummer.github.io/2021/11/02/Gin简易实现/index.html">
<meta property="og:site_name" content="Akita Summer&#39;s Blog">
<meta property="og:description" content="0. 前言各种语言都包含有 http 库，但是在我们真正开发的时候，我们会使用各种 web 框架，有 spring 一样大而全的框架，也有 koa 一样小而美的框架，但他们的核心其实都是一样的，帮助我们解决频繁手动处理的部分，简化我们的开发负担，提升开发体验。本次我们会实现一个简易的 gin，将会有以下功能：   路由树 分组控制 中间件 错误恢复   项目的架构图如下： 其中黑色的为 reque">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="https://akitasummer.github.io/image/gin/471676227283_.pic.jpg">
<meta property="og:image" content="https://akitasummer.github.io/image/gin/481676227283_.pic.jpg">
<meta property="og:image" content="https://akitasummer.github.io/image/gin/4491676227284_.pic.jpg">
<meta property="og:image" content="https://akitasummer.github.io/image/gin/501676227284_.pic.jpg">
<meta property="og:image" content="https://akitasummer.github.io/image/gin/511676227285_.pic.jpg">
<meta property="og:updated_time" content="2023-02-12T19:26:46.425Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Gin 简易实现">
<meta name="twitter:description" content="0. 前言各种语言都包含有 http 库，但是在我们真正开发的时候，我们会使用各种 web 框架，有 spring 一样大而全的框架，也有 koa 一样小而美的框架，但他们的核心其实都是一样的，帮助我们解决频繁手动处理的部分，简化我们的开发负担，提升开发体验。本次我们会实现一个简易的 gin，将会有以下功能：   路由树 分组控制 中间件 错误恢复   项目的架构图如下： 其中黑色的为 reque">
<meta name="twitter:image" content="https://akitasummer.github.io/image/gin/471676227283_.pic.jpg">






  <link rel="canonical" href="https://akitaSummer.github.io/2021/11/02/Gin简易实现/">



<script id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>Gin 简易实现 | Akita Summer's Blog</title>
  












  <noscript>
  <style>
  .use-motion .motion-element,
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-title { opacity: initial; }

  .use-motion .logo,
  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>


</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"><a href="https://github.com/akitaSummer" class="github-corner" aria-label="View source on GitHub"><svg width="80" height="80" viewbox="0 0 250 250" style="fill:#151513; color:#fff; position: absolute; top: 0; border: 0; right: 0;" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"/><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"/><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"/></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Akita Summer's Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="切换导航栏">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">

    
    
    
      
    

    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br>首页</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">

    
    
    
      
    

    

    <a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i> <br>标签</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-categories">

    
    
    
      
    

    

    <a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i> <br>分类</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">

    
    
    
      
    

    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br>归档</a>

  </li>

      
      
    </ul>
  

  

  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
            

          
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://akitaSummer.github.io/2021/11/02/Gin简易实现/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Akita Summer">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/v2-e386393694cb08152bb316fa79bba113_hd.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Akita Summer's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">Gin 简易实现

              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2021-11-02 18:10:04" itemprop="dateCreated datePublished" datetime="2021-11-02T18:10:04+08:00">2021-11-02</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2023-02-13 03:26:46" itemprop="dateModified" datetime="2023-02-13T03:26:46+08:00">2023-02-13</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/学习笔记/" itemprop="url" rel="index"><span itemprop="name">学习笔记</span></a></span>

                
                
              
            </span>
          

          
            
            
              
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
            
                <a href="/2021/11/02/Gin简易实现/#comments" itemprop="discussionUrl">
                  <span class="post-meta-item-text">评论数：</span> <span class="post-comments-count gitment-comments-count" data-xid="/2021/11/02/Gin简易实现/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h1 id="0-前言"><a href="#0-前言" class="headerlink" title="0. 前言"></a>0. 前言</h1><p>各种语言都包含有 http 库，但是在我们真正开发的时候，我们会使用各种 web 框架，有 spring 一样大而全的框架，也有 koa 一样小而美的框架，但他们的核心其实都是一样的，帮助我们解决频繁手动处理的部分，简化我们的开发负担，提升开发体验。本次我们会实现一个简易的 gin，将会有以下功能：</p>
<blockquote>
<ol>
<li>路由树</li>
<li>分组控制</li>
<li>中间件</li>
<li>错误恢复</li>
</ol>
</blockquote>
<p>项目的架构图如下：<br> <img src="/image/gin/471676227283_.pic.jpg" alt="Gin 架构"><br>其中黑色的为 request，红色的为 response，整体请求的处理逻辑为： Request -&gt; Group -&gt; Middleware -&gt; RouterTree -&gt; Handler -&gt; Middleware -&gt; Response 接下来，我将会由大到小带你一步步的实现这个 mini 版 Gin。</p>
<h1 id="1-最简框架"><a href="#1-最简框架" class="headerlink" title="1. 最简框架"></a>1. 最简框架</h1><p>我们的最简框架要求十分简单，就是能够处理请求即可。<br> <img src="/image/gin/481676227283_.pic.jpg" alt="http"><br>go 中内置了 net/http 库用于处理 http 请求，我们不妨使用它来完成我们的最简框架。</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// akt.go</span></span><br><span class="line"><span class="keyword">package</span> akt</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">        <span class="string">"fmt"</span></span><br><span class="line">        <span class="string">"net/http"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> HandlerFunc <span class="function"><span class="keyword">func</span><span class="params">(http.ResponseWriter, *http.Request)</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Engine <span class="keyword">struct</span> &#123;</span><br><span class="line">        router <span class="keyword">map</span>[<span class="keyword">string</span>]HandlerFunc <span class="comment">// 简易的路由映射</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(engine *Engine)</span> <span class="title">addRoute</span><span class="params">(method <span class="keyword">string</span>, pattern <span class="keyword">string</span>, handler HandlerFunc)</span></span> &#123;</span><br><span class="line">        name := method + <span class="string">"-"</span> + pattern</span><br><span class="line">        engine.router[name] = handler</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(engine *Engine)</span> <span class="title">GET</span><span class="params">(pattern <span class="keyword">string</span>, handler HandlerFunc)</span></span> &#123;</span><br><span class="line">        engine.addRoute(<span class="string">"GET"</span>, pattern, handler)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(engine *Engine)</span> <span class="title">POST</span><span class="params">(pattern <span class="keyword">string</span>, handler HandlerFunc)</span></span> &#123;</span><br><span class="line">        engine.addRoute(<span class="string">"POST"</span>, pattern, handler)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(engine *Engine)</span> <span class="title">Run</span><span class="params">(addr <span class="keyword">string</span>)</span> <span class="params">(err error)</span></span> &#123;</span><br><span class="line">        <span class="keyword">return</span> http.ListenAndServe(addr, engine)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(engine *Engine)</span> <span class="title">ServeHTTP</span><span class="params">(w http.ResponseWriter, req *http.Request)</span></span> &#123;</span><br><span class="line">        key := req.Method + <span class="string">"-"</span> + req.URL.Path</span><br><span class="line">        <span class="keyword">if</span> handler, ok := engine.router[key]; ok != <span class="literal">false</span> &#123;</span><br><span class="line">                handler(w, req)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                fmt.Fprintf(w, <span class="string">"404 NOT FOUND: %s\n"</span>, req.URL)</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">New</span><span class="params">()</span> *<span class="title">Engine</span></span> &#123;</span><br><span class="line">        <span class="keyword">return</span> &amp;Engine&#123;router: <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">string</span>]HandlerFunc)&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>代码非常简单，就是通过实现 ServeHTTP 接口的实例完成一个服务器的搭建，然后我们自己维护了一个路由映射表，通过请求的 Method 和 URL.Path 决定那个路由 handler 来进行处理。</p>
<p>Node 版</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> http <span class="keyword">from</span> <span class="string">'http'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> Akt &#123;</span><br><span class="line">  <span class="keyword">private</span> server: http.Server;</span><br><span class="line">  <span class="keyword">private</span> router: Map&lt;<span class="built_in">string</span>, http.RequestListener&gt;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">constructor</span>(<span class="params">requestListener?: http.RequestListener</span>) &#123;</span><br><span class="line">    <span class="keyword">this</span>.server = http.createServer(requestListener);</span><br><span class="line">    <span class="keyword">this</span>.router = <span class="keyword">new</span> Map();</span><br><span class="line">    <span class="keyword">this</span>.server.on(<span class="string">'request'</span>, <span class="function">(<span class="params">requset: http.IncomingMessage, response: http.ServerResponse</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> handler = <span class="keyword">this</span>.router.get(<span class="string">`<span class="subst">$&#123;requset.method&#125;</span>-<span class="subst">$&#123;requset.url&#125;</span>`</span>);</span><br><span class="line">      <span class="keyword">if</span> (handler) &#123;</span><br><span class="line">        handler(requset, response);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">`404 NOT FOUND: <span class="subst">$&#123;requset.url&#125;</span>`</span>);</span><br><span class="line">        response.statusCode = <span class="number">404</span>;</span><br><span class="line">        response.statusMessage = <span class="string">`404 NOT FOUND: <span class="subst">$&#123;requset.url&#125;</span>`</span>;</span><br><span class="line">        response.end();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> addRoute = <span class="function">(<span class="params">method: <span class="built_in">string</span>, pattern: <span class="built_in">string</span>, handler: http.RequestListener</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">this</span>.router.set(<span class="string">`<span class="subst">$&#123;method&#125;</span>-<span class="subst">$&#123;pattern&#125;</span>`</span>, handler);</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">get</span> = <span class="function">(<span class="params">pattern: <span class="built_in">string</span>, handler: http.RequestListener</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">this</span>.addRoute(<span class="string">'GET'</span>, pattern, handler);</span><br><span class="line">  &#125;;</span><br><span class="line">  post = <span class="function">(<span class="params">pattern: <span class="built_in">string</span>, handler: http.RequestListener</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">this</span>.addRoute(<span class="string">'POST'</span>, pattern, handler);</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  getServer = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.server;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  run = <span class="function">(<span class="params">addr: <span class="built_in">string</span>, listeningListener?: (<span class="params"></span>) =&gt; <span class="built_in">void</span></span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.server.listen(addr, listeningListener);</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> akt = <span class="function">(<span class="params">requestListener?: http.RequestListener</span>) =&gt;</span> <span class="keyword">new</span> Akt(requestListener);</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> akt;</span><br></pre></td></tr></table></figure>
<h1 id="2-封装-Context"><a href="#2-封装-Context" class="headerlink" title="2. 封装 Context"></a>2. 封装 Context</h1><p>将<code>http.ResponseWriter</code>和<code>http.Request</code>封装成为一个 Context 会带来很多的好处，比如简化接口调用，减少用户编写大量重复的代码等等，封装之后，用户想得到的东西只需要从 ctx 中直接获取即可。</p>
<p>Context 的封装实现：</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// context.go</span></span><br><span class="line"><span class="keyword">package</span> akt</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">        <span class="string">"encoding/json"</span></span><br><span class="line">        <span class="string">"fmt"</span></span><br><span class="line">        <span class="string">"net/http"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Context <span class="keyword">struct</span> &#123;</span><br><span class="line">        Req        *http.Request</span><br><span class="line">        Writer     http.ResponseWriter</span><br><span class="line">        Path       <span class="keyword">string</span></span><br><span class="line">        Method     <span class="keyword">string</span></span><br><span class="line">        StatusCode <span class="keyword">int</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Obj <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">interface</span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">newContext</span><span class="params">(writer http.ResponseWriter, req *http.Request)</span> *<span class="title">Context</span></span> &#123;</span><br><span class="line">        <span class="keyword">return</span> &amp;Context&#123;</span><br><span class="line">                Req:    req,</span><br><span class="line">                Writer: writer,</span><br><span class="line">                Path:   req.URL.Path,</span><br><span class="line">                Method: req.Method,</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *Context)</span> <span class="title">PostForm</span><span class="params">(key <span class="keyword">string</span>)</span> <span class="title">string</span></span> &#123;</span><br><span class="line">        <span class="keyword">return</span> c.Req.FormValue(key)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *Context)</span> <span class="title">Query</span><span class="params">(key <span class="keyword">string</span>)</span> <span class="title">string</span></span> &#123;</span><br><span class="line">        <span class="keyword">return</span> c.Req.URL.Query().Get(key)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *Context)</span> <span class="title">Status</span><span class="params">(code <span class="keyword">int</span>)</span></span> &#123;</span><br><span class="line">        c.StatusCode = code</span><br><span class="line">        c.Writer.WriteHeader(code)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *Context)</span> <span class="title">SetHeader</span><span class="params">(key <span class="keyword">string</span>, value <span class="keyword">string</span>)</span></span> &#123;</span><br><span class="line">        c.Writer.Header().Set(key, value)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *Context)</span> <span class="title">String</span><span class="params">(code <span class="keyword">int</span>, format <span class="keyword">string</span>, values ...<span class="keyword">interface</span>&#123;&#125;)</span></span> &#123;</span><br><span class="line">        c.Status(code)</span><br><span class="line">        c.SetHeader(<span class="string">"Content-Type"</span>, <span class="string">"text/plain"</span>)</span><br><span class="line">        c.Writer.Write([]<span class="keyword">byte</span>(fmt.Sprintf(format, values...)))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *Context)</span> <span class="title">JSON</span><span class="params">(code <span class="keyword">int</span>, obj <span class="keyword">interface</span>&#123;&#125;)</span></span> &#123;</span><br><span class="line">        c.SetHeader(<span class="string">"Content-Type"</span>, <span class="string">"application/json"</span>)</span><br><span class="line">        c.Status(code)</span><br><span class="line">        encoder := json.NewEncoder(c.Writer)</span><br><span class="line">        <span class="keyword">if</span> err := encoder.Encode(obj); err != <span class="literal">nil</span> &#123;</span><br><span class="line">                http.Error(c.Writer, err.Error(), <span class="number">500</span>)</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *Context)</span> <span class="title">Data</span><span class="params">(code <span class="keyword">int</span>, data []<span class="keyword">byte</span>)</span></span> &#123;</span><br><span class="line">        c.Status(code)</span><br><span class="line">        c.Writer.Write(data)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *Context)</span> <span class="title">HTML</span><span class="params">(code <span class="keyword">int</span>, html <span class="keyword">string</span>)</span></span> &#123;</span><br><span class="line">        c.SetHeader(<span class="string">"Content-Type"</span>, <span class="string">"text/html"</span>)</span><br><span class="line">        c.Status(code)</span><br><span class="line">        c.Writer.Write([]<span class="keyword">byte</span>(html))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这时候 router 的 handler 的参数就会变成 Context 了</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// router.go</span></span><br><span class="line"><span class="keyword">package</span> akt</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">        <span class="string">"net/http"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> router <span class="keyword">struct</span> &#123;</span><br><span class="line">        handlers <span class="keyword">map</span>[<span class="keyword">string</span>]HandlerFunc</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">newRouter</span><span class="params">()</span> *<span class="title">router</span></span> &#123;</span><br><span class="line">        <span class="keyword">return</span> &amp;router&#123;handlers: <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">string</span>]HandlerFunc)&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(router *router)</span> <span class="title">addRoute</span><span class="params">(method <span class="keyword">string</span>, pattern <span class="keyword">string</span>, handler HandlerFunc)</span></span> &#123;</span><br><span class="line">        name := method + <span class="string">"-"</span> + pattern</span><br><span class="line">        router.handlers[name] = handler</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(router *router)</span> <span class="title">handle</span><span class="params">(c *Context)</span></span> &#123;</span><br><span class="line">        key := c.Method + <span class="string">"-"</span> + c.Path</span><br><span class="line">        <span class="keyword">if</span> hander, ok := router.handlers[key]; ok &#123;</span><br><span class="line">                hander(c)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                c.String(http.StatusNotFound, <span class="string">"404 NOT FOUND: %s\n"</span>, c.Path)</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们的入口文件就会变得比较简单了。</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// akt.go</span></span><br><span class="line"><span class="keyword">package</span> akt</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">        <span class="string">"net/http"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> HandlerFunc <span class="function"><span class="keyword">func</span><span class="params">(*Context)</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Engine <span class="keyword">struct</span> &#123;</span><br><span class="line">        router *router</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(engine *Engine)</span> <span class="title">GET</span><span class="params">(pattern <span class="keyword">string</span>, handler HandlerFunc)</span></span> &#123;</span><br><span class="line">        engine.router.addRoute(<span class="string">"GET"</span>, pattern, handler)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(engine *Engine)</span> <span class="title">POST</span><span class="params">(pattern <span class="keyword">string</span>, handler HandlerFunc)</span></span> &#123;</span><br><span class="line">        engine.router.addRoute(<span class="string">"POST"</span>, pattern, handler)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(engine *Engine)</span> <span class="title">Run</span><span class="params">(addr <span class="keyword">string</span>)</span> <span class="params">(err error)</span></span> &#123;</span><br><span class="line">        <span class="keyword">return</span> http.ListenAndServe(addr, engine)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(engine *Engine)</span> <span class="title">ServeHTTP</span><span class="params">(w http.ResponseWriter, req *http.Request)</span></span> &#123;</span><br><span class="line">        c := newContext(w, req)</span><br><span class="line">        engine.router.handle(c)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">New</span><span class="params">()</span> *<span class="title">Engine</span></span> &#123;</span><br><span class="line">        <span class="keyword">return</span> &amp;Engine&#123;router: newRouter()&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Node 版</p>
<p>Context.ts:</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> http <span class="keyword">from</span> <span class="string">'http'</span>;</span><br><span class="line"><span class="keyword">import</span> querystring <span class="keyword">from</span> <span class="string">'querystring'</span>;</span><br><span class="line"><span class="keyword">import</span> url <span class="keyword">from</span> <span class="string">'url'</span>;</span><br><span class="line"><span class="keyword">import</span> util <span class="keyword">from</span> <span class="string">'util'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">type</span> ContextOptionsType = &#123;</span><br><span class="line">  [propsName: <span class="built_in">string</span>]: <span class="built_in">any</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> Context &#123;</span><br><span class="line">  req: http.IncomingMessage &amp; &#123; body?: <span class="built_in">any</span> &#125;;</span><br><span class="line">  res: http.ServerResponse;</span><br><span class="line">  path: <span class="built_in">string</span>;</span><br><span class="line">  method: <span class="built_in">string</span>;</span><br><span class="line">  statusCode: <span class="built_in">number</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> URL: url.URL;</span><br><span class="line">  <span class="keyword">constructor</span>(<span class="params">requset: http.IncomingMessage, response: http.ServerResponse</span>) &#123;</span><br><span class="line">    <span class="keyword">this</span>.req = requset;</span><br><span class="line">    <span class="keyword">this</span>.res = response;</span><br><span class="line">    <span class="keyword">this</span>.URL = <span class="keyword">new</span> url.URL(<span class="string">`http://<span class="subst">$&#123;<span class="keyword">this</span>.req.headers.host&#125;</span><span class="subst">$&#123;<span class="keyword">this</span>.req.url&#125;</span>`</span>);</span><br><span class="line">    <span class="keyword">this</span>.path = <span class="keyword">this</span>.URL.pathname;</span><br><span class="line">    <span class="keyword">this</span>.method = requset.method;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  query = <span class="function">(<span class="params">key: <span class="built_in">string</span></span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.URL.searchParams.get(key);</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  postForm = <span class="function">(<span class="params">key: <span class="built_in">string</span></span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.req.body?.[key];</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  status = <span class="function">(<span class="params">code: <span class="built_in">number</span>, message?: <span class="built_in">string</span></span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">this</span>.statusCode = code;</span><br><span class="line">    <span class="keyword">this</span>.res.statusCode = code;</span><br><span class="line">    <span class="keyword">this</span>.res.statusMessage = message;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  setHeader = <span class="function">(<span class="params">key: <span class="built_in">string</span>, value: <span class="built_in">string</span></span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">this</span>.res.setHeader(key, value);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">string</span> = <span class="function">(<span class="params">code: <span class="built_in">number</span>, str: <span class="built_in">string</span></span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">this</span>.setHeader(<span class="string">'Content-Type'</span>, <span class="string">'text/plain'</span>);</span><br><span class="line">    <span class="keyword">this</span>.status(code);</span><br><span class="line">    <span class="keyword">this</span>.res.end(str);</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">JSON</span> = <span class="function">(<span class="params">code: <span class="built_in">number</span>, obj: object</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">this</span>.setHeader(<span class="string">'Content-Type'</span>, <span class="string">'application/json'</span>);</span><br><span class="line">    <span class="keyword">this</span>.status(code);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> data = <span class="built_in">JSON</span>.stringify(obj);</span><br><span class="line">      <span class="keyword">this</span>.res.end(data);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(e);</span><br><span class="line">      <span class="keyword">this</span>.res.end(<span class="built_in">JSON</span>.stringify(&#123; err: e.toStirng() &#125;));</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  data = <span class="function">(<span class="params">code: <span class="built_in">number</span>, data: <span class="built_in">any</span></span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">this</span>.status(code);</span><br><span class="line">    <span class="keyword">this</span>.res.end(data);</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  HTML = <span class="function">(<span class="params">code: <span class="built_in">number</span>, HTML: <span class="built_in">string</span></span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">this</span>.setHeader(<span class="string">'Content-Type'</span>, <span class="string">'text/html'</span>);</span><br><span class="line">    <span class="keyword">this</span>.status(code);</span><br><span class="line">    <span class="keyword">this</span>.res.end(HTML);</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>router.ts</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> http <span class="keyword">from</span> <span class="string">'http'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Context &#125; <span class="keyword">from</span> <span class="string">'./context'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; HandlerFunc &#125; <span class="keyword">from</span> <span class="string">'./index'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> Router &#123;</span><br><span class="line">  <span class="keyword">private</span> handlers: Map&lt;<span class="built_in">string</span>, HandlerFunc&gt;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">constructor</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">this</span>.handlers = <span class="keyword">new</span> Map();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  addRoute = <span class="function">(<span class="params">method: <span class="built_in">string</span>, pattern: <span class="built_in">string</span>, handler: HandlerFunc</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">this</span>.handlers.set(<span class="string">`<span class="subst">$&#123;method&#125;</span>-<span class="subst">$&#123;pattern&#125;</span>`</span>, handler);</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  handle = <span class="function">(<span class="params">ctx: Context</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> key = <span class="string">`<span class="subst">$&#123;ctx.method&#125;</span>-<span class="subst">$&#123;ctx.path&#125;</span>`</span>;</span><br><span class="line">    <span class="keyword">const</span> handler = <span class="keyword">this</span>.handlers.get(key);</span><br><span class="line">    <span class="keyword">if</span> (handler) &#123;</span><br><span class="line">      handler(ctx);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      ctx.string(<span class="number">404</span>, <span class="string">`404 NOT FOUND: <span class="subst">$&#123;ctx.path&#125;</span>`</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>akt.ts</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> http <span class="keyword">from</span> <span class="string">'http'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Context &#125; <span class="keyword">from</span> <span class="string">'./context'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Router &#125; <span class="keyword">from</span> <span class="string">'./router'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> &#123; Context <span class="keyword">as</span> AktContext &#125; <span class="keyword">from</span> <span class="string">'./context'</span>;</span><br><span class="line"><span class="keyword">export</span> &#123; Router <span class="keyword">as</span> AktRouter &#125; <span class="keyword">from</span> <span class="string">'./router'</span>;</span><br><span class="line"><span class="keyword">import</span> util <span class="keyword">from</span> <span class="string">'util'</span>;</span><br><span class="line"><span class="keyword">import</span> querystring <span class="keyword">from</span> <span class="string">'querystring'</span>;</span><br><span class="line"><span class="keyword">import</span> parse <span class="keyword">from</span> <span class="string">'co-body'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">type</span> HandlerFunc = <span class="function">(<span class="params">ctx: Context</span>) =&gt;</span> <span class="built_in">void</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> Akt &#123;</span><br><span class="line">  <span class="keyword">private</span> server: http.Server;</span><br><span class="line">  <span class="keyword">private</span> router: Router;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">constructor</span>(<span class="params">requestListener?: http.RequestListener</span>) &#123;</span><br><span class="line">    <span class="keyword">this</span>.server = http.createServer(requestListener);</span><br><span class="line">    <span class="keyword">this</span>.router = <span class="keyword">new</span> Router();</span><br><span class="line">    <span class="keyword">this</span>.server.on(</span><br><span class="line">      <span class="string">'request'</span>,</span><br><span class="line">      (requset: http.IncomingMessage &amp; &#123; body?: <span class="built_in">any</span> &#125;, response: http.ServerResponse) =&gt; &#123;</span><br><span class="line">        <span class="comment">// 处理post请求</span></span><br><span class="line">        requset.body = <span class="string">''</span>;</span><br><span class="line">        requset.on(<span class="string">'data'</span>, <span class="function"><span class="params">chuck</span> =&gt;</span> &#123;</span><br><span class="line">          requset.body += chuck;</span><br><span class="line">        &#125;);</span><br><span class="line">        requset.on(<span class="string">'end'</span>, <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">          <span class="keyword">if</span> (requset.headers[<span class="string">'content-type'</span>]?.includes(<span class="string">'application/json'</span>)) &#123;</span><br><span class="line">            requset.body = <span class="built_in">JSON</span>.parse(requset.body);</span><br><span class="line">          &#125; <span class="keyword">else</span> <span class="keyword">if</span> (requset.method === <span class="string">'POST'</span>) &#123;</span><br><span class="line">            requset.body = querystring.parse(requset.body);</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">const</span> ctx = <span class="keyword">new</span> Context(requset, response);</span><br><span class="line">          <span class="keyword">this</span>.router.handle(ctx);</span><br><span class="line">        &#125;);</span><br><span class="line">      &#125;,</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">get</span> = <span class="function">(<span class="params">pattern: <span class="built_in">string</span>, handler: HandlerFunc</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">this</span>.router.addRoute(<span class="string">'GET'</span>, pattern, handler);</span><br><span class="line">  &#125;;</span><br><span class="line">  post = <span class="function">(<span class="params">pattern: <span class="built_in">string</span>, handler: HandlerFunc</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">this</span>.router.addRoute(<span class="string">'POST'</span>, pattern, handler);</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  getServer = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.server;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  run = <span class="function">(<span class="params">addr: <span class="built_in">string</span>, listeningListener?: (<span class="params"></span>) =&gt; <span class="built_in">void</span></span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.server.listen(addr, listeningListener);</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> akt = <span class="function">(<span class="params">requestListener?: http.RequestListener</span>) =&gt;</span> <span class="keyword">new</span> Akt(requestListener);</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> akt;</span><br></pre></td></tr></table></figure>
<h1 id="3-动态路由解析"><a href="#3-动态路由解析" class="headerlink" title="3. 动态路由解析"></a>3. 动态路由解析</h1><p>前面我们的路由使用了一个 map 进行储存，这个问题其实是非常明显的，我们并不支持类似于<code>/docs/:name/history</code>或者<code>/static/*filename</code>等形式的路由解析，这将是非常致命的。</p>
<p>现在我们要实现如下的架构：<br> <img src="/image/gin/4491676227284_.pic.jpg" alt="router"><br>对于路由的解析，我们可以使用树数据结构进行处理：</p>
<p>我们的路由可以根据/划分成一个又一个树状节点，然后我们根据每个节点的样式，来决定判断是否正确，寻找下一个节点，最终节点的 handler 进行处理请求。</p>
<p>首先我们先实现每个节点的数据结构：<br> <img src="/image/gin/501676227284_.pic.jpg" alt="tree"></p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// trie.go</span></span><br><span class="line"><span class="keyword">package</span> akt</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">"strings"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> node <span class="keyword">struct</span> &#123;</span><br><span class="line">        pattern  <span class="keyword">string</span></span><br><span class="line">        part     <span class="keyword">string</span></span><br><span class="line">        children []*node</span><br><span class="line">        isWild   <span class="keyword">bool</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(n *node)</span> <span class="title">matchChild</span><span class="params">(part <span class="keyword">string</span>)</span> *<span class="title">node</span></span> &#123; <span class="comment">// 匹配第一个节点，用于创建</span></span><br><span class="line">        <span class="keyword">for</span> _, child := <span class="keyword">range</span> n.children &#123;</span><br><span class="line">                <span class="keyword">if</span> child.part == part || child.isWild &#123;</span><br><span class="line">                        <span class="keyword">return</span> child</span><br><span class="line">                &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(n *node)</span> <span class="title">matchChildren</span><span class="params">(part <span class="keyword">string</span>)</span> []*<span class="title">node</span></span> &#123; <span class="comment">// 匹配所有节点，用于创建</span></span><br><span class="line">        nodes := <span class="built_in">make</span>([]*node, <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">for</span> _, child := <span class="keyword">range</span> n.children &#123;</span><br><span class="line">                <span class="keyword">if</span> child.part == part || child.isWild &#123;</span><br><span class="line">                        nodes = <span class="built_in">append</span>(nodes, child)</span><br><span class="line">                &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> nodes</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(n *node)</span> <span class="title">insert</span><span class="params">(pattern <span class="keyword">string</span>, parts []<span class="keyword">string</span>, height <span class="keyword">int</span>)</span></span> &#123; <span class="comment">// 插入节点</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(parts) == height &#123;</span><br><span class="line">                n.pattern = pattern</span><br><span class="line">                <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        part := parts[height]</span><br><span class="line">        child := n.matchChild(part)</span><br><span class="line">        <span class="keyword">if</span> child == <span class="literal">nil</span> &#123;</span><br><span class="line">                child = &amp;node&#123;part: part, isWild: part[<span class="number">0</span>] == <span class="string">':'</span> || part[<span class="number">0</span>] == <span class="string">'*'</span>&#125;</span><br><span class="line">                n.children = <span class="built_in">append</span>(n.children, child)</span><br><span class="line">        &#125;</span><br><span class="line">        child.insert(pattern, parts, height+<span class="number">1</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(n *node)</span> <span class="title">search</span><span class="params">(parts []<span class="keyword">string</span>, height <span class="keyword">int</span>)</span> *<span class="title">node</span></span> &#123; <span class="comment">// 查询节点</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(parts) == height || strings.HasPrefix(n.part, <span class="string">"*"</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> n.pattern == <span class="string">""</span> &#123;</span><br><span class="line">                        <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> n</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        part := parts[height]</span><br><span class="line">        children := n.matchChildren(part)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> _, child := <span class="keyword">range</span> children &#123;</span><br><span class="line">                result := child.search(parts, height)</span><br><span class="line">                <span class="keyword">if</span> result != <span class="literal">nil</span> &#123;</span><br><span class="line">                        <span class="keyword">return</span> result</span><br><span class="line">                &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后我们来更新路由文件</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// router.go</span></span><br><span class="line"><span class="keyword">package</span> akt</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">        <span class="string">"net/http"</span></span><br><span class="line">        <span class="string">"strings"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> router <span class="keyword">struct</span> &#123;</span><br><span class="line">        handlers <span class="keyword">map</span>[<span class="keyword">string</span>]HandlerFunc</span><br><span class="line">        roots    <span class="keyword">map</span>[<span class="keyword">string</span>]*node</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">parsePattern</span><span class="params">(pattern <span class="keyword">string</span>)</span> []<span class="title">string</span></span> &#123;</span><br><span class="line">        vs := strings.Split(pattern, <span class="string">"/"</span>)</span><br><span class="line"></span><br><span class="line">        parts := <span class="built_in">make</span>([]<span class="keyword">string</span>, <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">for</span> _, item := <span class="keyword">range</span> vs &#123;</span><br><span class="line">                <span class="keyword">if</span> item != <span class="string">""</span> &#123;</span><br><span class="line">                        parts = <span class="built_in">append</span>(parts, item)</span><br><span class="line">                        <span class="keyword">if</span> item[<span class="number">0</span>] == <span class="string">'*'</span> &#123;</span><br><span class="line">                                <span class="keyword">break</span></span><br><span class="line">                        &#125;</span><br><span class="line">                &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> parts</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">newRouter</span><span class="params">()</span> *<span class="title">router</span></span> &#123;</span><br><span class="line">        <span class="keyword">return</span> &amp;router&#123;handlers: <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">string</span>]HandlerFunc), roots: <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">string</span>]*node)&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(router *router)</span> <span class="title">addRoute</span><span class="params">(method <span class="keyword">string</span>, pattern <span class="keyword">string</span>, handler HandlerFunc)</span></span> &#123;</span><br><span class="line">        parts := parsePattern(pattern)</span><br><span class="line"></span><br><span class="line">        name := method + <span class="string">"-"</span> + pattern</span><br><span class="line"></span><br><span class="line">        _, ok := router.roots[method]</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> !ok &#123;</span><br><span class="line">                router.roots[method] = &amp;node&#123;&#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        router.roots[method].insert(pattern, parts, <span class="number">0</span>)</span><br><span class="line">        router.handlers[name] = handler</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(router *router)</span> <span class="title">getRoute</span><span class="params">(method <span class="keyword">string</span>, path <span class="keyword">string</span>)</span> <span class="params">(*node, <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">string</span>)</span></span> &#123;</span><br><span class="line">        searchParts := parsePattern(path)</span><br><span class="line"></span><br><span class="line">        params := <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">string</span>)</span><br><span class="line"></span><br><span class="line">        root, ok := router.roots[method]</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> !ok &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">nil</span>, <span class="literal">nil</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        n := root.search(searchParts, <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> n != <span class="literal">nil</span> &#123;</span><br><span class="line">                parts := parsePattern(n.pattern)</span><br><span class="line">                <span class="keyword">for</span> i, part := <span class="keyword">range</span> parts &#123;</span><br><span class="line">                        <span class="keyword">if</span> part[<span class="number">0</span>] == <span class="string">':'</span> &#123;</span><br><span class="line">                                params[part[<span class="number">1</span>:]] = searchParts[i]</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">if</span> part[<span class="number">0</span>] == <span class="string">'*'</span> &amp;&amp; <span class="built_in">len</span>(part) &gt; <span class="number">1</span> &#123;</span><br><span class="line">                                params[part[<span class="number">1</span>:]] = strings.Join(searchParts[i:], <span class="string">"/"</span>)</span><br><span class="line">                                <span class="keyword">break</span></span><br><span class="line">                        &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> n, params</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(router *router)</span> <span class="title">handle</span><span class="params">(c *Context)</span></span> &#123;</span><br><span class="line">        n, params := router.getRoute(c.Method, c.Path)</span><br><span class="line">        <span class="keyword">if</span> n != <span class="literal">nil</span> &#123;</span><br><span class="line">                c.Params = params</span><br><span class="line">                key := c.Method + <span class="string">"-"</span> + n.pattern</span><br><span class="line">                router.handlers[key](c)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                c.String(http.StatusNotFound, <span class="string">"404 NOT FOUND: %s\n"</span>, c.Path)</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>对由于我们支持了<code>/docs/:name/history</code>或者<code>/static/*filename</code>等形式的路由解析，我们需要对 Context 提供一个 Params</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> akt</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">        <span class="string">"encoding/json"</span></span><br><span class="line">        <span class="string">"fmt"</span></span><br><span class="line">        <span class="string">"net/http"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Context <span class="keyword">struct</span> &#123;</span><br><span class="line">        Req        *http.Request</span><br><span class="line">        Writer     http.ResponseWriter</span><br><span class="line">        Path       <span class="keyword">string</span></span><br><span class="line">        Method     <span class="keyword">string</span></span><br><span class="line">        StatusCode <span class="keyword">int</span></span><br><span class="line">        <span class="comment">// 新增</span></span><br><span class="line">        Params     <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">string</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *Context)</span> <span class="title">Param</span><span class="params">(key <span class="keyword">string</span>)</span> <span class="title">string</span></span> &#123;</span><br><span class="line">        value, _ := c.Params[key]</span><br><span class="line">        <span class="keyword">return</span> value</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Node 版本：</p>
<p>tire.ts</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> TrieNode &#123;</span><br><span class="line">  pattern: <span class="built_in">string</span>;</span><br><span class="line">  part: <span class="built_in">string</span>;</span><br><span class="line">  children: TrieNode[];</span><br><span class="line">  isWild: <span class="built_in">boolean</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">constructor</span>(<span class="params">pattern?: <span class="built_in">string</span>, part?: <span class="built_in">string</span>, children?: TrieNode[], isWild?: <span class="built_in">boolean</span></span>) &#123;</span><br><span class="line">    <span class="keyword">this</span>.pattern = pattern || <span class="string">''</span>;</span><br><span class="line">    <span class="keyword">this</span>.part = part || <span class="string">''</span>;</span><br><span class="line">    <span class="keyword">this</span>.children = children || [];</span><br><span class="line">    <span class="keyword">this</span>.isWild = isWild || <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  matchChild = <span class="function">(<span class="params">part: <span class="built_in">string</span></span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> child of <span class="keyword">this</span>.children) &#123;</span><br><span class="line">      <span class="keyword">if</span> (child.part === part || child.isWild) &#123;</span><br><span class="line">        <span class="keyword">return</span> child;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  matchChildren = <span class="function">(<span class="params">part: <span class="built_in">string</span></span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> nodes: TrieNode[] = [];</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> child of <span class="keyword">this</span>.children) &#123;</span><br><span class="line">      <span class="keyword">if</span> (child.part === part || child.isWild) &#123;</span><br><span class="line">        nodes.push(child);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> nodes;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  insert = <span class="function">(<span class="params">pattern: <span class="built_in">string</span>, parts: <span class="built_in">string</span>[], height: <span class="built_in">number</span></span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (parts.length === height) &#123;</span><br><span class="line">      <span class="keyword">this</span>.pattern = pattern;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> part = parts[height];</span><br><span class="line">    <span class="keyword">let</span> child = <span class="keyword">this</span>.matchChild(part);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!child) &#123;</span><br><span class="line">      child = <span class="keyword">new</span> TrieNode(<span class="string">''</span>, part, [], part[<span class="number">0</span>] === <span class="string">':'</span> || part[<span class="number">0</span>] === <span class="string">'*'</span>);</span><br><span class="line">      <span class="keyword">this</span>.children.push(child);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    child.insert(pattern, parts, height + <span class="number">1</span>);</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  search = (parts: <span class="built_in">string</span>[], height: <span class="built_in">number</span>): TrieNode | <span class="function"><span class="params">null</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (parts.length === height || <span class="keyword">this</span>.part.includes(<span class="string">'*'</span>)) &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">this</span>.pattern === <span class="string">''</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> part = parts[height];</span><br><span class="line">    <span class="keyword">const</span> children = <span class="keyword">this</span>.matchChildren(part);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> child of children) &#123;</span><br><span class="line">      <span class="keyword">const</span> result = child.search(parts, height + <span class="number">1</span>);</span><br><span class="line">      <span class="keyword">if</span> (result) &#123;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> TrieNode;</span><br></pre></td></tr></table></figure>
<p>router.ts</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Context &#125; <span class="keyword">from</span> <span class="string">'./context'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; HandlerFunc &#125; <span class="keyword">from</span> <span class="string">'./akt'</span>;</span><br><span class="line"><span class="keyword">import</span> TrieNode <span class="keyword">from</span> <span class="string">'./trie'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> parsePattern = <span class="function">(<span class="params">pattern: <span class="built_in">string</span></span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> vs = pattern.split(<span class="string">'/'</span>);</span><br><span class="line">  <span class="keyword">const</span> parts: <span class="built_in">string</span>[] = [];</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> item of vs) &#123;</span><br><span class="line">    <span class="keyword">if</span> (item !== <span class="string">''</span>) &#123;</span><br><span class="line">      parts.push(item);</span><br><span class="line">      <span class="keyword">if</span> (item[<span class="number">0</span>] === <span class="string">'*'</span>) &#123;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> parts;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> Router &#123;</span><br><span class="line">  <span class="keyword">private</span> handlers: Map&lt;<span class="built_in">string</span>, HandlerFunc&gt;;</span><br><span class="line">  roots: Map&lt;<span class="built_in">string</span>, TrieNode&gt;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">constructor</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">this</span>.handlers = <span class="keyword">new</span> Map();</span><br><span class="line">    <span class="keyword">this</span>.roots = <span class="keyword">new</span> Map();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 添加路由</span></span><br><span class="line">  addRoute = <span class="function">(<span class="params">method: <span class="built_in">string</span>, pattern: <span class="built_in">string</span>, handler: HandlerFunc</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> parts = parsePattern(pattern);</span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">this</span>.roots.get(method)) &#123;</span><br><span class="line">      <span class="keyword">const</span> node = <span class="keyword">new</span> TrieNode(<span class="string">''</span>, <span class="string">''</span>, [], <span class="literal">false</span>);</span><br><span class="line">      <span class="keyword">this</span>.roots.set(method, node);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">this</span>.roots.get(method).insert(pattern, parts, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">this</span>.handlers.set(<span class="string">`<span class="subst">$&#123;method&#125;</span>-<span class="subst">$&#123;pattern&#125;</span>`</span>, handler);</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  handle = <span class="function">(<span class="params">ctx: Context</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; node, params &#125; = <span class="keyword">this</span>.getRouter(ctx.method, ctx.path);</span><br><span class="line">    <span class="keyword">if</span> (node) &#123;</span><br><span class="line">      ctx.params = params;</span><br><span class="line">      <span class="keyword">const</span> key = <span class="string">`<span class="subst">$&#123;ctx.method&#125;</span>-<span class="subst">$&#123;node.pattern&#125;</span>`</span>;</span><br><span class="line">      <span class="keyword">const</span> handler = <span class="keyword">this</span>.handlers.get(key);</span><br><span class="line">      handler(ctx);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      ctx.string(<span class="number">404</span>, <span class="string">`404 NOT FOUND: <span class="subst">$&#123;ctx.path&#125;</span>`</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">  getRouter = <span class="function">(<span class="params">method: <span class="built_in">string</span>, path: <span class="built_in">string</span></span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> searchParts = parsePattern(path);</span><br><span class="line">    <span class="keyword">const</span> params: Map&lt;<span class="built_in">string</span>, <span class="built_in">string</span>&gt; = <span class="keyword">new</span> Map();</span><br><span class="line">    <span class="keyword">const</span> root = <span class="keyword">this</span>.roots.get(method);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!root) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> n = root.search(searchParts, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (n) &#123;</span><br><span class="line">      <span class="keyword">const</span> parts = parsePattern(n.pattern);</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; parts.length; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (parts[i][<span class="number">0</span>] === <span class="string">':'</span>) &#123;</span><br><span class="line">          params.set(parts[i].slice(<span class="number">1</span>), searchParts[i]);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (parts[i][<span class="number">0</span>] === <span class="string">'*'</span>) &#123;</span><br><span class="line">          params.set(parts[i].slice(<span class="number">1</span>), searchParts.slice(i).join(<span class="string">'/'</span>));</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> &#123;</span><br><span class="line">        node: n,</span><br><span class="line">        params,</span><br><span class="line">      &#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>context.ts</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> http <span class="keyword">from</span> <span class="string">'http'</span>;</span><br><span class="line"><span class="keyword">import</span> url <span class="keyword">from</span> <span class="string">'url'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">type</span> ContextOptionsType = &#123;</span><br><span class="line">  [propsName: <span class="built_in">string</span>]: <span class="built_in">any</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> Context &#123;</span><br><span class="line">  req: http.IncomingMessage &amp; &#123; body?: <span class="built_in">any</span> &#125;;</span><br><span class="line">  res: http.ServerResponse;</span><br><span class="line">  path: <span class="built_in">string</span>;</span><br><span class="line">  method: <span class="built_in">string</span>;</span><br><span class="line">  statusCode: <span class="built_in">number</span>;</span><br><span class="line">  <span class="comment">// 新增</span></span><br><span class="line">  params: Map&lt;<span class="built_in">string</span>, <span class="built_in">string</span>&gt;;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  param = <span class="function">(<span class="params">key: <span class="built_in">string</span></span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.params.get(key);</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="4-路由分组"><a href="#4-路由分组" class="headerlink" title="4. 路由分组"></a>4. 路由分组</h1><p>实际业务场景中，往往一些路由需要相似的处理，比如有的路由需要鉴权，有的路由是接口路由等等。由于需要相似处理的路由往往具有相同的前缀，因此我们可以选用前缀作为路由分组的依据。</p>
<p>架构图如下：<br> <img src="/image/gin/511676227285_.pic.jpg" alt="group"></p>
<p>Group 的实现：</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// group.go</span></span><br><span class="line"><span class="keyword">package</span> akt</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> RouterGroup <span class="keyword">struct</span> &#123;</span><br><span class="line">        prefix      <span class="keyword">string</span></span><br><span class="line">        parent      *RouterGroup</span><br><span class="line">        middlewares []HandlerFunc</span><br><span class="line">        engine      *Engine</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(group *RouterGroup)</span> <span class="title">Group</span><span class="params">(prefix <span class="keyword">string</span>)</span> *<span class="title">RouterGroup</span></span> &#123;</span><br><span class="line">        newGroup := &amp;RouterGroup&#123;</span><br><span class="line">                prefix:      group.prefix + prefix,</span><br><span class="line">                parent:      group,</span><br><span class="line">                middlewares: <span class="built_in">make</span>([]HandlerFunc, <span class="number">0</span>),</span><br><span class="line">                engine:      group.engine,</span><br><span class="line">        &#125;</span><br><span class="line">        group.engine.groups = <span class="built_in">append</span>(group.engine.groups, newGroup)</span><br><span class="line">        <span class="keyword">return</span> newGroup</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(group *RouterGroup)</span> <span class="title">addRoute</span><span class="params">(method <span class="keyword">string</span>, comp <span class="keyword">string</span>, handler HandlerFunc)</span></span> &#123;</span><br><span class="line">        pattern := group.prefix + comp</span><br><span class="line">        group.engine.router.addRoute(method, pattern, handler)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(group *RouterGroup)</span> <span class="title">GET</span><span class="params">(comp <span class="keyword">string</span>, handler HandlerFunc)</span></span> &#123;</span><br><span class="line">        group.addRoute(<span class="string">"GET"</span>, comp, handler)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(group *RouterGroup)</span> <span class="title">POST</span><span class="params">(comp <span class="keyword">string</span>, handler HandlerFunc)</span></span> &#123;</span><br><span class="line">        group.addRoute(<span class="string">"POST"</span>, comp, handler)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后我们小幅度修改下 server</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// akt</span></span><br><span class="line"><span class="keyword">package</span> akt</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">        <span class="string">"net/http"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> HandlerFunc <span class="function"><span class="keyword">func</span><span class="params">(*Context)</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Engine <span class="keyword">struct</span> &#123;</span><br><span class="line">    <span class="comment">// 新增</span></span><br><span class="line">        *RouterGroup</span><br><span class="line">        router *router</span><br><span class="line">    <span class="comment">// 新增</span></span><br><span class="line">        groups []*RouterGroup</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(engine *Engine)</span> <span class="title">GET</span><span class="params">(pattern <span class="keyword">string</span>, handler HandlerFunc)</span></span> &#123;</span><br><span class="line">        engine.router.addRoute(<span class="string">"GET"</span>, pattern, handler)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(engine *Engine)</span> <span class="title">POST</span><span class="params">(pattern <span class="keyword">string</span>, handler HandlerFunc)</span></span> &#123;</span><br><span class="line">        engine.router.addRoute(<span class="string">"POST"</span>, pattern, handler)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(engine *Engine)</span> <span class="title">Run</span><span class="params">(addr <span class="keyword">string</span>)</span> <span class="params">(err error)</span></span> &#123;</span><br><span class="line">        <span class="keyword">return</span> http.ListenAndServe(addr, engine)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(engine *Engine)</span> <span class="title">ServeHTTP</span><span class="params">(w http.ResponseWriter, req *http.Request)</span></span> &#123;</span><br><span class="line">        c := newContext(w, req)</span><br><span class="line">        engine.router.handle(c)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 新增</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">New</span><span class="params">()</span> *<span class="title">Engine</span></span> &#123;</span><br><span class="line">        engine := &amp;Engine&#123;router: newRouter()&#125;</span><br><span class="line">        engine.RouterGroup = &amp;RouterGroup&#123;engine: engine&#125;</span><br><span class="line">        engine.groups = []*RouterGroup&#123;engine.RouterGroup&#125;</span><br><span class="line">        <span class="keyword">return</span> engine</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Node 版本 akt.ts</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> http <span class="keyword">from</span> <span class="string">'http'</span>;</span><br><span class="line"><span class="keyword">import</span> querystring <span class="keyword">from</span> <span class="string">'querystring'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> getContext, &#123; AktContext &#125; <span class="keyword">from</span> <span class="string">'./context'</span>;</span><br><span class="line"><span class="keyword">import</span> getRouter, &#123; AktRouter &#125; <span class="keyword">from</span> <span class="string">'./router'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">type</span> RouterGroupType = &#123;</span><br><span class="line">  <span class="comment">// 前缀</span></span><br><span class="line">  prefix: <span class="built_in">string</span>;</span><br><span class="line">  middlewares: HandlerFunc[];</span><br><span class="line">  <span class="comment">// 父组</span></span><br><span class="line">  parent: RouterGroupType | AktType;</span><br><span class="line">  <span class="comment">// 根akt</span></span><br><span class="line">  akt: AktType;</span><br><span class="line">  <span class="comment">// 建立新分组</span></span><br><span class="line">  group: <span class="function">(<span class="params">prefix: <span class="built_in">string</span>, group?: RouterGroupType</span>) =&gt;</span> RouterGroupType;</span><br><span class="line">  <span class="comment">// 添加路由</span></span><br><span class="line">  addRoute: (</span><br><span class="line">    method: <span class="built_in">string</span>,</span><br><span class="line">    pattern: <span class="built_in">string</span>,</span><br><span class="line">    handler: HandlerFunc,</span><br><span class="line">    group?: RouterGroupType,</span><br><span class="line">  ) =&gt; <span class="built_in">void</span>;</span><br><span class="line">  <span class="keyword">get</span>: <span class="function">(<span class="params">pattern: <span class="built_in">string</span>, handler: HandlerFunc</span>) =&gt;</span> <span class="built_in">void</span>;</span><br><span class="line">  post: <span class="function">(<span class="params">pattern: <span class="built_in">string</span>, handler: HandlerFunc</span>) =&gt;</span> <span class="built_in">void</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">type</span> HandlerFunc = <span class="function">(<span class="params">ctx: AktContext</span>) =&gt;</span> <span class="built_in">void</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">type</span> AktType = &#123;</span><br><span class="line">  server: http.Server;</span><br><span class="line">  router: AktRouter;</span><br><span class="line">  groups: (RouterGroupType | AktType)[];</span><br><span class="line">  <span class="keyword">get</span>: <span class="function">(<span class="params">pattern: <span class="built_in">string</span>, handler: HandlerFunc</span>) =&gt;</span> <span class="built_in">void</span>;</span><br><span class="line">  post: <span class="function">(<span class="params">pattern: <span class="built_in">string</span>, handler: HandlerFunc</span>) =&gt;</span> <span class="built_in">void</span>;</span><br><span class="line">  run: <span class="function">(<span class="params">addr: <span class="built_in">string</span>, listeningListener?: (<span class="params"></span>) =&gt; <span class="built_in">void</span></span>) =&gt;</span> http.Server;</span><br><span class="line">&#125; &amp; Omit&lt;RouterGroupType, <span class="string">'addRoute'</span> | <span class="string">'post'</span> | <span class="string">'get'</span>&gt;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> akt = <span class="function">(<span class="params">requestListener?: http.RequestListener</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> akt: AktType = &#123;</span><br><span class="line">    <span class="comment">// server</span></span><br><span class="line">    server: http.createServer(requestListener),</span><br><span class="line">    <span class="comment">// 路由</span></span><br><span class="line">    router: getRouter(),</span><br><span class="line">    prefix: <span class="string">''</span>,</span><br><span class="line">    middlewares: [],</span><br><span class="line">    parent: <span class="literal">null</span>,</span><br><span class="line">    akt: <span class="literal">null</span>,</span><br><span class="line">    groups: [],</span><br><span class="line">    <span class="comment">// 设置get请求的路由</span></span><br><span class="line">    <span class="keyword">get</span>: <span class="function">(<span class="params">pattern: <span class="built_in">string</span>, handler: HandlerFunc, group?: RouterGroupType</span>) =&gt;</span> &#123;</span><br><span class="line">      akt.router.addRoute(<span class="string">'GET'</span>, pattern, handler);</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="comment">// 设置post请求的路由</span></span><br><span class="line">    post: <span class="function">(<span class="params">pattern: <span class="built_in">string</span>, handler: HandlerFunc, group?: RouterGroupType</span>) =&gt;</span> &#123;</span><br><span class="line">      akt.router.addRoute(<span class="string">'POST'</span>, pattern, handler);</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="comment">// 设置监听端口</span></span><br><span class="line">    run: <span class="function">(<span class="params">addr: <span class="built_in">string</span>, listeningListener?: (<span class="params"></span>) =&gt; <span class="built_in">void</span></span>) =&gt;</span></span><br><span class="line">      akt.server.listen(addr, listeningListener),</span><br><span class="line">    <span class="comment">// 建立新分组</span></span><br><span class="line">    group: <span class="function">(<span class="params">prefix: <span class="built_in">string</span>, parentGroup?: RouterGroupType</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> group = parentGroup || akt;</span><br><span class="line">      <span class="keyword">const</span> newGroup: RouterGroupType = &#123;</span><br><span class="line">        prefix: group.prefix + prefix,</span><br><span class="line">        parent: group,</span><br><span class="line">        akt: akt,</span><br><span class="line">        middlewares: [],</span><br><span class="line">        group: <span class="function">(<span class="params">prefix: <span class="built_in">string</span></span>) =&gt;</span> akt.group(prefix, newGroup),</span><br><span class="line">        addRoute: <span class="function">(<span class="params">method: <span class="built_in">string</span>, pattern: <span class="built_in">string</span>, handler: HandlerFunc</span>) =&gt;</span> &#123;</span><br><span class="line">          pattern = newGroup.prefix + pattern;</span><br><span class="line">          akt.router.addRoute(method, pattern, handler);</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="keyword">get</span>: <span class="function">(<span class="params">pattern: <span class="built_in">string</span>, handler: HandlerFunc</span>) =&gt;</span> &#123;</span><br><span class="line">          newGroup.addRoute(<span class="string">'GET'</span>, pattern, handler, newGroup);</span><br><span class="line">        &#125;,</span><br><span class="line">        post: <span class="function">(<span class="params">pattern: <span class="built_in">string</span>, handler: HandlerFunc</span>) =&gt;</span> &#123;</span><br><span class="line">          newGroup.addRoute(<span class="string">'POST'</span>, pattern, handler, newGroup);</span><br><span class="line">        &#125;,</span><br><span class="line">      &#125;;</span><br><span class="line"></span><br><span class="line">      group.akt.groups.push(newGroup);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> newGroup;</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 监听请求</span></span><br><span class="line">  akt.server.on(</span><br><span class="line">    <span class="string">'request'</span>,</span><br><span class="line">    (requset: http.IncomingMessage &amp; &#123; body?: <span class="built_in">any</span> &#125;, response: http.ServerResponse) =&gt; &#123;</span><br><span class="line">      <span class="comment">// 处理post请求</span></span><br><span class="line">      requset.body = <span class="string">''</span>;</span><br><span class="line">      requset.on(<span class="string">'data'</span>, <span class="function"><span class="params">chuck</span> =&gt;</span> &#123;</span><br><span class="line">        requset.body += chuck;</span><br><span class="line">      &#125;);</span><br><span class="line">      requset.on(<span class="string">'end'</span>, <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (requset.headers[<span class="string">'content-type'</span>]?.includes(<span class="string">'application/json'</span>)) &#123;</span><br><span class="line">          requset.body = <span class="built_in">JSON</span>.parse(requset.body);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (requset.method === <span class="string">'POST'</span>) &#123;</span><br><span class="line">          requset.body = querystring.parse(requset.body);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// data接收完毕后创建context,并执行</span></span><br><span class="line">        <span class="keyword">const</span> ctx = getContext(requset, response);</span><br><span class="line">        akt.router.handle(ctx);</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;,</span><br><span class="line">  );</span><br><span class="line"></span><br><span class="line">  akt.akt = akt;</span><br><span class="line">  akt.groups.push(akt);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> akt;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> akt;</span><br></pre></td></tr></table></figure>
<h1 id="5-中间件"><a href="#5-中间件" class="headerlink" title="5. 中间件"></a>5. 中间件</h1><p>距离我们最开始画的架构图现在只缺中间件了，想必用过 koa 的同学肯定都知道中间件是什么啦，我就不具体解释了，接下来我们就来实现它。</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Context.go</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> akt</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">        <span class="string">"encoding/json"</span></span><br><span class="line">        <span class="string">"fmt"</span></span><br><span class="line">        <span class="string">"net/http"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Context <span class="keyword">struct</span> &#123;</span><br><span class="line">        Req        *http.Request</span><br><span class="line">        Writer     http.ResponseWriter</span><br><span class="line">        Path       <span class="keyword">string</span></span><br><span class="line">        Method     <span class="keyword">string</span></span><br><span class="line">        StatusCode <span class="keyword">int</span></span><br><span class="line">        Params     <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">string</span></span><br><span class="line">        index      <span class="keyword">int</span>  <span class="comment">// 指示位置</span></span><br><span class="line">        handlers   []HandlerFunc <span class="comment">// 存储中间件</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 。。。</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *Context)</span> <span class="title">Next</span><span class="params">()</span></span> &#123; <span class="comment">// 调用Next()执行下一个中间件</span></span><br><span class="line">        c.index++</span><br><span class="line">        s := <span class="built_in">len</span>(c.handlers)</span><br><span class="line">        <span class="keyword">for</span> c.index &lt; s &#123;</span><br><span class="line">                c.handlers[c.index](c)</span><br><span class="line">                c.index++</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// group.go</span></span><br><span class="line"><span class="keyword">package</span> akt</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> RouterGroup <span class="keyword">struct</span> &#123;</span><br><span class="line">        prefix      <span class="keyword">string</span></span><br><span class="line">        parent      *RouterGroup</span><br><span class="line">        middlewares []HandlerFunc</span><br><span class="line">        engine      *Engine</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(group *RouterGroup)</span> <span class="title">Use</span><span class="params">(handler HandlerFunc)</span></span> &#123; <span class="comment">// 每个分组添加中间件</span></span><br><span class="line">        group.middlewares = <span class="built_in">append</span>(group.middlewares, handler)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// router.go</span></span><br><span class="line"><span class="keyword">package</span> akt</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">        <span class="string">"net/http"</span></span><br><span class="line">        <span class="string">"strings"</span></span><br><span class="line"></span><br><span class="line">        <span class="string">"fmt"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> router <span class="keyword">struct</span> &#123;</span><br><span class="line">        handlers <span class="keyword">map</span>[<span class="keyword">string</span>]HandlerFunc</span><br><span class="line">        roots    <span class="keyword">map</span>[<span class="keyword">string</span>]*node</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(router *router)</span> <span class="title">handle</span><span class="params">(c *Context)</span></span> &#123;</span><br><span class="line">        n, params := router.getRoute(c.Method, c.Path)</span><br><span class="line">        fmt.Printf(<span class="string">"%v"</span>, n)</span><br><span class="line">        <span class="keyword">if</span> n != <span class="literal">nil</span> &#123; <span class="comment">// 添加上不同分组的中间件</span></span><br><span class="line">                c.Params = params</span><br><span class="line">                key := c.Method + <span class="string">"-"</span> + n.pattern</span><br><span class="line">                handler := router.handlers[key]</span><br><span class="line">                c.handlers = <span class="built_in">append</span>(c.handlers, handler)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                c.String(http.StatusNotFound, <span class="string">"404 NOT FOUND: %s\n"</span>, c.Path)</span><br><span class="line">        &#125;</span><br><span class="line">        c.Next()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Node 版本</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// context.ts</span></span><br><span class="line"><span class="keyword">import</span> http <span class="keyword">from</span> <span class="string">'http'</span>;</span><br><span class="line"><span class="keyword">import</span> url <span class="keyword">from</span> <span class="string">'url'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123; HandlerFunc &#125; <span class="keyword">from</span> <span class="string">'./akt'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">type</span> ContextOptionsType = &#123;</span><br><span class="line">  [propsName: <span class="built_in">string</span>]: <span class="built_in">any</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> Context &#123;</span><br><span class="line">  req: http.IncomingMessage &amp; &#123; body?: <span class="built_in">any</span> &#125;;</span><br><span class="line">  res: http.ServerResponse;</span><br><span class="line">  path: <span class="built_in">string</span>;</span><br><span class="line">  method: <span class="built_in">string</span>;</span><br><span class="line">  statusCode: <span class="built_in">number</span>;</span><br><span class="line">  params: Map&lt;<span class="built_in">string</span>, <span class="built_in">string</span>&gt;;</span><br><span class="line">  <span class="keyword">private</span> index: <span class="built_in">number</span>;</span><br><span class="line">  hanlders: HandlerFunc[];</span><br><span class="line">  resData: <span class="built_in">any</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> URL: url.URL;</span><br><span class="line">  <span class="keyword">constructor</span>(<span class="params">requset: http.IncomingMessage, response: http.ServerResponse</span>) &#123;</span><br><span class="line">    <span class="keyword">this</span>.req = requset;</span><br><span class="line">    <span class="keyword">this</span>.res = response;</span><br><span class="line">    <span class="keyword">this</span>.URL = <span class="keyword">new</span> url.URL(<span class="string">`http://<span class="subst">$&#123;<span class="keyword">this</span>.req.headers.host&#125;</span><span class="subst">$&#123;<span class="keyword">this</span>.req.url&#125;</span>`</span>);</span><br><span class="line">    <span class="keyword">this</span>.path = <span class="keyword">this</span>.URL.pathname;</span><br><span class="line">    <span class="keyword">this</span>.method = requset.method;</span><br><span class="line">    <span class="keyword">this</span>.params = <span class="keyword">new</span> Map();</span><br><span class="line">    <span class="keyword">this</span>.index = <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">this</span>.hanlders = [];</span><br><span class="line">    <span class="keyword">this</span>.resData = <span class="literal">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">  next = <span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">    <span class="keyword">this</span>.index++;</span><br><span class="line">    <span class="keyword">while</span> (<span class="keyword">this</span>.index &lt; <span class="keyword">this</span>.hanlders.length) &#123;</span><br><span class="line">      <span class="keyword">this</span>.hanlders[<span class="keyword">this</span>.index](<span class="keyword">this</span>);</span><br><span class="line">      <span class="keyword">this</span>.index++;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// akt.ts</span></span><br><span class="line"><span class="keyword">import</span> http <span class="keyword">from</span> <span class="string">'http'</span>;</span><br><span class="line"><span class="keyword">import</span> querystring <span class="keyword">from</span> <span class="string">'querystring'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123; Context &#125; <span class="keyword">from</span> <span class="string">'./context'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Router &#125; <span class="keyword">from</span> <span class="string">'./router'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 新增</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">type</span> HandlerFunc = <span class="function">(<span class="params">ctx: Context</span>) =&gt;</span> <span class="built_in">void</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> RouterGroup &#123;</span><br><span class="line">  prefix: <span class="built_in">string</span>;</span><br><span class="line">  <span class="keyword">protected</span> parent: RouterGroup | Akt;</span><br><span class="line">  middlewares: HandlerFunc[];</span><br><span class="line">  <span class="keyword">protected</span> akt: Akt;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">constructor</span>(<span class="params">prefix: <span class="built_in">string</span>, parent: RouterGroup | Akt, akt: Akt</span>) &#123;</span><br><span class="line">    <span class="keyword">this</span>.prefix = (parent ? parent.prefix : <span class="string">''</span>) + prefix;</span><br><span class="line">    <span class="keyword">this</span>.parent = parent;</span><br><span class="line">    <span class="keyword">this</span>.akt = akt;</span><br><span class="line">    <span class="comment">// 新增</span></span><br><span class="line">    <span class="keyword">this</span>.middlewares = [];</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  group = <span class="function">(<span class="params">prefix: <span class="built_in">string</span></span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> newGruop = <span class="keyword">new</span> RouterGroup(prefix, <span class="keyword">this</span>, <span class="keyword">this</span>.akt);</span><br><span class="line">    <span class="keyword">this</span>.akt.groups.push(newGruop);</span><br><span class="line">    <span class="keyword">return</span> newGruop;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">get</span> = <span class="function">(<span class="params">pattern: <span class="built_in">string</span>, handler: HandlerFunc</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">this</span>.addRoute(<span class="string">'GET'</span>, pattern, handler);</span><br><span class="line">  &#125;;</span><br><span class="line">  post = <span class="function">(<span class="params">pattern: <span class="built_in">string</span>, handler: HandlerFunc</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">this</span>.addRoute(<span class="string">'POST'</span>, pattern, handler);</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">protected</span> addRoute = <span class="function">(<span class="params">method: <span class="built_in">string</span>, comp: <span class="built_in">string</span>, handler: HandlerFunc</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> pattern = <span class="keyword">this</span>.prefix + comp;</span><br><span class="line">    <span class="keyword">this</span>.akt.addRoute(method, pattern, handler);</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 新增</span></span><br><span class="line">  use = <span class="function">(<span class="params">handler: HandlerFunc</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">this</span>.middlewares.push(handler);</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> Akt <span class="keyword">extends</span> RouterGroup &#123;</span><br><span class="line">  <span class="keyword">private</span> server: http.Server;</span><br><span class="line">  <span class="keyword">private</span> router: Router;</span><br><span class="line">  groups: (RouterGroup | Akt)[];</span><br><span class="line"></span><br><span class="line">  <span class="keyword">constructor</span>(<span class="params">requestListener?: http.RequestListener</span>) &#123;</span><br><span class="line">    <span class="keyword">super</span>(<span class="string">''</span>, <span class="literal">null</span>, <span class="literal">null</span>);</span><br><span class="line">    <span class="keyword">this</span>.akt = <span class="keyword">this</span>;</span><br><span class="line">    <span class="keyword">this</span>.parent = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">this</span>.server = http.createServer(requestListener);</span><br><span class="line">    <span class="keyword">this</span>.router = <span class="keyword">new</span> Router();</span><br><span class="line">    <span class="keyword">this</span>.groups = [<span class="keyword">this</span>];</span><br><span class="line">    <span class="comment">// 监听请求</span></span><br><span class="line">    <span class="keyword">this</span>.server.on(</span><br><span class="line">      <span class="string">'request'</span>,</span><br><span class="line">      (requset: http.IncomingMessage &amp; &#123; body?: <span class="built_in">any</span> &#125;, response: http.ServerResponse) =&gt; &#123;</span><br><span class="line">        <span class="comment">// 处理post请求</span></span><br><span class="line">        requset.body = <span class="string">''</span>;</span><br><span class="line">        requset.on(<span class="string">'data'</span>, <span class="function"><span class="params">chuck</span> =&gt;</span> &#123;</span><br><span class="line">          requset.body += chuck;</span><br><span class="line">        &#125;);</span><br><span class="line">        requset.on(<span class="string">'end'</span>, <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">          <span class="keyword">if</span> (requset.headers[<span class="string">'content-type'</span>]?.includes(<span class="string">'application/json'</span>)) &#123;</span><br><span class="line">            requset.body = <span class="built_in">JSON</span>.parse(requset.body);</span><br><span class="line">          &#125; <span class="keyword">else</span> <span class="keyword">if</span> (requset.method === <span class="string">'POST'</span>) &#123;</span><br><span class="line">            requset.body = querystring.parse(requset.body);</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="comment">// 新增</span></span><br><span class="line">          <span class="keyword">let</span> middlewares: HandlerFunc[] = [];</span><br><span class="line">          <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; <span class="keyword">this</span>.groups.length; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (requset.url.includes(<span class="keyword">this</span>.groups[i].prefix)) &#123;</span><br><span class="line">              middlewares = [...middlewares, ...this.groups[i].middlewares];</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">const</span> ctx = <span class="keyword">new</span> Context(requset, response);</span><br><span class="line">          ctx.hanlders = middlewares;</span><br><span class="line">          <span class="keyword">this</span>.router.handle(ctx);</span><br><span class="line">        &#125;);</span><br><span class="line">      &#125;,</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 返回server实例，可用于多进程</span></span><br><span class="line">  getServer = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.server;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 设置监听端口</span></span><br><span class="line">  run = <span class="function">(<span class="params">addr: <span class="built_in">string</span>, listeningListener?: (<span class="params"></span>) =&gt; <span class="built_in">void</span></span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.server.listen(addr, listeningListener);</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  addRoute = <span class="function">(<span class="params">method: <span class="built_in">string</span>, pattern: <span class="built_in">string</span>, handler: HandlerFunc</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">this</span>.router.addRoute(method, pattern, handler);</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> akt = <span class="function">(<span class="params">requestListener?: http.RequestListener</span>) =&gt;</span> <span class="keyword">new</span> Akt(requestListener);</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> akt;</span><br></pre></td></tr></table></figure>
<h1 id="6-错误恢复"><a href="#6-错误恢复" class="headerlink" title="6. 错误恢复"></a>6. 错误恢复</h1><p>现在我们的项目已经基本完成了，但是存在一个问题，如果抛出 panic，导致我们的项目直接挂掉，因此，我们需要编写一个中间件用于处理错误恢复。</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> akt</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">        <span class="string">"fmt"</span></span><br><span class="line">        <span class="string">"log"</span></span><br><span class="line">        <span class="string">"net/http"</span></span><br><span class="line">        <span class="string">"runtime"</span></span><br><span class="line">        <span class="string">"strings"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">trace</span><span class="params">(message <span class="keyword">string</span>)</span> <span class="title">string</span></span> &#123; <span class="comment">// 展示堆栈信息</span></span><br><span class="line">        <span class="keyword">var</span> pcs [<span class="number">32</span>]<span class="keyword">uintptr</span></span><br><span class="line"></span><br><span class="line">        n := runtime.Callers(<span class="number">3</span>, pcs[:])</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> str strings.Builder</span><br><span class="line"></span><br><span class="line">        str.WriteString(message + <span class="string">"\nTraceback:"</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> _, pc := <span class="keyword">range</span> pcs[:n] &#123;</span><br><span class="line">                fn := runtime.FuncForPC(pc)</span><br><span class="line">                file, line := fn.FileLine(pc)</span><br><span class="line">                str.WriteString(fmt.Sprintf(<span class="string">"\n\t%s%d"</span>, file, line))</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> str.String()</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Recovery</span><span class="params">(c *Context)</span></span> &#123; <span class="comment">// 处理错误</span></span><br><span class="line">        <span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">                <span class="keyword">if</span> err := <span class="built_in">recover</span>(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">                        message := fmt.Sprintf(<span class="string">"%s"</span>, err)</span><br><span class="line">                        log.Printf(<span class="string">"%s\n\n"</span>, trace(message))</span><br><span class="line">                        c.String(http.StatusInternalServerError, <span class="string">"Internal Server Error"</span>)</span><br><span class="line">                        <span class="keyword">if</span> c.onError != <span class="literal">nil</span> &#123;</span><br><span class="line">                                c.onError(err)</span><br><span class="line">                        &#125;</span><br><span class="line">                &#125;</span><br><span class="line">        &#125;()</span><br><span class="line"></span><br><span class="line">        c.Next()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Node:</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// akt.ts</span></span><br><span class="line"><span class="keyword">import</span> http <span class="keyword">from</span> <span class="string">'http'</span>;</span><br><span class="line"><span class="keyword">import</span> querystring <span class="keyword">from</span> <span class="string">'querystring'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; join, resolve, parse &#125; <span class="keyword">from</span> <span class="string">'path'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; createReadStream &#125; <span class="keyword">from</span> <span class="string">'fs'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; stat &#125; <span class="keyword">from</span> <span class="string">'fs/promises'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; getType &#125; <span class="keyword">from</span> <span class="string">'mime'</span>;</span><br><span class="line"><span class="keyword">import</span> pug <span class="keyword">from</span> <span class="string">'pug'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123; Context &#125; <span class="keyword">from</span> <span class="string">'./context'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Router &#125; <span class="keyword">from</span> <span class="string">'./router'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; AktContext &#125; <span class="keyword">from</span> <span class="string">'classVersion'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">type</span> HandlerFunc = <span class="function">(<span class="params">ctx: Context</span>) =&gt;</span> <span class="built_in">void</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> createStaticHandler = (root: <span class="built_in">string</span>): <span class="function"><span class="params">HandlerFunc</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> absolutePath = join(resolve(<span class="string">'.'</span>), root);</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">async</span> (ctx: AktContext) =&gt; &#123;</span><br><span class="line">    <span class="keyword">let</span> pipe: http.ServerResponse;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> filePath = join(absolutePath, ctx.param(<span class="string">'filepath'</span>));</span><br><span class="line">      <span class="keyword">const</span> fileName = <span class="keyword">await</span> stat(filePath);</span><br><span class="line">      <span class="keyword">if</span> (fileName.isFile()) &#123;</span><br><span class="line">        <span class="keyword">const</span> ext = parse(filePath).ext;</span><br><span class="line">        <span class="keyword">const</span> mimeType = getType(ext);</span><br><span class="line">        ctx.setHeader(<span class="string">'Content-Type'</span>, mimeType);</span><br><span class="line">        pipe = createReadStream(filePath).pipe(ctx.res);</span><br><span class="line">        <span class="keyword">await</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="params">resolve</span> =&gt;</span> &#123;</span><br><span class="line">          pipe.on(<span class="string">'end'</span>, <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">            resolve(<span class="string">''</span>);</span><br><span class="line">          &#125;);</span><br><span class="line">        &#125;);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="built_in">Error</span>(<span class="string">'File is not found!'</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">      <span class="keyword">if</span> (pipe) pipe.destroy();</span><br><span class="line">      <span class="keyword">if</span> (ctx.akt.onError) ctx.akt.onError(e);</span><br><span class="line">      ctx.string(<span class="number">404</span>, <span class="string">'File is not found!'</span>);</span><br><span class="line">      ctx.setHeader(<span class="string">'Content-Type'</span>, <span class="string">'text/plain'</span>);</span><br><span class="line">      ctx.res.end();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> RouterGroup &#123;</span><br><span class="line">  prefix: <span class="built_in">string</span>;</span><br><span class="line">  <span class="keyword">protected</span> parent: RouterGroup | Akt;</span><br><span class="line">  middlewares: HandlerFunc[];</span><br><span class="line">  <span class="keyword">protected</span> akt: Akt;</span><br><span class="line">  onError: <span class="function">(<span class="params">err: <span class="built_in">any</span>, p?: <span class="built_in">Promise</span>&lt;<span class="built_in">any</span>&gt;</span>) =&gt;</span> <span class="built_in">void</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">constructor</span>(<span class="params">prefix: <span class="built_in">string</span>, parent: RouterGroup | Akt, akt: Akt</span>) &#123;</span><br><span class="line">    <span class="keyword">this</span>.prefix = (parent ? parent.prefix : <span class="string">''</span>) + prefix;</span><br><span class="line">    <span class="keyword">this</span>.parent = parent;</span><br><span class="line">    <span class="keyword">this</span>.akt = akt;</span><br><span class="line">    <span class="keyword">this</span>.middlewares = [];</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  group = <span class="function">(<span class="params">prefix: <span class="built_in">string</span></span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> newGruop = <span class="keyword">new</span> RouterGroup(prefix, <span class="keyword">this</span>, <span class="keyword">this</span>.akt);</span><br><span class="line">    <span class="keyword">this</span>.akt.groups.push(newGruop);</span><br><span class="line">    <span class="keyword">return</span> newGruop;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">get</span> = <span class="function">(<span class="params">pattern: <span class="built_in">string</span>, handler: HandlerFunc</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">this</span>.addRoute(<span class="string">'GET'</span>, pattern, handler);</span><br><span class="line">  &#125;;</span><br><span class="line">  post = <span class="function">(<span class="params">pattern: <span class="built_in">string</span>, handler: HandlerFunc</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">this</span>.addRoute(<span class="string">'POST'</span>, pattern, handler);</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">protected</span> addRoute = <span class="function">(<span class="params">method: <span class="built_in">string</span>, comp: <span class="built_in">string</span>, handler: HandlerFunc</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> pattern = <span class="keyword">this</span>.prefix + comp;</span><br><span class="line">    <span class="keyword">this</span>.akt.addRoute(method, pattern, handler);</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  use = <span class="function">(<span class="params">handler: HandlerFunc</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">this</span>.middlewares.push(handler);</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">static</span> = <span class="function">(<span class="params">relativePath: <span class="built_in">string</span>, root: <span class="built_in">string</span></span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> handler = createStaticHandler(root);</span><br><span class="line">    <span class="keyword">const</span> urlPattern = join(relativePath, <span class="string">'/*filepath'</span>).replace(<span class="regexp">/\\/g</span>, <span class="string">'/'</span>);</span><br><span class="line">    <span class="keyword">this</span>.get(urlPattern, handler);</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> Akt <span class="keyword">extends</span> RouterGroup &#123;</span><br><span class="line">  <span class="keyword">private</span> server: http.Server;</span><br><span class="line">  <span class="keyword">private</span> router: Router;</span><br><span class="line">  groups: (RouterGroup | Akt)[];</span><br><span class="line">  pug: <span class="keyword">typeof</span> pug;</span><br><span class="line">  templateRoot: <span class="built_in">string</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">constructor</span>(<span class="params">requestListener?: http.RequestListener</span>) &#123;</span><br><span class="line">    <span class="keyword">super</span>(<span class="string">''</span>, <span class="literal">null</span>, <span class="literal">null</span>);</span><br><span class="line">    <span class="keyword">this</span>.akt = <span class="keyword">this</span>;</span><br><span class="line">    <span class="keyword">this</span>.parent = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">this</span>.server = http.createServer(requestListener);</span><br><span class="line">    <span class="keyword">this</span>.router = <span class="keyword">new</span> Router();</span><br><span class="line">    <span class="keyword">this</span>.groups = [<span class="keyword">this</span>];</span><br><span class="line">    <span class="keyword">this</span>.pug = pug;</span><br><span class="line">    <span class="keyword">this</span>.templateRoot = <span class="literal">null</span>;</span><br><span class="line">    <span class="comment">// 监听请求</span></span><br><span class="line">    <span class="keyword">this</span>.server.on(</span><br><span class="line">      <span class="string">'request'</span>,</span><br><span class="line">      (requset: http.IncomingMessage &amp; &#123; body?: <span class="built_in">any</span> &#125;, response: http.ServerResponse) =&gt; &#123;</span><br><span class="line">        <span class="comment">// 处理post请求</span></span><br><span class="line">        requset.body = <span class="string">''</span>;</span><br><span class="line">        requset.on(<span class="string">'data'</span>, <span class="function"><span class="params">chuck</span> =&gt;</span> &#123;</span><br><span class="line">          requset.body += chuck;</span><br><span class="line">        &#125;);</span><br><span class="line">        requset.on(<span class="string">'end'</span>, <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">          <span class="keyword">if</span> (requset.headers[<span class="string">'content-type'</span>]?.includes(<span class="string">'application/json'</span>)) &#123;</span><br><span class="line">            requset.body = <span class="built_in">JSON</span>.parse(requset.body);</span><br><span class="line">          &#125; <span class="keyword">else</span> <span class="keyword">if</span> (requset.method === <span class="string">'POST'</span>) &#123;</span><br><span class="line">            requset.body = querystring.parse(requset.body);</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">let</span> middlewares: HandlerFunc[] = [];</span><br><span class="line">          <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; <span class="keyword">this</span>.groups.length; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (requset.url.includes(<span class="keyword">this</span>.groups[i].prefix)) &#123;</span><br><span class="line">              middlewares = [...middlewares, ...this.groups[i].middlewares];</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">const</span> ctx = <span class="keyword">new</span> Context(requset, response, <span class="keyword">this</span>);</span><br><span class="line">          ctx.hanlders = middlewares;</span><br><span class="line">          <span class="keyword">this</span>.router.handle(ctx);</span><br><span class="line">        &#125;);</span><br><span class="line">      &#125;,</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 新增</span></span><br><span class="line">    <span class="comment">// 捕获错误，用于防止服务器崩溃</span></span><br><span class="line">    process.on(<span class="string">'uncaughtException'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">err</span>) </span>&#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">this</span>.onError) <span class="keyword">this</span>.onError(err);</span><br><span class="line">      <span class="built_in">console</span>.log(err.stack);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    process.on(<span class="string">'unhandledRejection'</span>, <span class="function">(<span class="params">reason, p</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">this</span>.onError) <span class="keyword">this</span>.onError(reason, p);</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">'Unhandled Rejection at: Promise'</span>, p, <span class="string">'reason:'</span>, reason);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="7-写在最后"><a href="#7-写在最后" class="headerlink" title="7. 写在最后"></a>7. 写在最后</h1><p>至此，我们已经将 Gin 比较核心的几个点进行了实现，Gin 也是小而美的框架，虽然有 14k 的代码，但是其中的测试代码达到了 9k，还有一些例如静态资源获取，模板渲染等功能，因为时间篇幅有限，我实现了一些（<a href="https://github.com/akitaSummer/akt/blob/main/akt-golang/akt/group.go" target="_blank" rel="noopener">静态资源获取</a>， <a href="https://github.com/akitaSummer/akt/blob/main/akt-golang/akt/context.go" target="_blank" rel="noopener">模板渲染</a>），但没有在文章中写出，有兴趣的同学可以去自己实现一下，感受自己编写一个框架的乐趣吧。</p>
<p>在这文章的最后，我还是要再一次感谢你的阅读，本人的能力有限，可能有错误之处也请指出，如果有空，我还是非常推荐你阅读一下 Gin 的代码，他的精妙之处是我这 demo 无以比拟的。</p>

      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Golang/" rel="tag"># Golang</a>
          
            <a href="/tags/Gin/" rel="tag"># Gin</a>
          
            <a href="/tags/Web-Server/" rel="tag"># Web Server</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2020/12/04/ReactNative混合开发应用/" rel="next" title="React Native混合开发应用">
                <i class="fa fa-chevron-left"></i> React Native混合开发应用
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>


  </div>


          </div>
          

  
    <div class="comments" id="comments">
      
        <div id="gitment-container"></div>
      
    </div>

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/images/v2-e386393694cb08152bb316fa79bba113_hd.jpg" alt="Akita Summer">
            
              <p class="site-author-name" itemprop="name">Akita Summer</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">9</span>
                    <span class="site-state-item-name">日志</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  <a href="/categories/index.html">
                    
                    
                      
                    
                    <span class="site-state-item-count">1</span>
                    <span class="site-state-item-name">分类</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  <a href="/tags/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">13</span>
                    <span class="site-state-item-name">标签</span>
                  </a>
                </div>
              
            </nav>
          

          

          
            <div class="links-of-author motion-element">
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                    
                  
                  <a href="https://github.com/akitaSummer" title="GitHub &rarr; https://github.com/akitaSummer" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a>
                </span>
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                    
                  
                  <a href="mailto:644171127@qq.com" title="E-Mail &rarr; mailto:644171127@qq.com" rel="noopener" target="_blank"><i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                </span>
              
            </div>
          

          

          
          

          
            
          
          

        </div>
      </div>

      
      <!--noindex-->
        <div class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
            
            
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#0-前言"><span class="nav-number">1.</span> <span class="nav-text">0. 前言</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#1-最简框架"><span class="nav-number">2.</span> <span class="nav-text">1. 最简框架</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#2-封装-Context"><span class="nav-number">3.</span> <span class="nav-text">2. 封装 Context</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#3-动态路由解析"><span class="nav-number">4.</span> <span class="nav-text">3. 动态路由解析</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#4-路由分组"><span class="nav-number">5.</span> <span class="nav-text">4. 路由分组</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#5-中间件"><span class="nav-number">6.</span> <span class="nav-text">5. 中间件</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#6-错误恢复"><span class="nav-number">7.</span> <span class="nav-text">6. 错误恢复</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#7-写在最后"><span class="nav-number">8.</span> <span class="nav-text">7. 写在最后</span></a></li></ol></div>
            

          </div>
        </div>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2023</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Akita Summer</span>

  

  
</div>

<!--
  <div class="powered-by">由 <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> 强力驱动 v3.9.0</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 – <a href="https://theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a> v7.0.0</div>
-->



        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

    

    
  </div>

  

<script>
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  <script src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>


  


  <script src="/js/src/utils.js?v=7.0.0"></script>

  <script src="/js/src/motion.js?v=7.0.0"></script>



  
  


  <script src="/js/src/affix.js?v=7.0.0"></script>

  <script src="/js/src/schemes/pisces.js?v=7.0.0"></script>



  
  <script src="/js/src/scrollspy.js?v=7.0.0"></script>
<script src="/js/src/post-details.js?v=7.0.0"></script>



  


  <script src="/js/src/bootstrap.js?v=7.0.0"></script>



  


  
    <!-- LOCAL: You can save these files to your site and update links -->

  
  <script src="https://cdn.jsdelivr.net/gh/theme-next/theme-next-gitment@1/gitmint.browser.js"></script>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/theme-next/theme-next-gitment@1/default.css">
<!-- END LOCAL -->

<style>
#gitment-container a {
  border-bottom: none;
}

</style>

<script>
  function renderGitment() {
    var gitment = new Gitmint({
      id: window.location.pathname,
      owner: 'akitaSummer',
      repo: 'blogComment',
      
        lang: '' || navigator.language || navigator.systemLanguage || navigator.userLanguage,
      
      oauth: {
      
      
        client_secret: '624f365dba9bccb32867a185a2cf65556335f06e',
      
        client_id: 'f433f680d31e0d644e2c'
      }
    });
    gitment.render('gitment-container');
  }

  
    renderGitment();
  
</script>

  


  





  

  

  

  

  

  

  

  

  

  

  

  

  

</body>
</html>
