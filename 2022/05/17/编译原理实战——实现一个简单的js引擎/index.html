<!DOCTYPE html>












  


<html class="theme-next pisces use-motion" lang="zh-CN">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">


























<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2">

<link rel="stylesheet" href="/css/main.css?v=7.0.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=7.0.0">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=7.0.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=7.0.0">


  <link rel="mask-icon" href="/images/logo.svg?v=7.0.0" color="#222">







<script id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '7.0.0',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="前言之前我们实现了一个简单的浏览器，但是其中最为核心的 js 引擎，我们使用的是 v8，并没有自己实现，本次我们将会实现一个简单的 js 引擎，作为我们编译原理学习的一个练习。 设计js 引擎，实际上是一个编译器，编译器分为前端和后端两个部分，前端的主要作用是将源代码编译成中间代码，她会包含词法分析和语法分析，而后端则是将中间代码优化并产生最终代码（如机器码）。 词法解析就是 tokenize，将">
<meta name="keywords" content="rust,javascript engine,编译原理">
<meta property="og:type" content="article">
<meta property="og:title" content="编译原理实战——实现一个简单的js引擎">
<meta property="og:url" content="https://akitaSummer.github.io/2022/05/17/编译原理实战——实现一个简单的js引擎/index.html">
<meta property="og:site_name" content="Akita Summer&#39;s Blog">
<meta property="og:description" content="前言之前我们实现了一个简单的浏览器，但是其中最为核心的 js 引擎，我们使用的是 v8，并没有自己实现，本次我们将会实现一个简单的 js 引擎，作为我们编译原理学习的一个练习。 设计js 引擎，实际上是一个编译器，编译器分为前端和后端两个部分，前端的主要作用是将源代码编译成中间代码，她会包含词法分析和语法分析，而后端则是将中间代码优化并产生最终代码（如机器码）。 词法解析就是 tokenize，将">
<meta property="og:locale" content="zh-CN">
<meta property="og:updated_time" content="2023-11-11T19:06:31.867Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="编译原理实战——实现一个简单的js引擎">
<meta name="twitter:description" content="前言之前我们实现了一个简单的浏览器，但是其中最为核心的 js 引擎，我们使用的是 v8，并没有自己实现，本次我们将会实现一个简单的 js 引擎，作为我们编译原理学习的一个练习。 设计js 引擎，实际上是一个编译器，编译器分为前端和后端两个部分，前端的主要作用是将源代码编译成中间代码，她会包含词法分析和语法分析，而后端则是将中间代码优化并产生最终代码（如机器码）。 词法解析就是 tokenize，将">






  <link rel="canonical" href="https://akitaSummer.github.io/2022/05/17/编译原理实战——实现一个简单的js引擎/">



<script id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>编译原理实战——实现一个简单的js引擎 | Akita Summer's Blog</title>
  












  <noscript>
  <style>
  .use-motion .motion-element,
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-title { opacity: initial; }

  .use-motion .logo,
  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>


</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"><a href="https://github.com/akitaSummer" class="github-corner" aria-label="View source on GitHub"><svg width="80" height="80" viewbox="0 0 250 250" style="fill:#151513; color:#fff; position: absolute; top: 0; border: 0; right: 0;" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"/><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"/><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"/></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Akita Summer's Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="切换导航栏">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">

    
    
    
      
    

    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br>首页</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">

    
    
    
      
    

    

    <a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i> <br>标签</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-categories">

    
    
    
      
    

    

    <a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i> <br>分类</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">

    
    
    
      
    

    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br>归档</a>

  </li>

      
      
    </ul>
  

  

  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
            

          
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://akitaSummer.github.io/2022/05/17/编译原理实战——实现一个简单的js引擎/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Akita Summer">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/v2-e386393694cb08152bb316fa79bba113_hd.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Akita Summer's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">编译原理实战——实现一个简单的js引擎

              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2022-05-17 16:36:40" itemprop="dateCreated datePublished" datetime="2022-05-17T16:36:40+08:00">2022-05-17</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2023-11-12 03:06:31" itemprop="dateModified" datetime="2023-11-12T03:06:31+08:00">2023-11-12</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/学习笔记/" itemprop="url" rel="index"><span itemprop="name">学习笔记</span></a></span>

                
                
              
            </span>
          

          
            
            
              
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
            
                <a href="/2022/05/17/编译原理实战——实现一个简单的js引擎/#comments" itemprop="discussionUrl">
                  <span class="post-meta-item-text">评论数：</span> <span class="post-comments-count gitment-comments-count" data-xid="/2022/05/17/编译原理实战——实现一个简单的js引擎/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>之前我们实现了一个简单的浏览器，但是其中最为核心的 js 引擎，我们使用的是 v8，并没有自己实现，本次我们将会实现一个简单的 js 引擎，作为我们编译原理学习的一个练习。</p>
<h1 id="设计"><a href="#设计" class="headerlink" title="设计"></a>设计</h1><p>js 引擎，实际上是一个编译器，编译器分为前端和后端两个部分，前端的主要作用是将源代码编译成中间代码，她会包含词法分析和语法分析，而后端则是将中间代码优化并产生最终代码（如机器码）。</p>
<p>词法解析就是 tokenize，将源码切成一个个 token。语法分析就是要生成中间码，比如 ast。</p>
<p>后端一般会做一下中间代码优化，比如对常量替换，中间内联，死代码提出等等，这是工业级编译器中最难，最重要的部分，不过我们只是实现一个编译器，这个部分我们并不会去编写。</p>
<p>最后就是代码生成，我们这次会设计一个 vm，我们最终代码就是 vm 的字节码。</p>
<h1 id="词法解析"><a href="#词法解析" class="headerlink" title="词法解析"></a>词法解析</h1><h2 id="token-设计"><a href="#token-设计" class="headerlink" title="token 设计"></a>token 设计</h2><p>在第一步，我们需要先明确我们的 token，在这里我分为了两个部分，字面量（boolean, null…），Identifier(变量名、方法名、类名、参数名等)，Keyword 和 Symbol，首先我们先实现 Keyword 和 Symbol，由于他们在语法分析时会起到标志性作用，所以需要分别进行存储他们对应的映射，用于后续语法分析时查找优化：</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// 参考[acorn](https://github.com/acornjs/acorn/blob/master/acorn/src/tokentype.js)</span></span><br><span class="line"><span class="comment">// 通过为每种标记类型附加一个 beforeExpr 属性，来指示在这些标记之后的斜杠是否应该被视为正则表达式的开始。如果它们的 beforeExpr 属性的值为 true，那么在词法分析阶段，它可以遵循正则表达式的定义来生成正则表达式字面量标记。这个方法的目的是在词法分析阶段正确地处理JavaScript正则表达式，确保正则表达式的语法与整个JavaScript语法相协调。</span></span><br><span class="line"><span class="comment">// 生成4个集合，分别是name set, key:name map, name:key map, key set, 用于关键词</span></span><br><span class="line"><span class="built_in">macro_rules!</span> gen_map &#123;</span><br><span class="line">    ($($k:expr =&gt; $v:expr, $<span class="keyword">be</span>:expr)*) =&gt; &#123;</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut</span> s = HashSet::new();</span><br><span class="line">        $(</span><br><span class="line">          s.insert($v);</span><br><span class="line">        )*</span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut</span> kv = HashMap::new();</span><br><span class="line">        $(</span><br><span class="line">          kv.insert($k, $v);</span><br><span class="line">        )*</span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut</span> vk = HashMap::new();</span><br><span class="line">        $(</span><br><span class="line">          vk.insert($v, $k);</span><br><span class="line">        )*</span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut</span> <span class="keyword">be</span> = HashSet::new();</span><br><span class="line">        $(</span><br><span class="line">          <span class="keyword">be</span>.insert($k);</span><br><span class="line">        )*</span><br><span class="line">        (<span class="literal">Some</span>(s), <span class="literal">Some</span>(kv), <span class="literal">Some</span>(vk), <span class="literal">Some</span>(<span class="keyword">be</span>))</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[derive(Debug, Eq, PartialEq, Hash, Copy, Clone)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">enum</span> <span class="title">Keyword</span></span> &#123;</span><br><span class="line">    Break,</span><br><span class="line">    Do,</span><br><span class="line">    Instanceof,</span><br><span class="line">    Typeof,</span><br><span class="line">    Case,</span><br><span class="line">    Else,</span><br><span class="line">    New,</span><br><span class="line">    Var,</span><br><span class="line">    Catch,</span><br><span class="line">    Finally,</span><br><span class="line">    Return,</span><br><span class="line">    Void,</span><br><span class="line">    Continue,</span><br><span class="line">    For,</span><br><span class="line">    Switch,</span><br><span class="line">    While,</span><br><span class="line">    Debugger,</span><br><span class="line">    Function,</span><br><span class="line">    This,</span><br><span class="line">    With,</span><br><span class="line">    <span class="built_in">Default</span>,</span><br><span class="line">    If,</span><br><span class="line">    Throw,</span><br><span class="line">    Delete,</span><br><span class="line">    In,</span><br><span class="line">    Try,</span><br><span class="line">    <span class="comment">// 暂不支持</span></span><br><span class="line">    Class,</span><br><span class="line">    Enum,</span><br><span class="line">    Extends,</span><br><span class="line">    Super,</span><br><span class="line">    Const,</span><br><span class="line">    Export,</span><br><span class="line">    Import,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">mut</span> KEYWORDS_SET: <span class="built_in">Option</span>&lt;HashSet&lt;&amp;<span class="symbol">'static</span> <span class="built_in">str</span>&gt;&gt; = <span class="literal">None</span>;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">mut</span> KEYWORDS_KEY_NAME: <span class="built_in">Option</span>&lt;HashMap&lt;Keyword, &amp;<span class="symbol">'static</span> <span class="built_in">str</span>&gt;&gt; = <span class="literal">None</span>;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">mut</span> KEYWORDS_NAME_KEY: <span class="built_in">Option</span>&lt;HashMap&lt;&amp;<span class="symbol">'static</span> <span class="built_in">str</span>, Keyword&gt;&gt; = <span class="literal">None</span>;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">mut</span> KEYWORDS_BEFORE_EXPR_SET: <span class="built_in">Option</span>&lt;HashSet&lt;Keyword&gt;&gt; = <span class="literal">None</span>;</span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">init_keywords</span></span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> (s, kv, vk, <span class="keyword">be</span>) = gen_map! &#123;</span><br><span class="line">      Keyword::Break =&gt; <span class="string">"break"</span>, <span class="literal">false</span></span><br><span class="line">      Keyword::Do =&gt; <span class="string">"do"</span>, <span class="literal">true</span></span><br><span class="line">      Keyword::Instanceof =&gt; <span class="string">"instanceof"</span>, <span class="literal">true</span></span><br><span class="line">      Keyword::Typeof =&gt; <span class="string">"typeof"</span>, <span class="literal">true</span></span><br><span class="line">      Keyword::Case =&gt; <span class="string">"case"</span>, <span class="literal">true</span></span><br><span class="line">      Keyword::Else =&gt; <span class="string">"else"</span>, <span class="literal">true</span></span><br><span class="line">      Keyword::New =&gt; <span class="string">"new"</span>, <span class="literal">true</span></span><br><span class="line">      Keyword::Var =&gt; <span class="string">"var"</span>, <span class="literal">false</span></span><br><span class="line">      Keyword::Catch =&gt; <span class="string">"catch"</span>, <span class="literal">false</span></span><br><span class="line">      Keyword::Finally =&gt; <span class="string">"finally"</span>, <span class="literal">false</span></span><br><span class="line">      Keyword::Return =&gt; <span class="string">"return"</span>, <span class="literal">true</span></span><br><span class="line">      Keyword::Void =&gt; <span class="string">"void"</span>, <span class="literal">true</span></span><br><span class="line">      Keyword::Continue =&gt; <span class="string">"continue"</span>, <span class="literal">false</span></span><br><span class="line">      Keyword::For =&gt; <span class="string">"for"</span>, <span class="literal">false</span></span><br><span class="line">      Keyword::Switch =&gt; <span class="string">"switch"</span>, <span class="literal">false</span></span><br><span class="line">      Keyword::While =&gt; <span class="string">"while"</span>, <span class="literal">false</span></span><br><span class="line">      Keyword::Debugger =&gt; <span class="string">"debugger"</span>, <span class="literal">false</span></span><br><span class="line">      Keyword::Function =&gt; <span class="string">"function"</span>, <span class="literal">false</span></span><br><span class="line">      Keyword::This =&gt; <span class="string">"this"</span>, <span class="literal">false</span></span><br><span class="line">      Keyword::With =&gt; <span class="string">"with"</span>, <span class="literal">false</span></span><br><span class="line">      Keyword::<span class="built_in">Default</span> =&gt; <span class="string">"default"</span>, <span class="literal">true</span></span><br><span class="line">      Keyword::If =&gt; <span class="string">"if"</span>, <span class="literal">false</span></span><br><span class="line">      Keyword::Throw =&gt; <span class="string">"throw"</span>, <span class="literal">true</span></span><br><span class="line">      Keyword::Delete =&gt; <span class="string">"delete"</span>, <span class="literal">true</span></span><br><span class="line">      Keyword::In =&gt; <span class="string">"in"</span>, <span class="literal">true</span></span><br><span class="line">      Keyword::Try =&gt; <span class="string">"try"</span>, <span class="literal">false</span></span><br><span class="line">      <span class="comment">// future reserved words</span></span><br><span class="line">      Keyword::Class =&gt; <span class="string">"class"</span>, <span class="literal">false</span></span><br><span class="line">      Keyword::Enum =&gt; <span class="string">"enum"</span>, <span class="literal">false</span></span><br><span class="line">      Keyword::Extends =&gt; <span class="string">"extends"</span>, <span class="literal">true</span></span><br><span class="line">      Keyword::Super =&gt; <span class="string">"super"</span>, <span class="literal">false</span></span><br><span class="line">      Keyword::Const =&gt; <span class="string">"const"</span>, <span class="literal">false</span></span><br><span class="line">      Keyword::Export =&gt; <span class="string">"export"</span>, <span class="literal">false</span></span><br><span class="line">      Keyword::Import =&gt; <span class="string">"import"</span>, <span class="literal">false</span></span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">unsafe</span> &#123;</span><br><span class="line">        KEYWORDS_SET = s;</span><br><span class="line">        KEYWORDS_KEY_NAME = kv;</span><br><span class="line">        KEYWORDS_NAME_KEY = vk;</span><br><span class="line">        KEYWORDS_BEFORE_EXPR_SET = <span class="keyword">be</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">is_keyword</span></span>(s: &amp;<span class="built_in">str</span>) -&gt; <span class="built_in">bool</span> &#123;</span><br><span class="line">    <span class="keyword">unsafe</span> &#123; KEYWORDS_SET.as_ref().unwrap().contains(s) &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">keyword_to_name</span></span>(v: &amp;Keyword) -&gt; &amp;<span class="symbol">'static</span> <span class="built_in">str</span> &#123;</span><br><span class="line">    <span class="keyword">unsafe</span> &#123; KEYWORDS_KEY_NAME.as_ref().unwrap().get(v).unwrap() &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">name_to_keyword</span></span>(s: &amp;<span class="built_in">str</span>) -&gt; Keyword &#123;</span><br><span class="line">    <span class="keyword">unsafe</span> &#123;</span><br><span class="line">        KEYWORDS_NAME_KEY</span><br><span class="line">            .as_ref()</span><br><span class="line">            .unwrap()</span><br><span class="line">            .get(s)</span><br><span class="line">            .unwrap()</span><br><span class="line">            .to_owned()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">impl</span> Keyword &#123;</span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">name</span></span>(&amp;<span class="keyword">self</span>) -&gt; &amp;<span class="symbol">'static</span> <span class="built_in">str</span> &#123;</span><br><span class="line">        keyword_to_name(<span class="keyword">self</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">is_before_expr</span></span>(&amp;<span class="keyword">self</span>) -&gt; <span class="built_in">bool</span> &#123;</span><br><span class="line">        <span class="keyword">unsafe</span> &#123; KEYWORDS_BEFORE_EXPR_SET.as_ref().unwrap().contains(<span class="keyword">self</span>) &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#[derive(Debug, Eq, PartialEq, Hash, Copy, Clone)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">enum</span> <span class="title">Symbol</span></span> &#123;</span><br><span class="line">    BraceL,</span><br><span class="line">    BraceR,</span><br><span class="line">    ParenL,</span><br><span class="line">    ParenR,</span><br><span class="line">    BracketL,</span><br><span class="line">    BracketR,</span><br><span class="line">    Dot,</span><br><span class="line">    Semi,</span><br><span class="line">    Comma,</span><br><span class="line">    BinOpStart,</span><br><span class="line">    LT,</span><br><span class="line">    GT,</span><br><span class="line">    LE,</span><br><span class="line">    GE,</span><br><span class="line">    <span class="built_in">Eq</span>,</span><br><span class="line">    NotEq,</span><br><span class="line">    EqStrict,</span><br><span class="line">    NotEqStrict,</span><br><span class="line">    Add,</span><br><span class="line">    Sub,</span><br><span class="line">    Mul,</span><br><span class="line">    Div,</span><br><span class="line">    Mod,</span><br><span class="line">    Inc,</span><br><span class="line">    Dec,</span><br><span class="line">    SHL,</span><br><span class="line">    SAR,</span><br><span class="line">    SHR,</span><br><span class="line">    BitAnd,</span><br><span class="line">    BitOr,</span><br><span class="line">    BitXor,</span><br><span class="line">    Not,</span><br><span class="line">    BitNot,</span><br><span class="line">    And,</span><br><span class="line">    Or,</span><br><span class="line">    BinOpEnd,</span><br><span class="line">    Conditional,</span><br><span class="line">    Colon,</span><br><span class="line">    AssignStart,</span><br><span class="line">    Assign,</span><br><span class="line">    AssignAdd,</span><br><span class="line">    AssignSub,</span><br><span class="line">    AssignMul,</span><br><span class="line">    AssignDiv,</span><br><span class="line">    AssignMod,</span><br><span class="line">    AssignSHL,</span><br><span class="line">    AssignSAR,</span><br><span class="line">    AssignSHR,</span><br><span class="line">    AssignBitAnd,</span><br><span class="line">    AssignBitOr,</span><br><span class="line">    AssignBitXor,</span><br><span class="line">    AssignEnd,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">mut</span> SYMBOLS_SET: <span class="built_in">Option</span>&lt;HashSet&lt;&amp;<span class="symbol">'static</span> <span class="built_in">str</span>&gt;&gt; = <span class="literal">None</span>;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">mut</span> SYMBOLS_KEY_NAME: <span class="built_in">Option</span>&lt;HashMap&lt;Symbol, &amp;<span class="symbol">'static</span> <span class="built_in">str</span>&gt;&gt; = <span class="literal">None</span>;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">mut</span> SYMBOLS_NAME_KEY: <span class="built_in">Option</span>&lt;HashMap&lt;&amp;<span class="symbol">'static</span> <span class="built_in">str</span>, Symbol&gt;&gt; = <span class="literal">None</span>;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">mut</span> SYMBOLS_BEFORE_EXPR_SET: <span class="built_in">Option</span>&lt;HashSet&lt;Symbol&gt;&gt; = <span class="literal">None</span>;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">mut</span> SYMBOLS_KEY_PRECEDENCE: <span class="built_in">Option</span>&lt;HashMap&lt;Symbol, <span class="built_in">i32</span>&gt;&gt; = <span class="literal">None</span>;</span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">init_symbols</span></span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> (s, kv, vk, <span class="keyword">be</span>, pcd) = gen_map_syb! &#123;</span><br><span class="line">      Symbol::BraceL =&gt; <span class="string">"&#123;"</span>, <span class="literal">true</span>, <span class="number">0</span></span><br><span class="line">      Symbol::BraceR =&gt; <span class="string">"&#125;"</span>, <span class="literal">false</span>, <span class="number">0</span></span><br><span class="line">      Symbol::ParenL =&gt; <span class="string">"("</span>, <span class="literal">true</span>, <span class="number">20</span></span><br><span class="line">      Symbol::ParenR =&gt; <span class="string">")"</span>, <span class="literal">false</span>, <span class="number">0</span></span><br><span class="line">      Symbol::BracketL =&gt; <span class="string">"["</span>, <span class="literal">true</span>, <span class="number">19</span></span><br><span class="line">      Symbol::BracketR =&gt; <span class="string">"]"</span>, <span class="literal">false</span>, <span class="number">0</span></span><br><span class="line">      Symbol::Dot =&gt; <span class="string">"."</span>, <span class="literal">true</span>, <span class="number">19</span></span><br><span class="line">      Symbol::Semi =&gt; <span class="string">";"</span>, <span class="literal">true</span>, <span class="number">0</span></span><br><span class="line">      Symbol::Comma =&gt; <span class="string">","</span>, <span class="literal">true</span>, <span class="number">1</span></span><br><span class="line">      Symbol::LT =&gt; <span class="string">"&lt;"</span>, <span class="literal">true</span>, <span class="number">11</span></span><br><span class="line">      Symbol::GT =&gt; <span class="string">"&gt;"</span>, <span class="literal">true</span>, <span class="number">11</span></span><br><span class="line">      Symbol::LE =&gt; <span class="string">"&lt;="</span>, <span class="literal">true</span>, <span class="number">11</span></span><br><span class="line">      Symbol::GE =&gt; <span class="string">"&gt;="</span>, <span class="literal">true</span>, <span class="number">11</span></span><br><span class="line">      Symbol::<span class="built_in">Eq</span> =&gt; <span class="string">"=="</span>, <span class="literal">true</span>, <span class="number">10</span></span><br><span class="line">      Symbol::NotEq =&gt; <span class="string">"!="</span>, <span class="literal">true</span>, <span class="number">10</span></span><br><span class="line">      Symbol::EqStrict =&gt; <span class="string">"==="</span>, <span class="literal">true</span>, <span class="number">10</span></span><br><span class="line">      Symbol::NotEqStrict =&gt; <span class="string">"!=="</span>, <span class="literal">true</span>, <span class="number">10</span></span><br><span class="line">      Symbol::Add =&gt; <span class="string">"+"</span>, <span class="literal">true</span>, <span class="number">13</span></span><br><span class="line">      Symbol::Sub =&gt; <span class="string">"-"</span>, <span class="literal">true</span>, <span class="number">13</span></span><br><span class="line">      Symbol::Mul =&gt; <span class="string">"*"</span>, <span class="literal">true</span>, <span class="number">14</span></span><br><span class="line">      Symbol::Div =&gt; <span class="string">"/"</span>, <span class="literal">true</span>, <span class="number">14</span></span><br><span class="line">      Symbol::Mod =&gt; <span class="string">"%"</span>, <span class="literal">true</span>, <span class="number">14</span></span><br><span class="line">      Symbol::Inc =&gt; <span class="string">"++"</span>, <span class="literal">false</span>, <span class="number">16</span></span><br><span class="line">      Symbol::Dec =&gt; <span class="string">"--"</span>, <span class="literal">false</span>, <span class="number">16</span></span><br><span class="line">      Symbol::SHL =&gt; <span class="string">"&lt;&lt;"</span>, <span class="literal">true</span>, <span class="number">12</span></span><br><span class="line">      Symbol::SAR =&gt; <span class="string">"&gt;&gt;"</span>, <span class="literal">true</span>, <span class="number">12</span></span><br><span class="line">      Symbol::SHR =&gt; <span class="string">"&gt;&gt;&gt;"</span>, <span class="literal">true</span>, <span class="number">12</span></span><br><span class="line">      Symbol::BitAnd =&gt; <span class="string">"&amp;"</span>, <span class="literal">true</span>, <span class="number">9</span></span><br><span class="line">      Symbol::BitOr =&gt; <span class="string">"|"</span>, <span class="literal">true</span>, <span class="number">7</span></span><br><span class="line">      Symbol::BitXor =&gt; <span class="string">"^"</span>, <span class="literal">true</span>, <span class="number">8</span></span><br><span class="line">      Symbol::Not =&gt; <span class="string">"!"</span>, <span class="literal">true</span>, <span class="number">16</span></span><br><span class="line">      Symbol::BitNot =&gt; <span class="string">"~"</span>, <span class="literal">true</span>, <span class="number">16</span></span><br><span class="line">      Symbol::And =&gt; <span class="string">"&amp;&amp;"</span>, <span class="literal">true</span>, <span class="number">6</span></span><br><span class="line">      Symbol::Or =&gt; <span class="string">"||"</span>, <span class="literal">true</span>, <span class="number">5</span></span><br><span class="line">      Symbol::Conditional =&gt; <span class="string">"?"</span>, <span class="literal">true</span>, <span class="number">4</span></span><br><span class="line">      Symbol::Colon =&gt; <span class="string">":"</span>, <span class="literal">true</span>, <span class="number">4</span></span><br><span class="line">      Symbol::Assign =&gt; <span class="string">"="</span>, <span class="literal">true</span>, <span class="number">3</span></span><br><span class="line">      Symbol::AssignAdd =&gt; <span class="string">"+="</span>, <span class="literal">true</span>, <span class="number">3</span></span><br><span class="line">      Symbol::AssignSub =&gt; <span class="string">"-="</span>, <span class="literal">true</span>, <span class="number">3</span></span><br><span class="line">      Symbol::AssignMul =&gt; <span class="string">"*="</span>, <span class="literal">true</span>, <span class="number">3</span></span><br><span class="line">      Symbol::AssignDiv =&gt; <span class="string">"/="</span>, <span class="literal">true</span>, <span class="number">3</span></span><br><span class="line">      Symbol::AssignMod =&gt; <span class="string">"%="</span>, <span class="literal">true</span>, <span class="number">3</span></span><br><span class="line">      Symbol::AssignSHL =&gt; <span class="string">"&lt;&lt;="</span>, <span class="literal">true</span>, <span class="number">3</span></span><br><span class="line">      Symbol::AssignSAR =&gt; <span class="string">"&gt;&gt;="</span>, <span class="literal">true</span>, <span class="number">3</span></span><br><span class="line">      Symbol::AssignSHR =&gt; <span class="string">"&gt;&gt;&gt;="</span>, <span class="literal">true</span>, <span class="number">3</span></span><br><span class="line">      Symbol::AssignBitAnd =&gt; <span class="string">"&amp;="</span>, <span class="literal">true</span>, <span class="number">3</span></span><br><span class="line">      Symbol::AssignBitOr =&gt; <span class="string">"|="</span>, <span class="literal">true</span>, <span class="number">3</span></span><br><span class="line">      Symbol::AssignBitXor =&gt; <span class="string">"^="</span>, <span class="literal">true</span>, <span class="number">3</span></span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">unsafe</span> &#123;</span><br><span class="line">        SYMBOLS_SET = s;</span><br><span class="line">        SYMBOLS_KEY_NAME = kv;</span><br><span class="line">        SYMBOLS_NAME_KEY = vk;</span><br><span class="line">        SYMBOLS_BEFORE_EXPR_SET = <span class="keyword">be</span>;</span><br><span class="line">        SYMBOLS_KEY_PRECEDENCE = pcd;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">is_symbol</span></span>(s: &amp;<span class="built_in">str</span>) -&gt; <span class="built_in">bool</span> &#123;</span><br><span class="line">    <span class="keyword">unsafe</span> &#123; SYMBOLS_SET.as_ref().unwrap().contains(s) &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">symbol_to_name</span></span>(v: &amp;Symbol) -&gt; &amp;<span class="symbol">'static</span> <span class="built_in">str</span> &#123;</span><br><span class="line">    <span class="keyword">unsafe</span> &#123; SYMBOLS_KEY_NAME.as_ref().unwrap().get(v).unwrap() &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">symbol_pcd</span></span>(v: &amp;Symbol) -&gt; <span class="built_in">i32</span> &#123;</span><br><span class="line">    <span class="keyword">unsafe</span> &#123;</span><br><span class="line">        SYMBOLS_KEY_PRECEDENCE</span><br><span class="line">            .as_ref()</span><br><span class="line">            .unwrap()</span><br><span class="line">            .get(v)</span><br><span class="line">            .unwrap()</span><br><span class="line">            .to_owned()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">name_to_symbol</span></span>(s: &amp;<span class="built_in">str</span>) -&gt; Symbol &#123;</span><br><span class="line">    <span class="keyword">unsafe</span> &#123;</span><br><span class="line">        SYMBOLS_NAME_KEY</span><br><span class="line">            .as_ref()</span><br><span class="line">            .unwrap()</span><br><span class="line">            .get(s)</span><br><span class="line">            .unwrap()</span><br><span class="line">            .to_owned()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">impl</span> Symbol &#123;</span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">name</span></span>(&amp;<span class="keyword">self</span>) -&gt; &amp;<span class="symbol">'static</span> <span class="built_in">str</span> &#123;</span><br><span class="line">        symbol_to_name(<span class="keyword">self</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">is_before_expr</span></span>(&amp;<span class="keyword">self</span>) -&gt; <span class="built_in">bool</span> &#123;</span><br><span class="line">        <span class="keyword">unsafe</span> &#123; SYMBOLS_BEFORE_EXPR_SET.as_ref().unwrap().contains(<span class="keyword">self</span>) &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#[derive(Debug, Copy, Clone)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">struct</span> <span class="title">Position</span></span> &#123;</span><br><span class="line">    <span class="keyword">pub</span> line: <span class="built_in">i32</span>,</span><br><span class="line">    <span class="keyword">pub</span> column: <span class="built_in">i32</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> Position &#123;</span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">new</span></span>() -&gt; Position &#123;</span><br><span class="line">        Position &#123; line: <span class="number">0</span>, column: <span class="number">0</span> &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[derive(Debug, Copy, Clone)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">struct</span> <span class="title">SourceLoc</span></span> &#123;</span><br><span class="line">    <span class="keyword">pub</span> start: Position,</span><br><span class="line">    <span class="keyword">pub</span> end: Position,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> SourceLoc &#123;</span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">new</span></span>() -&gt; <span class="keyword">Self</span> &#123;</span><br><span class="line">        SourceLoc &#123;</span><br><span class="line">            start: Position::new(),</span><br><span class="line">            end: Position::new(),</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[derive(Debug, Copy, Clone)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">struct</span> <span class="title">KeywordData</span></span> &#123;</span><br><span class="line">    <span class="keyword">pub</span> kind: Keyword,</span><br><span class="line">    <span class="keyword">pub</span> loc: SourceLoc,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[derive(Debug, Clone)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">struct</span> <span class="title">SymbolData</span></span> &#123;</span><br><span class="line">    <span class="keyword">pub</span> kind: Symbol,</span><br><span class="line">    <span class="keyword">pub</span> loc: SourceLoc,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>接下来是字面量（boolean, null…）和 Identifier，他们就比较简单：</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// 标识符(变量名、方法名、类名、参数名等)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#[derive(Debug, Clone)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">struct</span> <span class="title">IdentifierData</span></span> &#123;</span><br><span class="line">    <span class="keyword">pub</span> value: <span class="built_in">String</span>,</span><br><span class="line">    <span class="keyword">pub</span> loc: SourceLoc,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 字面量，用于描述不同数据类型的值</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#[derive(Debug, Clone)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">struct</span> <span class="title">NullLiteralData</span></span> &#123;</span><br><span class="line">    <span class="keyword">pub</span> loc: SourceLoc,</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">is_null</span></span>(s: &amp;<span class="built_in">str</span>) -&gt; <span class="built_in">bool</span> &#123;</span><br><span class="line">    s == <span class="string">"null"</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[derive(Debug, Eq, PartialEq, Clone)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">enum</span> <span class="title">BooleanLiteral</span></span> &#123;</span><br><span class="line">    True,</span><br><span class="line">    False,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[derive(Debug, Clone)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">struct</span> <span class="title">BooleanLiteralData</span></span> &#123;</span><br><span class="line">    <span class="keyword">pub</span> kind: BooleanLiteral,</span><br><span class="line">    <span class="keyword">pub</span> loc: SourceLoc,</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">is_bool</span></span>(s: &amp;<span class="built_in">str</span>) -&gt; <span class="built_in">bool</span> &#123;</span><br><span class="line">    s == <span class="string">"true"</span> || s == <span class="string">"false"</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">name_to_bool</span></span>(s: &amp;<span class="built_in">str</span>) -&gt; BooleanLiteral &#123;</span><br><span class="line">    <span class="keyword">match</span> s &#123;</span><br><span class="line">        <span class="string">"true"</span> =&gt; BooleanLiteral::True,</span><br><span class="line">        <span class="string">"false"</span> =&gt; BooleanLiteral::False,</span><br><span class="line">        _ =&gt; <span class="built_in">panic!</span>(),</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">impl</span> BooleanLiteral &#123;</span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">name</span></span>(&amp;<span class="keyword">self</span>) -&gt; &amp;<span class="symbol">'static</span> <span class="built_in">str</span> &#123;</span><br><span class="line">        <span class="keyword">match</span> <span class="keyword">self</span> &#123;</span><br><span class="line">            BooleanLiteral::True =&gt; <span class="string">"true"</span>,</span><br><span class="line">            BooleanLiteral::False =&gt; <span class="string">"false"</span>,</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[derive(Debug, Clone)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">struct</span> <span class="title">StringLiteralData</span></span> &#123;</span><br><span class="line">    <span class="keyword">pub</span> value: <span class="built_in">String</span>,</span><br><span class="line">    <span class="keyword">pub</span> loc: SourceLoc,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[derive(Debug, Clone)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">struct</span> <span class="title">NumericLiteralData</span></span> &#123;</span><br><span class="line">    <span class="keyword">pub</span> value: <span class="built_in">String</span>,</span><br><span class="line">    <span class="keyword">pub</span> loc: SourceLoc,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[derive(Debug, Clone)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">struct</span> <span class="title">RegExpLiteralData</span></span> &#123;</span><br><span class="line">    <span class="keyword">pub</span> value: <span class="built_in">String</span>,</span><br><span class="line">    <span class="keyword">pub</span> loc: SourceLoc,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[derive(Debug, Clone)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">struct</span> <span class="title">EofData</span></span> &#123;</span><br><span class="line">    <span class="keyword">pub</span> loc: SourceLoc,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>最后我们定义我们的 token：</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// token</span></span><br><span class="line"><span class="meta">#[derive(Debug, Clone)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">enum</span> <span class="title">Token</span></span> &#123;</span><br><span class="line">    Keyword(KeywordData),</span><br><span class="line">    Symbol(SymbolData),</span><br><span class="line">    ContextualKeyword(CtxKeywordData),</span><br><span class="line">    Identifier(IdentifierData),</span><br><span class="line">    NullLiteral(NullLiteralData),</span><br><span class="line">    BooleanLiteral(BooleanLiteralData),</span><br><span class="line">    StringLiteral(StringLiteralData),</span><br><span class="line">    NumericLiteral(NumericLiteralData),</span><br><span class="line">    RegExpLiteral(RegExpLiteralData),</span><br><span class="line">    Eof(EofData),</span><br><span class="line">    Nil,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> Token &#123;</span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">is_keyword</span></span>(&amp;<span class="keyword">self</span>) -&gt; <span class="built_in">bool</span> &#123;</span><br><span class="line">        <span class="keyword">match</span> <span class="keyword">self</span> &#123;</span><br><span class="line">            Token::Keyword(_) =&gt; <span class="literal">true</span>,</span><br><span class="line">            _ =&gt; <span class="literal">false</span>,</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">is_keyword_kind</span></span>(&amp;<span class="keyword">self</span>, k: Keyword) -&gt; <span class="built_in">bool</span> &#123;</span><br><span class="line">        <span class="keyword">match</span> <span class="keyword">self</span> &#123;</span><br><span class="line">            Token::Keyword(data) =&gt; data.kind == k,</span><br><span class="line">            _ =&gt; <span class="literal">false</span>,</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">is_keyword_kind_in</span></span>(&amp;<span class="keyword">self</span>, ks: &amp;<span class="built_in">Vec</span>&lt;Keyword&gt;) -&gt; <span class="built_in">bool</span> &#123;</span><br><span class="line">        <span class="keyword">match</span> <span class="keyword">self</span> &#123;</span><br><span class="line">            Token::Keyword(d) =&gt; ks.contains(&amp;d.kind),</span><br><span class="line">            _ =&gt; <span class="literal">false</span>,</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">is_keyword_bin</span></span>(&amp;<span class="keyword">self</span>, not_in: <span class="built_in">bool</span>) -&gt; <span class="built_in">bool</span> &#123;</span><br><span class="line">        <span class="keyword">match</span> <span class="keyword">self</span> &#123;</span><br><span class="line">            Token::Keyword(d) =&gt; !not_in &amp;&amp; d.kind == Keyword::In,</span><br><span class="line">            _ =&gt; <span class="literal">false</span>,</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">keyword_pcd</span></span>(&amp;<span class="keyword">self</span>) -&gt; <span class="built_in">i32</span> &#123;</span><br><span class="line">        <span class="keyword">match</span> <span class="keyword">self</span> &#123;</span><br><span class="line">            Token::Keyword(d) =&gt; <span class="keyword">match</span> d.kind &#123;</span><br><span class="line">                Keyword::In =&gt; <span class="number">11</span>,</span><br><span class="line">                _ =&gt; -<span class="number">1</span>,</span><br><span class="line">            &#125;,</span><br><span class="line">            _ =&gt; -<span class="number">1</span>,</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">keyword_data</span></span>(&amp;<span class="keyword">self</span>) -&gt; &amp;KeywordData &#123;</span><br><span class="line">        <span class="keyword">match</span> <span class="keyword">self</span> &#123;</span><br><span class="line">            Token::Keyword(data) =&gt; data,</span><br><span class="line">            _ =&gt; <span class="built_in">panic!</span>(),</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">is_symbol</span></span>(&amp;<span class="keyword">self</span>) -&gt; <span class="built_in">bool</span> &#123;</span><br><span class="line">        <span class="keyword">match</span> <span class="keyword">self</span> &#123;</span><br><span class="line">            Token::Symbol(_) =&gt; <span class="literal">true</span>,</span><br><span class="line">            _ =&gt; <span class="literal">false</span>,</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">symbol_pcd</span></span>(&amp;<span class="keyword">self</span>) -&gt; <span class="built_in">i32</span> &#123;</span><br><span class="line">        <span class="keyword">match</span> <span class="keyword">self</span> &#123;</span><br><span class="line">            Token::Symbol(s) =&gt; symbol_pcd(&amp;s.kind),</span><br><span class="line">            _ =&gt; <span class="built_in">panic!</span>(),</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">is_symbol_bin</span></span>(&amp;<span class="keyword">self</span>) -&gt; <span class="built_in">bool</span> &#123;</span><br><span class="line">        <span class="keyword">match</span> <span class="keyword">self</span> &#123;</span><br><span class="line">            Token::Symbol(s) =&gt; &#123;</span><br><span class="line">                <span class="keyword">let</span> s = s.kind <span class="keyword">as</span> <span class="built_in">i32</span>;</span><br><span class="line">                <span class="keyword">let</span> start = Symbol::BinOpStart <span class="keyword">as</span> <span class="built_in">i32</span>;</span><br><span class="line">                <span class="keyword">let</span> end = Symbol::BinOpEnd <span class="keyword">as</span> <span class="built_in">i32</span>;</span><br><span class="line">                s &gt; start &amp;&amp; s &lt; end</span><br><span class="line">            &#125;</span><br><span class="line">            _ =&gt; <span class="literal">false</span>,</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">is_symbol_assign</span></span>(&amp;<span class="keyword">self</span>) -&gt; <span class="built_in">bool</span> &#123;</span><br><span class="line">        <span class="keyword">match</span> <span class="keyword">self</span> &#123;</span><br><span class="line">            Token::Symbol(s) =&gt; &#123;</span><br><span class="line">                <span class="keyword">let</span> s = s.kind <span class="keyword">as</span> <span class="built_in">i32</span>;</span><br><span class="line">                <span class="keyword">let</span> start = Symbol::AssignStart <span class="keyword">as</span> <span class="built_in">i32</span>;</span><br><span class="line">                <span class="keyword">let</span> end = Symbol::AssignEnd <span class="keyword">as</span> <span class="built_in">i32</span>;</span><br><span class="line">                s &gt; start &amp;&amp; s &lt; end</span><br><span class="line">            &#125;</span><br><span class="line">            _ =&gt; <span class="literal">false</span>,</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">is_symbol_kind</span></span>(&amp;<span class="keyword">self</span>, k: Symbol) -&gt; <span class="built_in">bool</span> &#123;</span><br><span class="line">        <span class="keyword">match</span> <span class="keyword">self</span> &#123;</span><br><span class="line">            Token::Symbol(s) =&gt; s.kind == k,</span><br><span class="line">            _ =&gt; <span class="literal">false</span>,</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">is_symbol_kind_in</span></span>(&amp;<span class="keyword">self</span>, ks: &amp;<span class="built_in">Vec</span>&lt;Symbol&gt;) -&gt; <span class="built_in">bool</span> &#123;</span><br><span class="line">        <span class="keyword">match</span> <span class="keyword">self</span> &#123;</span><br><span class="line">            Token::Symbol(d) =&gt; ks.contains(&amp;d.kind),</span><br><span class="line">            _ =&gt; <span class="literal">false</span>,</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">symbol_data</span></span>(&amp;<span class="keyword">self</span>) -&gt; &amp;SymbolData &#123;</span><br><span class="line">        <span class="keyword">match</span> <span class="keyword">self</span> &#123;</span><br><span class="line">            Token::Symbol(data) =&gt; data,</span><br><span class="line">            _ =&gt; <span class="built_in">panic!</span>(),</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">is_ctx_keyword</span></span>(&amp;<span class="keyword">self</span>) -&gt; <span class="built_in">bool</span> &#123;</span><br><span class="line">        <span class="keyword">match</span> <span class="keyword">self</span> &#123;</span><br><span class="line">            Token::ContextualKeyword(_) =&gt; <span class="literal">true</span>,</span><br><span class="line">            _ =&gt; <span class="literal">false</span>,</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">ctx_keyword_data</span></span>(&amp;<span class="keyword">self</span>) -&gt; &amp;CtxKeywordData &#123;</span><br><span class="line">        <span class="keyword">match</span> <span class="keyword">self</span> &#123;</span><br><span class="line">            Token::ContextualKeyword(data) =&gt; data,</span><br><span class="line">            _ =&gt; <span class="built_in">panic!</span>(),</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">is_id</span></span>(&amp;<span class="keyword">self</span>) -&gt; <span class="built_in">bool</span> &#123;</span><br><span class="line">        <span class="keyword">match</span> <span class="keyword">self</span> &#123;</span><br><span class="line">            Token::Identifier(v) =&gt; !v.value.eq(<span class="string">"undefined"</span>),</span><br><span class="line">            _ =&gt; <span class="literal">false</span>,</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">id_data</span></span>(&amp;<span class="keyword">self</span>) -&gt; &amp;IdentifierData &#123;</span><br><span class="line">        <span class="keyword">match</span> <span class="keyword">self</span> &#123;</span><br><span class="line">            Token::Identifier(data) =&gt; data,</span><br><span class="line">            _ =&gt; <span class="built_in">panic!</span>(),</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">is_undef</span></span>(&amp;<span class="keyword">self</span>) -&gt; <span class="built_in">bool</span> &#123;</span><br><span class="line">        <span class="keyword">match</span> <span class="keyword">self</span> &#123;</span><br><span class="line">            Token::Identifier(v) =&gt; v.value.eq(<span class="string">"undefined"</span>),</span><br><span class="line">            _ =&gt; <span class="literal">false</span>,</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">undef_data</span></span>(&amp;<span class="keyword">self</span>) -&gt; &amp;IdentifierData &#123;</span><br><span class="line">        <span class="keyword">match</span> <span class="keyword">self</span> &#123;</span><br><span class="line">            Token::Identifier(data) =&gt; data,</span><br><span class="line">            _ =&gt; <span class="built_in">panic!</span>(),</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">is_null</span></span>(&amp;<span class="keyword">self</span>) -&gt; <span class="built_in">bool</span> &#123;</span><br><span class="line">        <span class="keyword">match</span> <span class="keyword">self</span> &#123;</span><br><span class="line">            Token::NullLiteral(_) =&gt; <span class="literal">true</span>,</span><br><span class="line">            _ =&gt; <span class="literal">false</span>,</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">null_data</span></span>(&amp;<span class="keyword">self</span>) -&gt; &amp;NullLiteralData &#123;</span><br><span class="line">        <span class="keyword">match</span> <span class="keyword">self</span> &#123;</span><br><span class="line">            Token::NullLiteral(data) =&gt; data,</span><br><span class="line">            _ =&gt; <span class="built_in">panic!</span>(),</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">is_bool</span></span>(&amp;<span class="keyword">self</span>) -&gt; <span class="built_in">bool</span> &#123;</span><br><span class="line">        <span class="keyword">match</span> <span class="keyword">self</span> &#123;</span><br><span class="line">            Token::BooleanLiteral(_) =&gt; <span class="literal">true</span>,</span><br><span class="line">            _ =&gt; <span class="literal">false</span>,</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">bool_data</span></span>(&amp;<span class="keyword">self</span>) -&gt; &amp;BooleanLiteralData &#123;</span><br><span class="line">        <span class="keyword">match</span> <span class="keyword">self</span> &#123;</span><br><span class="line">            Token::BooleanLiteral(data) =&gt; data,</span><br><span class="line">            _ =&gt; <span class="built_in">panic!</span>(),</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">is_str</span></span>(&amp;<span class="keyword">self</span>) -&gt; <span class="built_in">bool</span> &#123;</span><br><span class="line">        <span class="keyword">match</span> <span class="keyword">self</span> &#123;</span><br><span class="line">            Token::StringLiteral(_) =&gt; <span class="literal">true</span>,</span><br><span class="line">            _ =&gt; <span class="literal">false</span>,</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">str_data</span></span>(&amp;<span class="keyword">self</span>) -&gt; &amp;StringLiteralData &#123;</span><br><span class="line">        <span class="keyword">match</span> <span class="keyword">self</span> &#123;</span><br><span class="line">            Token::StringLiteral(data) =&gt; data,</span><br><span class="line">            _ =&gt; <span class="built_in">panic!</span>(),</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">is_num</span></span>(&amp;<span class="keyword">self</span>) -&gt; <span class="built_in">bool</span> &#123;</span><br><span class="line">        <span class="keyword">match</span> <span class="keyword">self</span> &#123;</span><br><span class="line">            Token::NumericLiteral(_) =&gt; <span class="literal">true</span>,</span><br><span class="line">            _ =&gt; <span class="literal">false</span>,</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">num_data</span></span>(&amp;<span class="keyword">self</span>) -&gt; &amp;NumericLiteralData &#123;</span><br><span class="line">        <span class="keyword">match</span> <span class="keyword">self</span> &#123;</span><br><span class="line">            Token::NumericLiteral(data) =&gt; data,</span><br><span class="line">            _ =&gt; <span class="built_in">panic!</span>(),</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">is_regexp</span></span>(&amp;<span class="keyword">self</span>) -&gt; <span class="built_in">bool</span> &#123;</span><br><span class="line">        <span class="keyword">match</span> <span class="keyword">self</span> &#123;</span><br><span class="line">            Token::RegExpLiteral(_) =&gt; <span class="literal">true</span>,</span><br><span class="line">            _ =&gt; <span class="literal">false</span>,</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">regexp_data</span></span>(&amp;<span class="keyword">self</span>) -&gt; &amp;RegExpLiteralData &#123;</span><br><span class="line">        <span class="keyword">match</span> <span class="keyword">self</span> &#123;</span><br><span class="line">            Token::RegExpLiteral(data) =&gt; data,</span><br><span class="line">            _ =&gt; <span class="built_in">panic!</span>(),</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">is_before_expr</span></span>(&amp;<span class="keyword">self</span>) -&gt; <span class="built_in">bool</span> &#123;</span><br><span class="line">        <span class="keyword">match</span> <span class="keyword">self</span> &#123;</span><br><span class="line">            Token::Keyword(data) =&gt; data.kind.is_before_expr(),</span><br><span class="line">            Token::Symbol(data) =&gt; data.kind.is_before_expr(),</span><br><span class="line">            Token::ContextualKeyword(data) =&gt; data.kind.is_before_expr(),</span><br><span class="line">            _ =&gt; <span class="literal">false</span>,</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">is_eof</span></span>(&amp;<span class="keyword">self</span>) -&gt; <span class="built_in">bool</span> &#123;</span><br><span class="line">        <span class="keyword">match</span> <span class="keyword">self</span> &#123;</span><br><span class="line">            Token::Eof(_) =&gt; <span class="literal">true</span>,</span><br><span class="line">            _ =&gt; <span class="literal">false</span>,</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">loc</span></span>(&amp;<span class="keyword">self</span>) -&gt; &amp;SourceLoc &#123;</span><br><span class="line">        <span class="keyword">match</span> <span class="keyword">self</span> &#123;</span><br><span class="line">            Token::Keyword(data) =&gt; &amp;data.loc,</span><br><span class="line">            Token::Symbol(data) =&gt; &amp;data.loc,</span><br><span class="line">            Token::ContextualKeyword(data) =&gt; &amp;data.loc,</span><br><span class="line">            Token::Identifier(data) =&gt; &amp;data.loc,</span><br><span class="line">            Token::NullLiteral(data) =&gt; &amp;data.loc,</span><br><span class="line">            Token::BooleanLiteral(data) =&gt; &amp;data.loc,</span><br><span class="line">            Token::StringLiteral(data) =&gt; &amp;data.loc,</span><br><span class="line">            Token::NumericLiteral(data) =&gt; &amp;data.loc,</span><br><span class="line">            Token::RegExpLiteral(data) =&gt; &amp;data.loc,</span><br><span class="line">            Token::Eof(data) =&gt; &amp;data.loc,</span><br><span class="line">            Token::Nil =&gt; <span class="built_in">panic!</span>(),</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> INIT_TOKEN_DATA_ONCE: Once = Once::new();</span><br><span class="line"><span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">init_token_data</span></span>() &#123;</span><br><span class="line">    INIT_TOKEN_DATA_ONCE.call_once(|| &#123;</span><br><span class="line">        init_keywords();</span><br><span class="line">        init_symbols();</span><br><span class="line">        init_ctx_keyword();</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="字符流处理"><a href="#字符流处理" class="headerlink" title="字符流处理"></a>字符流处理</h2><p>在编写词法分析器之前，我们需要有个对字符流处理的对象，他主要的目的是帮助我们词法分析器更好的获取字符：</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 处理源代码的字符流</span></span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">struct</span> <span class="title">Source</span></span>&lt;<span class="symbol">'a</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">pub</span> chs: Chars&lt;<span class="symbol">'a</span>&gt;,</span><br><span class="line">    <span class="keyword">pub</span> peeked: VecDeque&lt;<span class="built_in">char</span>&gt;,</span><br><span class="line">    <span class="keyword">pub</span> line: <span class="built_in">i32</span>,</span><br><span class="line">    <span class="keyword">pub</span> column: <span class="built_in">i32</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">const</span> EOL: <span class="built_in">char</span> = <span class="string">'\n'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// '\n'、 '\r'、 U+2028 or U+2029</span></span><br><span class="line"><span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">is_line_terminator</span></span>(c: <span class="built_in">char</span>) -&gt; <span class="built_in">bool</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> cc = c <span class="keyword">as</span> <span class="built_in">u32</span>;</span><br><span class="line">    cc == <span class="number">0x0a</span> || cc == <span class="number">0x0d</span> || cc == <span class="number">0x2028</span> || cc == <span class="number">0x2029</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span>&lt;<span class="symbol">'a</span>&gt; Source&lt;<span class="symbol">'a</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">new</span></span>(code: &amp;<span class="symbol">'a</span> <span class="built_in">String</span>) -&gt; <span class="keyword">Self</span> &#123;</span><br><span class="line">        Source &#123;</span><br><span class="line">            chs: code.chars(),</span><br><span class="line">            peeked: VecDeque::with_capacity(<span class="number">3</span>),</span><br><span class="line">            line: <span class="number">1</span>,</span><br><span class="line">            column: <span class="number">0</span>,</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 用于从字符流中获取下一个字符</span></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">next_join_crlf</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) -&gt; <span class="built_in">Option</span>&lt;<span class="built_in">char</span>&gt; &#123;</span><br><span class="line">        <span class="keyword">match</span> <span class="keyword">self</span>.chs.next() &#123;</span><br><span class="line">            <span class="literal">Some</span>(c) =&gt; &#123;</span><br><span class="line">                <span class="keyword">if</span> is_line_terminator(c) &#123;</span><br><span class="line">                    <span class="comment">// 如果是回车符 '\r'，则进一步检查下一个字符</span></span><br><span class="line">                    <span class="keyword">if</span> c == <span class="string">'\r'</span> &#123;</span><br><span class="line">                        <span class="comment">// 如果下一个字符是换行符 '\n'，则跳过回车符 '\r'，并将换行符 '\n' 存储在 peeked 队列中</span></span><br><span class="line">                        <span class="keyword">if</span> <span class="keyword">let</span> <span class="literal">Some</span>(c) = <span class="keyword">self</span>.chs.next() &#123;</span><br><span class="line">                            <span class="comment">// 如果下一个字符不是换行符 '\n'，则将下一个字符存储在 peeked 队列中，以便后续读取</span></span><br><span class="line">                            <span class="keyword">if</span> c != <span class="string">'\n'</span> &#123;</span><br><span class="line">                                <span class="keyword">self</span>.peeked.push_back(c);</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="literal">Some</span>(EOL)</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="literal">Some</span>(c)</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            _ =&gt; <span class="literal">None</span>,</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 用于读取下一个字符，优先从 peeked 中读取</span></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">read</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) -&gt; <span class="built_in">Option</span>&lt;<span class="built_in">char</span>&gt; &#123;</span><br><span class="line">        <span class="keyword">let</span> c = <span class="keyword">match</span> <span class="keyword">self</span>.peeked.pop_front() &#123;</span><br><span class="line">            <span class="literal">Some</span>(c) =&gt; <span class="literal">Some</span>(c),</span><br><span class="line">            _ =&gt; <span class="keyword">self</span>.next_join_crlf(),</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">let</span> <span class="literal">Some</span>(c) = c &#123;</span><br><span class="line">            <span class="keyword">if</span> c == EOL &#123;</span><br><span class="line">                <span class="keyword">self</span>.line += <span class="number">1</span>;</span><br><span class="line">                <span class="keyword">self</span>.column = <span class="number">0</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">self</span>.column += <span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        c</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 用于预览下一个字符，如果 peeked 非空，则返回队列头部字符，否则通过 next_join_crlf 预读取字符，并将其存储在 peeked 中</span></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">peek</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) -&gt; <span class="built_in">Option</span>&lt;<span class="built_in">char</span>&gt; &#123;</span><br><span class="line">        <span class="keyword">match</span> <span class="keyword">self</span>.peeked.front().cloned() &#123;</span><br><span class="line">            <span class="literal">Some</span>(c) =&gt; <span class="literal">Some</span>(c),</span><br><span class="line">            _ =&gt; <span class="keyword">match</span> <span class="keyword">self</span>.next_join_crlf() &#123;</span><br><span class="line">                <span class="literal">Some</span>(c) =&gt; &#123;</span><br><span class="line">                    <span class="keyword">self</span>.peeked.push_back(c);</span><br><span class="line">                    <span class="literal">Some</span>(c)</span><br><span class="line">                &#125;</span><br><span class="line">                _ =&gt; <span class="literal">None</span>,</span><br><span class="line">            &#125;,</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 测试预读的字符是否与指定的字符或字符序列匹配</span></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">test_ahead</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, ch: <span class="built_in">char</span>) -&gt; <span class="built_in">bool</span> &#123;</span><br><span class="line">        <span class="keyword">match</span> <span class="keyword">self</span>.peek() &#123;</span><br><span class="line">            <span class="literal">Some</span>(c) =&gt; c == ch,</span><br><span class="line">            _ =&gt; <span class="literal">false</span>,</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">test_ahead_or</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, c1: <span class="built_in">char</span>, c2: <span class="built_in">char</span>) -&gt; <span class="built_in">bool</span> &#123;</span><br><span class="line">        <span class="keyword">match</span> <span class="keyword">self</span>.peek() &#123;</span><br><span class="line">            <span class="literal">Some</span>(c) =&gt; c == c1 || c == c2,</span><br><span class="line">            _ =&gt; <span class="literal">false</span>,</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">test_ahead_chs</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, chs: &amp;[<span class="built_in">char</span>]) -&gt; <span class="built_in">bool</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut</span> pass = <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="number">0</span>..<span class="keyword">self</span>.peeked.len() &#123;</span><br><span class="line">            pass = <span class="keyword">match</span> <span class="keyword">self</span>.peeked.get(i) &#123;</span><br><span class="line">                <span class="literal">Some</span>(c) =&gt; *c == chs[i],</span><br><span class="line">                _ =&gt; <span class="literal">false</span>,</span><br><span class="line">            &#125;;</span><br><span class="line">            <span class="keyword">if</span> !pass &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="keyword">self</span>.peeked.len()..chs.len() &#123;</span><br><span class="line">            pass = <span class="keyword">match</span> <span class="keyword">self</span>.next_join_crlf() &#123;</span><br><span class="line">                <span class="literal">Some</span>(c) =&gt; &#123;</span><br><span class="line">                    <span class="keyword">self</span>.peeked.push_back(c);</span><br><span class="line">                    c == chs[i]</span><br><span class="line">                &#125;</span><br><span class="line">                _ =&gt; <span class="literal">false</span>,</span><br><span class="line">            &#125;;</span><br><span class="line">            <span class="keyword">if</span> !pass &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        pass</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">test_ahead2</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, c1: <span class="built_in">char</span>, c2: <span class="built_in">char</span>) -&gt; <span class="built_in">bool</span> &#123;</span><br><span class="line">        <span class="keyword">self</span>.test_ahead_chs(&amp;[c1, c2])</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">test_ahead3</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, c1: <span class="built_in">char</span>, c2: <span class="built_in">char</span>, c3: <span class="built_in">char</span>) -&gt; <span class="built_in">bool</span> &#123;</span><br><span class="line">        <span class="keyword">self</span>.test_ahead_chs(&amp;[c1, c2, c3])</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 前进到下一个字符</span></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">advance</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) &#123;</span><br><span class="line">        <span class="keyword">self</span>.read();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">advance2</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) &#123;</span><br><span class="line">        <span class="keyword">self</span>.read();</span><br><span class="line">        <span class="keyword">self</span>.read();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="lexer"><a href="#lexer" class="headerlink" title="lexer"></a>lexer</h2><p>在有了 token 定义及字符流处理器后，我们就可以实现我们的 lexer，核心的原理就是不断地从字符流中获取字符，判断其每个开头与对应的哪种 token 开头相同，找到相同的 token 类型，就一直解析到对应 token 的结束：</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br><span class="line">650</span><br><span class="line">651</span><br><span class="line">652</span><br><span class="line">653</span><br><span class="line">654</span><br><span class="line">655</span><br><span class="line">656</span><br><span class="line">657</span><br><span class="line">658</span><br><span class="line">659</span><br><span class="line">660</span><br><span class="line">661</span><br><span class="line">662</span><br><span class="line">663</span><br><span class="line">664</span><br><span class="line">665</span><br><span class="line">666</span><br><span class="line">667</span><br><span class="line">668</span><br><span class="line">669</span><br><span class="line">670</span><br><span class="line">671</span><br><span class="line">672</span><br><span class="line">673</span><br><span class="line">674</span><br><span class="line">675</span><br><span class="line">676</span><br><span class="line">677</span><br><span class="line">678</span><br><span class="line">679</span><br><span class="line">680</span><br><span class="line">681</span><br><span class="line">682</span><br><span class="line">683</span><br><span class="line">684</span><br><span class="line">685</span><br><span class="line">686</span><br><span class="line">687</span><br><span class="line">688</span><br><span class="line">689</span><br><span class="line">690</span><br><span class="line">691</span><br><span class="line">692</span><br><span class="line">693</span><br><span class="line">694</span><br><span class="line">695</span><br><span class="line">696</span><br><span class="line">697</span><br><span class="line">698</span><br><span class="line">699</span><br><span class="line">700</span><br><span class="line">701</span><br><span class="line">702</span><br><span class="line">703</span><br><span class="line">704</span><br><span class="line">705</span><br><span class="line">706</span><br><span class="line">707</span><br><span class="line">708</span><br><span class="line">709</span><br><span class="line">710</span><br><span class="line">711</span><br><span class="line">712</span><br><span class="line">713</span><br><span class="line">714</span><br><span class="line">715</span><br><span class="line">716</span><br><span class="line">717</span><br><span class="line">718</span><br><span class="line">719</span><br><span class="line">720</span><br><span class="line">721</span><br><span class="line">722</span><br><span class="line">723</span><br><span class="line">724</span><br><span class="line">725</span><br><span class="line">726</span><br><span class="line">727</span><br><span class="line">728</span><br><span class="line">729</span><br><span class="line">730</span><br><span class="line">731</span><br><span class="line">732</span><br><span class="line">733</span><br><span class="line">734</span><br><span class="line">735</span><br><span class="line">736</span><br><span class="line">737</span><br><span class="line">738</span><br><span class="line">739</span><br><span class="line">740</span><br><span class="line">741</span><br><span class="line">742</span><br><span class="line">743</span><br><span class="line">744</span><br><span class="line">745</span><br><span class="line">746</span><br><span class="line">747</span><br><span class="line">748</span><br><span class="line">749</span><br><span class="line">750</span><br><span class="line">751</span><br><span class="line">752</span><br><span class="line">753</span><br><span class="line">754</span><br><span class="line">755</span><br><span class="line">756</span><br><span class="line">757</span><br><span class="line">758</span><br><span class="line">759</span><br><span class="line">760</span><br><span class="line">761</span><br><span class="line">762</span><br><span class="line">763</span><br><span class="line">764</span><br><span class="line">765</span><br><span class="line">766</span><br><span class="line">767</span><br><span class="line">768</span><br><span class="line">769</span><br><span class="line">770</span><br><span class="line">771</span><br><span class="line">772</span><br><span class="line">773</span><br><span class="line">774</span><br><span class="line">775</span><br><span class="line">776</span><br><span class="line">777</span><br><span class="line">778</span><br><span class="line">779</span><br><span class="line">780</span><br><span class="line">781</span><br><span class="line">782</span><br><span class="line">783</span><br><span class="line">784</span><br><span class="line">785</span><br><span class="line">786</span><br><span class="line">787</span><br><span class="line">788</span><br><span class="line">789</span><br><span class="line">790</span><br><span class="line">791</span><br><span class="line">792</span><br><span class="line">793</span><br><span class="line">794</span><br><span class="line">795</span><br><span class="line">796</span><br><span class="line">797</span><br><span class="line">798</span><br><span class="line">799</span><br><span class="line">800</span><br><span class="line">801</span><br><span class="line">802</span><br><span class="line">803</span><br><span class="line">804</span><br><span class="line">805</span><br><span class="line">806</span><br><span class="line">807</span><br><span class="line">808</span><br><span class="line">809</span><br><span class="line">810</span><br><span class="line">811</span><br><span class="line">812</span><br><span class="line">813</span><br><span class="line">814</span><br><span class="line">815</span><br><span class="line">816</span><br><span class="line">817</span><br><span class="line">818</span><br><span class="line">819</span><br><span class="line">820</span><br><span class="line">821</span><br><span class="line">822</span><br><span class="line">823</span><br><span class="line">824</span><br><span class="line">825</span><br><span class="line">826</span><br><span class="line">827</span><br><span class="line">828</span><br><span class="line">829</span><br><span class="line">830</span><br><span class="line">831</span><br><span class="line">832</span><br><span class="line">833</span><br><span class="line">834</span><br><span class="line">835</span><br><span class="line">836</span><br><span class="line">837</span><br><span class="line">838</span><br><span class="line">839</span><br><span class="line">840</span><br><span class="line">841</span><br><span class="line">842</span><br><span class="line">843</span><br><span class="line">844</span><br><span class="line">845</span><br><span class="line">846</span><br><span class="line">847</span><br><span class="line">848</span><br><span class="line">849</span><br><span class="line">850</span><br><span class="line">851</span><br><span class="line">852</span><br><span class="line">853</span><br><span class="line">854</span><br><span class="line">855</span><br><span class="line">856</span><br><span class="line">857</span><br><span class="line">858</span><br><span class="line">859</span><br><span class="line">860</span><br><span class="line">861</span><br><span class="line">862</span><br><span class="line">863</span><br><span class="line">864</span><br><span class="line">865</span><br><span class="line">866</span><br><span class="line">867</span><br><span class="line">868</span><br><span class="line">869</span><br><span class="line">870</span><br><span class="line">871</span><br><span class="line">872</span><br><span class="line">873</span><br><span class="line">874</span><br><span class="line">875</span><br><span class="line">876</span><br><span class="line">877</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// 判断字符是否是空白字符，排除行终止符。</span></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">is_whitespace</span></span>(c: <span class="built_in">char</span>) -&gt; <span class="built_in">bool</span> &#123;</span><br><span class="line">    !is_line_terminator(c) &amp;&amp; c.is_whitespace()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 判断一个字符是否是 Unicode 字母</span></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">is_unicode_letter</span></span>(c: <span class="built_in">char</span>) -&gt; <span class="built_in">bool</span> &#123;</span><br><span class="line">    <span class="comment">// 是否为大写字母或小写字母</span></span><br><span class="line">    <span class="keyword">if</span> c.is_uppercase() || c.is_lowercase() &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">match</span> GeneralCategory::of(c) &#123;</span><br><span class="line">    <span class="comment">// 大写标题字母</span></span><br><span class="line">    GeneralCategory::TitlecaseLetter</span><br><span class="line">    <span class="comment">// 修饰符字母</span></span><br><span class="line">    | GeneralCategory::ModifierLetter</span><br><span class="line">    <span class="comment">// 其他字母，包括小写字母、大写字母以外的字母</span></span><br><span class="line">    | GeneralCategory::OtherLetter</span><br><span class="line">    <span class="comment">// 字母数字，通常是字母与数字的混合</span></span><br><span class="line">    | GeneralCategory::LetterNumber =&gt; <span class="literal">true</span>,</span><br><span class="line">    _ =&gt; <span class="literal">false</span>,</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 字符是否可以作为标识符的开头</span></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">is_id_start</span></span>(c: <span class="built_in">char</span>) -&gt; <span class="built_in">bool</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> is_unicode_letter(c) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">match</span> c &#123;</span><br><span class="line">        <span class="string">'$'</span> | <span class="string">'_'</span> | <span class="string">'\\'</span> =&gt; <span class="literal">true</span>,</span><br><span class="line">        _ =&gt; <span class="literal">false</span>,</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 字符是否可以作为标识符的一部分</span></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">is_id_part</span></span>(c: <span class="built_in">char</span>) -&gt; <span class="built_in">bool</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> is_id_start(c) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">let</span> cc = c <span class="keyword">as</span> <span class="built_in">u32</span>;</span><br><span class="line">    <span class="comment">// Zero Width Non-Joiner and Zero Width Joiner</span></span><br><span class="line">    <span class="keyword">if</span> cc == <span class="number">0x200c</span> || cc == <span class="number">0x200d</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">match</span> GeneralCategory::of(c) &#123;</span><br><span class="line">    <span class="comment">// 非间隔标记，包括一些变音符号等</span></span><br><span class="line">    GeneralCategory::NonspacingMark</span><br><span class="line">    <span class="comment">// 间隔标记，包括一些空格修饰符等</span></span><br><span class="line">    | GeneralCategory::SpacingMark</span><br><span class="line">    <span class="comment">// 十进制数字，包括数字 0 到 9</span></span><br><span class="line">    | GeneralCategory::DecimalNumber</span><br><span class="line">    <span class="comment">// 连接标点，包括下划线等</span></span><br><span class="line">    | GeneralCategory::ConnectorPunctuation =&gt; <span class="literal">true</span>,</span><br><span class="line">    _ =&gt; <span class="literal">false</span>,</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 是否是单字符转义字符</span></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">is_single_escape_ch</span></span>(c: <span class="built_in">char</span>) -&gt; <span class="built_in">bool</span> &#123;</span><br><span class="line">    <span class="keyword">match</span> c &#123;</span><br><span class="line">        <span class="string">'\''</span> | <span class="string">'"'</span> | <span class="string">'\\'</span> | <span class="string">'b'</span> | <span class="string">'f'</span> | <span class="string">'n'</span> | <span class="string">'r'</span> | <span class="string">'t'</span> | <span class="string">'v'</span> =&gt; <span class="literal">true</span>,</span><br><span class="line">        _ =&gt; <span class="literal">false</span>,</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 将转义字符转换为实际字符</span></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">escape_ch</span></span>(c: <span class="built_in">char</span>) -&gt; <span class="built_in">char</span> &#123;</span><br><span class="line">    <span class="keyword">match</span> c &#123;</span><br><span class="line">        <span class="string">'\''</span> =&gt; <span class="string">'\''</span>,</span><br><span class="line">        <span class="string">'"'</span> =&gt; <span class="string">'"'</span>,</span><br><span class="line">        <span class="string">'\\'</span> =&gt; <span class="string">'\\'</span>,</span><br><span class="line">        <span class="string">'b'</span> =&gt; <span class="string">'\x08'</span>,</span><br><span class="line">        <span class="string">'f'</span> =&gt; <span class="string">'\x0c'</span>,</span><br><span class="line">        <span class="string">'n'</span> =&gt; <span class="string">'\x0a'</span>,</span><br><span class="line">        <span class="string">'r'</span> =&gt; <span class="string">'\x0d'</span>,</span><br><span class="line">        <span class="string">'t'</span> =&gt; <span class="string">'\x09'</span>,</span><br><span class="line">        <span class="string">'v'</span> =&gt; <span class="string">'\x0b'</span>,</span><br><span class="line">        _ =&gt; <span class="built_in">panic!</span>(),</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 字符是否不是单字符转义字符、行终止符、ASCII 数字、x、u</span></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">is_non_escape_ch</span></span>(c: <span class="built_in">char</span>) -&gt; <span class="built_in">bool</span> &#123;</span><br><span class="line">    !is_single_escape_ch(c) &amp;&amp; !is_line_terminator(c) &amp;&amp; !c.is_ascii_digit() &amp;&amp; c != <span class="string">'x'</span> &amp;&amp; c != <span class="string">'u'</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">struct</span> <span class="title">TokenNextNewline</span></span> &#123;</span><br><span class="line">    tok: Rc&lt;Token&gt;,</span><br><span class="line">    next_is_line_terminator: <span class="built_in">bool</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">struct</span> <span class="title">Lexer</span></span>&lt;<span class="symbol">'a</span>&gt; &#123;</span><br><span class="line">    src: Source&lt;<span class="symbol">'a</span>&gt;,</span><br><span class="line">    tok: Rc&lt;Token&gt;,</span><br><span class="line">    <span class="keyword">pub</span> next_is_line_terminator: <span class="built_in">bool</span>,</span><br><span class="line">    peeked: VecDeque&lt;TokenNextNewline&gt;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[derive(Debug)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">struct</span> <span class="title">LexError</span></span> &#123;</span><br><span class="line">    <span class="keyword">pub</span> msg: <span class="built_in">String</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> LexError &#123;</span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">new</span></span>(msg: <span class="built_in">String</span>) -&gt; <span class="keyword">Self</span> &#123;</span><br><span class="line">        LexError &#123; msg &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">default</span></span>() -&gt; <span class="keyword">Self</span> &#123;</span><br><span class="line">        LexError &#123;</span><br><span class="line">            msg: <span class="string">""</span>.to_string(),</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span>&lt;<span class="symbol">'a</span>&gt; Lexer&lt;<span class="symbol">'a</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">new</span></span>(src: Source&lt;<span class="symbol">'a</span>&gt;) -&gt; <span class="keyword">Self</span> &#123;</span><br><span class="line">        Lexer &#123;</span><br><span class="line">            src,</span><br><span class="line">            tok: Rc::new(Token::Nil),</span><br><span class="line">            next_is_line_terminator: <span class="literal">false</span>,</span><br><span class="line">            peeked: VecDeque::new(),</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">next_</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) -&gt; <span class="built_in">Result</span>&lt;Token, LexError&gt; &#123;</span><br><span class="line">        <span class="keyword">self</span>.skip_whitespace();</span><br><span class="line">        <span class="comment">// 解析标识符、数字、字符串还是符号</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">self</span>.ahead_is_id_start() &#123;</span><br><span class="line">            <span class="keyword">self</span>.read_name()</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> <span class="keyword">self</span>.ahead_is_decimal_int() &#123;</span><br><span class="line">            <span class="keyword">self</span>.read_numeric()</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> <span class="keyword">self</span>.ahead_is_string_start() &#123;</span><br><span class="line">            <span class="keyword">let</span> t = <span class="keyword">self</span>.src.read().unwrap();</span><br><span class="line">            <span class="keyword">self</span>.read_string(t)</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> !<span class="keyword">self</span>.ahead_is_eof() &#123;</span><br><span class="line">            <span class="keyword">self</span>.read_symbol()</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="literal">Ok</span>(Token::Eof(EofData &#123;</span><br><span class="line">                loc: <span class="keyword">self</span>.loc().clone(),</span><br><span class="line">            &#125;))</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 查看下一个token，但不会将其从输入中移除</span></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">peek</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) -&gt; <span class="built_in">Result</span>&lt;Rc&lt;Token&gt;, LexError&gt; &#123;</span><br><span class="line">        <span class="keyword">match</span> <span class="keyword">self</span>.peeked.front() &#123;</span><br><span class="line">            <span class="comment">// 如果 peeked 中有已经查看的token，它会返回该token</span></span><br><span class="line">            <span class="literal">Some</span>(tok) =&gt; <span class="literal">Ok</span>(tok.tok.clone()),</span><br><span class="line">            <span class="comment">// 调用 next_ 方法来获取下一个token，将其存储在 peeked 中，然后返回</span></span><br><span class="line">            _ =&gt; <span class="keyword">match</span> <span class="keyword">self</span>.next_() &#123;</span><br><span class="line">                <span class="literal">Ok</span>(tok) =&gt; &#123;</span><br><span class="line">                    <span class="keyword">let</span> tok = Rc::new(tok);</span><br><span class="line">                    <span class="keyword">let</span> next_is_line_terminator = <span class="keyword">self</span>.ahead_is_line_terminator_or_eof();</span><br><span class="line">                    <span class="keyword">self</span>.peeked.push_back(TokenNextNewline &#123;</span><br><span class="line">                        tok: tok.clone(),</span><br><span class="line">                        next_is_line_terminator,</span><br><span class="line">                    &#125;);</span><br><span class="line">                    <span class="literal">Ok</span>(tok)</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="literal">Err</span>(e) =&gt; <span class="literal">Err</span>(e),</span><br><span class="line">            &#125;,</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取下一个token，并将其从输入中移除</span></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">next</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) -&gt; <span class="built_in">Result</span>&lt;Rc&lt;Token&gt;, LexError&gt; &#123;</span><br><span class="line">        <span class="comment">// 检查 peeked 中是否有已经查看的token</span></span><br><span class="line">        <span class="keyword">match</span> <span class="keyword">self</span>.peeked.pop_front() &#123;</span><br><span class="line">            <span class="literal">Some</span>(tn) =&gt; &#123;</span><br><span class="line">                <span class="keyword">self</span>.tok = tn.tok;</span><br><span class="line">                <span class="keyword">self</span>.next_is_line_terminator = tn.next_is_line_terminator;</span><br><span class="line">                <span class="literal">Ok</span>(<span class="keyword">self</span>.tok.clone())</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 调用 next_ 方法来获取下一个token，并存储在 peeked 中以备后续使用</span></span><br><span class="line">            _ =&gt; <span class="keyword">match</span> <span class="keyword">self</span>.next_() &#123;</span><br><span class="line">                <span class="literal">Ok</span>(tok) =&gt; &#123;</span><br><span class="line">                    <span class="keyword">self</span>.tok = Rc::new(tok);</span><br><span class="line">                    <span class="keyword">self</span>.next_is_line_terminator = <span class="keyword">self</span>.ahead_is_line_terminator_or_eof();</span><br><span class="line">                    <span class="literal">Ok</span>(<span class="keyword">self</span>.tok.clone())</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="literal">Err</span>(e) =&gt; <span class="literal">Err</span>(e),</span><br><span class="line">            &#125;,</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取下一个token，但不会将其从输入中移除</span></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">advance</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) &#123;</span><br><span class="line">        <span class="keyword">match</span> <span class="keyword">self</span>.next() &#123;</span><br><span class="line">            <span class="literal">Ok</span>(_) =&gt; (),</span><br><span class="line">            <span class="literal">Err</span>(e) =&gt; <span class="built_in">panic!</span>(<span class="string">"&#123;&#125;"</span>, e.msg),</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 解析 Unicode 转义序列</span></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">read_unicode_escape_seq</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) -&gt; <span class="built_in">Option</span>&lt;<span class="built_in">char</span>&gt; &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut</span> hex = [<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>];</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="number">0</span>..hex.len() &#123;</span><br><span class="line">            <span class="keyword">match</span> <span class="keyword">self</span>.src.read() &#123;</span><br><span class="line">                <span class="literal">Some</span>(c) =&gt; &#123;</span><br><span class="line">                    <span class="keyword">if</span> c.is_ascii_hexdigit() &#123;</span><br><span class="line">                        hex[i] = c <span class="keyword">as</span> <span class="built_in">u8</span>;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="keyword">return</span> <span class="literal">None</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                _ =&gt; <span class="keyword">return</span> <span class="literal">None</span>,</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">let</span> hex = <span class="built_in">str</span>::from_utf8(&amp;hex).unwrap();</span><br><span class="line">        <span class="keyword">match</span> <span class="built_in">u32</span>::from_str_radix(hex, <span class="number">16</span>) &#123;</span><br><span class="line">            <span class="literal">Ok</span>(i) =&gt; <span class="keyword">match</span> <span class="built_in">char</span>::from_u32(i) &#123;</span><br><span class="line">                <span class="literal">Some</span>(c) =&gt; <span class="literal">Some</span>(c),</span><br><span class="line">                _ =&gt; <span class="literal">None</span>, <span class="comment">// deformed unicode</span></span><br><span class="line">            &#125;,</span><br><span class="line">            _ =&gt; <span class="literal">None</span>, <span class="comment">// deformed hex digits</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 检查下一个字符是否是标识符的起始字符</span></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">ahead_is_id_start</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) -&gt; <span class="built_in">bool</span> &#123;</span><br><span class="line">        <span class="keyword">match</span> <span class="keyword">self</span>.src.peek() &#123;</span><br><span class="line">            <span class="literal">Some</span>(c) =&gt; is_id_start(c),</span><br><span class="line">            _ =&gt; <span class="literal">false</span>,</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 检查下一个字符是否是起始标识符的部分字符</span></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">ahead_is_id_part</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) -&gt; <span class="built_in">bool</span> &#123;</span><br><span class="line">        <span class="keyword">match</span> <span class="keyword">self</span>.src.peek() &#123;</span><br><span class="line">            <span class="literal">Some</span>(c) =&gt; is_id_part(c),</span><br><span class="line">            _ =&gt; <span class="literal">false</span>,</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">errmsg</span></span>(&amp;<span class="keyword">self</span>) -&gt; <span class="built_in">String</span> &#123;</span><br><span class="line">        <span class="built_in">format!</span>(</span><br><span class="line">            <span class="string">"Unexpected char at line: &#123;&#125; column: &#123;&#125;"</span>,</span><br><span class="line">            <span class="keyword">self</span>.src.line, <span class="keyword">self</span>.src.column</span><br><span class="line">        )</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">pos</span></span>(&amp;<span class="keyword">self</span>) -&gt; Position &#123;</span><br><span class="line">        Position &#123;</span><br><span class="line">            line: <span class="keyword">self</span>.src.line,</span><br><span class="line">            column: <span class="keyword">self</span>.src.column,</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">loc</span></span>(&amp;<span class="keyword">self</span>) -&gt; SourceLoc &#123;</span><br><span class="line">        SourceLoc &#123;</span><br><span class="line">            start: <span class="keyword">self</span>.pos(),</span><br><span class="line">            end: Position::new(),</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">fin_loc</span></span>(&amp;<span class="keyword">self</span>, loc: SourceLoc) -&gt; SourceLoc &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut</span> loc = loc;</span><br><span class="line">        loc.end = <span class="keyword">self</span>.pos();</span><br><span class="line">        loc</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">read_escape_unicode</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, bs: <span class="built_in">char</span>) -&gt; <span class="built_in">Result</span>&lt;<span class="built_in">char</span>, LexError&gt; &#123;</span><br><span class="line">        <span class="comment">// Unicode 转义序列以 \u 开头，后跟 4 个十六进制数字</span></span><br><span class="line">        <span class="keyword">if</span> bs == <span class="string">'\\'</span> &amp;&amp; <span class="keyword">self</span>.src.test_ahead(<span class="string">'u'</span>) &#123;</span><br><span class="line">            <span class="keyword">self</span>.src.advance();</span><br><span class="line">            <span class="keyword">match</span> <span class="keyword">self</span>.read_unicode_escape_seq() &#123;</span><br><span class="line">                <span class="literal">Some</span>(ec) =&gt; <span class="literal">Ok</span>(ec),</span><br><span class="line">                _ =&gt; <span class="literal">Err</span>(LexError::new(<span class="keyword">self</span>.errmsg())),</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="literal">Ok</span>(bs)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">read_id_part</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) -&gt; <span class="built_in">Result</span>&lt;<span class="built_in">String</span>, LexError&gt; &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut</span> val = <span class="built_in">vec!</span>[];</span><br><span class="line">        <span class="keyword">loop</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">self</span>.ahead_is_id_part() &#123;</span><br><span class="line">                <span class="keyword">let</span> c = <span class="keyword">self</span>.src.read().unwrap();</span><br><span class="line">                <span class="keyword">match</span> <span class="keyword">self</span>.read_escape_unicode(c) &#123;</span><br><span class="line">                    <span class="literal">Ok</span>(cc) =&gt; val.push(cc),</span><br><span class="line">                    <span class="literal">Err</span>(e) =&gt; <span class="keyword">return</span> <span class="literal">Err</span>(e),</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="literal">Ok</span>(val.into_iter().collect())</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 解析keyword bool null和标识符</span></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">read_name</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) -&gt; <span class="built_in">Result</span>&lt;Token, LexError&gt; &#123;</span><br><span class="line">        <span class="keyword">let</span> loc = <span class="keyword">self</span>.loc();</span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut</span> c = <span class="keyword">self</span>.src.read().unwrap();</span><br><span class="line">        <span class="keyword">match</span> <span class="keyword">self</span>.read_escape_unicode(c) &#123;</span><br><span class="line">            <span class="literal">Ok</span>(cc) =&gt; c = cc,</span><br><span class="line">            <span class="literal">Err</span>(e) =&gt; <span class="keyword">return</span> <span class="literal">Err</span>(e),</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut</span> val = <span class="built_in">vec!</span>[c];</span><br><span class="line">        <span class="keyword">match</span> <span class="keyword">self</span>.read_id_part() &#123;</span><br><span class="line">            <span class="literal">Ok</span>(cc) =&gt; val.extend(cc.chars()),</span><br><span class="line">            <span class="literal">Err</span>(e) =&gt; <span class="keyword">return</span> <span class="literal">Err</span>(e),</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">let</span> val: <span class="built_in">String</span> = val.into_iter().collect();</span><br><span class="line">        <span class="keyword">if</span> is_keyword(&amp;val) &#123;</span><br><span class="line">            <span class="literal">Ok</span>(Token::Keyword(KeywordData &#123;</span><br><span class="line">                kind: name_to_keyword(&amp;val),</span><br><span class="line">                loc: <span class="keyword">self</span>.fin_loc(loc),</span><br><span class="line">            &#125;))</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> is_ctx_keyword(&amp;val) &#123;</span><br><span class="line">            <span class="literal">Ok</span>(Token::ContextualKeyword(CtxKeywordData &#123;</span><br><span class="line">                kind: name_to_ctx_keyword(&amp;val),</span><br><span class="line">                loc: <span class="keyword">self</span>.fin_loc(loc),</span><br><span class="line">            &#125;))</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> is_bool(&amp;val) &#123;</span><br><span class="line">            <span class="literal">Ok</span>(Token::BooleanLiteral(BooleanLiteralData &#123;</span><br><span class="line">                kind: name_to_bool(&amp;val),</span><br><span class="line">                loc: <span class="keyword">self</span>.fin_loc(loc),</span><br><span class="line">            &#125;))</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> is_null(&amp;val) &#123;</span><br><span class="line">            <span class="literal">Ok</span>(Token::NullLiteral(NullLiteralData &#123;</span><br><span class="line">                loc: <span class="keyword">self</span>.fin_loc(loc),</span><br><span class="line">            &#125;))</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="literal">Ok</span>(Token::Identifier(IdentifierData &#123;</span><br><span class="line">                value: val,</span><br><span class="line">                loc: <span class="keyword">self</span>.fin_loc(loc),</span><br><span class="line">            &#125;))</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 解析数字</span></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">read_decimal_digits</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) -&gt; <span class="built_in">String</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut</span> ret = <span class="built_in">String</span>::new();</span><br><span class="line">        <span class="keyword">loop</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">let</span> <span class="literal">Some</span>(c) = <span class="keyword">self</span>.src.peek() &#123;</span><br><span class="line">                <span class="keyword">if</span> c.is_ascii_digit() &#123;</span><br><span class="line">                    ret.push(<span class="keyword">self</span>.src.read().unwrap());</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        ret</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 科学计算</span></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">read_exponent</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) -&gt; <span class="built_in">Result</span>&lt;<span class="built_in">String</span>, LexError&gt; &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut</span> ret = <span class="built_in">String</span>::new();</span><br><span class="line">        <span class="comment">// 使用 e|E</span></span><br><span class="line">        ret.push(<span class="keyword">self</span>.src.read().unwrap());</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">let</span> <span class="literal">Some</span>(c) = <span class="keyword">self</span>.src.peek() &#123;</span><br><span class="line">            <span class="keyword">if</span> c == <span class="string">'+'</span> || c == <span class="string">'-'</span> &#123;</span><br><span class="line">                ret.push(<span class="keyword">self</span>.src.read().unwrap());</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">let</span> digits = <span class="keyword">self</span>.read_decimal_digits();</span><br><span class="line">            <span class="keyword">if</span> digits.is_empty() &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">Err</span>(LexError::new(<span class="keyword">self</span>.errmsg()));</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                ret.push_str(digits.as_str());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="literal">Ok</span>(ret)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">read_decimal_int_part</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) -&gt; <span class="built_in">String</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut</span> ret = <span class="built_in">String</span>::new();</span><br><span class="line">        <span class="keyword">let</span> c = <span class="keyword">self</span>.src.read().unwrap();</span><br><span class="line">        ret.push(c);</span><br><span class="line">        <span class="keyword">if</span> c == <span class="string">'0'</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> ret;</span><br><span class="line">        &#125;</span><br><span class="line">        ret.push_str(<span class="keyword">self</span>.read_decimal_digits().as_str());</span><br><span class="line">        ret</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 解析字符串</span></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">read_decimal</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) -&gt; <span class="built_in">Result</span>&lt;<span class="built_in">String</span>, LexError&gt; &#123;</span><br><span class="line">        <span class="keyword">let</span> c = <span class="keyword">self</span>.src.peek().unwrap();</span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut</span> ret = <span class="built_in">String</span>::new();</span><br><span class="line">        <span class="keyword">let</span> digits_opt = c != <span class="string">'.'</span>;</span><br><span class="line">        <span class="keyword">if</span> c.is_ascii_digit() &#123;</span><br><span class="line">            ret.push_str(<span class="keyword">self</span>.read_decimal_int_part().as_str());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 处理小数部分：这部分代码涉及解析浮点数，即具有小数部分的数字。根据 JavaScript 语法，浮点数的小数部分是可选的。</span></span><br><span class="line">        <span class="comment">// 如果浮点数以小数点 . 开头，那么下一个字符（或字符序列）必须是小数部分。这意味着小数点后面必须紧跟着数字。</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">self</span>.src.test_ahead(<span class="string">'.'</span>) &#123;</span><br><span class="line">            ret.push(<span class="keyword">self</span>.src.read().unwrap());</span><br><span class="line">            <span class="keyword">let</span> digits = <span class="keyword">self</span>.read_decimal_digits();</span><br><span class="line">            <span class="keyword">if</span> digits.is_empty() &amp;&amp; !digits_opt &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">Err</span>(LexError::new(<span class="keyword">self</span>.errmsg()));</span><br><span class="line">            &#125;</span><br><span class="line">            ret.push_str(digits.as_str());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//如果浮点数以非零数字开头，那么小数部分中的数字是可选的。这意味着可以有整数值而无小数部分。</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">self</span>.src.test_ahead_or(<span class="string">'e'</span>, <span class="string">'E'</span>) &#123;</span><br><span class="line">            <span class="keyword">match</span> <span class="keyword">self</span>.read_exponent() &#123;</span><br><span class="line">                <span class="literal">Ok</span>(s) =&gt; ret.push_str(s.as_str()),</span><br><span class="line">                err @ <span class="literal">Err</span>(_) =&gt; <span class="keyword">return</span> err,</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="literal">Ok</span>(ret)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 解析十六进制</span></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">read_hex</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) -&gt; <span class="built_in">Result</span>&lt;<span class="built_in">String</span>, LexError&gt; &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut</span> ret = <span class="built_in">String</span>::new();</span><br><span class="line">        ret.push(<span class="keyword">self</span>.src.read().unwrap());</span><br><span class="line">        ret.push(<span class="keyword">self</span>.src.read().unwrap());</span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut</span> digits = <span class="built_in">vec!</span>[];</span><br><span class="line">        <span class="keyword">loop</span> &#123;</span><br><span class="line">            <span class="keyword">match</span> <span class="keyword">self</span>.src.peek() &#123;</span><br><span class="line">                <span class="literal">Some</span>(c) =&gt; &#123;</span><br><span class="line">                    <span class="keyword">if</span> c.is_ascii_hexdigit() &#123;</span><br><span class="line">                        digits.push(<span class="keyword">self</span>.src.read().unwrap());</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                _ =&gt; <span class="keyword">break</span>,</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> digits.len() == <span class="number">0</span> &#123;</span><br><span class="line">            <span class="literal">Err</span>(LexError::new(<span class="keyword">self</span>.errmsg()))</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">let</span> digits: <span class="built_in">String</span> = digits.iter().collect();</span><br><span class="line">            ret.push_str(digits.as_str());</span><br><span class="line">            <span class="literal">Ok</span>(ret)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">ahead_is_decimal_int</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) -&gt; <span class="built_in">bool</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">let</span> <span class="literal">Some</span>(c) = <span class="keyword">self</span>.src.peek() &#123;</span><br><span class="line">            <span class="keyword">if</span> c == <span class="string">'.'</span> &#123;</span><br><span class="line">                <span class="keyword">match</span> <span class="keyword">self</span>.src.chs.next() &#123;</span><br><span class="line">                    <span class="literal">Some</span>(cc) =&gt; &#123;</span><br><span class="line">                        <span class="keyword">self</span>.src.peeked.push_back(cc);</span><br><span class="line">                        cc.is_ascii_digit()</span><br><span class="line">                    &#125;</span><br><span class="line">                    _ =&gt; <span class="literal">false</span>,</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                c.is_ascii_digit()</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="literal">false</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 解析数字</span></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">read_numeric</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) -&gt; <span class="built_in">Result</span>&lt;Token, LexError&gt; &#123;</span><br><span class="line">        <span class="keyword">let</span> loc = <span class="keyword">self</span>.loc();</span><br><span class="line">        <span class="keyword">let</span> value: <span class="built_in">Result</span>&lt;<span class="built_in">String</span>, LexError&gt;;</span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut</span> is_hex = <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">self</span>.src.test_ahead(<span class="string">'0'</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">let</span> <span class="literal">Some</span>(c) = <span class="keyword">self</span>.src.chs.next() &#123;</span><br><span class="line">                <span class="keyword">self</span>.src.peeked.push_back(c);</span><br><span class="line">                <span class="keyword">if</span> c == <span class="string">'x'</span> || c == <span class="string">'X'</span> &#123;</span><br><span class="line">                    is_hex = <span class="literal">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> is_hex &#123;</span><br><span class="line">            value = <span class="keyword">self</span>.read_hex();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            value = <span class="keyword">self</span>.read_decimal();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">match</span> value &#123;</span><br><span class="line">            <span class="literal">Ok</span>(v) =&gt; <span class="literal">Ok</span>(Token::NumericLiteral(NumericLiteralData &#123;</span><br><span class="line">                value: v,</span><br><span class="line">                loc: <span class="keyword">self</span>.fin_loc(loc),</span><br><span class="line">            &#125;)),</span><br><span class="line">            <span class="literal">Err</span>(e) =&gt; <span class="literal">Err</span>(e),</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">ahead_is_string_start</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) -&gt; <span class="built_in">bool</span> &#123;</span><br><span class="line">        <span class="keyword">match</span> <span class="keyword">self</span>.src.peek() &#123;</span><br><span class="line">            <span class="literal">Some</span>(c) =&gt; c == <span class="string">'\''</span> || c == <span class="string">'"'</span>,</span><br><span class="line">            _ =&gt; <span class="literal">false</span>,</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 解析转译</span></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">read_string_escape_seq</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) -&gt; <span class="built_in">Result</span>&lt;<span class="built_in">Option</span>&lt;<span class="built_in">char</span>&gt;, LexError&gt; &#123;</span><br><span class="line">        <span class="keyword">self</span>.src.advance(); <span class="comment">// 反斜杠</span></span><br><span class="line">        <span class="keyword">match</span> <span class="keyword">self</span>.src.read() &#123;</span><br><span class="line">            <span class="literal">Some</span>(<span class="keyword">mut</span> c) =&gt; &#123;</span><br><span class="line">                <span class="comment">// 单字符转义字符</span></span><br><span class="line">                <span class="keyword">if</span> is_single_escape_ch(c) &#123;</span><br><span class="line">                    c = escape_ch(c);</span><br><span class="line">                    <span class="comment">// \0：表示空字符 (NUL)</span></span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> c == <span class="string">'0'</span> &#123;</span><br><span class="line">                    c = <span class="string">'\0'</span>;</span><br><span class="line">                    <span class="comment">// 0 [lookahead ∉ DecimalDigit]</span></span><br><span class="line">                    <span class="keyword">if</span> <span class="keyword">let</span> <span class="literal">Some</span>(c) = <span class="keyword">self</span>.src.peek() &#123;</span><br><span class="line">                        <span class="keyword">if</span> c.is_ascii_digit() &#123;</span><br><span class="line">                            <span class="keyword">return</span> <span class="literal">Err</span>(LexError::new(<span class="keyword">self</span>.errmsg()));</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">// \x：表示十六进制转义</span></span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> c == <span class="string">'x'</span> &#123;</span><br><span class="line">                    <span class="keyword">let</span> <span class="keyword">mut</span> hex = [<span class="number">0</span>, <span class="number">0</span>];</span><br><span class="line">                    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="number">0</span>..hex.len() &#123;</span><br><span class="line">                        <span class="keyword">if</span> <span class="keyword">let</span> <span class="literal">Some</span>(cc) = <span class="keyword">self</span>.src.read() &#123;</span><br><span class="line">                            <span class="keyword">if</span> cc.is_ascii_hexdigit() &#123;</span><br><span class="line">                                hex[i] = cc <span class="keyword">as</span> <span class="built_in">u8</span>;</span><br><span class="line">                                <span class="keyword">continue</span>;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">return</span> <span class="literal">Err</span>(LexError::new(<span class="keyword">self</span>.errmsg()));</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">let</span> hex = <span class="built_in">str</span>::from_utf8(&amp;hex).unwrap();</span><br><span class="line">                    c = <span class="built_in">char</span>::from_u32(<span class="built_in">u32</span>::from_str_radix(hex, <span class="number">16</span>).ok().unwrap()).unwrap()</span><br><span class="line">                    <span class="comment">// \u：表示 Unicode 转义</span></span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> c == <span class="string">'u'</span> &#123;</span><br><span class="line">                    <span class="keyword">match</span> <span class="keyword">self</span>.read_unicode_escape_seq() &#123;</span><br><span class="line">                        <span class="literal">Some</span>(ec) =&gt; c = ec,</span><br><span class="line">                        _ =&gt; <span class="keyword">return</span> <span class="literal">Err</span>(LexError::new(<span class="keyword">self</span>.errmsg())),</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">// 换行符</span></span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> is_line_terminator(c) &#123;</span><br><span class="line">                    <span class="keyword">if</span> c == <span class="string">'\r'</span> &amp;&amp; <span class="keyword">self</span>.src.test_ahead(<span class="string">'\n'</span>) &#123;</span><br><span class="line">                        <span class="keyword">self</span>.src.advance();</span><br><span class="line">                        <span class="keyword">return</span> <span class="literal">Err</span>(LexError::new(<span class="keyword">self</span>.errmsg()));</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">Ok</span>(<span class="literal">None</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> is_non_escape_ch(c) &#123;</span><br><span class="line">                    <span class="comment">// todo</span></span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">Err</span>(LexError::new(<span class="keyword">self</span>.errmsg()));</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="literal">Ok</span>(<span class="literal">Some</span>(c))</span><br><span class="line">            &#125;</span><br><span class="line">            _ =&gt; <span class="literal">Err</span>(LexError::new(<span class="keyword">self</span>.errmsg())),</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 解析字符串</span></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">read_string</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, t: <span class="built_in">char</span>) -&gt; <span class="built_in">Result</span>&lt;Token, LexError&gt; &#123;</span><br><span class="line">        <span class="keyword">let</span> loc = <span class="keyword">self</span>.loc();</span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut</span> ret = <span class="built_in">String</span>::new();</span><br><span class="line">        <span class="keyword">loop</span> &#123;</span><br><span class="line">            <span class="keyword">match</span> <span class="keyword">self</span>.src.peek() &#123;</span><br><span class="line">                <span class="literal">Some</span>(c) =&gt; &#123;</span><br><span class="line">                    <span class="keyword">if</span> c == t &#123;</span><br><span class="line">                        <span class="keyword">self</span>.src.advance();</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125; <span class="keyword">else</span> <span class="keyword">if</span> c == <span class="string">'\\'</span> &#123;</span><br><span class="line">                        <span class="keyword">match</span> <span class="keyword">self</span>.read_string_escape_seq() &#123;</span><br><span class="line">                            <span class="literal">Ok</span>(<span class="literal">Some</span>(c)) =&gt; ret.push(c),</span><br><span class="line">                            <span class="literal">Err</span>(e) =&gt; <span class="keyword">return</span> <span class="literal">Err</span>(e),</span><br><span class="line">                            _ =&gt; (),</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        ret.push(<span class="keyword">self</span>.src.read().unwrap());</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                _ =&gt; <span class="keyword">break</span>,</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="literal">Ok</span>(Token::StringLiteral(StringLiteralData &#123;</span><br><span class="line">            value: ret,</span><br><span class="line">            loc: <span class="keyword">self</span>.fin_loc(loc),</span><br><span class="line">        &#125;))</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">ahead_is_regexp_start</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) -&gt; <span class="built_in">bool</span> &#123;</span><br><span class="line">        <span class="keyword">match</span> <span class="keyword">self</span>.src.peek() &#123;</span><br><span class="line">            <span class="literal">Some</span>(<span class="string">'/'</span>) =&gt; <span class="keyword">self</span>.tok.is_before_expr(),</span><br><span class="line">            _ =&gt; <span class="literal">false</span>,</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">ahead_is_regexp_backslash_seq</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) -&gt; <span class="built_in">bool</span> &#123;</span><br><span class="line">        <span class="keyword">match</span> <span class="keyword">self</span>.src.peek() &#123;</span><br><span class="line">            <span class="literal">Some</span>(c) =&gt; c == <span class="string">'\\'</span>,</span><br><span class="line">            _ =&gt; <span class="literal">false</span>,</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">read_regexp_backslash_seq</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) -&gt; <span class="built_in">Result</span>&lt;<span class="built_in">String</span>, LexError&gt; &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut</span> ret = <span class="built_in">vec!</span>[<span class="keyword">self</span>.src.read().unwrap()];</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">self</span>.ahead_is_line_terminator_or_eof() &#123;</span><br><span class="line">            <span class="literal">Err</span>(LexError::new(<span class="keyword">self</span>.errmsg()))</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            ret.push(<span class="keyword">self</span>.src.read().unwrap());</span><br><span class="line">            <span class="literal">Ok</span>(ret.into_iter().collect())</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">ahead_is_regexp_class</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) -&gt; <span class="built_in">bool</span> &#123;</span><br><span class="line">        <span class="keyword">match</span> <span class="keyword">self</span>.src.peek() &#123;</span><br><span class="line">            <span class="literal">Some</span>(c) =&gt; c == <span class="string">'['</span>,</span><br><span class="line">            _ =&gt; <span class="literal">false</span>,</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">read_regexp_class</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) -&gt; <span class="built_in">Result</span>&lt;<span class="built_in">String</span>, LexError&gt; &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut</span> ret = <span class="built_in">vec!</span>[<span class="keyword">self</span>.src.read().unwrap()];</span><br><span class="line">        <span class="keyword">loop</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">self</span>.ahead_is_regexp_backslash_seq() &#123;</span><br><span class="line">                <span class="keyword">match</span> <span class="keyword">self</span>.read_regexp_backslash_seq() &#123;</span><br><span class="line">                    <span class="literal">Ok</span>(s) =&gt; ret.extend(s.chars()),</span><br><span class="line">                    <span class="literal">Err</span>(e) =&gt; <span class="keyword">return</span> <span class="literal">Err</span>(e),</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> <span class="keyword">self</span>.ahead_is_line_terminator_or_eof() &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">Err</span>(LexError::new(<span class="keyword">self</span>.errmsg()));</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">let</span> c = <span class="keyword">self</span>.src.read().unwrap();</span><br><span class="line">                ret.push(c);</span><br><span class="line">                <span class="keyword">if</span> c == <span class="string">']'</span> &#123;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="literal">Ok</span>(ret.into_iter().collect())</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">read_regexp_body</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) -&gt; <span class="built_in">Result</span>&lt;<span class="built_in">String</span>, LexError&gt; &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut</span> ret = <span class="built_in">vec!</span>[<span class="keyword">self</span>.src.read().unwrap()];</span><br><span class="line">        <span class="keyword">loop</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">self</span>.ahead_is_regexp_backslash_seq() &#123;</span><br><span class="line">                <span class="keyword">match</span> <span class="keyword">self</span>.read_regexp_backslash_seq() &#123;</span><br><span class="line">                    <span class="literal">Ok</span>(s) =&gt; ret.extend(s.chars()),</span><br><span class="line">                    <span class="literal">Err</span>(e) =&gt; <span class="keyword">return</span> <span class="literal">Err</span>(e),</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> <span class="keyword">self</span>.ahead_is_regexp_class() &#123;</span><br><span class="line">                <span class="keyword">match</span> <span class="keyword">self</span>.read_regexp_class() &#123;</span><br><span class="line">                    <span class="literal">Ok</span>(s) =&gt; ret.extend(s.chars()),</span><br><span class="line">                    <span class="literal">Err</span>(e) =&gt; <span class="keyword">return</span> <span class="literal">Err</span>(e),</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> <span class="keyword">self</span>.ahead_is_line_terminator_or_eof() &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">Err</span>(LexError::new(<span class="keyword">self</span>.errmsg()));</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">let</span> c = <span class="keyword">self</span>.src.read().unwrap();</span><br><span class="line">                ret.push(c);</span><br><span class="line">                <span class="keyword">if</span> c == <span class="string">'/'</span> &#123;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="literal">Ok</span>(ret.into_iter().collect())</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">read_regexp_flags</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) -&gt; <span class="built_in">Result</span>&lt;<span class="built_in">String</span>, LexError&gt; &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut</span> ret = <span class="built_in">vec!</span>[];</span><br><span class="line">        <span class="keyword">loop</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">self</span>.ahead_is_id_part() &#123;</span><br><span class="line">                <span class="keyword">match</span> <span class="keyword">self</span>.read_id_part() &#123;</span><br><span class="line">                    <span class="literal">Ok</span>(s) =&gt; ret.extend(s.chars()),</span><br><span class="line">                    <span class="literal">Err</span>(e) =&gt; <span class="keyword">return</span> <span class="literal">Err</span>(e),</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="literal">Ok</span>(ret.into_iter().collect())</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 解析正则</span></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">read_regexp</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) -&gt; <span class="built_in">Result</span>&lt;Token, LexError&gt; &#123;</span><br><span class="line">        <span class="keyword">let</span> loc = <span class="keyword">self</span>.loc();</span><br><span class="line">        <span class="keyword">match</span> <span class="keyword">self</span>.read_regexp_body() &#123;</span><br><span class="line">            <span class="literal">Ok</span>(<span class="keyword">mut</span> body) =&gt; <span class="keyword">match</span> <span class="keyword">self</span>.read_regexp_flags() &#123;</span><br><span class="line">                <span class="literal">Ok</span>(flags) =&gt; &#123;</span><br><span class="line">                    body.push_str(flags.as_str());</span><br><span class="line">                    <span class="literal">Ok</span>(Token::RegExpLiteral(RegExpLiteralData &#123;</span><br><span class="line">                        value: body,</span><br><span class="line">                        loc: <span class="keyword">self</span>.fin_loc(loc),</span><br><span class="line">                    &#125;))</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="literal">Err</span>(e) =&gt; <span class="literal">Err</span>(e),</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="literal">Err</span>(e) =&gt; <span class="literal">Err</span>(e),</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 解析符号</span></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">read_symbol</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) -&gt; <span class="built_in">Result</span>&lt;Token, LexError&gt; &#123;</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">self</span>.ahead_is_regexp_start() &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">self</span>.read_regexp();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">let</span> loc = <span class="keyword">self</span>.loc();</span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut</span> s = <span class="built_in">vec!</span>[];</span><br><span class="line">        <span class="keyword">loop</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">self</span>.ahead_is_whitespace_or_eof() &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">let</span> c = <span class="keyword">self</span>.src.peek().unwrap();</span><br><span class="line">            <span class="keyword">match</span> c &#123;</span><br><span class="line">                <span class="string">'&#123;'</span> | <span class="string">'&#125;'</span> | <span class="string">'('</span> | <span class="string">')'</span> | <span class="string">'['</span> | <span class="string">']'</span> | <span class="string">'.'</span> | <span class="string">';'</span> | <span class="string">','</span> | <span class="string">'?'</span> | <span class="string">':'</span> =&gt; &#123;</span><br><span class="line">                    s.push(<span class="keyword">self</span>.src.read().unwrap());</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="string">'&lt;'</span> =&gt; &#123;</span><br><span class="line">                    <span class="comment">// &lt; &lt;&lt;= &lt;&lt; &lt;=</span></span><br><span class="line">                    s.push(<span class="keyword">self</span>.src.read().unwrap());</span><br><span class="line">                    <span class="keyword">if</span> <span class="keyword">self</span>.src.test_ahead2(<span class="string">'&lt;'</span>, <span class="string">'='</span>) &#123;</span><br><span class="line">                        s.push(<span class="keyword">self</span>.src.read().unwrap());</span><br><span class="line">                        s.push(<span class="keyword">self</span>.src.read().unwrap());</span><br><span class="line">                    &#125; <span class="keyword">else</span> <span class="keyword">if</span> <span class="keyword">self</span>.src.test_ahead_or(<span class="string">'&lt;'</span>, <span class="string">'='</span>) &#123;</span><br><span class="line">                        s.push(<span class="keyword">self</span>.src.read().unwrap());</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="string">'&gt;'</span> =&gt; &#123;</span><br><span class="line">                    <span class="comment">// &gt; &gt;&gt;&gt;= &gt;&gt;= &gt;&gt; &gt;=</span></span><br><span class="line">                    s.push(<span class="keyword">self</span>.src.read().unwrap());</span><br><span class="line">                    <span class="keyword">if</span> <span class="keyword">self</span>.src.test_ahead3(<span class="string">'&gt;'</span>, <span class="string">'&gt;'</span>, <span class="string">'='</span>) &#123;</span><br><span class="line">                        s.push(<span class="keyword">self</span>.src.read().unwrap());</span><br><span class="line">                        s.push(<span class="keyword">self</span>.src.read().unwrap());</span><br><span class="line">                        s.push(<span class="keyword">self</span>.src.read().unwrap());</span><br><span class="line">                    &#125; <span class="keyword">else</span> <span class="keyword">if</span> <span class="keyword">self</span>.src.test_ahead2(<span class="string">'&gt;'</span>, <span class="string">'='</span>) &#123;</span><br><span class="line">                        s.push(<span class="keyword">self</span>.src.read().unwrap());</span><br><span class="line">                        s.push(<span class="keyword">self</span>.src.read().unwrap());</span><br><span class="line">                    &#125; <span class="keyword">else</span> <span class="keyword">if</span> <span class="keyword">self</span>.src.test_ahead_or(<span class="string">'&gt;'</span>, <span class="string">'='</span>) &#123;</span><br><span class="line">                        s.push(<span class="keyword">self</span>.src.read().unwrap());</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="string">'='</span> =&gt; &#123;</span><br><span class="line">                    <span class="comment">// = === ==</span></span><br><span class="line">                    s.push(<span class="keyword">self</span>.src.read().unwrap());</span><br><span class="line">                    <span class="keyword">if</span> <span class="keyword">self</span>.src.test_ahead2(<span class="string">'='</span>, <span class="string">'='</span>) &#123;</span><br><span class="line">                        s.push(<span class="keyword">self</span>.src.read().unwrap());</span><br><span class="line">                        s.push(<span class="keyword">self</span>.src.read().unwrap());</span><br><span class="line">                    &#125; <span class="keyword">else</span> <span class="keyword">if</span> <span class="keyword">self</span>.src.test_ahead(<span class="string">'='</span>) &#123;</span><br><span class="line">                        s.push(<span class="keyword">self</span>.src.read().unwrap());</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="string">'!'</span> =&gt; &#123;</span><br><span class="line">                    <span class="comment">// ! != !==</span></span><br><span class="line">                    s.push(<span class="keyword">self</span>.src.read().unwrap());</span><br><span class="line">                    <span class="keyword">if</span> <span class="keyword">self</span>.src.test_ahead2(<span class="string">'='</span>, <span class="string">'='</span>) &#123;</span><br><span class="line">                        s.push(<span class="keyword">self</span>.src.read().unwrap());</span><br><span class="line">                        s.push(<span class="keyword">self</span>.src.read().unwrap());</span><br><span class="line">                    &#125; <span class="keyword">else</span> <span class="keyword">if</span> <span class="keyword">self</span>.src.test_ahead(<span class="string">'='</span>) &#123;</span><br><span class="line">                        s.push(<span class="keyword">self</span>.src.read().unwrap());</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="string">'+'</span> =&gt; &#123;</span><br><span class="line">                    <span class="comment">// + ++ +=</span></span><br><span class="line">                    s.push(<span class="keyword">self</span>.src.read().unwrap());</span><br><span class="line">                    <span class="keyword">if</span> <span class="keyword">self</span>.src.test_ahead_or(<span class="string">'+'</span>, <span class="string">'='</span>) &#123;</span><br><span class="line">                        s.push(<span class="keyword">self</span>.src.read().unwrap());</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="string">'-'</span> =&gt; &#123;</span><br><span class="line">                    <span class="comment">// - -- -=</span></span><br><span class="line">                    s.push(<span class="keyword">self</span>.src.read().unwrap());</span><br><span class="line">                    <span class="keyword">if</span> <span class="keyword">self</span>.src.test_ahead_or(<span class="string">'-'</span>, <span class="string">'='</span>) &#123;</span><br><span class="line">                        s.push(<span class="keyword">self</span>.src.read().unwrap());</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="string">'&amp;'</span> =&gt; &#123;</span><br><span class="line">                    <span class="comment">// &amp; &amp;&amp; &amp;=</span></span><br><span class="line">                    s.push(<span class="keyword">self</span>.src.read().unwrap());</span><br><span class="line">                    <span class="keyword">if</span> <span class="keyword">self</span>.src.test_ahead_or(<span class="string">'&amp;'</span>, <span class="string">'='</span>) &#123;</span><br><span class="line">                        s.push(<span class="keyword">self</span>.src.read().unwrap());</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="string">'|'</span> =&gt; &#123;</span><br><span class="line">                    <span class="comment">// | || |=</span></span><br><span class="line">                    s.push(<span class="keyword">self</span>.src.read().unwrap());</span><br><span class="line">                    <span class="keyword">if</span> <span class="keyword">self</span>.src.test_ahead_or(<span class="string">'|'</span>, <span class="string">'='</span>) &#123;</span><br><span class="line">                        s.push(<span class="keyword">self</span>.src.read().unwrap());</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="string">'*'</span> | <span class="string">'/'</span> | <span class="string">'%'</span> | <span class="string">'^'</span> | <span class="string">'~'</span> =&gt; &#123;</span><br><span class="line">                    <span class="comment">// pattern pattern=</span></span><br><span class="line">                    s.push(<span class="keyword">self</span>.src.read().unwrap());</span><br><span class="line">                    <span class="keyword">if</span> <span class="keyword">self</span>.src.test_ahead(<span class="string">'='</span>) &#123;</span><br><span class="line">                        s.push(<span class="keyword">self</span>.src.read().unwrap());</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                _ =&gt; <span class="keyword">return</span> <span class="literal">Err</span>(LexError::new(<span class="keyword">self</span>.errmsg())),</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">let</span> s: <span class="built_in">String</span> = s.into_iter().collect();</span><br><span class="line">        <span class="keyword">if</span> is_symbol(&amp;s) &#123;</span><br><span class="line">            <span class="literal">Ok</span>(Token::Symbol(SymbolData &#123;</span><br><span class="line">                kind: name_to_symbol(&amp;s),</span><br><span class="line">                loc: <span class="keyword">self</span>.fin_loc(loc),</span><br><span class="line">            &#125;))</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="literal">Err</span>(LexError::new(<span class="keyword">self</span>.errmsg()))</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 跳过注释</span></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">skip_comment_single</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) &#123;</span><br><span class="line">        <span class="keyword">self</span>.src.advance2();</span><br><span class="line">        <span class="keyword">loop</span> &#123;</span><br><span class="line">            <span class="keyword">match</span> <span class="keyword">self</span>.src.read() &#123;</span><br><span class="line">                <span class="literal">Some</span>(EOL) | <span class="literal">None</span> =&gt; <span class="keyword">break</span>,</span><br><span class="line">                _ =&gt; (),</span><br><span class="line">            &#125;;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">skip_comment_multi</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) &#123;</span><br><span class="line">        <span class="keyword">self</span>.src.advance2();</span><br><span class="line">        <span class="keyword">loop</span> &#123;</span><br><span class="line">            <span class="keyword">match</span> <span class="keyword">self</span>.src.read() &#123;</span><br><span class="line">                <span class="literal">Some</span>(<span class="string">'*'</span>) =&gt; &#123;</span><br><span class="line">                    <span class="keyword">if</span> <span class="keyword">self</span>.src.test_ahead(<span class="string">'/'</span>) &#123;</span><br><span class="line">                        <span class="keyword">self</span>.src.advance();</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="literal">None</span> =&gt; <span class="keyword">break</span>,</span><br><span class="line">                _ =&gt; (),</span><br><span class="line">            &#125;;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">ahead_is_line_terminator_or_eof</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) -&gt; <span class="built_in">bool</span> &#123;</span><br><span class="line">        <span class="keyword">match</span> <span class="keyword">self</span>.src.peek() &#123;</span><br><span class="line">            <span class="literal">Some</span>(c) =&gt; is_line_terminator(c),</span><br><span class="line">            _ =&gt; <span class="literal">true</span>,</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">ahead_is_eof</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) -&gt; <span class="built_in">bool</span> &#123;</span><br><span class="line">        <span class="keyword">match</span> <span class="keyword">self</span>.src.peek() &#123;</span><br><span class="line">            <span class="literal">Some</span>(_) =&gt; <span class="literal">false</span>,</span><br><span class="line">            _ =&gt; <span class="literal">true</span>,</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">ahead_is_whitespace</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) -&gt; <span class="built_in">bool</span> &#123;</span><br><span class="line">        <span class="keyword">match</span> <span class="keyword">self</span>.src.peek() &#123;</span><br><span class="line">            <span class="literal">Some</span>(c) =&gt; is_whitespace(c),</span><br><span class="line">            _ =&gt; <span class="literal">false</span>,</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">ahead_is_whitespace_or_line_terminator</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) -&gt; <span class="built_in">bool</span> &#123;</span><br><span class="line">        <span class="keyword">match</span> <span class="keyword">self</span>.src.peek() &#123;</span><br><span class="line">            <span class="literal">Some</span>(c) =&gt; c.is_whitespace(),</span><br><span class="line">            _ =&gt; <span class="literal">false</span>,</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">ahead_is_whitespace_or_eof</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) -&gt; <span class="built_in">bool</span> &#123;</span><br><span class="line">        <span class="keyword">match</span> <span class="keyword">self</span>.src.peek() &#123;</span><br><span class="line">            <span class="literal">Some</span>(c) =&gt; is_whitespace(c),</span><br><span class="line">            _ =&gt; <span class="literal">true</span>,</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 跳过空白字符</span></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">skip_whitespace</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) &#123;</span><br><span class="line">        <span class="keyword">loop</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">self</span>.ahead_is_whitespace_or_line_terminator() &#123;</span><br><span class="line">                <span class="keyword">self</span>.src.read();</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> <span class="keyword">self</span>.src.test_ahead2(<span class="string">'/'</span>, <span class="string">'/'</span>) &#123;</span><br><span class="line">                <span class="keyword">self</span>.skip_comment_single();</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> <span class="keyword">self</span>.src.test_ahead2(<span class="string">'/'</span>, <span class="string">'*'</span>) &#123;</span><br><span class="line">                <span class="keyword">self</span>.skip_comment_multi();</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="语法解析"><a href="#语法解析" class="headerlink" title="语法解析"></a>语法解析</h1><h2 id="AST"><a href="#AST" class="headerlink" title="AST"></a>AST</h2><p>语法分析的最终产物就是 ast，因此我们需要先设计出我的 ast，然后才能进一步设计我们的 parser。</p>
<p>我们的 ast 将会包含 Prog，Stmt，Expr 以及字面量。首先我们来设计字面量，即用于描述不同数据类型的值：</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 字面量，用于描述不同数据类型的值</span></span><br><span class="line"><span class="meta">#[derive(Debug)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">struct</span> <span class="title">RegExpData</span></span> &#123;</span><br><span class="line">    <span class="keyword">pub</span> loc: SourceLoc,</span><br><span class="line">    <span class="keyword">pub</span> value: <span class="built_in">String</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> RegExpData &#123;</span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">new</span></span>(loc: SourceLoc, value: <span class="built_in">String</span>) -&gt; <span class="keyword">Self</span> &#123;</span><br><span class="line">        RegExpData &#123; loc, value &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[derive(Debug)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">struct</span> <span class="title">NullData</span></span> &#123;</span><br><span class="line">    <span class="keyword">pub</span> loc: SourceLoc,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> NullData &#123;</span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">new</span></span>(loc: SourceLoc) -&gt; <span class="keyword">Self</span> &#123;</span><br><span class="line">        NullData &#123; loc &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[derive(Debug)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">struct</span> <span class="title">UndefData</span></span> &#123;</span><br><span class="line">    <span class="keyword">pub</span> loc: SourceLoc,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> UndefData &#123;</span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">new</span></span>(loc: SourceLoc) -&gt; <span class="keyword">Self</span> &#123;</span><br><span class="line">        UndefData &#123; loc &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[derive(Debug)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">struct</span> <span class="title">StringData</span></span> &#123;</span><br><span class="line">    <span class="keyword">pub</span> loc: SourceLoc,</span><br><span class="line">    <span class="keyword">pub</span> value: <span class="built_in">String</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> StringData &#123;</span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">new</span></span>(loc: SourceLoc, value: <span class="built_in">String</span>) -&gt; <span class="keyword">Self</span> &#123;</span><br><span class="line">        StringData &#123; loc, value &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[derive(Debug)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">struct</span> <span class="title">BoolData</span></span> &#123;</span><br><span class="line">    <span class="keyword">pub</span> loc: SourceLoc,</span><br><span class="line">    <span class="keyword">pub</span> value: <span class="built_in">bool</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> BoolData &#123;</span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">new</span></span>(loc: SourceLoc, value: <span class="built_in">bool</span>) -&gt; <span class="keyword">Self</span> &#123;</span><br><span class="line">        BoolData &#123; loc, value &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[derive(Debug)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">struct</span> <span class="title">NumericData</span></span> &#123;</span><br><span class="line">    <span class="keyword">pub</span> loc: SourceLoc,</span><br><span class="line">    <span class="keyword">pub</span> value: <span class="built_in">String</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> NumericData &#123;</span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">new</span></span>(loc: SourceLoc, value: <span class="built_in">String</span>) -&gt; <span class="keyword">Self</span> &#123;</span><br><span class="line">        NumericData &#123; loc, value &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[derive(Debug)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">enum</span> <span class="title">Literal</span></span> &#123;</span><br><span class="line">    RegExp(RegExpData),</span><br><span class="line">    Null(NullData),</span><br><span class="line">    Undef(UndefData),</span><br><span class="line">    <span class="built_in">String</span>(StringData),</span><br><span class="line">    Bool(BoolData),</span><br><span class="line">    Numeric(NumericData),</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> Literal &#123;</span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">is_regexp</span></span>(&amp;<span class="keyword">self</span>) -&gt; <span class="built_in">bool</span> &#123;</span><br><span class="line">        <span class="keyword">match</span> <span class="keyword">self</span> &#123;</span><br><span class="line">            Literal::RegExp(_) =&gt; <span class="literal">true</span>,</span><br><span class="line">            _ =&gt; <span class="literal">false</span>,</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">is_null</span></span>(&amp;<span class="keyword">self</span>) -&gt; <span class="built_in">bool</span> &#123;</span><br><span class="line">        <span class="keyword">match</span> <span class="keyword">self</span> &#123;</span><br><span class="line">            Literal::Null(_) =&gt; <span class="literal">true</span>,</span><br><span class="line">            _ =&gt; <span class="literal">false</span>,</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">is_str</span></span>(&amp;<span class="keyword">self</span>) -&gt; <span class="built_in">bool</span> &#123;</span><br><span class="line">        <span class="keyword">match</span> <span class="keyword">self</span> &#123;</span><br><span class="line">            Literal::<span class="built_in">String</span>(_) =&gt; <span class="literal">true</span>,</span><br><span class="line">            _ =&gt; <span class="literal">false</span>,</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">is_bool</span></span>(&amp;<span class="keyword">self</span>) -&gt; <span class="built_in">bool</span> &#123;</span><br><span class="line">        <span class="keyword">match</span> <span class="keyword">self</span> &#123;</span><br><span class="line">            Literal::Bool(_) =&gt; <span class="literal">true</span>,</span><br><span class="line">            _ =&gt; <span class="literal">false</span>,</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">is_num</span></span>(&amp;<span class="keyword">self</span>) -&gt; <span class="built_in">bool</span> &#123;</span><br><span class="line">        <span class="keyword">match</span> <span class="keyword">self</span> &#123;</span><br><span class="line">            Literal::Numeric(_) =&gt; <span class="literal">true</span>,</span><br><span class="line">            _ =&gt; <span class="literal">false</span>,</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">regexp</span></span>(&amp;<span class="keyword">self</span>) -&gt; &amp;RegExpData &#123;</span><br><span class="line">        <span class="keyword">match</span> <span class="keyword">self</span> &#123;</span><br><span class="line">            Literal::RegExp(d) =&gt; d,</span><br><span class="line">            _ =&gt; <span class="built_in">panic!</span>(),</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">null</span></span>(&amp;<span class="keyword">self</span>) -&gt; &amp;NullData &#123;</span><br><span class="line">        <span class="keyword">match</span> <span class="keyword">self</span> &#123;</span><br><span class="line">            Literal::Null(d) =&gt; d,</span><br><span class="line">            _ =&gt; <span class="built_in">panic!</span>(),</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">str</span></span>(&amp;<span class="keyword">self</span>) -&gt; &amp;StringData &#123;</span><br><span class="line">        <span class="keyword">match</span> <span class="keyword">self</span> &#123;</span><br><span class="line">            Literal::<span class="built_in">String</span>(d) =&gt; d,</span><br><span class="line">            _ =&gt; <span class="built_in">panic!</span>(),</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">bool</span></span>(&amp;<span class="keyword">self</span>) -&gt; &amp;BoolData &#123;</span><br><span class="line">        <span class="keyword">match</span> <span class="keyword">self</span> &#123;</span><br><span class="line">            Literal::Bool(d) =&gt; d,</span><br><span class="line">            _ =&gt; <span class="built_in">panic!</span>(),</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">num</span></span>(&amp;<span class="keyword">self</span>) -&gt; &amp;NumericData &#123;</span><br><span class="line">        <span class="keyword">match</span> <span class="keyword">self</span> &#123;</span><br><span class="line">            Literal::Numeric(d) =&gt; d,</span><br><span class="line">            _ =&gt; <span class="built_in">panic!</span>(),</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">loc</span></span>(&amp;<span class="keyword">self</span>) -&gt; &amp;SourceLoc &#123;</span><br><span class="line">        <span class="keyword">match</span> <span class="keyword">self</span> &#123;</span><br><span class="line">            Literal::RegExp(d) =&gt; &amp;d.loc,</span><br><span class="line">            Literal::Null(d) =&gt; &amp;d.loc,</span><br><span class="line">            Literal::Undef(d) =&gt; &amp;d.loc,</span><br><span class="line">            Literal::Numeric(d) =&gt; &amp;d.loc,</span><br><span class="line">            Literal::<span class="built_in">String</span>(d) =&gt; &amp;d.loc,</span><br><span class="line">            Literal::Bool(d) =&gt; &amp;d.loc,</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="built_in">From</span>&lt;RegExpData&gt; <span class="keyword">for</span> Literal &#123;</span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">from</span></span>(f: RegExpData) -&gt; <span class="keyword">Self</span> &#123;</span><br><span class="line">        Literal::RegExp(f)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="built_in">From</span>&lt;NullData&gt; <span class="keyword">for</span> Literal &#123;</span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">from</span></span>(f: NullData) -&gt; <span class="keyword">Self</span> &#123;</span><br><span class="line">        Literal::Null(f)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="built_in">From</span>&lt;UndefData&gt; <span class="keyword">for</span> Literal &#123;</span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">from</span></span>(f: UndefData) -&gt; <span class="keyword">Self</span> &#123;</span><br><span class="line">        Literal::Undef(f)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="built_in">From</span>&lt;StringData&gt; <span class="keyword">for</span> Literal &#123;</span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">from</span></span>(f: StringData) -&gt; <span class="keyword">Self</span> &#123;</span><br><span class="line">        Literal::<span class="built_in">String</span>(f)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="built_in">From</span>&lt;BoolData&gt; <span class="keyword">for</span> Literal &#123;</span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">from</span></span>(f: BoolData) -&gt; <span class="keyword">Self</span> &#123;</span><br><span class="line">        Literal::Bool(f)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="built_in">From</span>&lt;NumericData&gt; <span class="keyword">for</span> Literal &#123;</span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">from</span></span>(f: NumericData) -&gt; <span class="keyword">Self</span> &#123;</span><br><span class="line">        Literal::Numeric(f)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>下一步实现 Expr，即表达式，比如赋值，创建变量等行为：</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// 表达式</span></span><br><span class="line"><span class="meta">#[derive(Debug)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">struct</span> <span class="title">ThisExprData</span></span> &#123;</span><br><span class="line">    <span class="keyword">pub</span> loc: SourceLoc,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> ThisExprData &#123;</span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">new</span></span>(loc: SourceLoc) -&gt; <span class="keyword">Self</span> &#123;</span><br><span class="line">        ThisExprData &#123; loc &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[derive(Debug)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">struct</span> <span class="title">IdData</span></span> &#123;</span><br><span class="line">    <span class="keyword">pub</span> loc: SourceLoc,</span><br><span class="line">    <span class="keyword">pub</span> name: <span class="built_in">String</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> IdData &#123;</span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">new</span></span>(loc: SourceLoc, name: <span class="built_in">String</span>) -&gt; <span class="keyword">Self</span> &#123;</span><br><span class="line">        IdData &#123; loc, name &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[derive(Debug)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">struct</span> <span class="title">ArrayData</span></span> &#123;</span><br><span class="line">    <span class="keyword">pub</span> loc: SourceLoc,</span><br><span class="line">    <span class="keyword">pub</span> value: <span class="built_in">Vec</span>&lt;Expr&gt;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[derive(Debug)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">struct</span> <span class="title">ObjectProperty</span></span> &#123;</span><br><span class="line">    <span class="keyword">pub</span> loc: SourceLoc,</span><br><span class="line">    <span class="keyword">pub</span> key: Expr,</span><br><span class="line">    <span class="keyword">pub</span> value: Expr,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[derive(Debug)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">struct</span> <span class="title">ObjectData</span></span> &#123;</span><br><span class="line">    <span class="keyword">pub</span> loc: SourceLoc,</span><br><span class="line">    <span class="keyword">pub</span> properties: <span class="built_in">Vec</span>&lt;ObjectProperty&gt;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[derive(Debug)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">struct</span> <span class="title">ParenData</span></span> &#123;</span><br><span class="line">    <span class="keyword">pub</span> loc: SourceLoc,</span><br><span class="line">    <span class="keyword">pub</span> value: Expr,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[derive(Debug)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">struct</span> <span class="title">FnDec</span></span> &#123;</span><br><span class="line">    <span class="keyword">pub</span> loc: SourceLoc,</span><br><span class="line">    <span class="keyword">pub</span> id: <span class="built_in">Option</span>&lt;PrimaryExpr&gt;,</span><br><span class="line">    <span class="keyword">pub</span> params: <span class="built_in">Vec</span>&lt;PrimaryExpr&gt;,</span><br><span class="line">    <span class="keyword">pub</span> body: Stmt,</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 基本表达式</span></span><br><span class="line"><span class="meta">#[derive(Debug)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">enum</span> <span class="title">PrimaryExpr</span></span> &#123;</span><br><span class="line">    <span class="comment">// this.fn = b</span></span><br><span class="line">    This(ThisExprData),</span><br><span class="line">    Identifier(IdData),</span><br><span class="line">    Literal(Literal),</span><br><span class="line">    <span class="comment">// [1,2,3]</span></span><br><span class="line">    ArrayLiteral(ArrayData),</span><br><span class="line">    ObjectLiteral(ObjectData),</span><br><span class="line">    Parenthesized(ParenData),</span><br><span class="line">    Function(Rc&lt;FnDec&gt;),</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> PrimaryExpr &#123;</span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">is_id</span></span>(&amp;<span class="keyword">self</span>) -&gt; <span class="built_in">bool</span> &#123;</span><br><span class="line">        <span class="keyword">match</span> <span class="keyword">self</span> &#123;</span><br><span class="line">            PrimaryExpr::Identifier(_) =&gt; <span class="literal">true</span>,</span><br><span class="line">            _ =&gt; <span class="literal">false</span>,</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">is_this</span></span>(&amp;<span class="keyword">self</span>) -&gt; <span class="built_in">bool</span> &#123;</span><br><span class="line">        <span class="keyword">match</span> <span class="keyword">self</span> &#123;</span><br><span class="line">            PrimaryExpr::This(_) =&gt; <span class="literal">true</span>,</span><br><span class="line">            _ =&gt; <span class="literal">false</span>,</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">is_literal</span></span>(&amp;<span class="keyword">self</span>) -&gt; <span class="built_in">bool</span> &#123;</span><br><span class="line">        <span class="keyword">match</span> <span class="keyword">self</span> &#123;</span><br><span class="line">            PrimaryExpr::Literal(_) =&gt; <span class="literal">true</span>,</span><br><span class="line">            _ =&gt; <span class="literal">false</span>,</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">is_array</span></span>(&amp;<span class="keyword">self</span>) -&gt; <span class="built_in">bool</span> &#123;</span><br><span class="line">        <span class="keyword">match</span> <span class="keyword">self</span> &#123;</span><br><span class="line">            PrimaryExpr::ArrayLiteral(_) =&gt; <span class="literal">true</span>,</span><br><span class="line">            _ =&gt; <span class="literal">false</span>,</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">is_object</span></span>(&amp;<span class="keyword">self</span>) -&gt; <span class="built_in">bool</span> &#123;</span><br><span class="line">        <span class="keyword">match</span> <span class="keyword">self</span> &#123;</span><br><span class="line">            PrimaryExpr::ObjectLiteral(_) =&gt; <span class="literal">true</span>,</span><br><span class="line">            _ =&gt; <span class="literal">false</span>,</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">is_paren</span></span>(&amp;<span class="keyword">self</span>) -&gt; <span class="built_in">bool</span> &#123;</span><br><span class="line">        <span class="keyword">match</span> <span class="keyword">self</span> &#123;</span><br><span class="line">            PrimaryExpr::Parenthesized(_) =&gt; <span class="literal">true</span>,</span><br><span class="line">            _ =&gt; <span class="literal">false</span>,</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">is_fn</span></span>(&amp;<span class="keyword">self</span>) -&gt; <span class="built_in">bool</span> &#123;</span><br><span class="line">        <span class="keyword">match</span> <span class="keyword">self</span> &#123;</span><br><span class="line">            PrimaryExpr::Function(_) =&gt; <span class="literal">true</span>,</span><br><span class="line">            _ =&gt; <span class="literal">false</span>,</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">this</span></span>(&amp;<span class="keyword">self</span>) -&gt; &amp;ThisExprData &#123;</span><br><span class="line">        <span class="keyword">match</span> <span class="keyword">self</span> &#123;</span><br><span class="line">            PrimaryExpr::This(d) =&gt; d,</span><br><span class="line">            _ =&gt; <span class="built_in">panic!</span>(),</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">literal</span></span>(&amp;<span class="keyword">self</span>) -&gt; &amp;Literal &#123;</span><br><span class="line">        <span class="keyword">match</span> <span class="keyword">self</span> &#123;</span><br><span class="line">            PrimaryExpr::Literal(d) =&gt; d,</span><br><span class="line">            _ =&gt; <span class="built_in">panic!</span>(),</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">array</span></span>(&amp;<span class="keyword">self</span>) -&gt; &amp;ArrayData &#123;</span><br><span class="line">        <span class="keyword">match</span> <span class="keyword">self</span> &#123;</span><br><span class="line">            PrimaryExpr::ArrayLiteral(d) =&gt; d,</span><br><span class="line">            _ =&gt; <span class="built_in">panic!</span>(),</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">object</span></span>(&amp;<span class="keyword">self</span>) -&gt; &amp;ObjectData &#123;</span><br><span class="line">        <span class="keyword">match</span> <span class="keyword">self</span> &#123;</span><br><span class="line">            PrimaryExpr::ObjectLiteral(d) =&gt; d,</span><br><span class="line">            _ =&gt; <span class="built_in">panic!</span>(),</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">paren</span></span>(&amp;<span class="keyword">self</span>) -&gt; &amp;ParenData &#123;</span><br><span class="line">        <span class="keyword">match</span> <span class="keyword">self</span> &#123;</span><br><span class="line">            PrimaryExpr::Parenthesized(d) =&gt; d,</span><br><span class="line">            _ =&gt; <span class="built_in">panic!</span>(),</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">id</span></span>(&amp;<span class="keyword">self</span>) -&gt; &amp;IdData &#123;</span><br><span class="line">        <span class="keyword">match</span> <span class="keyword">self</span> &#123;</span><br><span class="line">            PrimaryExpr::Identifier(d) =&gt; d,</span><br><span class="line">            _ =&gt; <span class="built_in">panic!</span>(),</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">fn_expr</span></span>(&amp;<span class="keyword">self</span>) -&gt; &amp;Rc&lt;FnDec&gt; &#123;</span><br><span class="line">        <span class="keyword">match</span> <span class="keyword">self</span> &#123;</span><br><span class="line">            PrimaryExpr::Function(expr) =&gt; expr,</span><br><span class="line">            _ =&gt; <span class="built_in">panic!</span>(),</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">loc</span></span>(&amp;<span class="keyword">self</span>) -&gt; &amp;SourceLoc &#123;</span><br><span class="line">        <span class="keyword">match</span> <span class="keyword">self</span> &#123;</span><br><span class="line">            PrimaryExpr::This(d) =&gt; &amp;d.loc,</span><br><span class="line">            PrimaryExpr::Identifier(d) =&gt; &amp;d.loc,</span><br><span class="line">            PrimaryExpr::Literal(d) =&gt; &amp;d.loc(),</span><br><span class="line">            PrimaryExpr::ArrayLiteral(d) =&gt; &amp;d.loc,</span><br><span class="line">            PrimaryExpr::ObjectLiteral(d) =&gt; &amp;d.loc,</span><br><span class="line">            PrimaryExpr::Parenthesized(d) =&gt; &amp;d.loc,</span><br><span class="line">            PrimaryExpr::Function(d) =&gt; &amp;d.loc,</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="built_in">From</span>&lt;ThisExprData&gt; <span class="keyword">for</span> PrimaryExpr &#123;</span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">from</span></span>(f: ThisExprData) -&gt; <span class="keyword">Self</span> &#123;</span><br><span class="line">        PrimaryExpr::This(f)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="built_in">From</span>&lt;IdData&gt; <span class="keyword">for</span> PrimaryExpr &#123;</span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">from</span></span>(f: IdData) -&gt; <span class="keyword">Self</span> &#123;</span><br><span class="line">        PrimaryExpr::Identifier(f)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="built_in">From</span>&lt;Literal&gt; <span class="keyword">for</span> PrimaryExpr &#123;</span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">from</span></span>(f: Literal) -&gt; <span class="keyword">Self</span> &#123;</span><br><span class="line">        PrimaryExpr::Literal(f)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="built_in">From</span>&lt;StringData&gt; <span class="keyword">for</span> PrimaryExpr &#123;</span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">from</span></span>(f: StringData) -&gt; <span class="keyword">Self</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> node: Literal = f.into();</span><br><span class="line">        node.into()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="built_in">From</span>&lt;NullData&gt; <span class="keyword">for</span> PrimaryExpr &#123;</span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">from</span></span>(f: NullData) -&gt; <span class="keyword">Self</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> node: Literal = f.into();</span><br><span class="line">        node.into()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="built_in">From</span>&lt;UndefData&gt; <span class="keyword">for</span> PrimaryExpr &#123;</span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">from</span></span>(f: UndefData) -&gt; <span class="keyword">Self</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> node: Literal = f.into();</span><br><span class="line">        node.into()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="built_in">From</span>&lt;RegExpData&gt; <span class="keyword">for</span> PrimaryExpr &#123;</span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">from</span></span>(f: RegExpData) -&gt; <span class="keyword">Self</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> node: Literal = f.into();</span><br><span class="line">        node.into()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="built_in">From</span>&lt;BoolData&gt; <span class="keyword">for</span> PrimaryExpr &#123;</span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">from</span></span>(f: BoolData) -&gt; <span class="keyword">Self</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> node: Literal = f.into();</span><br><span class="line">        node.into()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="built_in">From</span>&lt;NumericData&gt; <span class="keyword">for</span> PrimaryExpr &#123;</span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">from</span></span>(f: NumericData) -&gt; <span class="keyword">Self</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> node: Literal = f.into();</span><br><span class="line">        node.into()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="built_in">From</span>&lt;ArrayData&gt; <span class="keyword">for</span> PrimaryExpr &#123;</span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">from</span></span>(f: ArrayData) -&gt; <span class="keyword">Self</span> &#123;</span><br><span class="line">        PrimaryExpr::ArrayLiteral(f)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="built_in">From</span>&lt;FnDec&gt; <span class="keyword">for</span> PrimaryExpr &#123;</span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">from</span></span>(f: FnDec) -&gt; <span class="keyword">Self</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> expr = Rc::new(f);</span><br><span class="line">        PrimaryExpr::Function(expr)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="built_in">From</span>&lt;ParenData&gt; <span class="keyword">for</span> PrimaryExpr &#123;</span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">from</span></span>(f: ParenData) -&gt; <span class="keyword">Self</span> &#123;</span><br><span class="line">        PrimaryExpr::Parenthesized(f)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[derive(Debug)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">struct</span> <span class="title">UnaryExpr</span></span> &#123;</span><br><span class="line">    <span class="keyword">pub</span> loc: SourceLoc,</span><br><span class="line">    <span class="keyword">pub</span> op: Token,</span><br><span class="line">    <span class="keyword">pub</span> argument: Expr,</span><br><span class="line">    <span class="keyword">pub</span> prefix: <span class="built_in">bool</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[derive(Debug)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">struct</span> <span class="title">BinaryExpr</span></span> &#123;</span><br><span class="line">    <span class="keyword">pub</span> loc: SourceLoc,</span><br><span class="line">    <span class="keyword">pub</span> op: Token,</span><br><span class="line">    <span class="keyword">pub</span> left: Expr,</span><br><span class="line">    <span class="keyword">pub</span> right: Expr,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[derive(Debug)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">struct</span> <span class="title">MemberExpr</span></span> &#123;</span><br><span class="line">    <span class="keyword">pub</span> loc: SourceLoc,</span><br><span class="line">    <span class="keyword">pub</span> object: Expr,</span><br><span class="line">    <span class="keyword">pub</span> property: Expr,</span><br><span class="line">    <span class="keyword">pub</span> computed: <span class="built_in">bool</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[derive(Debug)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">struct</span> <span class="title">NewExpr</span></span> &#123;</span><br><span class="line">    <span class="keyword">pub</span> loc: SourceLoc,</span><br><span class="line">    <span class="keyword">pub</span> callee: Expr,</span><br><span class="line">    <span class="keyword">pub</span> arguments: <span class="built_in">Vec</span>&lt;Expr&gt;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[derive(Debug)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">struct</span> <span class="title">CallExpr</span></span> &#123;</span><br><span class="line">    <span class="keyword">pub</span> loc: SourceLoc,</span><br><span class="line">    <span class="keyword">pub</span> callee: Expr,</span><br><span class="line">    <span class="keyword">pub</span> arguments: <span class="built_in">Vec</span>&lt;Expr&gt;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[derive(Debug)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">struct</span> <span class="title">CondExpr</span></span> &#123;</span><br><span class="line">    <span class="keyword">pub</span> loc: SourceLoc,</span><br><span class="line">    <span class="keyword">pub</span> test: Expr,</span><br><span class="line">    <span class="keyword">pub</span> cons: Expr,</span><br><span class="line">    <span class="keyword">pub</span> alt: Expr,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[derive(Debug)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">struct</span> <span class="title">AssignExpr</span></span> &#123;</span><br><span class="line">    <span class="keyword">pub</span> loc: SourceLoc,</span><br><span class="line">    <span class="keyword">pub</span> op: Token,</span><br><span class="line">    <span class="keyword">pub</span> left: Expr,</span><br><span class="line">    <span class="keyword">pub</span> right: Expr,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[derive(Debug)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">struct</span> <span class="title">SeqExpr</span></span> &#123;</span><br><span class="line">    <span class="keyword">pub</span> loc: SourceLoc,</span><br><span class="line">    <span class="keyword">pub</span> exprs: <span class="built_in">Vec</span>&lt;Expr&gt;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[derive(Debug, Clone)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">enum</span> <span class="title">Expr</span></span> &#123;</span><br><span class="line">    Primary(Rc&lt;PrimaryExpr&gt;),</span><br><span class="line">    <span class="comment">// func</span></span><br><span class="line">    Member(Rc&lt;MemberExpr&gt;),</span><br><span class="line">    <span class="comment">// new</span></span><br><span class="line">    New(Rc&lt;NewExpr&gt;),</span><br><span class="line">    <span class="comment">// func()</span></span><br><span class="line">    Call(Rc&lt;CallExpr&gt;),</span><br><span class="line">    <span class="comment">// "-" | "+" | "!" | "~" | "typeof" | "void" | "delete"</span></span><br><span class="line">    Unary(Rc&lt;UnaryExpr&gt;),</span><br><span class="line">    <span class="comment">// "==" | "!=" | "===" | "!=="  | "&lt;" | "&lt;=" | "&gt;" | "&gt;=" | "&lt;&lt;" | "&gt;&gt;" | "&gt;&gt;&gt;" | "+" | "-" | "*" | "**" | "/" | "%" | "|" | "^" | "&amp;" | "in" | "instanceof"</span></span><br><span class="line">    Binary(Rc&lt;BinaryExpr&gt;),</span><br><span class="line">    <span class="comment">// "=" | "+=" | "-=" | "*=" | "**=" | "/=" | "%=" | "&lt;&lt;=" | "&gt;&gt;=" | "&gt;&gt;&gt;=" | "|=" | "^=" | "&amp;=" | "||=" | "&amp;&amp;=" | "??="</span></span><br><span class="line">    Assignment(Rc&lt;AssignExpr&gt;),</span><br><span class="line">    <span class="comment">// isMember ? '$2.00' : '$10.00';</span></span><br><span class="line">    Conditional(Rc&lt;CondExpr&gt;),</span><br><span class="line">    Sequence(Rc&lt;SeqExpr&gt;),</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> Expr &#123;</span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">is_unary</span></span>(&amp;<span class="keyword">self</span>) -&gt; <span class="built_in">bool</span> &#123;</span><br><span class="line">        <span class="keyword">match</span> <span class="keyword">self</span> &#123;</span><br><span class="line">            Expr::Unary(_) =&gt; <span class="literal">true</span>,</span><br><span class="line">            _ =&gt; <span class="literal">false</span>,</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">is_member</span></span>(&amp;<span class="keyword">self</span>) -&gt; <span class="built_in">bool</span> &#123;</span><br><span class="line">        <span class="keyword">match</span> <span class="keyword">self</span> &#123;</span><br><span class="line">            Expr::Member(_) =&gt; <span class="literal">true</span>,</span><br><span class="line">            _ =&gt; <span class="literal">false</span>,</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">is_new</span></span>(&amp;<span class="keyword">self</span>) -&gt; <span class="built_in">bool</span> &#123;</span><br><span class="line">        <span class="keyword">match</span> <span class="keyword">self</span> &#123;</span><br><span class="line">            Expr::New(_) =&gt; <span class="literal">true</span>,</span><br><span class="line">            _ =&gt; <span class="literal">false</span>,</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">is_call</span></span>(&amp;<span class="keyword">self</span>) -&gt; <span class="built_in">bool</span> &#123;</span><br><span class="line">        <span class="keyword">match</span> <span class="keyword">self</span> &#123;</span><br><span class="line">            Expr::Call(_) =&gt; <span class="literal">true</span>,</span><br><span class="line">            _ =&gt; <span class="literal">false</span>,</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">is_bin</span></span>(&amp;<span class="keyword">self</span>) -&gt; <span class="built_in">bool</span> &#123;</span><br><span class="line">        <span class="keyword">match</span> <span class="keyword">self</span> &#123;</span><br><span class="line">            Expr::Binary(_) =&gt; <span class="literal">true</span>,</span><br><span class="line">            _ =&gt; <span class="literal">false</span>,</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">is_cond</span></span>(&amp;<span class="keyword">self</span>) -&gt; <span class="built_in">bool</span> &#123;</span><br><span class="line">        <span class="keyword">match</span> <span class="keyword">self</span> &#123;</span><br><span class="line">            Expr::Conditional(_) =&gt; <span class="literal">true</span>,</span><br><span class="line">            _ =&gt; <span class="literal">false</span>,</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">is_assign</span></span>(&amp;<span class="keyword">self</span>) -&gt; <span class="built_in">bool</span> &#123;</span><br><span class="line">        <span class="keyword">match</span> <span class="keyword">self</span> &#123;</span><br><span class="line">            Expr::Assignment(_) =&gt; <span class="literal">true</span>,</span><br><span class="line">            _ =&gt; <span class="literal">false</span>,</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">is_seq</span></span>(&amp;<span class="keyword">self</span>) -&gt; <span class="built_in">bool</span> &#123;</span><br><span class="line">        <span class="keyword">match</span> <span class="keyword">self</span> &#123;</span><br><span class="line">            Expr::Sequence(_) =&gt; <span class="literal">true</span>,</span><br><span class="line">            _ =&gt; <span class="literal">false</span>,</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">primary</span></span>(&amp;<span class="keyword">self</span>) -&gt; &amp;PrimaryExpr &#123;</span><br><span class="line">        <span class="keyword">match</span> <span class="keyword">self</span> &#123;</span><br><span class="line">            Expr::Primary(expr) =&gt; expr,</span><br><span class="line">            _ =&gt; <span class="built_in">panic!</span>(),</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">member</span></span>(&amp;<span class="keyword">self</span>) -&gt; &amp;MemberExpr &#123;</span><br><span class="line">        <span class="keyword">match</span> <span class="keyword">self</span> &#123;</span><br><span class="line">            Expr::Member(expr) =&gt; expr,</span><br><span class="line">            _ =&gt; <span class="built_in">panic!</span>(),</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">unary</span></span>(&amp;<span class="keyword">self</span>) -&gt; &amp;UnaryExpr &#123;</span><br><span class="line">        <span class="keyword">match</span> <span class="keyword">self</span> &#123;</span><br><span class="line">            Expr::Unary(expr) =&gt; expr,</span><br><span class="line">            _ =&gt; <span class="built_in">panic!</span>(),</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">new_expr</span></span>(&amp;<span class="keyword">self</span>) -&gt; &amp;NewExpr &#123;</span><br><span class="line">        <span class="keyword">match</span> <span class="keyword">self</span> &#123;</span><br><span class="line">            Expr::New(expr) =&gt; expr,</span><br><span class="line">            _ =&gt; <span class="built_in">panic!</span>(),</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">call_expr</span></span>(&amp;<span class="keyword">self</span>) -&gt; &amp;CallExpr &#123;</span><br><span class="line">        <span class="keyword">match</span> <span class="keyword">self</span> &#123;</span><br><span class="line">            Expr::Call(expr) =&gt; expr,</span><br><span class="line">            _ =&gt; <span class="built_in">panic!</span>(),</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">bin_expr</span></span>(&amp;<span class="keyword">self</span>) -&gt; &amp;BinaryExpr &#123;</span><br><span class="line">        <span class="keyword">match</span> <span class="keyword">self</span> &#123;</span><br><span class="line">            Expr::Binary(expr) =&gt; expr,</span><br><span class="line">            _ =&gt; <span class="built_in">panic!</span>(),</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">cond_expr</span></span>(&amp;<span class="keyword">self</span>) -&gt; &amp;CondExpr &#123;</span><br><span class="line">        <span class="keyword">match</span> <span class="keyword">self</span> &#123;</span><br><span class="line">            Expr::Conditional(expr) =&gt; expr,</span><br><span class="line">            _ =&gt; <span class="built_in">panic!</span>(),</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">assign_expr</span></span>(&amp;<span class="keyword">self</span>) -&gt; &amp;AssignExpr &#123;</span><br><span class="line">        <span class="keyword">match</span> <span class="keyword">self</span> &#123;</span><br><span class="line">            Expr::Assignment(expr) =&gt; expr,</span><br><span class="line">            _ =&gt; <span class="built_in">panic!</span>(),</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">seq_expr</span></span>(&amp;<span class="keyword">self</span>) -&gt; &amp;SeqExpr &#123;</span><br><span class="line">        <span class="keyword">match</span> <span class="keyword">self</span> &#123;</span><br><span class="line">            Expr::Sequence(expr) =&gt; expr,</span><br><span class="line">            _ =&gt; <span class="built_in">panic!</span>(),</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="built_in">From</span>&lt;UnaryExpr&gt; <span class="keyword">for</span> Expr &#123;</span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">from</span></span>(f: UnaryExpr) -&gt; <span class="keyword">Self</span> &#123;</span><br><span class="line">        Expr::Unary(Rc::new(f))</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="built_in">From</span>&lt;PrimaryExpr&gt; <span class="keyword">for</span> Expr &#123;</span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">from</span></span>(f: PrimaryExpr) -&gt; <span class="keyword">Self</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> expr = Rc::new(f);</span><br><span class="line">        Expr::Primary(expr)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="built_in">From</span>&lt;NewExpr&gt; <span class="keyword">for</span> Expr &#123;</span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">from</span></span>(f: NewExpr) -&gt; <span class="keyword">Self</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> expr = Rc::new(f);</span><br><span class="line">        Expr::New(expr)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="built_in">From</span>&lt;CallExpr&gt; <span class="keyword">for</span> Expr &#123;</span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">from</span></span>(f: CallExpr) -&gt; <span class="keyword">Self</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> expr = Rc::new(f);</span><br><span class="line">        Expr::Call(expr)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="built_in">From</span>&lt;BinaryExpr&gt; <span class="keyword">for</span> Expr &#123;</span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">from</span></span>(f: BinaryExpr) -&gt; <span class="keyword">Self</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> expr = Rc::new(f);</span><br><span class="line">        Expr::Binary(expr)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="built_in">From</span>&lt;CondExpr&gt; <span class="keyword">for</span> Expr &#123;</span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">from</span></span>(f: CondExpr) -&gt; <span class="keyword">Self</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> expr = Rc::new(f);</span><br><span class="line">        Expr::Conditional(expr)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="built_in">From</span>&lt;AssignExpr&gt; <span class="keyword">for</span> Expr &#123;</span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">from</span></span>(f: AssignExpr) -&gt; <span class="keyword">Self</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> expr = Rc::new(f);</span><br><span class="line">        Expr::Assignment(expr)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="built_in">From</span>&lt;SeqExpr&gt; <span class="keyword">for</span> Expr &#123;</span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">from</span></span>(f: SeqExpr) -&gt; <span class="keyword">Self</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> expr = Rc::new(f);</span><br><span class="line">        Expr::Sequence(expr)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>最后我们来实现 Stmt，对语句范畴的定义描述，而 Prog 实际上就是 Stmt 的一个合集：</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// 对语句范畴的定义描述</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#[derive(Debug)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">struct</span> <span class="title">ExprStmt</span></span> &#123;</span><br><span class="line">    <span class="keyword">pub</span> expr: Expr,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[derive(Debug, Clone)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">struct</span> <span class="title">BlockStmt</span></span> &#123;</span><br><span class="line">    <span class="keyword">pub</span> loc: SourceLoc,</span><br><span class="line">    <span class="keyword">pub</span> body: <span class="built_in">Vec</span>&lt;Stmt&gt;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[derive(Debug)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">struct</span> <span class="title">VarDecor</span></span> &#123;</span><br><span class="line">    <span class="keyword">pub</span> id: PrimaryExpr,</span><br><span class="line">    <span class="keyword">pub</span> init: <span class="built_in">Option</span>&lt;Expr&gt;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[derive(Debug)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">struct</span> <span class="title">VarDec</span></span> &#123;</span><br><span class="line">    <span class="keyword">pub</span> loc: SourceLoc,</span><br><span class="line">    <span class="keyword">pub</span> decs: <span class="built_in">Vec</span>&lt;VarDecor&gt;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[derive(Debug)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">struct</span> <span class="title">EmptyStmt</span></span> &#123;</span><br><span class="line">    <span class="keyword">pub</span> loc: SourceLoc,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[derive(Debug)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">struct</span> <span class="title">IfStmt</span></span> &#123;</span><br><span class="line">    <span class="keyword">pub</span> loc: SourceLoc,</span><br><span class="line">    <span class="keyword">pub</span> test: Expr,</span><br><span class="line">    <span class="keyword">pub</span> cons: Stmt,</span><br><span class="line">    <span class="keyword">pub</span> alt: <span class="built_in">Option</span>&lt;Stmt&gt;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[derive(Debug)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">enum</span> <span class="title">ForFirst</span></span> &#123;</span><br><span class="line">    VarDec(Rc&lt;VarDec&gt;),</span><br><span class="line">    Expr(Expr),</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[derive(Debug)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">struct</span> <span class="title">ForStmt</span></span> &#123;</span><br><span class="line">    <span class="keyword">pub</span> loc: SourceLoc,</span><br><span class="line">    <span class="keyword">pub</span> init: <span class="built_in">Option</span>&lt;ForFirst&gt;,</span><br><span class="line">    <span class="keyword">pub</span> test: <span class="built_in">Option</span>&lt;Expr&gt;,</span><br><span class="line">    <span class="keyword">pub</span> update: <span class="built_in">Option</span>&lt;Expr&gt;,</span><br><span class="line">    <span class="keyword">pub</span> body: Stmt,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[derive(Debug)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">struct</span> <span class="title">ForInStmt</span></span> &#123;</span><br><span class="line">    <span class="keyword">pub</span> loc: SourceLoc,</span><br><span class="line">    <span class="keyword">pub</span> left: ForFirst,</span><br><span class="line">    <span class="keyword">pub</span> right: Expr,</span><br><span class="line">    <span class="keyword">pub</span> body: Stmt,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[derive(Debug)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">struct</span> <span class="title">DoWhileStmt</span></span> &#123;</span><br><span class="line">    <span class="keyword">pub</span> loc: SourceLoc,</span><br><span class="line">    <span class="keyword">pub</span> test: Expr,</span><br><span class="line">    <span class="keyword">pub</span> body: Stmt,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[derive(Debug)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">struct</span> <span class="title">WhileStmt</span></span> &#123;</span><br><span class="line">    <span class="keyword">pub</span> loc: SourceLoc,</span><br><span class="line">    <span class="keyword">pub</span> test: Expr,</span><br><span class="line">    <span class="keyword">pub</span> body: Stmt,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[derive(Debug)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">struct</span> <span class="title">ContStmt</span></span> &#123;</span><br><span class="line">    <span class="keyword">pub</span> loc: SourceLoc,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[derive(Debug)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">struct</span> <span class="title">BreakStmt</span></span> &#123;</span><br><span class="line">    <span class="keyword">pub</span> loc: SourceLoc,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[derive(Debug)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">struct</span> <span class="title">ReturnStmt</span></span> &#123;</span><br><span class="line">    <span class="keyword">pub</span> loc: SourceLoc,</span><br><span class="line">    <span class="keyword">pub</span> argument: <span class="built_in">Option</span>&lt;Expr&gt;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[derive(Debug)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">struct</span> <span class="title">WithStmt</span></span> &#123;</span><br><span class="line">    <span class="keyword">pub</span> loc: SourceLoc,</span><br><span class="line">    <span class="keyword">pub</span> object: Expr,</span><br><span class="line">    <span class="keyword">pub</span> body: Stmt,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[derive(Debug)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">struct</span> <span class="title">SwitchCase</span></span> &#123;</span><br><span class="line">    <span class="keyword">pub</span> test: <span class="built_in">Option</span>&lt;Expr&gt;,</span><br><span class="line">    <span class="keyword">pub</span> cons: <span class="built_in">Vec</span>&lt;Stmt&gt;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[derive(Debug)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">struct</span> <span class="title">SwitchStmt</span></span> &#123;</span><br><span class="line">    <span class="keyword">pub</span> loc: SourceLoc,</span><br><span class="line">    <span class="keyword">pub</span> discrim: Expr,</span><br><span class="line">    <span class="keyword">pub</span> cases: <span class="built_in">Vec</span>&lt;SwitchCase&gt;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[derive(Debug)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">struct</span> <span class="title">ThrowStmt</span></span> &#123;</span><br><span class="line">    <span class="keyword">pub</span> loc: SourceLoc,</span><br><span class="line">    <span class="keyword">pub</span> argument: Expr,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[derive(Debug)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">struct</span> <span class="title">CatchClause</span></span> &#123;</span><br><span class="line">    <span class="keyword">pub</span> id: PrimaryExpr,</span><br><span class="line">    <span class="keyword">pub</span> body: Stmt,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[derive(Debug)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">struct</span> <span class="title">TryStmt</span></span> &#123;</span><br><span class="line">    <span class="keyword">pub</span> loc: SourceLoc,</span><br><span class="line">    <span class="keyword">pub</span> block: Stmt,</span><br><span class="line">    <span class="keyword">pub</span> handler: <span class="built_in">Option</span>&lt;CatchClause&gt;,</span><br><span class="line">    <span class="keyword">pub</span> finalizer: <span class="built_in">Option</span>&lt;Stmt&gt;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[derive(Debug)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">struct</span> <span class="title">DebugStmt</span></span> &#123;</span><br><span class="line">    <span class="keyword">pub</span> loc: SourceLoc,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[derive(Debug, Clone)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">enum</span> <span class="title">Stmt</span></span> &#123;</span><br><span class="line">    Block(Rc&lt;BlockStmt&gt;),</span><br><span class="line">    VarDec(Rc&lt;VarDec&gt;),</span><br><span class="line">    Empty(Rc&lt;EmptyStmt&gt;),</span><br><span class="line">    Expr(Rc&lt;ExprStmt&gt;),</span><br><span class="line">    If(Rc&lt;IfStmt&gt;),</span><br><span class="line">    For(Rc&lt;ForStmt&gt;),</span><br><span class="line">    ForIn(Rc&lt;ForInStmt&gt;),</span><br><span class="line">    DoWhile(Rc&lt;DoWhileStmt&gt;),</span><br><span class="line">    While(Rc&lt;WhileStmt&gt;),</span><br><span class="line">    Cont(Rc&lt;ContStmt&gt;),</span><br><span class="line">    Break(Rc&lt;BreakStmt&gt;),</span><br><span class="line">    Return(Rc&lt;ReturnStmt&gt;),</span><br><span class="line">    With(Rc&lt;WithStmt&gt;),</span><br><span class="line">    Switch(Rc&lt;SwitchStmt&gt;),</span><br><span class="line">    Throw(Rc&lt;ThrowStmt&gt;),</span><br><span class="line">    Try(Rc&lt;TryStmt&gt;),</span><br><span class="line">    Debugger(Rc&lt;DebugStmt&gt;),</span><br><span class="line">    Function(Rc&lt;FnDec&gt;),</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="built_in">From</span>&lt;BlockStmt&gt; <span class="keyword">for</span> Stmt &#123;</span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">from</span></span>(f: BlockStmt) -&gt; <span class="keyword">Self</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> expr = Rc::new(f);</span><br><span class="line">        Stmt::Block(expr)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="built_in">From</span>&lt;ExprStmt&gt; <span class="keyword">for</span> Stmt &#123;</span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">from</span></span>(f: ExprStmt) -&gt; <span class="keyword">Self</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> expr = Rc::new(f);</span><br><span class="line">        Stmt::Expr(expr)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="built_in">From</span>&lt;VarDec&gt; <span class="keyword">for</span> Stmt &#123;</span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">from</span></span>(f: VarDec) -&gt; <span class="keyword">Self</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> expr = Rc::new(f);</span><br><span class="line">        Stmt::VarDec(expr)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="built_in">From</span>&lt;IfStmt&gt; <span class="keyword">for</span> Stmt &#123;</span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">from</span></span>(f: IfStmt) -&gt; <span class="keyword">Self</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> expr = Rc::new(f);</span><br><span class="line">        Stmt::If(expr)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="built_in">From</span>&lt;ForInStmt&gt; <span class="keyword">for</span> Stmt &#123;</span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">from</span></span>(f: ForInStmt) -&gt; <span class="keyword">Self</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> expr = Rc::new(f);</span><br><span class="line">        Stmt::ForIn(expr)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="built_in">From</span>&lt;ForStmt&gt; <span class="keyword">for</span> Stmt &#123;</span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">from</span></span>(f: ForStmt) -&gt; <span class="keyword">Self</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> expr = Rc::new(f);</span><br><span class="line">        Stmt::For(expr)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="built_in">From</span>&lt;DoWhileStmt&gt; <span class="keyword">for</span> Stmt &#123;</span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">from</span></span>(f: DoWhileStmt) -&gt; <span class="keyword">Self</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> expr = Rc::new(f);</span><br><span class="line">        Stmt::DoWhile(expr)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="built_in">From</span>&lt;WhileStmt&gt; <span class="keyword">for</span> Stmt &#123;</span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">from</span></span>(f: WhileStmt) -&gt; <span class="keyword">Self</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> expr = Rc::new(f);</span><br><span class="line">        Stmt::While(expr)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="built_in">From</span>&lt;ContStmt&gt; <span class="keyword">for</span> Stmt &#123;</span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">from</span></span>(f: ContStmt) -&gt; <span class="keyword">Self</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> expr = Rc::new(f);</span><br><span class="line">        Stmt::Cont(expr)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="built_in">From</span>&lt;BreakStmt&gt; <span class="keyword">for</span> Stmt &#123;</span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">from</span></span>(f: BreakStmt) -&gt; <span class="keyword">Self</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> expr = Rc::new(f);</span><br><span class="line">        Stmt::Break(expr)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="built_in">From</span>&lt;ReturnStmt&gt; <span class="keyword">for</span> Stmt &#123;</span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">from</span></span>(f: ReturnStmt) -&gt; <span class="keyword">Self</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> expr = Rc::new(f);</span><br><span class="line">        Stmt::Return(expr)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="built_in">From</span>&lt;EmptyStmt&gt; <span class="keyword">for</span> Stmt &#123;</span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">from</span></span>(f: EmptyStmt) -&gt; <span class="keyword">Self</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> expr = Rc::new(f);</span><br><span class="line">        Stmt::Empty(expr)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="built_in">From</span>&lt;WithStmt&gt; <span class="keyword">for</span> Stmt &#123;</span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">from</span></span>(f: WithStmt) -&gt; <span class="keyword">Self</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> expr = Rc::new(f);</span><br><span class="line">        Stmt::With(expr)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="built_in">From</span>&lt;SwitchStmt&gt; <span class="keyword">for</span> Stmt &#123;</span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">from</span></span>(f: SwitchStmt) -&gt; <span class="keyword">Self</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> expr = Rc::new(f);</span><br><span class="line">        Stmt::Switch(expr)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="built_in">From</span>&lt;DebugStmt&gt; <span class="keyword">for</span> Stmt &#123;</span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">from</span></span>(f: DebugStmt) -&gt; <span class="keyword">Self</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> expr = Rc::new(f);</span><br><span class="line">        Stmt::Debugger(expr)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="built_in">From</span>&lt;TryStmt&gt; <span class="keyword">for</span> Stmt &#123;</span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">from</span></span>(f: TryStmt) -&gt; <span class="keyword">Self</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> expr = Rc::new(f);</span><br><span class="line">        Stmt::Try(expr)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="built_in">From</span>&lt;ThrowStmt&gt; <span class="keyword">for</span> Stmt &#123;</span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">from</span></span>(f: ThrowStmt) -&gt; <span class="keyword">Self</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> expr = Rc::new(f);</span><br><span class="line">        Stmt::Throw(expr)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="built_in">From</span>&lt;FnDec&gt; <span class="keyword">for</span> Stmt &#123;</span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">from</span></span>(f: FnDec) -&gt; <span class="keyword">Self</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> expr = Rc::new(f);</span><br><span class="line">        Stmt::Function(expr)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> Stmt &#123;</span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">is_block</span></span>(&amp;<span class="keyword">self</span>) -&gt; <span class="built_in">bool</span> &#123;</span><br><span class="line">        <span class="keyword">match</span> <span class="keyword">self</span> &#123;</span><br><span class="line">            Stmt::Block(_) =&gt; <span class="literal">true</span>,</span><br><span class="line">            _ =&gt; <span class="literal">false</span>,</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">is_expr</span></span>(&amp;<span class="keyword">self</span>) -&gt; <span class="built_in">bool</span> &#123;</span><br><span class="line">        <span class="keyword">match</span> <span class="keyword">self</span> &#123;</span><br><span class="line">            Stmt::Expr(_) =&gt; <span class="literal">true</span>,</span><br><span class="line">            _ =&gt; <span class="literal">false</span>,</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">is_var</span></span>(&amp;<span class="keyword">self</span>) -&gt; <span class="built_in">bool</span> &#123;</span><br><span class="line">        <span class="keyword">match</span> <span class="keyword">self</span> &#123;</span><br><span class="line">            Stmt::VarDec(_) =&gt; <span class="literal">true</span>,</span><br><span class="line">            _ =&gt; <span class="literal">false</span>,</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">is_if</span></span>(&amp;<span class="keyword">self</span>) -&gt; <span class="built_in">bool</span> &#123;</span><br><span class="line">        <span class="keyword">match</span> <span class="keyword">self</span> &#123;</span><br><span class="line">            Stmt::If(_) =&gt; <span class="literal">true</span>,</span><br><span class="line">            _ =&gt; <span class="literal">false</span>,</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">is_for</span></span>(&amp;<span class="keyword">self</span>) -&gt; <span class="built_in">bool</span> &#123;</span><br><span class="line">        <span class="keyword">match</span> <span class="keyword">self</span> &#123;</span><br><span class="line">            Stmt::For(_) =&gt; <span class="literal">true</span>,</span><br><span class="line">            _ =&gt; <span class="literal">false</span>,</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">is_for_in</span></span>(&amp;<span class="keyword">self</span>) -&gt; <span class="built_in">bool</span> &#123;</span><br><span class="line">        <span class="keyword">match</span> <span class="keyword">self</span> &#123;</span><br><span class="line">            Stmt::ForIn(_) =&gt; <span class="literal">true</span>,</span><br><span class="line">            _ =&gt; <span class="literal">false</span>,</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">is_do_while</span></span>(&amp;<span class="keyword">self</span>) -&gt; <span class="built_in">bool</span> &#123;</span><br><span class="line">        <span class="keyword">match</span> <span class="keyword">self</span> &#123;</span><br><span class="line">            Stmt::DoWhile(_) =&gt; <span class="literal">true</span>,</span><br><span class="line">            _ =&gt; <span class="literal">false</span>,</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">is_while_stmt</span></span>(&amp;<span class="keyword">self</span>) -&gt; <span class="built_in">bool</span> &#123;</span><br><span class="line">        <span class="keyword">match</span> <span class="keyword">self</span> &#123;</span><br><span class="line">            Stmt::While(_) =&gt; <span class="literal">true</span>,</span><br><span class="line">            _ =&gt; <span class="literal">false</span>,</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">is_ret</span></span>(&amp;<span class="keyword">self</span>) -&gt; <span class="built_in">bool</span> &#123;</span><br><span class="line">        <span class="keyword">match</span> <span class="keyword">self</span> &#123;</span><br><span class="line">            Stmt::Return(_) =&gt; <span class="literal">true</span>,</span><br><span class="line">            _ =&gt; <span class="literal">false</span>,</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">is_cont</span></span>(&amp;<span class="keyword">self</span>) -&gt; <span class="built_in">bool</span> &#123;</span><br><span class="line">        <span class="keyword">match</span> <span class="keyword">self</span> &#123;</span><br><span class="line">            Stmt::Cont(_) =&gt; <span class="literal">true</span>,</span><br><span class="line">            _ =&gt; <span class="literal">false</span>,</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">is_break</span></span>(&amp;<span class="keyword">self</span>) -&gt; <span class="built_in">bool</span> &#123;</span><br><span class="line">        <span class="keyword">match</span> <span class="keyword">self</span> &#123;</span><br><span class="line">            Stmt::Break(_) =&gt; <span class="literal">true</span>,</span><br><span class="line">            _ =&gt; <span class="literal">false</span>,</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">is_empty</span></span>(&amp;<span class="keyword">self</span>) -&gt; <span class="built_in">bool</span> &#123;</span><br><span class="line">        <span class="keyword">match</span> <span class="keyword">self</span> &#123;</span><br><span class="line">            Stmt::Empty(_) =&gt; <span class="literal">true</span>,</span><br><span class="line">            _ =&gt; <span class="literal">false</span>,</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">is_with</span></span>(&amp;<span class="keyword">self</span>) -&gt; <span class="built_in">bool</span> &#123;</span><br><span class="line">        <span class="keyword">match</span> <span class="keyword">self</span> &#123;</span><br><span class="line">            Stmt::With(_) =&gt; <span class="literal">true</span>,</span><br><span class="line">            _ =&gt; <span class="literal">false</span>,</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">is_switch</span></span>(&amp;<span class="keyword">self</span>) -&gt; <span class="built_in">bool</span> &#123;</span><br><span class="line">        <span class="keyword">match</span> <span class="keyword">self</span> &#123;</span><br><span class="line">            Stmt::Switch(_) =&gt; <span class="literal">true</span>,</span><br><span class="line">            _ =&gt; <span class="literal">false</span>,</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">is_debug</span></span>(&amp;<span class="keyword">self</span>) -&gt; <span class="built_in">bool</span> &#123;</span><br><span class="line">        <span class="keyword">match</span> <span class="keyword">self</span> &#123;</span><br><span class="line">            Stmt::Debugger(_) =&gt; <span class="literal">true</span>,</span><br><span class="line">            _ =&gt; <span class="literal">false</span>,</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">is_try</span></span>(&amp;<span class="keyword">self</span>) -&gt; <span class="built_in">bool</span> &#123;</span><br><span class="line">        <span class="keyword">match</span> <span class="keyword">self</span> &#123;</span><br><span class="line">            Stmt::Try(_) =&gt; <span class="literal">true</span>,</span><br><span class="line">            _ =&gt; <span class="literal">false</span>,</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">is_throw</span></span>(&amp;<span class="keyword">self</span>) -&gt; <span class="built_in">bool</span> &#123;</span><br><span class="line">        <span class="keyword">match</span> <span class="keyword">self</span> &#123;</span><br><span class="line">            Stmt::Throw(_) =&gt; <span class="literal">true</span>,</span><br><span class="line">            _ =&gt; <span class="literal">false</span>,</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">is_fn</span></span>(&amp;<span class="keyword">self</span>) -&gt; <span class="built_in">bool</span> &#123;</span><br><span class="line">        <span class="keyword">match</span> <span class="keyword">self</span> &#123;</span><br><span class="line">            Stmt::Function(_) =&gt; <span class="literal">true</span>,</span><br><span class="line">            _ =&gt; <span class="literal">false</span>,</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">block</span></span>(&amp;<span class="keyword">self</span>) -&gt; &amp;BlockStmt &#123;</span><br><span class="line">        <span class="keyword">match</span> <span class="keyword">self</span> &#123;</span><br><span class="line">            Stmt::Block(s) =&gt; s,</span><br><span class="line">            _ =&gt; <span class="built_in">panic!</span>(),</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">expr</span></span>(&amp;<span class="keyword">self</span>) -&gt; &amp;ExprStmt &#123;</span><br><span class="line">        <span class="keyword">match</span> <span class="keyword">self</span> &#123;</span><br><span class="line">            Stmt::Expr(s) =&gt; s,</span><br><span class="line">            _ =&gt; <span class="built_in">panic!</span>(),</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">var_dec</span></span>(&amp;<span class="keyword">self</span>) -&gt; &amp;VarDec &#123;</span><br><span class="line">        <span class="keyword">match</span> <span class="keyword">self</span> &#123;</span><br><span class="line">            Stmt::VarDec(s) =&gt; s,</span><br><span class="line">            _ =&gt; <span class="built_in">panic!</span>(),</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">if_stmt</span></span>(&amp;<span class="keyword">self</span>) -&gt; &amp;IfStmt &#123;</span><br><span class="line">        <span class="keyword">match</span> <span class="keyword">self</span> &#123;</span><br><span class="line">            Stmt::If(s) =&gt; s,</span><br><span class="line">            _ =&gt; <span class="built_in">panic!</span>(),</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">for_stmt</span></span>(&amp;<span class="keyword">self</span>) -&gt; &amp;ForStmt &#123;</span><br><span class="line">        <span class="keyword">match</span> <span class="keyword">self</span> &#123;</span><br><span class="line">            Stmt::For(s) =&gt; s,</span><br><span class="line">            _ =&gt; <span class="built_in">panic!</span>(),</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">for_in</span></span>(&amp;<span class="keyword">self</span>) -&gt; &amp;ForInStmt &#123;</span><br><span class="line">        <span class="keyword">match</span> <span class="keyword">self</span> &#123;</span><br><span class="line">            Stmt::ForIn(s) =&gt; s,</span><br><span class="line">            _ =&gt; <span class="built_in">panic!</span>(),</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">do_while</span></span>(&amp;<span class="keyword">self</span>) -&gt; &amp;DoWhileStmt &#123;</span><br><span class="line">        <span class="keyword">match</span> <span class="keyword">self</span> &#123;</span><br><span class="line">            Stmt::DoWhile(s) =&gt; s,</span><br><span class="line">            _ =&gt; <span class="built_in">panic!</span>(),</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">while_stmt</span></span>(&amp;<span class="keyword">self</span>) -&gt; &amp;WhileStmt &#123;</span><br><span class="line">        <span class="keyword">match</span> <span class="keyword">self</span> &#123;</span><br><span class="line">            Stmt::While(s) =&gt; s,</span><br><span class="line">            _ =&gt; <span class="built_in">panic!</span>(),</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">cont</span></span>(&amp;<span class="keyword">self</span>) -&gt; &amp;ContStmt &#123;</span><br><span class="line">        <span class="keyword">match</span> <span class="keyword">self</span> &#123;</span><br><span class="line">            Stmt::Cont(s) =&gt; s,</span><br><span class="line">            _ =&gt; <span class="built_in">panic!</span>(),</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">break_stmt</span></span>(&amp;<span class="keyword">self</span>) -&gt; &amp;BreakStmt &#123;</span><br><span class="line">        <span class="keyword">match</span> <span class="keyword">self</span> &#123;</span><br><span class="line">            Stmt::Break(s) =&gt; s,</span><br><span class="line">            _ =&gt; <span class="built_in">panic!</span>(),</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">ret_stmt</span></span>(&amp;<span class="keyword">self</span>) -&gt; &amp;ReturnStmt &#123;</span><br><span class="line">        <span class="keyword">match</span> <span class="keyword">self</span> &#123;</span><br><span class="line">            Stmt::Return(s) =&gt; s,</span><br><span class="line">            _ =&gt; <span class="built_in">panic!</span>(),</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">empty</span></span>(&amp;<span class="keyword">self</span>) -&gt; &amp;EmptyStmt &#123;</span><br><span class="line">        <span class="keyword">match</span> <span class="keyword">self</span> &#123;</span><br><span class="line">            Stmt::Empty(s) =&gt; s,</span><br><span class="line">            _ =&gt; <span class="built_in">panic!</span>(),</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">with_stmt</span></span>(&amp;<span class="keyword">self</span>) -&gt; &amp;WithStmt &#123;</span><br><span class="line">        <span class="keyword">match</span> <span class="keyword">self</span> &#123;</span><br><span class="line">            Stmt::With(s) =&gt; s,</span><br><span class="line">            _ =&gt; <span class="built_in">panic!</span>(),</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">switch_stmt</span></span>(&amp;<span class="keyword">self</span>) -&gt; &amp;SwitchStmt &#123;</span><br><span class="line">        <span class="keyword">match</span> <span class="keyword">self</span> &#123;</span><br><span class="line">            Stmt::Switch(s) =&gt; s,</span><br><span class="line">            _ =&gt; <span class="built_in">panic!</span>(),</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">debug_stmt</span></span>(&amp;<span class="keyword">self</span>) -&gt; &amp;DebugStmt &#123;</span><br><span class="line">        <span class="keyword">match</span> <span class="keyword">self</span> &#123;</span><br><span class="line">            Stmt::Debugger(s) =&gt; s,</span><br><span class="line">            _ =&gt; <span class="built_in">panic!</span>(),</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">try_stmt</span></span>(&amp;<span class="keyword">self</span>) -&gt; &amp;TryStmt &#123;</span><br><span class="line">        <span class="keyword">match</span> <span class="keyword">self</span> &#123;</span><br><span class="line">            Stmt::Try(s) =&gt; s,</span><br><span class="line">            _ =&gt; <span class="built_in">panic!</span>(),</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">throw_stmt</span></span>(&amp;<span class="keyword">self</span>) -&gt; &amp;ThrowStmt &#123;</span><br><span class="line">        <span class="keyword">match</span> <span class="keyword">self</span> &#123;</span><br><span class="line">            Stmt::Throw(s) =&gt; s,</span><br><span class="line">            _ =&gt; <span class="built_in">panic!</span>(),</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">fn_dec</span></span>(&amp;<span class="keyword">self</span>) -&gt; &amp;FnDec &#123;</span><br><span class="line">        <span class="keyword">match</span> <span class="keyword">self</span> &#123;</span><br><span class="line">            Stmt::Function(s) =&gt; s,</span><br><span class="line">            _ =&gt; <span class="built_in">panic!</span>(),</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[derive(Debug)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">struct</span> <span class="title">Prog</span></span> &#123;</span><br><span class="line">    <span class="keyword">pub</span> body: <span class="built_in">Vec</span>&lt;Stmt&gt;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="parser"><a href="#parser" class="headerlink" title="parser"></a>parser</h2><p>当我们定义完我们的 ast 后，我们下一步就是现实我们的 parser 了，在这里，我使用了递归下降作为语法解析，简单来说就是核心的两个公式：</p>
<ul>
<li>S = aS | bS’</li>
<li>S’ = a | Σ</li>
</ul>
<p>S 代表的是代码的整体，a 和 b 是终结符，不可再分的 token，解析到这就结束了，Σ 代表的是空。根据这种定义，我们可以一直递归解析下去，直到结果只有 a,b,Σ。</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br><span class="line">650</span><br><span class="line">651</span><br><span class="line">652</span><br><span class="line">653</span><br><span class="line">654</span><br><span class="line">655</span><br><span class="line">656</span><br><span class="line">657</span><br><span class="line">658</span><br><span class="line">659</span><br><span class="line">660</span><br><span class="line">661</span><br><span class="line">662</span><br><span class="line">663</span><br><span class="line">664</span><br><span class="line">665</span><br><span class="line">666</span><br><span class="line">667</span><br><span class="line">668</span><br><span class="line">669</span><br><span class="line">670</span><br><span class="line">671</span><br><span class="line">672</span><br><span class="line">673</span><br><span class="line">674</span><br><span class="line">675</span><br><span class="line">676</span><br><span class="line">677</span><br><span class="line">678</span><br><span class="line">679</span><br><span class="line">680</span><br><span class="line">681</span><br><span class="line">682</span><br><span class="line">683</span><br><span class="line">684</span><br><span class="line">685</span><br><span class="line">686</span><br><span class="line">687</span><br><span class="line">688</span><br><span class="line">689</span><br><span class="line">690</span><br><span class="line">691</span><br><span class="line">692</span><br><span class="line">693</span><br><span class="line">694</span><br><span class="line">695</span><br><span class="line">696</span><br><span class="line">697</span><br><span class="line">698</span><br><span class="line">699</span><br><span class="line">700</span><br><span class="line">701</span><br><span class="line">702</span><br><span class="line">703</span><br><span class="line">704</span><br><span class="line">705</span><br><span class="line">706</span><br><span class="line">707</span><br><span class="line">708</span><br><span class="line">709</span><br><span class="line">710</span><br><span class="line">711</span><br><span class="line">712</span><br><span class="line">713</span><br><span class="line">714</span><br><span class="line">715</span><br><span class="line">716</span><br><span class="line">717</span><br><span class="line">718</span><br><span class="line">719</span><br><span class="line">720</span><br><span class="line">721</span><br><span class="line">722</span><br><span class="line">723</span><br><span class="line">724</span><br><span class="line">725</span><br><span class="line">726</span><br><span class="line">727</span><br><span class="line">728</span><br><span class="line">729</span><br><span class="line">730</span><br><span class="line">731</span><br><span class="line">732</span><br><span class="line">733</span><br><span class="line">734</span><br><span class="line">735</span><br><span class="line">736</span><br><span class="line">737</span><br><span class="line">738</span><br><span class="line">739</span><br><span class="line">740</span><br><span class="line">741</span><br><span class="line">742</span><br><span class="line">743</span><br><span class="line">744</span><br><span class="line">745</span><br><span class="line">746</span><br><span class="line">747</span><br><span class="line">748</span><br><span class="line">749</span><br><span class="line">750</span><br><span class="line">751</span><br><span class="line">752</span><br><span class="line">753</span><br><span class="line">754</span><br><span class="line">755</span><br><span class="line">756</span><br><span class="line">757</span><br><span class="line">758</span><br><span class="line">759</span><br><span class="line">760</span><br><span class="line">761</span><br><span class="line">762</span><br><span class="line">763</span><br><span class="line">764</span><br><span class="line">765</span><br><span class="line">766</span><br><span class="line">767</span><br><span class="line">768</span><br><span class="line">769</span><br><span class="line">770</span><br><span class="line">771</span><br><span class="line">772</span><br><span class="line">773</span><br><span class="line">774</span><br><span class="line">775</span><br><span class="line">776</span><br><span class="line">777</span><br><span class="line">778</span><br><span class="line">779</span><br><span class="line">780</span><br><span class="line">781</span><br><span class="line">782</span><br><span class="line">783</span><br><span class="line">784</span><br><span class="line">785</span><br><span class="line">786</span><br><span class="line">787</span><br><span class="line">788</span><br><span class="line">789</span><br><span class="line">790</span><br><span class="line">791</span><br><span class="line">792</span><br><span class="line">793</span><br><span class="line">794</span><br><span class="line">795</span><br><span class="line">796</span><br><span class="line">797</span><br><span class="line">798</span><br><span class="line">799</span><br><span class="line">800</span><br><span class="line">801</span><br><span class="line">802</span><br><span class="line">803</span><br><span class="line">804</span><br><span class="line">805</span><br><span class="line">806</span><br><span class="line">807</span><br><span class="line">808</span><br><span class="line">809</span><br><span class="line">810</span><br><span class="line">811</span><br><span class="line">812</span><br><span class="line">813</span><br><span class="line">814</span><br><span class="line">815</span><br><span class="line">816</span><br><span class="line">817</span><br><span class="line">818</span><br><span class="line">819</span><br><span class="line">820</span><br><span class="line">821</span><br><span class="line">822</span><br><span class="line">823</span><br><span class="line">824</span><br><span class="line">825</span><br><span class="line">826</span><br><span class="line">827</span><br><span class="line">828</span><br><span class="line">829</span><br><span class="line">830</span><br><span class="line">831</span><br><span class="line">832</span><br><span class="line">833</span><br><span class="line">834</span><br><span class="line">835</span><br><span class="line">836</span><br><span class="line">837</span><br><span class="line">838</span><br><span class="line">839</span><br><span class="line">840</span><br><span class="line">841</span><br><span class="line">842</span><br><span class="line">843</span><br><span class="line">844</span><br><span class="line">845</span><br><span class="line">846</span><br><span class="line">847</span><br><span class="line">848</span><br><span class="line">849</span><br><span class="line">850</span><br><span class="line">851</span><br><span class="line">852</span><br><span class="line">853</span><br><span class="line">854</span><br><span class="line">855</span><br><span class="line">856</span><br><span class="line">857</span><br><span class="line">858</span><br><span class="line">859</span><br><span class="line">860</span><br><span class="line">861</span><br><span class="line">862</span><br><span class="line">863</span><br><span class="line">864</span><br><span class="line">865</span><br><span class="line">866</span><br><span class="line">867</span><br><span class="line">868</span><br><span class="line">869</span><br><span class="line">870</span><br><span class="line">871</span><br><span class="line">872</span><br><span class="line">873</span><br><span class="line">874</span><br><span class="line">875</span><br><span class="line">876</span><br><span class="line">877</span><br><span class="line">878</span><br><span class="line">879</span><br><span class="line">880</span><br><span class="line">881</span><br><span class="line">882</span><br><span class="line">883</span><br><span class="line">884</span><br><span class="line">885</span><br><span class="line">886</span><br><span class="line">887</span><br><span class="line">888</span><br><span class="line">889</span><br><span class="line">890</span><br><span class="line">891</span><br><span class="line">892</span><br><span class="line">893</span><br><span class="line">894</span><br><span class="line">895</span><br><span class="line">896</span><br><span class="line">897</span><br><span class="line">898</span><br><span class="line">899</span><br><span class="line">900</span><br><span class="line">901</span><br><span class="line">902</span><br><span class="line">903</span><br><span class="line">904</span><br><span class="line">905</span><br><span class="line">906</span><br><span class="line">907</span><br><span class="line">908</span><br><span class="line">909</span><br><span class="line">910</span><br><span class="line">911</span><br><span class="line">912</span><br><span class="line">913</span><br><span class="line">914</span><br><span class="line">915</span><br><span class="line">916</span><br><span class="line">917</span><br><span class="line">918</span><br><span class="line">919</span><br><span class="line">920</span><br><span class="line">921</span><br><span class="line">922</span><br><span class="line">923</span><br><span class="line">924</span><br><span class="line">925</span><br><span class="line">926</span><br><span class="line">927</span><br><span class="line">928</span><br><span class="line">929</span><br><span class="line">930</span><br><span class="line">931</span><br><span class="line">932</span><br><span class="line">933</span><br><span class="line">934</span><br><span class="line">935</span><br><span class="line">936</span><br><span class="line">937</span><br><span class="line">938</span><br><span class="line">939</span><br><span class="line">940</span><br><span class="line">941</span><br><span class="line">942</span><br><span class="line">943</span><br><span class="line">944</span><br><span class="line">945</span><br><span class="line">946</span><br><span class="line">947</span><br><span class="line">948</span><br><span class="line">949</span><br><span class="line">950</span><br><span class="line">951</span><br><span class="line">952</span><br><span class="line">953</span><br><span class="line">954</span><br><span class="line">955</span><br><span class="line">956</span><br><span class="line">957</span><br><span class="line">958</span><br><span class="line">959</span><br><span class="line">960</span><br><span class="line">961</span><br><span class="line">962</span><br><span class="line">963</span><br><span class="line">964</span><br><span class="line">965</span><br><span class="line">966</span><br><span class="line">967</span><br><span class="line">968</span><br><span class="line">969</span><br><span class="line">970</span><br><span class="line">971</span><br><span class="line">972</span><br><span class="line">973</span><br><span class="line">974</span><br><span class="line">975</span><br><span class="line">976</span><br><span class="line">977</span><br><span class="line">978</span><br><span class="line">979</span><br><span class="line">980</span><br><span class="line">981</span><br><span class="line">982</span><br><span class="line">983</span><br><span class="line">984</span><br><span class="line">985</span><br><span class="line">986</span><br><span class="line">987</span><br><span class="line">988</span><br><span class="line">989</span><br><span class="line">990</span><br><span class="line">991</span><br><span class="line">992</span><br><span class="line">993</span><br><span class="line">994</span><br><span class="line">995</span><br><span class="line">996</span><br><span class="line">997</span><br><span class="line">998</span><br><span class="line">999</span><br><span class="line">1000</span><br><span class="line">1001</span><br><span class="line">1002</span><br><span class="line">1003</span><br><span class="line">1004</span><br><span class="line">1005</span><br><span class="line">1006</span><br><span class="line">1007</span><br><span class="line">1008</span><br><span class="line">1009</span><br><span class="line">1010</span><br><span class="line">1011</span><br><span class="line">1012</span><br><span class="line">1013</span><br><span class="line">1014</span><br><span class="line">1015</span><br><span class="line">1016</span><br><span class="line">1017</span><br><span class="line">1018</span><br><span class="line">1019</span><br><span class="line">1020</span><br><span class="line">1021</span><br><span class="line">1022</span><br><span class="line">1023</span><br><span class="line">1024</span><br><span class="line">1025</span><br><span class="line">1026</span><br><span class="line">1027</span><br><span class="line">1028</span><br><span class="line">1029</span><br><span class="line">1030</span><br><span class="line">1031</span><br><span class="line">1032</span><br><span class="line">1033</span><br><span class="line">1034</span><br><span class="line">1035</span><br><span class="line">1036</span><br><span class="line">1037</span><br><span class="line">1038</span><br><span class="line">1039</span><br><span class="line">1040</span><br><span class="line">1041</span><br><span class="line">1042</span><br><span class="line">1043</span><br><span class="line">1044</span><br><span class="line">1045</span><br><span class="line">1046</span><br><span class="line">1047</span><br><span class="line">1048</span><br><span class="line">1049</span><br><span class="line">1050</span><br><span class="line">1051</span><br><span class="line">1052</span><br><span class="line">1053</span><br><span class="line">1054</span><br><span class="line">1055</span><br><span class="line">1056</span><br><span class="line">1057</span><br><span class="line">1058</span><br><span class="line">1059</span><br><span class="line">1060</span><br><span class="line">1061</span><br><span class="line">1062</span><br><span class="line">1063</span><br><span class="line">1064</span><br><span class="line">1065</span><br><span class="line">1066</span><br><span class="line">1067</span><br><span class="line">1068</span><br><span class="line">1069</span><br><span class="line">1070</span><br><span class="line">1071</span><br><span class="line">1072</span><br><span class="line">1073</span><br><span class="line">1074</span><br><span class="line">1075</span><br><span class="line">1076</span><br><span class="line">1077</span><br><span class="line">1078</span><br><span class="line">1079</span><br><span class="line">1080</span><br><span class="line">1081</span><br><span class="line">1082</span><br><span class="line">1083</span><br><span class="line">1084</span><br><span class="line">1085</span><br><span class="line">1086</span><br><span class="line">1087</span><br><span class="line">1088</span><br><span class="line">1089</span><br><span class="line">1090</span><br><span class="line">1091</span><br><span class="line">1092</span><br><span class="line">1093</span><br><span class="line">1094</span><br><span class="line">1095</span><br><span class="line">1096</span><br><span class="line">1097</span><br><span class="line">1098</span><br><span class="line">1099</span><br><span class="line">1100</span><br><span class="line">1101</span><br><span class="line">1102</span><br><span class="line">1103</span><br><span class="line">1104</span><br><span class="line">1105</span><br><span class="line">1106</span><br><span class="line">1107</span><br><span class="line">1108</span><br><span class="line">1109</span><br><span class="line">1110</span><br><span class="line">1111</span><br><span class="line">1112</span><br><span class="line">1113</span><br><span class="line">1114</span><br><span class="line">1115</span><br><span class="line">1116</span><br><span class="line">1117</span><br><span class="line">1118</span><br><span class="line">1119</span><br><span class="line">1120</span><br><span class="line">1121</span><br><span class="line">1122</span><br><span class="line">1123</span><br><span class="line">1124</span><br><span class="line">1125</span><br><span class="line">1126</span><br><span class="line">1127</span><br><span class="line">1128</span><br><span class="line">1129</span><br><span class="line">1130</span><br><span class="line">1131</span><br><span class="line">1132</span><br><span class="line">1133</span><br><span class="line">1134</span><br><span class="line">1135</span><br><span class="line">1136</span><br><span class="line">1137</span><br><span class="line">1138</span><br><span class="line">1139</span><br><span class="line">1140</span><br><span class="line">1141</span><br><span class="line">1142</span><br><span class="line">1143</span><br><span class="line">1144</span><br><span class="line">1145</span><br><span class="line">1146</span><br><span class="line">1147</span><br><span class="line">1148</span><br><span class="line">1149</span><br><span class="line">1150</span><br><span class="line">1151</span><br><span class="line">1152</span><br><span class="line">1153</span><br><span class="line">1154</span><br><span class="line">1155</span><br><span class="line">1156</span><br><span class="line">1157</span><br><span class="line">1158</span><br><span class="line">1159</span><br><span class="line">1160</span><br><span class="line">1161</span><br><span class="line">1162</span><br><span class="line">1163</span><br><span class="line">1164</span><br><span class="line">1165</span><br><span class="line">1166</span><br><span class="line">1167</span><br><span class="line">1168</span><br><span class="line">1169</span><br><span class="line">1170</span><br><span class="line">1171</span><br><span class="line">1172</span><br><span class="line">1173</span><br><span class="line">1174</span><br><span class="line">1175</span><br><span class="line">1176</span><br><span class="line">1177</span><br><span class="line">1178</span><br><span class="line">1179</span><br><span class="line">1180</span><br><span class="line">1181</span><br><span class="line">1182</span><br><span class="line">1183</span><br><span class="line">1184</span><br><span class="line">1185</span><br><span class="line">1186</span><br><span class="line">1187</span><br><span class="line">1188</span><br><span class="line">1189</span><br><span class="line">1190</span><br><span class="line">1191</span><br><span class="line">1192</span><br><span class="line">1193</span><br><span class="line">1194</span><br><span class="line">1195</span><br><span class="line">1196</span><br><span class="line">1197</span><br><span class="line">1198</span><br><span class="line">1199</span><br><span class="line">1200</span><br><span class="line">1201</span><br><span class="line">1202</span><br><span class="line">1203</span><br><span class="line">1204</span><br><span class="line">1205</span><br><span class="line">1206</span><br><span class="line">1207</span><br><span class="line">1208</span><br><span class="line">1209</span><br><span class="line">1210</span><br><span class="line">1211</span><br><span class="line">1212</span><br><span class="line">1213</span><br><span class="line">1214</span><br><span class="line">1215</span><br><span class="line">1216</span><br><span class="line">1217</span><br><span class="line">1218</span><br><span class="line">1219</span><br><span class="line">1220</span><br><span class="line">1221</span><br><span class="line">1222</span><br><span class="line">1223</span><br><span class="line">1224</span><br><span class="line">1225</span><br><span class="line">1226</span><br><span class="line">1227</span><br><span class="line">1228</span><br><span class="line">1229</span><br><span class="line">1230</span><br><span class="line">1231</span><br><span class="line">1232</span><br><span class="line">1233</span><br><span class="line">1234</span><br><span class="line">1235</span><br><span class="line">1236</span><br><span class="line">1237</span><br><span class="line">1238</span><br><span class="line">1239</span><br><span class="line">1240</span><br><span class="line">1241</span><br><span class="line">1242</span><br><span class="line">1243</span><br><span class="line">1244</span><br><span class="line">1245</span><br><span class="line">1246</span><br><span class="line">1247</span><br><span class="line">1248</span><br><span class="line">1249</span><br><span class="line">1250</span><br><span class="line">1251</span><br><span class="line">1252</span><br><span class="line">1253</span><br><span class="line">1254</span><br><span class="line">1255</span><br><span class="line">1256</span><br><span class="line">1257</span><br><span class="line">1258</span><br><span class="line">1259</span><br><span class="line">1260</span><br><span class="line">1261</span><br><span class="line">1262</span><br><span class="line">1263</span><br><span class="line">1264</span><br><span class="line">1265</span><br><span class="line">1266</span><br><span class="line">1267</span><br><span class="line">1268</span><br><span class="line">1269</span><br><span class="line">1270</span><br><span class="line">1271</span><br><span class="line">1272</span><br><span class="line">1273</span><br><span class="line">1274</span><br><span class="line">1275</span><br><span class="line">1276</span><br><span class="line">1277</span><br><span class="line">1278</span><br><span class="line">1279</span><br><span class="line">1280</span><br><span class="line">1281</span><br><span class="line">1282</span><br><span class="line">1283</span><br><span class="line">1284</span><br><span class="line">1285</span><br><span class="line">1286</span><br><span class="line">1287</span><br><span class="line">1288</span><br><span class="line">1289</span><br><span class="line">1290</span><br><span class="line">1291</span><br><span class="line">1292</span><br><span class="line">1293</span><br><span class="line">1294</span><br><span class="line">1295</span><br><span class="line">1296</span><br><span class="line">1297</span><br><span class="line">1298</span><br><span class="line">1299</span><br><span class="line">1300</span><br><span class="line">1301</span><br><span class="line">1302</span><br><span class="line">1303</span><br><span class="line">1304</span><br><span class="line">1305</span><br><span class="line">1306</span><br><span class="line">1307</span><br><span class="line">1308</span><br><span class="line">1309</span><br><span class="line">1310</span><br><span class="line">1311</span><br><span class="line">1312</span><br><span class="line">1313</span><br><span class="line">1314</span><br><span class="line">1315</span><br><span class="line">1316</span><br><span class="line">1317</span><br><span class="line">1318</span><br><span class="line">1319</span><br><span class="line">1320</span><br><span class="line">1321</span><br><span class="line">1322</span><br><span class="line">1323</span><br><span class="line">1324</span><br><span class="line">1325</span><br><span class="line">1326</span><br><span class="line">1327</span><br><span class="line">1328</span><br><span class="line">1329</span><br><span class="line">1330</span><br><span class="line">1331</span><br><span class="line">1332</span><br><span class="line">1333</span><br><span class="line">1334</span><br><span class="line">1335</span><br><span class="line">1336</span><br><span class="line">1337</span><br><span class="line">1338</span><br><span class="line">1339</span><br><span class="line">1340</span><br><span class="line">1341</span><br><span class="line">1342</span><br><span class="line">1343</span><br><span class="line">1344</span><br><span class="line">1345</span><br><span class="line">1346</span><br><span class="line">1347</span><br><span class="line">1348</span><br><span class="line">1349</span><br><span class="line">1350</span><br><span class="line">1351</span><br><span class="line">1352</span><br><span class="line">1353</span><br><span class="line">1354</span><br><span class="line">1355</span><br><span class="line">1356</span><br><span class="line">1357</span><br><span class="line">1358</span><br><span class="line">1359</span><br><span class="line">1360</span><br><span class="line">1361</span><br><span class="line">1362</span><br><span class="line">1363</span><br><span class="line">1364</span><br><span class="line">1365</span><br><span class="line">1366</span><br><span class="line">1367</span><br><span class="line">1368</span><br><span class="line">1369</span><br><span class="line">1370</span><br><span class="line">1371</span><br><span class="line">1372</span><br><span class="line">1373</span><br><span class="line">1374</span><br><span class="line">1375</span><br><span class="line">1376</span><br><span class="line">1377</span><br><span class="line">1378</span><br><span class="line">1379</span><br><span class="line">1380</span><br><span class="line">1381</span><br><span class="line">1382</span><br><span class="line">1383</span><br><span class="line">1384</span><br><span class="line">1385</span><br><span class="line">1386</span><br><span class="line">1387</span><br><span class="line">1388</span><br><span class="line">1389</span><br><span class="line">1390</span><br><span class="line">1391</span><br><span class="line">1392</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">struct</span> <span class="title">Parser</span></span>&lt;<span class="symbol">'a</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">pub</span> lexer: &amp;<span class="symbol">'a</span> <span class="keyword">mut</span> Lexer&lt;<span class="symbol">'a</span>&gt;,</span><br><span class="line">    in_loop_flags: <span class="built_in">Vec</span>&lt;<span class="built_in">bool</span>&gt;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span>&lt;<span class="symbol">'a</span>&gt; Parser&lt;<span class="symbol">'a</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">new</span></span>(lexer: &amp;<span class="symbol">'a</span> <span class="keyword">mut</span> Lexer&lt;<span class="symbol">'a</span>&gt;) -&gt; <span class="keyword">Self</span> &#123;</span><br><span class="line">        Parser &#123;</span><br><span class="line">            lexer,</span><br><span class="line">            in_loop_flags: <span class="built_in">vec!</span>[],</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">enter_loop</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) &#123;</span><br><span class="line">        <span class="keyword">self</span>.in_loop_flags.push(<span class="literal">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">leave_loop</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) &#123;</span><br><span class="line">        <span class="keyword">self</span>.in_loop_flags.pop();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">in_loop</span></span>(&amp;<span class="keyword">self</span>) -&gt; <span class="built_in">bool</span> &#123;</span><br><span class="line">        <span class="keyword">match</span> <span class="keyword">self</span>.in_loop_flags.last() &#123;</span><br><span class="line">            <span class="literal">Some</span>(_) =&gt; <span class="literal">true</span>,</span><br><span class="line">            _ =&gt; <span class="literal">false</span>,</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">prog</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) -&gt; <span class="built_in">Result</span>&lt;Prog, ParsingError&gt; &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut</span> body = <span class="built_in">vec!</span>[];</span><br><span class="line">        <span class="keyword">loop</span> &#123;</span><br><span class="line">            <span class="keyword">match</span> <span class="keyword">self</span>.lexer.peek() &#123;</span><br><span class="line">                <span class="literal">Ok</span>(tok) =&gt; &#123;</span><br><span class="line">                    <span class="keyword">if</span> tok.is_eof() &#123;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="literal">Err</span>(e) =&gt; <span class="keyword">return</span> <span class="literal">Err</span>(e.into()),</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">match</span> <span class="keyword">self</span>.stmt() &#123;</span><br><span class="line">                <span class="literal">Ok</span>(stmt) =&gt; body.push(stmt),</span><br><span class="line">                <span class="literal">Err</span>(e) =&gt; <span class="keyword">return</span> <span class="literal">Err</span>(e),</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="literal">Ok</span>(Prog &#123; body &#125;)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">stmt</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) -&gt; <span class="built_in">Result</span>&lt;Stmt, ParsingError&gt; &#123;</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">self</span>.ahead_is_symbol(Symbol::BraceL) &#123;</span><br><span class="line">            <span class="keyword">self</span>.block_stmt()</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> <span class="keyword">self</span>.ahead_is_keyword(Keyword::Var) &#123;</span><br><span class="line">            <span class="keyword">self</span>.var_dec_stmt(<span class="literal">false</span>, <span class="literal">false</span>)</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> <span class="keyword">self</span>.ahead_is_keyword(Keyword::If) &#123;</span><br><span class="line">            <span class="keyword">self</span>.if_stmt()</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> <span class="keyword">self</span>.ahead_is_keyword(Keyword::For) &#123;</span><br><span class="line">            <span class="keyword">self</span>.for_stmt()</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> <span class="keyword">self</span>.ahead_is_keyword(Keyword::Do) &#123;</span><br><span class="line">            <span class="keyword">self</span>.do_while()</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> <span class="keyword">self</span>.ahead_is_keyword(Keyword::While) &#123;</span><br><span class="line">            <span class="keyword">self</span>.while_stmt()</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> <span class="keyword">self</span>.ahead_is_keyword(Keyword::Continue) &#123;</span><br><span class="line">            <span class="keyword">self</span>.cont_stmt()</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> <span class="keyword">self</span>.ahead_is_keyword(Keyword::Break) &#123;</span><br><span class="line">            <span class="keyword">self</span>.break_stmt()</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> <span class="keyword">self</span>.ahead_is_keyword(Keyword::Return) &#123;</span><br><span class="line">            <span class="keyword">self</span>.ret_stmt()</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> <span class="keyword">self</span>.ahead_is_keyword(Keyword::With) &#123;</span><br><span class="line">            <span class="keyword">self</span>.with_stmt()</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> <span class="keyword">self</span>.ahead_is_keyword(Keyword::Switch) &#123;</span><br><span class="line">            <span class="keyword">self</span>.switch_stmt()</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> <span class="keyword">self</span>.ahead_is_keyword(Keyword::Debugger) &#123;</span><br><span class="line">            <span class="keyword">self</span>.debug_stmt()</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> <span class="keyword">self</span>.ahead_is_keyword(Keyword::Throw) &#123;</span><br><span class="line">            <span class="keyword">self</span>.throw_stmt()</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> <span class="keyword">self</span>.ahead_is_keyword(Keyword::Try) &#123;</span><br><span class="line">            <span class="keyword">self</span>.try_stmt()</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> <span class="keyword">self</span>.ahead_is_keyword(Keyword::Function) &#123;</span><br><span class="line">            <span class="keyword">self</span>.fn_dec_stmt()</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> <span class="keyword">self</span>.ahead_is_symbol(Symbol::Semi) &#123;</span><br><span class="line">            <span class="keyword">self</span>.empty_stmt()</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">self</span>.expr_stmt()</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">fn_dec_stmt</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) -&gt; <span class="built_in">Result</span>&lt;Stmt, ParsingError&gt; &#123;</span><br><span class="line">        <span class="keyword">let</span> tok = <span class="keyword">self</span>.lexer.next().ok().unwrap();</span><br><span class="line">        <span class="keyword">let</span> expr = <span class="keyword">match</span> <span class="keyword">self</span>.fn_expr(&amp;tok) &#123;</span><br><span class="line">            <span class="literal">Ok</span>(expr) =&gt; expr,</span><br><span class="line">            <span class="literal">Err</span>(e) =&gt; <span class="keyword">return</span> <span class="literal">Err</span>(e),</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> fun = expr.fn_expr().clone();</span><br><span class="line">        <span class="literal">Ok</span>(Stmt::Function(fun))</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">throw_stmt</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) -&gt; <span class="built_in">Result</span>&lt;Stmt, ParsingError&gt; &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut</span> loc = <span class="keyword">self</span>.loc();</span><br><span class="line">        <span class="keyword">self</span>.lexer.advance();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> argument = <span class="keyword">match</span> <span class="keyword">self</span>.expr(<span class="literal">false</span>) &#123;</span><br><span class="line">            <span class="literal">Ok</span>(expr) =&gt; expr,</span><br><span class="line">            <span class="literal">Err</span>(e) =&gt; <span class="keyword">return</span> <span class="literal">Err</span>(e),</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        loc.end = <span class="keyword">self</span>.pos();</span><br><span class="line">        <span class="literal">Ok</span>(ThrowStmt &#123; loc, argument &#125;.into())</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">try_stmt</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) -&gt; <span class="built_in">Result</span>&lt;Stmt, ParsingError&gt; &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut</span> loc = <span class="keyword">self</span>.loc();</span><br><span class="line">        <span class="keyword">self</span>.lexer.advance();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> block = <span class="keyword">match</span> <span class="keyword">self</span>.block_stmt() &#123;</span><br><span class="line">            <span class="literal">Ok</span>(stmt) =&gt; stmt,</span><br><span class="line">            <span class="literal">Err</span>(e) =&gt; <span class="keyword">return</span> <span class="literal">Err</span>(e),</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut</span> handler = <span class="literal">None</span>;</span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut</span> finalizer = <span class="literal">None</span>;</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">self</span>.ahead_is_keyword(Keyword::Catch) &#123;</span><br><span class="line">            handler = <span class="keyword">match</span> <span class="keyword">self</span>.try_catch_clause() &#123;</span><br><span class="line">                <span class="literal">Ok</span>(cc) =&gt; <span class="literal">Some</span>(cc),</span><br><span class="line">                <span class="literal">Err</span>(e) =&gt; <span class="keyword">return</span> <span class="literal">Err</span>(e),</span><br><span class="line">            &#125;;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> <span class="keyword">self</span>.ahead_is_keyword(Keyword::Finally) &#123;</span><br><span class="line">            finalizer = <span class="keyword">match</span> <span class="keyword">self</span>.block_stmt() &#123;</span><br><span class="line">                <span class="literal">Ok</span>(stmt) =&gt; <span class="literal">Some</span>(stmt),</span><br><span class="line">                <span class="literal">Err</span>(e) =&gt; <span class="keyword">return</span> <span class="literal">Err</span>(e),</span><br><span class="line">            &#125;;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        loc.end = <span class="keyword">self</span>.pos();</span><br><span class="line">        <span class="keyword">let</span> stmt = TryStmt &#123;</span><br><span class="line">            loc,</span><br><span class="line">            block,</span><br><span class="line">            handler,</span><br><span class="line">            finalizer,</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="literal">Ok</span>(stmt.into())</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">try_catch_clause</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) -&gt; <span class="built_in">Result</span>&lt;CatchClause, ParsingError&gt; &#123;</span><br><span class="line">        <span class="keyword">self</span>.lexer.advance();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">match</span> <span class="keyword">self</span>.ahead_is_symbol(Symbol::ParenL) &#123;</span><br><span class="line">            <span class="literal">true</span> =&gt; <span class="keyword">self</span>.lexer.advance(),</span><br><span class="line">            <span class="literal">false</span> =&gt; <span class="keyword">return</span> <span class="literal">Err</span>(ParserError::at(&amp;<span class="keyword">self</span>.loc()).into()),</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> id = <span class="keyword">match</span> <span class="keyword">self</span>.primary_expr() &#123;</span><br><span class="line">            <span class="literal">Ok</span>(id) =&gt; id,</span><br><span class="line">            <span class="literal">Err</span>(e) =&gt; <span class="keyword">return</span> <span class="literal">Err</span>(e),</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">match</span> <span class="keyword">self</span>.ahead_is_symbol(Symbol::ParenR) &#123;</span><br><span class="line">            <span class="literal">true</span> =&gt; <span class="keyword">self</span>.lexer.advance(),</span><br><span class="line">            <span class="literal">false</span> =&gt; <span class="keyword">return</span> <span class="literal">Err</span>(ParserError::at(&amp;<span class="keyword">self</span>.loc()).into()),</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> body = <span class="keyword">match</span> <span class="keyword">self</span>.block_stmt() &#123;</span><br><span class="line">            <span class="literal">Ok</span>(stmt) =&gt; stmt,</span><br><span class="line">            <span class="literal">Err</span>(e) =&gt; <span class="keyword">return</span> <span class="literal">Err</span>(e),</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="literal">Ok</span>(CatchClause &#123; id, body &#125;.into())</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">debug_stmt</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) -&gt; <span class="built_in">Result</span>&lt;Stmt, ParsingError&gt; &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut</span> loc = <span class="keyword">self</span>.loc();</span><br><span class="line">        <span class="keyword">self</span>.lexer.advance();</span><br><span class="line">        loc.end = <span class="keyword">self</span>.pos();</span><br><span class="line">        <span class="literal">Ok</span>(DebugStmt &#123; loc &#125;.into())</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">switch_stmt</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) -&gt; <span class="built_in">Result</span>&lt;Stmt, ParsingError&gt; &#123;</span><br><span class="line">        <span class="keyword">self</span>.enter_loop();</span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut</span> loc = <span class="keyword">self</span>.loc();</span><br><span class="line">        <span class="keyword">self</span>.lexer.advance();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">match</span> <span class="keyword">self</span>.ahead_is_symbol(Symbol::ParenL) &#123;</span><br><span class="line">            <span class="literal">true</span> =&gt; <span class="keyword">self</span>.lexer.advance(),</span><br><span class="line">            <span class="literal">false</span> =&gt; <span class="keyword">return</span> <span class="literal">Err</span>(ParserError::at(&amp;<span class="keyword">self</span>.loc()).into()),</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> discrim = <span class="keyword">match</span> <span class="keyword">self</span>.expr(<span class="literal">false</span>) &#123;</span><br><span class="line">            <span class="literal">Ok</span>(expr) =&gt; expr,</span><br><span class="line">            <span class="literal">Err</span>(e) =&gt; <span class="keyword">return</span> <span class="literal">Err</span>(e),</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">match</span> <span class="keyword">self</span>.ahead_is_symbol(Symbol::ParenR) &#123;</span><br><span class="line">            <span class="literal">true</span> =&gt; <span class="keyword">self</span>.lexer.advance(),</span><br><span class="line">            <span class="literal">false</span> =&gt; <span class="keyword">return</span> <span class="literal">Err</span>(ParserError::at(&amp;<span class="keyword">self</span>.loc()).into()),</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">match</span> <span class="keyword">self</span>.ahead_is_symbol(Symbol::BraceL) &#123;</span><br><span class="line">            <span class="literal">true</span> =&gt; <span class="keyword">self</span>.lexer.advance(),</span><br><span class="line">            <span class="literal">false</span> =&gt; <span class="keyword">return</span> <span class="literal">Err</span>(ParserError::at(&amp;<span class="keyword">self</span>.loc()).into()),</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut</span> cases = <span class="built_in">vec!</span>[];</span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut</span> met_default = <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">loop</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">self</span>.ahead_is_symbol(Symbol::BraceR) &#123;</span><br><span class="line">                <span class="keyword">self</span>.lexer.advance();</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> <span class="keyword">self</span>.ahead_is_keyword(Keyword::Case) &#123;</span><br><span class="line">                <span class="keyword">match</span> <span class="keyword">self</span>.switch_case() &#123;</span><br><span class="line">                    <span class="literal">Ok</span>(case) =&gt; cases.push(case),</span><br><span class="line">                    <span class="literal">Err</span>(e) =&gt; <span class="keyword">return</span> <span class="literal">Err</span>(e),</span><br><span class="line">                &#125;;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> <span class="keyword">self</span>.ahead_is_keyword(Keyword::<span class="built_in">Default</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> !met_default &#123;</span><br><span class="line">                    met_default = <span class="literal">true</span>;</span><br><span class="line">                    <span class="keyword">match</span> <span class="keyword">self</span>.switch_default() &#123;</span><br><span class="line">                        <span class="literal">Ok</span>(case) =&gt; cases.push(case),</span><br><span class="line">                        <span class="literal">Err</span>(e) =&gt; <span class="keyword">return</span> <span class="literal">Err</span>(e),</span><br><span class="line">                    &#125;;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">Err</span>(ParserError::at(&amp;<span class="keyword">self</span>.loc()).into());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        loc.end = <span class="keyword">self</span>.pos();</span><br><span class="line">        <span class="keyword">let</span> switch = SwitchStmt &#123;</span><br><span class="line">            loc,</span><br><span class="line">            discrim,</span><br><span class="line">            cases,</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">self</span>.leave_loop();</span><br><span class="line">        <span class="literal">Ok</span>(switch.into())</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">switch_default</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) -&gt; <span class="built_in">Result</span>&lt;SwitchCase, ParsingError&gt; &#123;</span><br><span class="line">        <span class="keyword">self</span>.lexer.advance();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">match</span> <span class="keyword">self</span>.ahead_is_symbol(Symbol::Colon) &#123;</span><br><span class="line">            <span class="literal">true</span> =&gt; <span class="keyword">self</span>.lexer.advance(),</span><br><span class="line">            <span class="literal">false</span> =&gt; <span class="keyword">return</span> <span class="literal">Err</span>(ParserError::at(&amp;<span class="keyword">self</span>.loc()).into()),</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut</span> cons = <span class="built_in">vec!</span>[];</span><br><span class="line">        <span class="keyword">loop</span> &#123;</span><br><span class="line">            <span class="keyword">let</span> stmt = <span class="keyword">match</span> <span class="keyword">self</span>.stmt() &#123;</span><br><span class="line">                <span class="literal">Ok</span>(stmt) =&gt; stmt,</span><br><span class="line">                <span class="literal">Err</span>(e) =&gt; <span class="keyword">return</span> <span class="literal">Err</span>(e),</span><br><span class="line">            &#125;;</span><br><span class="line">            cons.push(stmt);</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">self</span>.ahead_is_keyword(Keyword::Case) || <span class="keyword">self</span>.ahead_is_symbol(Symbol::BraceR) &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="literal">Ok</span>(SwitchCase &#123; test: <span class="literal">None</span>, cons &#125;)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">switch_case</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) -&gt; <span class="built_in">Result</span>&lt;SwitchCase, ParsingError&gt; &#123;</span><br><span class="line">        <span class="keyword">self</span>.lexer.advance();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> test = <span class="keyword">match</span> <span class="keyword">self</span>.expr(<span class="literal">false</span>) &#123;</span><br><span class="line">            <span class="literal">Ok</span>(expr) =&gt; <span class="literal">Some</span>(expr),</span><br><span class="line">            <span class="literal">Err</span>(e) =&gt; <span class="keyword">return</span> <span class="literal">Err</span>(e),</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">match</span> <span class="keyword">self</span>.ahead_is_symbol(Symbol::Colon) &#123;</span><br><span class="line">            <span class="literal">true</span> =&gt; <span class="keyword">self</span>.lexer.advance(),</span><br><span class="line">            <span class="literal">false</span> =&gt; <span class="keyword">return</span> <span class="literal">Err</span>(ParserError::at(&amp;<span class="keyword">self</span>.loc()).into()),</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut</span> cons = <span class="built_in">vec!</span>[];</span><br><span class="line">        <span class="keyword">loop</span> &#123;</span><br><span class="line">            <span class="keyword">let</span> stmt = <span class="keyword">match</span> <span class="keyword">self</span>.stmt() &#123;</span><br><span class="line">                <span class="literal">Ok</span>(stmt) =&gt; stmt,</span><br><span class="line">                <span class="literal">Err</span>(e) =&gt; <span class="keyword">return</span> <span class="literal">Err</span>(e),</span><br><span class="line">            &#125;;</span><br><span class="line">            cons.push(stmt);</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">self</span>.ahead_is_keyword(Keyword::Case) || <span class="keyword">self</span>.ahead_is_symbol(Symbol::BraceR) &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="literal">Ok</span>(SwitchCase &#123; test, cons &#125;)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">with_stmt</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) -&gt; <span class="built_in">Result</span>&lt;Stmt, ParsingError&gt; &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut</span> loc = <span class="keyword">self</span>.loc();</span><br><span class="line">        <span class="keyword">self</span>.lexer.advance();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">match</span> <span class="keyword">self</span>.ahead_is_symbol(Symbol::ParenL) &#123;</span><br><span class="line">            <span class="literal">true</span> =&gt; <span class="keyword">self</span>.lexer.advance(),</span><br><span class="line">            <span class="literal">false</span> =&gt; <span class="keyword">return</span> <span class="literal">Err</span>(ParserError::at(&amp;<span class="keyword">self</span>.loc()).into()),</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> object = <span class="keyword">match</span> <span class="keyword">self</span>.expr(<span class="literal">false</span>) &#123;</span><br><span class="line">            <span class="literal">Ok</span>(expr) =&gt; expr,</span><br><span class="line">            <span class="literal">Err</span>(e) =&gt; <span class="keyword">return</span> <span class="literal">Err</span>(e),</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">match</span> <span class="keyword">self</span>.ahead_is_symbol(Symbol::ParenR) &#123;</span><br><span class="line">            <span class="literal">true</span> =&gt; <span class="keyword">self</span>.lexer.advance(),</span><br><span class="line">            <span class="literal">false</span> =&gt; <span class="keyword">return</span> <span class="literal">Err</span>(ParserError::at(&amp;<span class="keyword">self</span>.loc()).into()),</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> body = <span class="keyword">match</span> <span class="keyword">self</span>.stmt() &#123;</span><br><span class="line">            <span class="literal">Ok</span>(stmt) =&gt; stmt,</span><br><span class="line">            <span class="literal">Err</span>(e) =&gt; <span class="keyword">return</span> <span class="literal">Err</span>(e),</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        loc.end = <span class="keyword">self</span>.pos();</span><br><span class="line">        <span class="keyword">let</span> stmt = WithStmt &#123; loc, object, body &#125;;</span><br><span class="line">        <span class="literal">Ok</span>(stmt.into())</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">empty_stmt</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) -&gt; <span class="built_in">Result</span>&lt;Stmt, ParsingError&gt; &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut</span> loc = <span class="keyword">self</span>.loc();</span><br><span class="line">        <span class="keyword">self</span>.lexer.advance();</span><br><span class="line">        loc.end = <span class="keyword">self</span>.pos();</span><br><span class="line">        <span class="literal">Ok</span>(EmptyStmt &#123; loc &#125;.into())</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">ret_stmt</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) -&gt; <span class="built_in">Result</span>&lt;Stmt, ParsingError&gt; &#123;</span><br><span class="line">        <span class="keyword">let</span> loc = <span class="keyword">self</span>.loc();</span><br><span class="line">        <span class="keyword">self</span>.lexer.advance();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut</span> ret = ReturnStmt &#123;</span><br><span class="line">            loc,</span><br><span class="line">            argument: <span class="literal">None</span>,</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">self</span>.lexer.next_is_line_terminator &#123;</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">self</span>.ahead_is_symbol(Symbol::Semi) &#123;</span><br><span class="line">                <span class="keyword">self</span>.lexer.advance();</span><br><span class="line">            &#125;</span><br><span class="line">            ret.loc.end = <span class="keyword">self</span>.pos();</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">Ok</span>(ret.into());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> !<span class="keyword">self</span>.ahead_is_symbol(Symbol::BraceR) &#123;</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">self</span>.ahead_is_symbol(Symbol::Semi) &#123;</span><br><span class="line">                <span class="keyword">self</span>.lexer.advance();</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                ret.argument = <span class="keyword">match</span> <span class="keyword">self</span>.expr(<span class="literal">false</span>) &#123;</span><br><span class="line">                    <span class="literal">Ok</span>(expr) =&gt; <span class="literal">Some</span>(expr),</span><br><span class="line">                    <span class="literal">Err</span>(e) =&gt; <span class="keyword">return</span> <span class="literal">Err</span>(e),</span><br><span class="line">                &#125;;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ret.loc.end = <span class="keyword">self</span>.pos();</span><br><span class="line">        <span class="literal">Ok</span>(ret.into())</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">break_stmt</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) -&gt; <span class="built_in">Result</span>&lt;Stmt, ParsingError&gt; &#123;</span><br><span class="line">        <span class="keyword">if</span> !<span class="keyword">self</span>.in_loop() &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">Err</span>(ParserError::at(&amp;<span class="keyword">self</span>.loc()).into());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut</span> loc = <span class="keyword">self</span>.loc();</span><br><span class="line">        <span class="keyword">self</span>.lexer.advance();</span><br><span class="line">        loc.end = <span class="keyword">self</span>.pos();</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">self</span>.ahead_is_symbol(Symbol::Semi) &#123;</span><br><span class="line">            <span class="keyword">self</span>.lexer.advance();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="literal">Ok</span>(BreakStmt &#123; loc &#125;.into())</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">cont_stmt</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) -&gt; <span class="built_in">Result</span>&lt;Stmt, ParsingError&gt; &#123;</span><br><span class="line">        <span class="keyword">if</span> !<span class="keyword">self</span>.in_loop() &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">Err</span>(ParserError::at(&amp;<span class="keyword">self</span>.loc()).into());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut</span> loc = <span class="keyword">self</span>.loc();</span><br><span class="line">        <span class="keyword">self</span>.lexer.advance();</span><br><span class="line">        loc.end = <span class="keyword">self</span>.pos();</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">self</span>.ahead_is_symbol(Symbol::Semi) &#123;</span><br><span class="line">            <span class="keyword">self</span>.lexer.advance();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="literal">Ok</span>(ContStmt &#123; loc &#125;.into())</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">while_stmt</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) -&gt; <span class="built_in">Result</span>&lt;Stmt, ParsingError&gt; &#123;</span><br><span class="line">        <span class="keyword">self</span>.enter_loop();</span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut</span> loc = <span class="keyword">self</span>.loc();</span><br><span class="line">        <span class="keyword">self</span>.lexer.advance();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">match</span> <span class="keyword">self</span>.ahead_is_symbol(Symbol::ParenL) &#123;</span><br><span class="line">            <span class="literal">true</span> =&gt; <span class="keyword">self</span>.lexer.advance(),</span><br><span class="line">            <span class="literal">false</span> =&gt; <span class="keyword">return</span> <span class="literal">Err</span>(ParserError::at(&amp;<span class="keyword">self</span>.loc()).into()),</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> test = <span class="keyword">match</span> <span class="keyword">self</span>.expr(<span class="literal">false</span>) &#123;</span><br><span class="line">            <span class="literal">Ok</span>(expr) =&gt; expr,</span><br><span class="line">            <span class="literal">Err</span>(e) =&gt; <span class="keyword">return</span> <span class="literal">Err</span>(e),</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">match</span> <span class="keyword">self</span>.ahead_is_symbol(Symbol::ParenR) &#123;</span><br><span class="line">            <span class="literal">true</span> =&gt; <span class="keyword">self</span>.lexer.advance(),</span><br><span class="line">            <span class="literal">false</span> =&gt; <span class="keyword">return</span> <span class="literal">Err</span>(ParserError::at(&amp;<span class="keyword">self</span>.loc()).into()),</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> body = <span class="keyword">match</span> <span class="keyword">self</span>.stmt() &#123;</span><br><span class="line">            <span class="literal">Ok</span>(stmt) =&gt; stmt,</span><br><span class="line">            <span class="literal">Err</span>(e) =&gt; <span class="keyword">return</span> <span class="literal">Err</span>(e),</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        loc.end = <span class="keyword">self</span>.pos();</span><br><span class="line">        <span class="keyword">let</span> stmt = WhileStmt &#123; loc, test, body &#125;;</span><br><span class="line">        <span class="keyword">self</span>.leave_loop();</span><br><span class="line">        <span class="literal">Ok</span>(stmt.into())</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">do_while</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) -&gt; <span class="built_in">Result</span>&lt;Stmt, ParsingError&gt; &#123;</span><br><span class="line">        <span class="keyword">self</span>.enter_loop();</span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut</span> loc = <span class="keyword">self</span>.loc();</span><br><span class="line">        <span class="keyword">self</span>.lexer.advance();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> body = <span class="keyword">match</span> <span class="keyword">self</span>.stmt() &#123;</span><br><span class="line">            <span class="literal">Ok</span>(stmt) =&gt; stmt,</span><br><span class="line">            <span class="literal">Err</span>(e) =&gt; <span class="keyword">return</span> <span class="literal">Err</span>(e),</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">match</span> <span class="keyword">self</span>.ahead_is_keyword(Keyword::While) &#123;</span><br><span class="line">            <span class="literal">true</span> =&gt; <span class="keyword">self</span>.lexer.advance(),</span><br><span class="line">            <span class="literal">false</span> =&gt; <span class="keyword">return</span> <span class="literal">Err</span>(ParserError::at(&amp;<span class="keyword">self</span>.loc()).into()),</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">match</span> <span class="keyword">self</span>.ahead_is_symbol(Symbol::ParenL) &#123;</span><br><span class="line">            <span class="literal">true</span> =&gt; <span class="keyword">self</span>.lexer.advance(),</span><br><span class="line">            <span class="literal">false</span> =&gt; <span class="keyword">return</span> <span class="literal">Err</span>(ParserError::at(&amp;<span class="keyword">self</span>.loc()).into()),</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> test = <span class="keyword">match</span> <span class="keyword">self</span>.expr(<span class="literal">false</span>) &#123;</span><br><span class="line">            <span class="literal">Ok</span>(expr) =&gt; expr,</span><br><span class="line">            <span class="literal">Err</span>(e) =&gt; <span class="keyword">return</span> <span class="literal">Err</span>(e),</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">match</span> <span class="keyword">self</span>.ahead_is_symbol(Symbol::ParenR) &#123;</span><br><span class="line">            <span class="literal">true</span> =&gt; <span class="keyword">self</span>.lexer.advance(),</span><br><span class="line">            <span class="literal">false</span> =&gt; <span class="keyword">return</span> <span class="literal">Err</span>(ParserError::at(&amp;<span class="keyword">self</span>.loc()).into()),</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        loc.end = <span class="keyword">self</span>.pos();</span><br><span class="line">        <span class="keyword">let</span> stmt = DoWhileStmt &#123; loc, test, body &#125;;</span><br><span class="line">        <span class="keyword">self</span>.leave_loop();</span><br><span class="line">        <span class="literal">Ok</span>(stmt.into())</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">for_stmt</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) -&gt; <span class="built_in">Result</span>&lt;Stmt, ParsingError&gt; &#123;</span><br><span class="line">        <span class="keyword">self</span>.enter_loop();</span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut</span> loc = <span class="keyword">self</span>.loc();</span><br><span class="line">        <span class="keyword">self</span>.lexer.advance();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> !<span class="keyword">self</span>.ahead_is_symbol(Symbol::ParenL) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">Err</span>(ParserError::at(&amp;<span class="keyword">self</span>.loc()).into());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">self</span>.lexer.advance();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut</span> first = <span class="literal">None</span>;</span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut</span> left = <span class="literal">None</span>;</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">self</span>.ahead_is_keyword(Keyword::Var) &#123;</span><br><span class="line">            first = <span class="keyword">match</span> <span class="keyword">self</span>.for_var() &#123;</span><br><span class="line">                <span class="literal">Ok</span>(expr) =&gt; <span class="literal">Some</span>(expr),</span><br><span class="line">                <span class="literal">Err</span>(e) =&gt; <span class="keyword">return</span> <span class="literal">Err</span>(e),</span><br><span class="line">            &#125;;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> !<span class="keyword">self</span>.ahead_is_symbol(Symbol::Semi) &#123;</span><br><span class="line">            left = <span class="keyword">match</span> <span class="keyword">self</span>.expr(<span class="literal">true</span>) &#123;</span><br><span class="line">                <span class="literal">Ok</span>(expr) =&gt; <span class="literal">Some</span>(expr),</span><br><span class="line">                <span class="literal">Err</span>(e) =&gt; <span class="keyword">return</span> <span class="literal">Err</span>(e),</span><br><span class="line">            &#125;;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> is_for_in = <span class="keyword">self</span>.ahead_is_keyword(Keyword::In);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut</span> for_in_left = <span class="literal">None</span>;</span><br><span class="line">        <span class="keyword">if</span> first.is_some() &#123;</span><br><span class="line">            <span class="keyword">let</span> first = first.unwrap();</span><br><span class="line">            <span class="keyword">if</span> is_for_in &amp;&amp; first.decs.len() &gt; <span class="number">1</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">Err</span>(ParserError::at(&amp;first.loc).into());</span><br><span class="line">            &#125;</span><br><span class="line">            for_in_left = <span class="literal">Some</span>(ForFirst::VarDec(first));</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> left.is_some() &#123;</span><br><span class="line">            for_in_left = <span class="literal">Some</span>(ForFirst::Expr(left.unwrap()));</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> is_for_in &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">Err</span>(ParserError::at(&amp;<span class="keyword">self</span>.loc()).into());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> is_for_in &#123;</span><br><span class="line">            <span class="keyword">self</span>.lexer.advance();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">let</span> right = <span class="keyword">match</span> <span class="keyword">self</span>.expr(<span class="literal">false</span>) &#123;</span><br><span class="line">                <span class="literal">Ok</span>(expr) =&gt; expr,</span><br><span class="line">                <span class="literal">Err</span>(e) =&gt; <span class="keyword">return</span> <span class="literal">Err</span>(e),</span><br><span class="line">            &#125;;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> !<span class="keyword">self</span>.ahead_is_symbol(Symbol::ParenR) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">Err</span>(ParserError::at(&amp;<span class="keyword">self</span>.loc()).into());</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">self</span>.lexer.advance();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">let</span> body = <span class="keyword">match</span> <span class="keyword">self</span>.stmt() &#123;</span><br><span class="line">                <span class="literal">Ok</span>(stmt) =&gt; stmt,</span><br><span class="line">                <span class="literal">Err</span>(e) =&gt; <span class="keyword">return</span> <span class="literal">Err</span>(e),</span><br><span class="line">            &#125;;</span><br><span class="line"></span><br><span class="line">            loc.end = <span class="keyword">self</span>.pos();</span><br><span class="line">            <span class="keyword">self</span>.leave_loop();</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">Ok</span>(ForInStmt &#123;</span><br><span class="line">                loc,</span><br><span class="line">                left: for_in_left.unwrap(),</span><br><span class="line">                right,</span><br><span class="line">                body,</span><br><span class="line">            &#125;</span><br><span class="line">            .into());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> !<span class="keyword">self</span>.ahead_is_symbol(Symbol::Semi) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">Err</span>(ParserError::at(&amp;<span class="keyword">self</span>.loc()).into());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">self</span>.lexer.advance();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> test = <span class="keyword">match</span> <span class="keyword">self</span>.ahead_is_symbol(Symbol::Semi) &#123;</span><br><span class="line">            <span class="literal">true</span> =&gt; <span class="literal">None</span>,</span><br><span class="line">            <span class="literal">false</span> =&gt; <span class="keyword">match</span> <span class="keyword">self</span>.expr(<span class="literal">false</span>) &#123;</span><br><span class="line">                <span class="literal">Ok</span>(expr) =&gt; <span class="literal">Some</span>(expr),</span><br><span class="line">                <span class="literal">Err</span>(e) =&gt; <span class="keyword">return</span> <span class="literal">Err</span>(e),</span><br><span class="line">            &#125;,</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">if</span> !<span class="keyword">self</span>.ahead_is_symbol(Symbol::Semi) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">Err</span>(ParserError::at(&amp;<span class="keyword">self</span>.loc()).into());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">self</span>.lexer.advance();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> update = <span class="keyword">match</span> <span class="keyword">self</span>.ahead_is_symbol(Symbol::ParenR) &#123;</span><br><span class="line">            <span class="literal">true</span> =&gt; <span class="literal">None</span>,</span><br><span class="line">            <span class="literal">false</span> =&gt; <span class="keyword">match</span> <span class="keyword">self</span>.expr(<span class="literal">false</span>) &#123;</span><br><span class="line">                <span class="literal">Ok</span>(expr) =&gt; <span class="literal">Some</span>(expr),</span><br><span class="line">                <span class="literal">Err</span>(e) =&gt; <span class="keyword">return</span> <span class="literal">Err</span>(e),</span><br><span class="line">            &#125;,</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> !<span class="keyword">self</span>.ahead_is_symbol(Symbol::ParenR) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">Err</span>(ParserError::at(&amp;<span class="keyword">self</span>.loc()).into());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">self</span>.lexer.advance();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> body = <span class="keyword">match</span> <span class="keyword">self</span>.stmt() &#123;</span><br><span class="line">            <span class="literal">Ok</span>(stmt) =&gt; stmt,</span><br><span class="line">            <span class="literal">Err</span>(e) =&gt; <span class="keyword">return</span> <span class="literal">Err</span>(e),</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        loc.end = <span class="keyword">self</span>.pos();</span><br><span class="line">        <span class="literal">Ok</span>(ForStmt &#123;</span><br><span class="line">            loc,</span><br><span class="line">            init: for_in_left,</span><br><span class="line">            test,</span><br><span class="line">            update,</span><br><span class="line">            body,</span><br><span class="line">        &#125;</span><br><span class="line">        .into())</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">for_var</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) -&gt; <span class="built_in">Result</span>&lt;Rc&lt;VarDec&gt;, ParsingError&gt; &#123;</span><br><span class="line">        <span class="keyword">match</span> <span class="keyword">self</span>.var_dec_stmt(<span class="literal">true</span>, <span class="literal">true</span>) &#123;</span><br><span class="line">            <span class="literal">Ok</span>(stmt) =&gt; <span class="keyword">match</span> stmt &#123;</span><br><span class="line">                Stmt::VarDec(stmt) =&gt; <span class="literal">Ok</span>(stmt.clone()),</span><br><span class="line">                _ =&gt; <span class="built_in">panic!</span>(), <span class="comment">// unreachable</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="literal">Err</span>(e) =&gt; <span class="literal">Err</span>(e),</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">if_stmt</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) -&gt; <span class="built_in">Result</span>&lt;Stmt, ParsingError&gt; &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut</span> loc = <span class="keyword">self</span>.loc();</span><br><span class="line">        <span class="keyword">self</span>.lexer.advance();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> !<span class="keyword">self</span>.ahead_is_symbol(Symbol::ParenL) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">Err</span>(ParserError::at(&amp;<span class="keyword">self</span>.loc()).into());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">self</span>.lexer.advance();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> test = <span class="keyword">match</span> <span class="keyword">self</span>.expr(<span class="literal">false</span>) &#123;</span><br><span class="line">            <span class="literal">Ok</span>(expr) =&gt; expr,</span><br><span class="line">            <span class="literal">Err</span>(e) =&gt; <span class="keyword">return</span> <span class="literal">Err</span>(e),</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> !<span class="keyword">self</span>.ahead_is_symbol(Symbol::ParenR) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">Err</span>(ParserError::at(&amp;<span class="keyword">self</span>.loc()).into());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">self</span>.lexer.advance();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> cons = <span class="keyword">match</span> <span class="keyword">self</span>.stmt() &#123;</span><br><span class="line">            <span class="literal">Ok</span>(stmt) =&gt; stmt,</span><br><span class="line">            <span class="literal">Err</span>(e) =&gt; <span class="keyword">return</span> <span class="literal">Err</span>(e),</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut</span> alt: <span class="built_in">Option</span>&lt;Stmt&gt; = <span class="literal">None</span>;</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">self</span>.ahead_is_keyword(Keyword::Else) &#123;</span><br><span class="line">            <span class="keyword">self</span>.lexer.advance();</span><br><span class="line">            alt = <span class="keyword">match</span> <span class="keyword">self</span>.stmt() &#123;</span><br><span class="line">                <span class="literal">Ok</span>(stmt) =&gt; <span class="literal">Some</span>(stmt),</span><br><span class="line">                <span class="literal">Err</span>(e) =&gt; <span class="keyword">return</span> <span class="literal">Err</span>(e),</span><br><span class="line">            &#125;;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        loc.end = <span class="keyword">self</span>.pos();</span><br><span class="line">        <span class="keyword">let</span> s = IfStmt &#123;</span><br><span class="line">            loc,</span><br><span class="line">            test,</span><br><span class="line">            cons,</span><br><span class="line">            alt,</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="literal">Ok</span>(s.into())</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">var_dec_stmt</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, not_in: <span class="built_in">bool</span>, leave_semi: <span class="built_in">bool</span>) -&gt; <span class="built_in">Result</span>&lt;Stmt, ParsingError&gt; &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut</span> loc = <span class="keyword">self</span>.loc();</span><br><span class="line">        <span class="keyword">self</span>.lexer.advance();</span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut</span> decs = <span class="built_in">vec!</span>[];</span><br><span class="line">        <span class="keyword">loop</span> &#123;</span><br><span class="line">            <span class="keyword">match</span> <span class="keyword">self</span>.var_decor(not_in) &#123;</span><br><span class="line">                <span class="literal">Ok</span>(dec) =&gt; decs.push(dec),</span><br><span class="line">                <span class="literal">Err</span>(e) =&gt; <span class="keyword">return</span> <span class="literal">Err</span>(e),</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">self</span>.ahead_is_symbol(Symbol::Comma) &#123;</span><br><span class="line">                <span class="keyword">self</span>.lexer.advance();</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">self</span>.ahead_is_symbol(Symbol::Semi) &amp;&amp; !leave_semi &#123;</span><br><span class="line">                <span class="keyword">self</span>.lexer.advance();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        loc.end = <span class="keyword">self</span>.pos();</span><br><span class="line">        <span class="keyword">let</span> var_dec = VarDec &#123; loc, decs &#125;;</span><br><span class="line">        <span class="literal">Ok</span>(var_dec.into())</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">var_decor</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, not_in: <span class="built_in">bool</span>) -&gt; <span class="built_in">Result</span>&lt;VarDecor, ParsingError&gt; &#123;</span><br><span class="line">        <span class="keyword">let</span> id = <span class="keyword">match</span> <span class="keyword">self</span>.primary_expr() &#123;</span><br><span class="line">            <span class="literal">Ok</span>(expr) =&gt; &#123;</span><br><span class="line">                <span class="keyword">if</span> !expr.is_id() &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">Err</span>(ParserError::at(expr.literal().loc()).into());</span><br><span class="line">                &#125;</span><br><span class="line">                expr</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="literal">Err</span>(e) =&gt; <span class="keyword">return</span> <span class="literal">Err</span>(e),</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut</span> dec = VarDecor &#123; id, init: <span class="literal">None</span> &#125;;</span><br><span class="line">        <span class="keyword">if</span> !<span class="keyword">self</span>.ahead_is_symbol(Symbol::Assign) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">Ok</span>(dec);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">self</span>.lexer.advance();</span><br><span class="line">        dec.init = <span class="keyword">match</span> <span class="keyword">self</span>.cond_expr(not_in) &#123;</span><br><span class="line">            <span class="literal">Ok</span>(expr) =&gt; <span class="literal">Some</span>(expr),</span><br><span class="line">            <span class="literal">Err</span>(e) =&gt; <span class="keyword">return</span> <span class="literal">Err</span>(e),</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">Ok</span>(dec);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">block_stmt</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) -&gt; <span class="built_in">Result</span>&lt;Stmt, ParsingError&gt; &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut</span> loc = <span class="keyword">self</span>.loc();</span><br><span class="line">        <span class="keyword">self</span>.lexer.advance();</span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut</span> body = <span class="built_in">vec!</span>[];</span><br><span class="line">        <span class="keyword">loop</span> &#123;</span><br><span class="line">            <span class="keyword">match</span> <span class="keyword">self</span>.lexer.peek() &#123;</span><br><span class="line">                <span class="literal">Ok</span>(tok) =&gt; &#123;</span><br><span class="line">                    <span class="keyword">if</span> tok.is_symbol_kind(Symbol::BraceR) &#123;</span><br><span class="line">                        <span class="keyword">self</span>.lexer.advance();</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">match</span> <span class="keyword">self</span>.stmt() &#123;</span><br><span class="line">                        <span class="literal">Ok</span>(stmt) =&gt; body.push(stmt),</span><br><span class="line">                        <span class="literal">Err</span>(e) =&gt; <span class="keyword">return</span> <span class="literal">Err</span>(e),</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="literal">Err</span>(e) =&gt; <span class="keyword">return</span> <span class="literal">Err</span>(e.into()),</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        loc.end = <span class="keyword">self</span>.pos();</span><br><span class="line">        <span class="keyword">let</span> b = BlockStmt &#123; loc, body &#125;;</span><br><span class="line">        <span class="literal">Ok</span>(b.into())</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">expr_stmt</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) -&gt; <span class="built_in">Result</span>&lt;Stmt, ParsingError&gt; &#123;</span><br><span class="line">        <span class="keyword">match</span> <span class="keyword">self</span>.expr(<span class="literal">false</span>) &#123;</span><br><span class="line">            <span class="literal">Ok</span>(expr) =&gt; &#123;</span><br><span class="line">                <span class="keyword">if</span> <span class="keyword">self</span>.ahead_is_symbol(Symbol::Semi) &#123;</span><br><span class="line">                    <span class="keyword">self</span>.lexer.advance();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="literal">Ok</span>(ExprStmt &#123; expr &#125;.into())</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="literal">Err</span>(e) =&gt; <span class="literal">Err</span>(e),</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">expr</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, not_in: <span class="built_in">bool</span>) -&gt; <span class="built_in">Result</span>&lt;Expr, ParsingError&gt; &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut</span> loc = <span class="keyword">self</span>.loc();</span><br><span class="line">        <span class="keyword">let</span> first = <span class="keyword">match</span> <span class="keyword">self</span>.assign_expr(not_in, <span class="literal">None</span>) &#123;</span><br><span class="line">            <span class="literal">Ok</span>(expr) =&gt; expr,</span><br><span class="line">            <span class="literal">Err</span>(e) =&gt; <span class="keyword">return</span> <span class="literal">Err</span>(e),</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> tok = <span class="keyword">self</span>.lexer.peek();</span><br><span class="line">        <span class="keyword">if</span> tok.is_err() &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">Ok</span>(first);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">let</span> tok = tok.ok().unwrap();</span><br><span class="line">        <span class="keyword">if</span> !tok.is_symbol_kind(Symbol::Comma) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">Ok</span>(first);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">self</span>.lexer.advance();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut</span> seq: <span class="built_in">Vec</span>&lt;Expr&gt; = <span class="built_in">vec!</span>[first];</span><br><span class="line">        <span class="keyword">loop</span> &#123;</span><br><span class="line">            <span class="keyword">let</span> expr = <span class="keyword">match</span> <span class="keyword">self</span>.assign_expr(not_in, <span class="literal">None</span>) &#123;</span><br><span class="line">                <span class="literal">Ok</span>(expr) =&gt; expr,</span><br><span class="line">                <span class="literal">Err</span>(e) =&gt; <span class="keyword">return</span> <span class="literal">Err</span>(e),</span><br><span class="line">            &#125;;</span><br><span class="line">            seq.push(expr);</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">self</span>.ahead_is_symbol(Symbol::Comma) &#123;</span><br><span class="line">                <span class="keyword">self</span>.lexer.advance();</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        loc.end = <span class="keyword">self</span>.pos();</span><br><span class="line">        <span class="keyword">let</span> seq = SeqExpr &#123; loc, exprs: seq &#125;;</span><br><span class="line">        <span class="literal">Ok</span>(seq.into())</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">ahead_is_symbol_assign</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) -&gt; <span class="built_in">bool</span> &#123;</span><br><span class="line">        <span class="keyword">match</span> <span class="keyword">self</span>.lexer.peek() &#123;</span><br><span class="line">            <span class="literal">Err</span>(_) =&gt; <span class="literal">false</span>,</span><br><span class="line">            <span class="literal">Ok</span>(tok) =&gt; tok.is_symbol_assign(),</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">assign_expr</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, not_in: <span class="built_in">bool</span>, left: <span class="built_in">Option</span>&lt;Expr&gt;) -&gt; <span class="built_in">Result</span>&lt;Expr, ParsingError&gt; &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut</span> loc = <span class="keyword">self</span>.loc();</span><br><span class="line">        <span class="keyword">let</span> lhs = <span class="keyword">match</span> left &#123;</span><br><span class="line">            <span class="literal">Some</span>(expr) =&gt; expr,</span><br><span class="line">            _ =&gt; <span class="keyword">match</span> <span class="keyword">self</span>.cond_expr(not_in) &#123;</span><br><span class="line">                <span class="literal">Ok</span>(expr) =&gt; expr,</span><br><span class="line">                <span class="literal">Err</span>(e) =&gt; <span class="keyword">return</span> <span class="literal">Err</span>(e),</span><br><span class="line">            &#125;,</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> !<span class="keyword">self</span>.ahead_is_symbol_assign() &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">Ok</span>(lhs);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">let</span> op = <span class="keyword">self</span>.lexer.next().ok().unwrap().deref().clone();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut</span> rhs = <span class="keyword">match</span> <span class="keyword">self</span>.cond_expr(not_in) &#123;</span><br><span class="line">            <span class="literal">Ok</span>(expr) =&gt; expr,</span><br><span class="line">            <span class="literal">Err</span>(e) =&gt; <span class="keyword">return</span> <span class="literal">Err</span>(e),</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">self</span>.ahead_is_symbol_assign() &#123;</span><br><span class="line">            rhs = <span class="keyword">match</span> <span class="keyword">self</span>.assign_expr(not_in, <span class="literal">Some</span>(rhs)) &#123;</span><br><span class="line">                <span class="literal">Ok</span>(expr) =&gt; expr,</span><br><span class="line">                <span class="literal">Err</span>(e) =&gt; <span class="keyword">return</span> <span class="literal">Err</span>(e),</span><br><span class="line">            &#125;;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        loc.end = <span class="keyword">self</span>.pos();</span><br><span class="line">        <span class="keyword">let</span> assign = AssignExpr &#123;</span><br><span class="line">            loc,</span><br><span class="line">            op,</span><br><span class="line">            left: lhs,</span><br><span class="line">            right: rhs,</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="literal">Ok</span>(assign.into())</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">cond_expr</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, not_in: <span class="built_in">bool</span>) -&gt; <span class="built_in">Result</span>&lt;Expr, ParsingError&gt; &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut</span> loc = <span class="keyword">self</span>.loc();</span><br><span class="line">        <span class="keyword">let</span> test = <span class="keyword">match</span> <span class="keyword">self</span>.expr_op(<span class="literal">None</span>, <span class="number">0</span>, not_in) &#123;</span><br><span class="line">            <span class="literal">Ok</span>(expr) =&gt; expr,</span><br><span class="line">            <span class="literal">Err</span>(e) =&gt; <span class="keyword">return</span> <span class="literal">Err</span>(e),</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> tok = <span class="keyword">self</span>.lexer.peek();</span><br><span class="line">        <span class="keyword">if</span> tok.is_err() &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">Ok</span>(test);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">let</span> tok = tok.ok().unwrap();</span><br><span class="line">        <span class="keyword">if</span> !tok.is_symbol_kind(Symbol::Conditional) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">Ok</span>(test);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">self</span>.lexer.advance();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> cons = <span class="keyword">match</span> <span class="keyword">self</span>.assign_expr(not_in, <span class="literal">None</span>) &#123;</span><br><span class="line">            <span class="literal">Ok</span>(expr) =&gt; expr,</span><br><span class="line">            <span class="literal">Err</span>(e) =&gt; <span class="keyword">return</span> <span class="literal">Err</span>(e),</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">match</span> <span class="keyword">self</span>.lexer.next() &#123;</span><br><span class="line">            <span class="literal">Ok</span>(tok) =&gt; <span class="keyword">match</span> tok.is_symbol_kind(Symbol::Colon) &#123;</span><br><span class="line">                <span class="literal">false</span> =&gt; <span class="keyword">return</span> <span class="literal">Err</span>(ParserError::at_tok(&amp;tok).into()),</span><br><span class="line">                <span class="literal">true</span> =&gt; (),</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="literal">Err</span>(e) =&gt; <span class="keyword">return</span> <span class="literal">Err</span>(e.into()),</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> alt = <span class="keyword">match</span> <span class="keyword">self</span>.assign_expr(not_in, <span class="literal">None</span>) &#123;</span><br><span class="line">            <span class="literal">Ok</span>(expr) =&gt; expr,</span><br><span class="line">            <span class="literal">Err</span>(e) =&gt; <span class="keyword">return</span> <span class="literal">Err</span>(e),</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        loc.end = <span class="keyword">self</span>.pos();</span><br><span class="line">        <span class="keyword">let</span> cond = CondExpr &#123;</span><br><span class="line">            loc,</span><br><span class="line">            test,</span><br><span class="line">            cons,</span><br><span class="line">            alt,</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="literal">Ok</span>(cond.into())</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">expr_op</span></span>(</span><br><span class="line">        &amp;<span class="keyword">mut</span> <span class="keyword">self</span>,</span><br><span class="line">        lhs: <span class="built_in">Option</span>&lt;Expr&gt;,</span><br><span class="line">        min_pcd: <span class="built_in">i32</span>,</span><br><span class="line">        not_in: <span class="built_in">bool</span>,</span><br><span class="line">    ) -&gt; <span class="built_in">Result</span>&lt;Expr, ParsingError&gt; &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut</span> loc = <span class="keyword">self</span>.loc();</span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut</span> lhs = <span class="keyword">match</span> lhs &#123;</span><br><span class="line">            <span class="literal">Some</span>(expr) =&gt; expr,</span><br><span class="line">            _ =&gt; <span class="keyword">match</span> <span class="keyword">self</span>.unary_expr() &#123;</span><br><span class="line">                <span class="literal">Ok</span>(expr) =&gt; expr,</span><br><span class="line">                <span class="literal">Err</span>(e) =&gt; <span class="keyword">return</span> <span class="literal">Err</span>(e),</span><br><span class="line">            &#125;,</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">loop</span> &#123;</span><br><span class="line">            <span class="keyword">let</span> ahead = <span class="keyword">match</span> <span class="keyword">self</span>.lexer.peek() &#123;</span><br><span class="line">                <span class="literal">Ok</span>(tok) =&gt; tok,</span><br><span class="line">                <span class="literal">Err</span>(_) =&gt; <span class="keyword">break</span>,</span><br><span class="line">            &#125;;</span><br><span class="line">            <span class="keyword">let</span> pcd;</span><br><span class="line">            <span class="keyword">if</span> ahead.is_symbol_bin() &#123;</span><br><span class="line">                pcd = ahead.symbol_pcd();</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> ahead.is_keyword_bin(not_in) &#123;</span><br><span class="line">                pcd = ahead.keyword_pcd()</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> pcd &lt; min_pcd &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">self</span>.lexer.advance();</span><br><span class="line">            <span class="keyword">let</span> op = ahead.deref().clone();</span><br><span class="line">            <span class="keyword">let</span> <span class="keyword">mut</span> rhs = <span class="keyword">match</span> <span class="keyword">self</span>.unary_expr() &#123;</span><br><span class="line">                <span class="literal">Ok</span>(expr) =&gt; expr,</span><br><span class="line">                <span class="literal">Err</span>(e) =&gt; <span class="keyword">return</span> <span class="literal">Err</span>(e),</span><br><span class="line">            &#125;;</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">let</span> <span class="literal">Ok</span>(next_ok) = <span class="keyword">self</span>.lexer.peek() &#123;</span><br><span class="line">                <span class="keyword">if</span> next_ok.is_symbol_bin() &#123;</span><br><span class="line">                    rhs = <span class="keyword">match</span> <span class="keyword">self</span>.expr_op(<span class="literal">Some</span>(rhs), pcd, not_in) &#123;</span><br><span class="line">                        <span class="literal">Ok</span>(expr) =&gt; expr,</span><br><span class="line">                        <span class="literal">Err</span>(e) =&gt; <span class="keyword">return</span> <span class="literal">Err</span>(e),</span><br><span class="line">                    &#125;;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            loc.end = <span class="keyword">self</span>.pos();</span><br><span class="line">            <span class="keyword">let</span> bin = BinaryExpr &#123;</span><br><span class="line">                loc,</span><br><span class="line">                op,</span><br><span class="line">                left: lhs,</span><br><span class="line">                right: rhs,</span><br><span class="line">            &#125;;</span><br><span class="line">            lhs = bin.into();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="literal">Ok</span>(lhs)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">postfix_expr</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) -&gt; <span class="built_in">Result</span>&lt;Expr, ParsingError&gt; &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut</span> loc = <span class="keyword">self</span>.loc();</span><br><span class="line">        <span class="keyword">match</span> <span class="keyword">self</span>.lhs_expr() &#123;</span><br><span class="line">            <span class="literal">Ok</span>(expr) =&gt; &#123;</span><br><span class="line">                <span class="keyword">if</span> <span class="keyword">let</span> <span class="literal">Ok</span>(tok) = <span class="keyword">self</span>.lexer.peek() &#123;</span><br><span class="line">                    <span class="keyword">if</span> tok.is_symbol_kind(Symbol::Inc) || tok.is_symbol_kind(Symbol::Dec) &#123;</span><br><span class="line">                        <span class="keyword">let</span> tok = <span class="keyword">self</span>.lexer.next().ok().unwrap();</span><br><span class="line">                        loc.end = <span class="keyword">self</span>.pos();</span><br><span class="line">                        <span class="keyword">let</span> expr: Expr = UnaryExpr &#123;</span><br><span class="line">                            loc,</span><br><span class="line">                            op: tok.deref().clone(),</span><br><span class="line">                            argument: expr,</span><br><span class="line">                            prefix: <span class="literal">false</span>,</span><br><span class="line">                        &#125;</span><br><span class="line">                        .into();</span><br><span class="line">                        <span class="keyword">return</span> <span class="literal">Ok</span>(expr);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="literal">Ok</span>(expr)</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="literal">Err</span>(e) =&gt; <span class="literal">Err</span>(e),</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">unary_expr</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) -&gt; <span class="built_in">Result</span>&lt;Expr, ParsingError&gt; &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut</span> loc = <span class="keyword">self</span>.loc();</span><br><span class="line">        <span class="keyword">let</span> tok = <span class="keyword">match</span> <span class="keyword">self</span>.lexer.peek() &#123;</span><br><span class="line">            <span class="literal">Ok</span>(tok) =&gt; tok,</span><br><span class="line">            <span class="literal">Err</span>(e) =&gt; <span class="keyword">return</span> <span class="literal">Err</span>(e.into()),</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">let</span> ks = <span class="built_in">vec!</span>[Keyword::Delete, Keyword::Void, Keyword::Typeof];</span><br><span class="line">        <span class="keyword">let</span> ss = <span class="built_in">vec!</span>[</span><br><span class="line">            Symbol::Inc,</span><br><span class="line">            Symbol::Dec,</span><br><span class="line">            Symbol::Add,</span><br><span class="line">            Symbol::Sub,</span><br><span class="line">            Symbol::BitNot,</span><br><span class="line">            Symbol::Not,</span><br><span class="line">        ];</span><br><span class="line">        <span class="keyword">if</span> tok.is_keyword_kind_in(&amp;ks) || tok.is_symbol_kind_in(&amp;ss) &#123;</span><br><span class="line">            <span class="keyword">let</span> op = <span class="keyword">self</span>.lexer.next().ok().unwrap().deref().clone();</span><br><span class="line">            <span class="keyword">let</span> argument = <span class="keyword">match</span> <span class="keyword">self</span>.unary_expr() &#123;</span><br><span class="line">                <span class="literal">Ok</span>(expr) =&gt; expr,</span><br><span class="line">                <span class="literal">Err</span>(e) =&gt; <span class="keyword">return</span> <span class="literal">Err</span>(e),</span><br><span class="line">            &#125;;</span><br><span class="line">            loc.end = <span class="keyword">self</span>.pos();</span><br><span class="line">            <span class="keyword">let</span> expr = UnaryExpr &#123;</span><br><span class="line">                loc,</span><br><span class="line">                op,</span><br><span class="line">                argument,</span><br><span class="line">                prefix: <span class="literal">true</span>,</span><br><span class="line">            &#125;;</span><br><span class="line">            <span class="literal">Ok</span>(expr.into())</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">self</span>.postfix_expr()</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">lhs_expr</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) -&gt; <span class="built_in">Result</span>&lt;Expr, ParsingError&gt; &#123;</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">self</span>.ahead_is_keyword(Keyword::New) &#123;</span><br><span class="line">            <span class="keyword">self</span>.new_expr()</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">self</span>.call_expr(<span class="literal">None</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">ahead_is_keyword</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, k: Keyword) -&gt; <span class="built_in">bool</span> &#123;</span><br><span class="line">        <span class="keyword">match</span> <span class="keyword">self</span>.lexer.peek() &#123;</span><br><span class="line">            <span class="literal">Ok</span>(tok) =&gt; tok.is_keyword_kind(k),</span><br><span class="line">            _ =&gt; <span class="literal">false</span>,</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">ahead_is_symbol</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, syb: Symbol) -&gt; <span class="built_in">bool</span> &#123;</span><br><span class="line">        <span class="keyword">match</span> <span class="keyword">self</span>.lexer.peek() &#123;</span><br><span class="line">            <span class="literal">Ok</span>(tok) =&gt; tok.is_symbol_kind(syb),</span><br><span class="line">            _ =&gt; <span class="literal">false</span>,</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">ahead_is_symbol_or</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, s1: Symbol, s2: Symbol) -&gt; <span class="built_in">bool</span> &#123;</span><br><span class="line">        <span class="keyword">match</span> <span class="keyword">self</span>.lexer.peek() &#123;</span><br><span class="line">            <span class="literal">Ok</span>(tok) =&gt; tok.is_symbol_kind(s1) || tok.is_symbol_kind(s2),</span><br><span class="line">            _ =&gt; <span class="literal">false</span>,</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">new_expr</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) -&gt; <span class="built_in">Result</span>&lt;Expr, ParsingError&gt; &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut</span> loc = <span class="keyword">self</span>.loc();</span><br><span class="line">        <span class="keyword">self</span>.lexer.advance();</span><br><span class="line">        <span class="keyword">let</span> callee = <span class="keyword">match</span> <span class="keyword">self</span>.ahead_is_keyword(Keyword::New) &#123;</span><br><span class="line">            <span class="literal">true</span> =&gt; <span class="keyword">self</span>.new_expr(),</span><br><span class="line">            <span class="literal">false</span> =&gt; <span class="keyword">self</span>.member_expr(<span class="literal">None</span>),</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">let</span> callee = <span class="keyword">match</span> callee &#123;</span><br><span class="line">            <span class="literal">Ok</span>(expr) =&gt; expr,</span><br><span class="line">            <span class="literal">Err</span>(e) =&gt; <span class="keyword">return</span> <span class="literal">Err</span>(e),</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">let</span> arguments = <span class="keyword">match</span> <span class="keyword">self</span>.ahead_is_symbol(Symbol::ParenL) &#123;</span><br><span class="line">            <span class="literal">true</span> =&gt; <span class="keyword">match</span> <span class="keyword">self</span>.args() &#123;</span><br><span class="line">                <span class="literal">Ok</span>(args) =&gt; args,</span><br><span class="line">                <span class="literal">Err</span>(e) =&gt; <span class="keyword">return</span> <span class="literal">Err</span>(e),</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="literal">false</span> =&gt; <span class="built_in">vec!</span>[],</span><br><span class="line">        &#125;;</span><br><span class="line">        loc.end = <span class="keyword">self</span>.pos();</span><br><span class="line">        <span class="keyword">let</span> expr = NewExpr &#123;</span><br><span class="line">            loc,</span><br><span class="line">            callee,</span><br><span class="line">            arguments,</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="literal">Ok</span>(expr.into())</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">args</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) -&gt; <span class="built_in">Result</span>&lt;<span class="built_in">Vec</span>&lt;Expr&gt;, ParsingError&gt; &#123;</span><br><span class="line">        <span class="keyword">self</span>.lexer.advance();</span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut</span> args: <span class="built_in">Vec</span>&lt;Expr&gt; = <span class="built_in">vec!</span>[];</span><br><span class="line">        <span class="keyword">loop</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">self</span>.ahead_is_symbol(Symbol::ParenR) &#123;</span><br><span class="line">                <span class="keyword">self</span>.lexer.advance();</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">match</span> <span class="keyword">self</span>.assign_expr(<span class="literal">false</span>, <span class="literal">None</span>) &#123;</span><br><span class="line">                <span class="literal">Ok</span>(expr) =&gt; args.push(expr),</span><br><span class="line">                <span class="literal">Err</span>(e) =&gt; <span class="keyword">return</span> <span class="literal">Err</span>(e),</span><br><span class="line">            &#125;;</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">self</span>.ahead_is_symbol(Symbol::Comma) &#123;</span><br><span class="line">                <span class="keyword">self</span>.lexer.advance();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="literal">Ok</span>(args)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">call_expr</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, callee: <span class="built_in">Option</span>&lt;Expr&gt;) -&gt; <span class="built_in">Result</span>&lt;Expr, ParsingError&gt; &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut</span> loc = <span class="keyword">self</span>.loc();</span><br><span class="line">        <span class="keyword">let</span> callee = <span class="keyword">match</span> callee &#123;</span><br><span class="line">            <span class="literal">Some</span>(expr) =&gt; expr,</span><br><span class="line">            _ =&gt; <span class="keyword">match</span> <span class="keyword">self</span>.member_expr(<span class="literal">None</span>) &#123;</span><br><span class="line">                <span class="literal">Ok</span>(expr) =&gt; expr,</span><br><span class="line">                <span class="literal">Err</span>(e) =&gt; <span class="keyword">return</span> <span class="literal">Err</span>(e),</span><br><span class="line">            &#125;,</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> !<span class="keyword">self</span>.ahead_is_symbol(Symbol::ParenL) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">Ok</span>(callee);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> arguments = <span class="keyword">match</span> <span class="keyword">self</span>.args() &#123;</span><br><span class="line">            <span class="literal">Ok</span>(args) =&gt; args,</span><br><span class="line">            <span class="literal">Err</span>(e) =&gt; <span class="keyword">return</span> <span class="literal">Err</span>(e),</span><br><span class="line">        &#125;;</span><br><span class="line">        loc.end = <span class="keyword">self</span>.pos();</span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut</span> expr: Expr = CallExpr &#123;</span><br><span class="line">            loc,</span><br><span class="line">            callee,</span><br><span class="line">            arguments,</span><br><span class="line">        &#125;</span><br><span class="line">        .into();</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">self</span>.ahead_is_symbol_or(Symbol::Dot, Symbol::BracketL) &#123;</span><br><span class="line">            expr = <span class="keyword">match</span> <span class="keyword">self</span>.member_expr(<span class="literal">Some</span>(expr)) &#123;</span><br><span class="line">                <span class="literal">Ok</span>(expr) =&gt; expr,</span><br><span class="line">                <span class="literal">Err</span>(e) =&gt; <span class="keyword">return</span> <span class="literal">Err</span>(e),</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> <span class="keyword">self</span>.ahead_is_symbol(Symbol::ParenL) &#123;</span><br><span class="line">            expr = <span class="keyword">match</span> <span class="keyword">self</span>.call_expr(<span class="literal">Some</span>(expr)) &#123;</span><br><span class="line">                <span class="literal">Ok</span>(expr) =&gt; expr,</span><br><span class="line">                <span class="literal">Err</span>(e) =&gt; <span class="keyword">return</span> <span class="literal">Err</span>(e),</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="literal">Ok</span>(expr)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">member_expr</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, obj: <span class="built_in">Option</span>&lt;Expr&gt;) -&gt; <span class="built_in">Result</span>&lt;Expr, ParsingError&gt; &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut</span> loc = <span class="keyword">self</span>.loc();</span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut</span> obj = <span class="keyword">match</span> obj &#123;</span><br><span class="line">            <span class="literal">Some</span>(o) =&gt; o,</span><br><span class="line">            _ =&gt; <span class="keyword">match</span> <span class="keyword">self</span>.primary_expr() &#123;</span><br><span class="line">                <span class="literal">Ok</span>(expr) =&gt; expr.into(),</span><br><span class="line">                <span class="literal">Err</span>(e) =&gt; <span class="keyword">return</span> <span class="literal">Err</span>(e),</span><br><span class="line">            &#125;,</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">loop</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">let</span> <span class="literal">Ok</span>(tok) = <span class="keyword">self</span>.lexer.peek() &#123;</span><br><span class="line">                <span class="keyword">if</span> tok.is_symbol_kind(Symbol::Dot) &#123;</span><br><span class="line">                    <span class="keyword">self</span>.lexer.advance();</span><br><span class="line">                    <span class="keyword">match</span> <span class="keyword">self</span>.lexer.next() &#123;</span><br><span class="line">                        <span class="literal">Ok</span>(tok) =&gt; &#123;</span><br><span class="line">                            <span class="keyword">if</span> !tok.is_id() &#123;</span><br><span class="line">                                <span class="keyword">return</span> <span class="literal">Err</span>(ParserError::at_tok(&amp;tok).into());</span><br><span class="line">                            &#125;</span><br><span class="line">                            <span class="keyword">let</span> prop = PrimaryExpr::Identifier(IdData::new(</span><br><span class="line">                                tok.loc().clone(),</span><br><span class="line">                                tok.id_data().clone().value,</span><br><span class="line">                            ));</span><br><span class="line">                            loc.end = <span class="keyword">self</span>.pos();</span><br><span class="line">                            obj = Expr::Member(Rc::new(MemberExpr &#123;</span><br><span class="line">                                loc,</span><br><span class="line">                                object: obj,</span><br><span class="line">                                property: prop.into(),</span><br><span class="line">                                computed: <span class="literal">false</span>,</span><br><span class="line">                            &#125;));</span><br><span class="line">                            <span class="keyword">continue</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="literal">Err</span>(e) =&gt; <span class="keyword">return</span> <span class="literal">Err</span>(e.into()),</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> tok.is_symbol_kind(Symbol::BracketL) &#123;</span><br><span class="line">                    <span class="keyword">self</span>.lexer.advance();</span><br><span class="line">                    <span class="keyword">let</span> prop = <span class="keyword">match</span> <span class="keyword">self</span>.expr(<span class="literal">false</span>) &#123;</span><br><span class="line">                        <span class="literal">Ok</span>(expr) =&gt; expr,</span><br><span class="line">                        <span class="literal">Err</span>(e) =&gt; <span class="keyword">return</span> <span class="literal">Err</span>(e.into()),</span><br><span class="line">                    &#125;;</span><br><span class="line">                    <span class="keyword">match</span> <span class="keyword">self</span>.lexer.next() &#123;</span><br><span class="line">                        <span class="literal">Ok</span>(tok) =&gt; &#123;</span><br><span class="line">                            <span class="keyword">if</span> !tok.is_symbol_kind(Symbol::BracketR) &#123;</span><br><span class="line">                                <span class="keyword">return</span> <span class="literal">Err</span>(ParserError::at_tok(&amp;tok).into());</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="literal">Err</span>(e) =&gt; <span class="keyword">return</span> <span class="literal">Err</span>(e.into()),</span><br><span class="line">                    &#125;</span><br><span class="line">                    loc.end = <span class="keyword">self</span>.pos();</span><br><span class="line">                    obj = Expr::Member(Rc::new(MemberExpr &#123;</span><br><span class="line">                        loc,</span><br><span class="line">                        object: obj,</span><br><span class="line">                        property: prop,</span><br><span class="line">                        computed: <span class="literal">true</span>,</span><br><span class="line">                    &#125;));</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="literal">Ok</span>(obj)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">primary_expr</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) -&gt; <span class="built_in">Result</span>&lt;PrimaryExpr, ParsingError&gt; &#123;</span><br><span class="line">        <span class="keyword">match</span> <span class="keyword">self</span>.lexer.next() &#123;</span><br><span class="line">            <span class="literal">Ok</span>(tok) =&gt; &#123;</span><br><span class="line">                <span class="keyword">let</span> loc = tok.loc().to_owned();</span><br><span class="line">                <span class="keyword">if</span> tok.is_keyword_kind(Keyword::This) &#123;</span><br><span class="line">                    <span class="literal">Ok</span>(ThisExprData::new(loc).into())</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> tok.is_id() &#123;</span><br><span class="line">                    <span class="literal">Ok</span>(IdData::new(loc, tok.id_data().value.clone()).into())</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> tok.is_undef() &#123;</span><br><span class="line">                    <span class="literal">Ok</span>(UndefData::new(loc).into())</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> tok.is_str() &#123;</span><br><span class="line">                    <span class="literal">Ok</span>(StringData::new(loc, tok.str_data().value.clone()).into())</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> tok.is_null() &#123;</span><br><span class="line">                    <span class="literal">Ok</span>(NullData::new(loc).into())</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> tok.is_bool() &#123;</span><br><span class="line">                    <span class="literal">Ok</span>(BoolData::new(loc, tok.bool_data().kind == BooleanLiteral::True).into())</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> tok.is_num() &#123;</span><br><span class="line">                    <span class="literal">Ok</span>(NumericData::new(loc, tok.num_data().value.clone()).into())</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> tok.is_symbol_kind(Symbol::BraceL) &#123;</span><br><span class="line">                    <span class="keyword">self</span>.object_literal(&amp;tok)</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> tok.is_symbol_kind(Symbol::BracketL) &#123;</span><br><span class="line">                    <span class="keyword">self</span>.array_literal(&amp;tok)</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> tok.is_symbol_kind(Symbol::ParenL) &#123;</span><br><span class="line">                    <span class="keyword">self</span>.paren_expr(&amp;tok)</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> tok.is_keyword_kind(Keyword::Function) &#123;</span><br><span class="line">                    <span class="keyword">self</span>.fn_expr(&amp;tok)</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="literal">Err</span>(ParserError::at_tok(&amp;tok).into())</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="literal">Err</span>(e) =&gt; <span class="literal">Err</span>(e.into()),</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">paren_expr</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, open: &amp;Token) -&gt; <span class="built_in">Result</span>&lt;PrimaryExpr, ParsingError&gt; &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut</span> loc = open.loc().to_owned();</span><br><span class="line">        <span class="keyword">let</span> value = <span class="keyword">match</span> <span class="keyword">self</span>.expr(<span class="literal">false</span>) &#123;</span><br><span class="line">            <span class="literal">Ok</span>(expr) =&gt; expr,</span><br><span class="line">            <span class="literal">Err</span>(e) =&gt; <span class="keyword">return</span> <span class="literal">Err</span>(e),</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">match</span> <span class="keyword">self</span>.ahead_is_symbol(Symbol::ParenR) &#123;</span><br><span class="line">            <span class="literal">true</span> =&gt; <span class="keyword">self</span>.lexer.advance(),</span><br><span class="line">            <span class="literal">false</span> =&gt; <span class="keyword">return</span> <span class="literal">Err</span>(ParserError::at(&amp;<span class="keyword">self</span>.loc()).into()),</span><br><span class="line">        &#125;</span><br><span class="line">        loc.end = <span class="keyword">self</span>.pos();</span><br><span class="line">        <span class="literal">Ok</span>(ParenData &#123; loc, value &#125;.into())</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">fn_expr</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, open: &amp;Token) -&gt; <span class="built_in">Result</span>&lt;PrimaryExpr, ParsingError&gt; &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut</span> loc = open.loc().to_owned();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut</span> id = <span class="literal">None</span>;</span><br><span class="line">        <span class="keyword">if</span> !<span class="keyword">self</span>.ahead_is_symbol(Symbol::ParenL) &#123;</span><br><span class="line">            id = <span class="keyword">match</span> <span class="keyword">self</span>.primary_expr() &#123;</span><br><span class="line">                <span class="literal">Ok</span>(expr) =&gt; &#123;</span><br><span class="line">                    <span class="keyword">if</span> !expr.is_id() &#123;</span><br><span class="line">                        <span class="keyword">return</span> <span class="literal">Err</span>(ParserError::at(expr.loc()).into());</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="literal">Some</span>(expr)</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="literal">Err</span>(e) =&gt; <span class="keyword">return</span> <span class="literal">Err</span>(e),</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">match</span> <span class="keyword">self</span>.ahead_is_symbol(Symbol::ParenL) &#123;</span><br><span class="line">            <span class="literal">true</span> =&gt; <span class="keyword">self</span>.lexer.advance(),</span><br><span class="line">            <span class="literal">false</span> =&gt; <span class="keyword">return</span> <span class="literal">Err</span>(ParserError::at(&amp;<span class="keyword">self</span>.loc()).into()),</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut</span> params = <span class="built_in">vec!</span>[];</span><br><span class="line">        <span class="keyword">loop</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">self</span>.ahead_is_symbol(Symbol::ParenR) &#123;</span><br><span class="line">                <span class="keyword">self</span>.lexer.advance();</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">match</span> <span class="keyword">self</span>.primary_expr() &#123;</span><br><span class="line">                <span class="literal">Ok</span>(e) =&gt; &#123;</span><br><span class="line">                    <span class="keyword">if</span> !e.is_id() &#123;</span><br><span class="line">                        <span class="keyword">return</span> <span class="literal">Err</span>(ParserError::at(e.loc()).into());</span><br><span class="line">                    &#125;</span><br><span class="line">                    params.push(e);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="literal">Err</span>(e) =&gt; <span class="keyword">return</span> <span class="literal">Err</span>(e),</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">self</span>.ahead_is_symbol(Symbol::Comma) &#123;</span><br><span class="line">                <span class="keyword">self</span>.lexer.advance();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        loc.end = <span class="keyword">self</span>.pos();</span><br><span class="line">        <span class="keyword">let</span> body = <span class="keyword">match</span> <span class="keyword">self</span>.block_stmt() &#123;</span><br><span class="line">            <span class="literal">Ok</span>(stmt) =&gt; stmt,</span><br><span class="line">            <span class="literal">Err</span>(e) =&gt; <span class="keyword">return</span> <span class="literal">Err</span>(e),</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> dec = FnDec &#123;</span><br><span class="line">            loc,</span><br><span class="line">            id,</span><br><span class="line">            params,</span><br><span class="line">            body,</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="literal">Ok</span>(dec.into())</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">object_literal</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, open: &amp;Token) -&gt; <span class="built_in">Result</span>&lt;PrimaryExpr, ParsingError&gt; &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut</span> ret = ObjectData &#123;</span><br><span class="line">            loc: open.loc().to_owned(),</span><br><span class="line">            properties: <span class="built_in">vec!</span>[],</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">loop</span> &#123;</span><br><span class="line">            <span class="keyword">match</span> <span class="keyword">self</span>.lexer.peek() &#123;</span><br><span class="line">                <span class="literal">Ok</span>(tok) =&gt; &#123;</span><br><span class="line">                    <span class="keyword">if</span> tok.is_symbol_kind(Symbol::BraceR) &#123;</span><br><span class="line">                        <span class="keyword">match</span> <span class="keyword">self</span>.lexer.next() &#123;</span><br><span class="line">                            <span class="literal">Err</span>(e) =&gt; <span class="keyword">return</span> <span class="literal">Err</span>(e.into()),</span><br><span class="line">                            _ =&gt; <span class="keyword">break</span>,</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">else</span> <span class="keyword">if</span> tok.is_symbol_kind(Symbol::Comma) &#123;</span><br><span class="line">                        <span class="keyword">match</span> <span class="keyword">self</span>.lexer.next() &#123;</span><br><span class="line">                            <span class="literal">Err</span>(e) =&gt; <span class="keyword">return</span> <span class="literal">Err</span>(e.into()),</span><br><span class="line">                            _ =&gt; (),</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">match</span> <span class="keyword">self</span>.object_prop() &#123;</span><br><span class="line">                        <span class="literal">Ok</span>(prop) =&gt; ret.properties.push(prop),</span><br><span class="line">                        <span class="literal">Err</span>(e) =&gt; <span class="keyword">return</span> <span class="literal">Err</span>(e),</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="literal">Err</span>(e) =&gt; <span class="keyword">return</span> <span class="literal">Err</span>(e.into()),</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        ret.loc.end = <span class="keyword">self</span>.pos();</span><br><span class="line">        <span class="literal">Ok</span>(PrimaryExpr::ObjectLiteral(ret))</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">object_prop</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) -&gt; <span class="built_in">Result</span>&lt;ObjectProperty, ParsingError&gt; &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut</span> loc = <span class="keyword">self</span>.loc();</span><br><span class="line">        <span class="keyword">let</span> key = <span class="keyword">match</span> <span class="keyword">self</span>.lexer.next() &#123;</span><br><span class="line">            <span class="literal">Ok</span>(tok) =&gt; &#123;</span><br><span class="line">                <span class="keyword">if</span> tok.is_str() &#123;</span><br><span class="line">                    PrimaryExpr::Literal(Literal::<span class="built_in">String</span>(StringData &#123;</span><br><span class="line">                        loc: tok.loc().to_owned(),</span><br><span class="line">                        value: tok.str_data().value.clone(),</span><br><span class="line">                    &#125;))</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> tok.is_id() &#123;</span><br><span class="line">                    PrimaryExpr::Identifier(IdData &#123;</span><br><span class="line">                        loc: tok.loc().to_owned(),</span><br><span class="line">                        name: tok.id_data().value.clone(),</span><br><span class="line">                    &#125;)</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">Err</span>(ParserError::at(tok.loc()).into());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="literal">Err</span>(e) =&gt; <span class="keyword">return</span> <span class="literal">Err</span>(e.into()),</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">match</span> <span class="keyword">self</span>.lexer.next() &#123;</span><br><span class="line">            <span class="literal">Ok</span>(tok) =&gt; &#123;</span><br><span class="line">                <span class="keyword">if</span> !tok.is_symbol_kind(Symbol::Colon) &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">Err</span>(ParserError::at(tok.loc()).into());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="literal">Err</span>(e) =&gt; <span class="keyword">return</span> <span class="literal">Err</span>(e.into()),</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">let</span> value = <span class="keyword">match</span> <span class="keyword">self</span>.assign_expr(<span class="literal">false</span>, <span class="literal">None</span>) &#123;</span><br><span class="line">            <span class="literal">Ok</span>(expr) =&gt; expr,</span><br><span class="line">            <span class="literal">Err</span>(e) =&gt; <span class="keyword">return</span> <span class="literal">Err</span>(e.into()),</span><br><span class="line">        &#125;;</span><br><span class="line">        loc.end = <span class="keyword">self</span>.pos();</span><br><span class="line">        <span class="literal">Ok</span>(ObjectProperty &#123;</span><br><span class="line">            loc,</span><br><span class="line">            key: key.into(),</span><br><span class="line">            value,</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">array_literal</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, open: &amp;Token) -&gt; <span class="built_in">Result</span>&lt;PrimaryExpr, ParsingError&gt; &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut</span> ret = ArrayData &#123;</span><br><span class="line">            loc: open.loc().to_owned(),</span><br><span class="line">            value: <span class="built_in">vec!</span>[],</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">loop</span> &#123;</span><br><span class="line">            <span class="keyword">match</span> <span class="keyword">self</span>.lexer.peek() &#123;</span><br><span class="line">                <span class="literal">Ok</span>(tok) =&gt; &#123;</span><br><span class="line">                    <span class="keyword">if</span> tok.is_symbol_kind(Symbol::BracketR) &#123;</span><br><span class="line">                        <span class="keyword">match</span> <span class="keyword">self</span>.lexer.next() &#123;</span><br><span class="line">                            <span class="literal">Err</span>(e) =&gt; <span class="keyword">return</span> <span class="literal">Err</span>(e.into()),</span><br><span class="line">                            _ =&gt; <span class="keyword">break</span>,</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">else</span> <span class="keyword">if</span> tok.is_symbol_kind(Symbol::Comma) &#123;</span><br><span class="line">                        <span class="keyword">match</span> <span class="keyword">self</span>.lexer.next() &#123;</span><br><span class="line">                            <span class="literal">Err</span>(e) =&gt; <span class="keyword">return</span> <span class="literal">Err</span>(e.into()),</span><br><span class="line">                            _ =&gt; &#123;</span><br><span class="line">                                <span class="keyword">let</span> expr = Expr::Primary(Rc::new(PrimaryExpr::Literal(</span><br><span class="line">                                    Literal::Undef(UndefData &#123;</span><br><span class="line">                                        loc: tok.loc().clone(),</span><br><span class="line">                                    &#125;),</span><br><span class="line">                                )));</span><br><span class="line">                                ret.value.push(expr)</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="keyword">match</span> <span class="keyword">self</span>.assign_expr(<span class="literal">false</span>, <span class="literal">None</span>) &#123;</span><br><span class="line">                            <span class="literal">Ok</span>(expr) =&gt; ret.value.push(expr),</span><br><span class="line">                            <span class="literal">Err</span>(e) =&gt; <span class="keyword">return</span> <span class="literal">Err</span>(e.into()),</span><br><span class="line">                        &#125;;</span><br><span class="line">                        <span class="keyword">if</span> <span class="keyword">self</span>.ahead_is_symbol(Symbol::Comma) &#123;</span><br><span class="line">                            <span class="keyword">self</span>.lexer.advance();</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="literal">Err</span>(e) =&gt; <span class="keyword">return</span> <span class="literal">Err</span>(e.into()),</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="literal">Ok</span>(ret.into())</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">pos</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) -&gt; Position &#123;</span><br><span class="line">        <span class="keyword">self</span>.lexer.pos()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">loc</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) -&gt; SourceLoc &#123;</span><br><span class="line">        <span class="keyword">self</span>.lexer.loc()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[derive(Debug)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">struct</span> <span class="title">ParserError</span></span> &#123;</span><br><span class="line">    <span class="keyword">pub</span> msg: <span class="built_in">String</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> ParserError &#123;</span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">new</span></span>(msg: <span class="built_in">String</span>) -&gt; <span class="keyword">Self</span> &#123;</span><br><span class="line">        ParserError &#123; msg &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">at</span></span>(loc: &amp;SourceLoc) -&gt; <span class="keyword">Self</span> &#123;</span><br><span class="line">        ParserError &#123;</span><br><span class="line">            msg: <span class="built_in">format!</span>(</span><br><span class="line">                <span class="string">"Unexpected token at line: &#123;&#125; column: &#123;&#125;"</span>,</span><br><span class="line">                loc.start.line, loc.start.column</span><br><span class="line">            ),</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">at_tok</span></span>(tok: &amp;Token) -&gt; <span class="keyword">Self</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> loc = tok.loc();</span><br><span class="line">        ParserError::at(loc)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">default</span></span>() -&gt; <span class="keyword">Self</span> &#123;</span><br><span class="line">        ParserError &#123;</span><br><span class="line">            msg: <span class="string">""</span>.to_string(),</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[derive(Debug)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">enum</span> <span class="title">ParsingError</span></span> &#123;</span><br><span class="line">    Parser(ParserError),</span><br><span class="line">    Lexer(LexError),</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> ParsingError &#123;</span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">msg</span></span>(&amp;<span class="keyword">self</span>) -&gt; &amp;<span class="built_in">str</span> &#123;</span><br><span class="line">        <span class="keyword">match</span> <span class="keyword">self</span> &#123;</span><br><span class="line">            ParsingError::Parser(e) =&gt; e.msg.as_str(),</span><br><span class="line">            ParsingError::Lexer(e) =&gt; e.msg.as_str(),</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="built_in">From</span>&lt;ParserError&gt; <span class="keyword">for</span> ParsingError &#123;</span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">from</span></span>(e: ParserError) -&gt; <span class="keyword">Self</span> &#123;</span><br><span class="line">        ParsingError::Parser(e)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="built_in">From</span>&lt;LexError&gt; <span class="keyword">for</span> ParsingError &#123;</span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">from</span></span>(e: LexError) -&gt; <span class="keyword">Self</span> &#123;</span><br><span class="line">        ParsingError::Lexer(e)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Visitor"><a href="#Visitor" class="headerlink" title="Visitor"></a>Visitor</h2><p>为了在后端部分的方便，这里定义了一个访问器的 trait，他的目的是，保证后端访问时的 ast 类型。</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">trait</span> <span class="title">AstVisitor</span></span>&lt;T, E&gt; &#123;</span><br><span class="line">  <span class="function"><span class="keyword">fn</span> <span class="title">prog</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, prog: &amp;Prog) -&gt; <span class="built_in">Result</span>&lt;T, E&gt;;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">fn</span> <span class="title">stmt</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, stmt: &amp;Stmt) -&gt; <span class="built_in">Result</span>&lt;T, E&gt; &#123;</span><br><span class="line">    <span class="keyword">match</span> stmt &#123;</span><br><span class="line">      Stmt::Block(s) =&gt; <span class="keyword">self</span>.block_stmt(s),</span><br><span class="line">      Stmt::VarDec(s) =&gt; <span class="keyword">self</span>.var_dec_stmt(s),</span><br><span class="line">      Stmt::Empty(s) =&gt; <span class="keyword">self</span>.empty_stmt(s),</span><br><span class="line">      Stmt::Expr(s) =&gt; <span class="keyword">self</span>.expr_stmt(s),</span><br><span class="line">      Stmt::If(s) =&gt; <span class="keyword">self</span>.if_stmt(s),</span><br><span class="line">      Stmt::For(s) =&gt; <span class="keyword">self</span>.for_stmt(s),</span><br><span class="line">      Stmt::ForIn(s) =&gt; <span class="keyword">self</span>.for_in_stmt(s),</span><br><span class="line">      Stmt::DoWhile(s) =&gt; <span class="keyword">self</span>.do_while_stmt(s),</span><br><span class="line">      Stmt::While(s) =&gt; <span class="keyword">self</span>.while_stmt(s),</span><br><span class="line">      Stmt::Cont(s) =&gt; <span class="keyword">self</span>.cont_stmt(s),</span><br><span class="line">      Stmt::Break(s) =&gt; <span class="keyword">self</span>.break_stmt(s),</span><br><span class="line">      Stmt::Return(s) =&gt; <span class="keyword">self</span>.ret_stmt(s),</span><br><span class="line">      Stmt::With(s) =&gt; <span class="keyword">self</span>.with_stmt(s),</span><br><span class="line">      Stmt::Switch(s) =&gt; <span class="keyword">self</span>.switch_stmt(s),</span><br><span class="line">      Stmt::Throw(s) =&gt; <span class="keyword">self</span>.throw_stmt(s),</span><br><span class="line">      Stmt::Try(s) =&gt; <span class="keyword">self</span>.try_stmt(s),</span><br><span class="line">      Stmt::Debugger(s) =&gt; <span class="keyword">self</span>.debug_stmt(s),</span><br><span class="line">      Stmt::Function(s) =&gt; <span class="keyword">self</span>.fn_stmt(s),</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">fn</span> <span class="title">block_stmt</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, stmt: &amp;BlockStmt) -&gt; <span class="built_in">Result</span>&lt;T, E&gt;;</span><br><span class="line">  <span class="function"><span class="keyword">fn</span> <span class="title">var_dec_stmt</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, stmt: &amp;VarDec) -&gt; <span class="built_in">Result</span>&lt;T, E&gt;;</span><br><span class="line">  <span class="function"><span class="keyword">fn</span> <span class="title">empty_stmt</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, stmt: &amp;EmptyStmt) -&gt; <span class="built_in">Result</span>&lt;T, E&gt;;</span><br><span class="line">  <span class="function"><span class="keyword">fn</span> <span class="title">expr_stmt</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, stmt: &amp;ExprStmt) -&gt; <span class="built_in">Result</span>&lt;T, E&gt;;</span><br><span class="line">  <span class="function"><span class="keyword">fn</span> <span class="title">if_stmt</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, stmt: &amp;IfStmt) -&gt; <span class="built_in">Result</span>&lt;T, E&gt;;</span><br><span class="line">  <span class="function"><span class="keyword">fn</span> <span class="title">for_stmt</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, stmt: &amp;ForStmt) -&gt; <span class="built_in">Result</span>&lt;T, E&gt;;</span><br><span class="line">  <span class="function"><span class="keyword">fn</span> <span class="title">for_in_stmt</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, stmt: &amp;ForInStmt) -&gt; <span class="built_in">Result</span>&lt;T, E&gt;;</span><br><span class="line">  <span class="function"><span class="keyword">fn</span> <span class="title">do_while_stmt</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, stmt: &amp;DoWhileStmt) -&gt; <span class="built_in">Result</span>&lt;T, E&gt;;</span><br><span class="line">  <span class="function"><span class="keyword">fn</span> <span class="title">while_stmt</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, stmt: &amp;WhileStmt) -&gt; <span class="built_in">Result</span>&lt;T, E&gt;;</span><br><span class="line">  <span class="function"><span class="keyword">fn</span> <span class="title">cont_stmt</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, stmt: &amp;ContStmt) -&gt; <span class="built_in">Result</span>&lt;T, E&gt;;</span><br><span class="line">  <span class="function"><span class="keyword">fn</span> <span class="title">break_stmt</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, stmt: &amp;BreakStmt) -&gt; <span class="built_in">Result</span>&lt;T, E&gt;;</span><br><span class="line">  <span class="function"><span class="keyword">fn</span> <span class="title">ret_stmt</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, stmt: &amp;ReturnStmt) -&gt; <span class="built_in">Result</span>&lt;T, E&gt;;</span><br><span class="line">  <span class="function"><span class="keyword">fn</span> <span class="title">with_stmt</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, stmt: &amp;WithStmt) -&gt; <span class="built_in">Result</span>&lt;T, E&gt;;</span><br><span class="line">  <span class="function"><span class="keyword">fn</span> <span class="title">switch_stmt</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, stmt: &amp;SwitchStmt) -&gt; <span class="built_in">Result</span>&lt;T, E&gt;;</span><br><span class="line">  <span class="function"><span class="keyword">fn</span> <span class="title">throw_stmt</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, stmt: &amp;ThrowStmt) -&gt; <span class="built_in">Result</span>&lt;T, E&gt;;</span><br><span class="line">  <span class="function"><span class="keyword">fn</span> <span class="title">try_stmt</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, stmt: &amp;TryStmt) -&gt; <span class="built_in">Result</span>&lt;T, E&gt;;</span><br><span class="line">  <span class="function"><span class="keyword">fn</span> <span class="title">debug_stmt</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, stmt: &amp;DebugStmt) -&gt; <span class="built_in">Result</span>&lt;T, E&gt;;</span><br><span class="line">  <span class="function"><span class="keyword">fn</span> <span class="title">fn_stmt</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, stmt: &amp;FnDec) -&gt; <span class="built_in">Result</span>&lt;T, E&gt;;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">fn</span> <span class="title">expr</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, expr: &amp;Expr) -&gt; <span class="built_in">Result</span>&lt;T, E&gt; &#123;</span><br><span class="line">    <span class="keyword">match</span> expr &#123;</span><br><span class="line">      Expr::Primary(ex) =&gt; <span class="keyword">self</span>.primary_expr(ex),</span><br><span class="line">      Expr::Member(ex) =&gt; <span class="keyword">self</span>.member_expr(ex),</span><br><span class="line">      Expr::New(ex) =&gt; <span class="keyword">self</span>.new_expr(ex),</span><br><span class="line">      Expr::Call(ex) =&gt; <span class="keyword">self</span>.call_expr(ex),</span><br><span class="line">      Expr::Unary(ex) =&gt; <span class="keyword">self</span>.unary_expr(ex),</span><br><span class="line">      Expr::Binary(ex) =&gt; <span class="keyword">self</span>.binary_expr(ex),</span><br><span class="line">      Expr::Assignment(ex) =&gt; <span class="keyword">self</span>.assign_expr(ex),</span><br><span class="line">      Expr::Conditional(ex) =&gt; <span class="keyword">self</span>.cond_expr(ex),</span><br><span class="line">      Expr::Sequence(ex) =&gt; <span class="keyword">self</span>.seq_expr(ex),</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">fn</span> <span class="title">member_expr</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, expr: &amp;MemberExpr) -&gt; <span class="built_in">Result</span>&lt;T, E&gt;;</span><br><span class="line">  <span class="function"><span class="keyword">fn</span> <span class="title">new_expr</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, expr: &amp;NewExpr) -&gt; <span class="built_in">Result</span>&lt;T, E&gt;;</span><br><span class="line">  <span class="function"><span class="keyword">fn</span> <span class="title">call_expr</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, expr: &amp;CallExpr) -&gt; <span class="built_in">Result</span>&lt;T, E&gt;;</span><br><span class="line">  <span class="function"><span class="keyword">fn</span> <span class="title">unary_expr</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, expr: &amp;UnaryExpr) -&gt; <span class="built_in">Result</span>&lt;T, E&gt;;</span><br><span class="line">  <span class="function"><span class="keyword">fn</span> <span class="title">binary_expr</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, expr: &amp;BinaryExpr) -&gt; <span class="built_in">Result</span>&lt;T, E&gt;;</span><br><span class="line">  <span class="function"><span class="keyword">fn</span> <span class="title">assign_expr</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, expr: &amp;AssignExpr) -&gt; <span class="built_in">Result</span>&lt;T, E&gt;;</span><br><span class="line">  <span class="function"><span class="keyword">fn</span> <span class="title">cond_expr</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, expr: &amp;CondExpr) -&gt; <span class="built_in">Result</span>&lt;T, E&gt;;</span><br><span class="line">  <span class="function"><span class="keyword">fn</span> <span class="title">seq_expr</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, expr: &amp;SeqExpr) -&gt; <span class="built_in">Result</span>&lt;T, E&gt;;</span><br><span class="line">  <span class="function"><span class="keyword">fn</span> <span class="title">primary_expr</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, expr: &amp;PrimaryExpr) -&gt; <span class="built_in">Result</span>&lt;T, E&gt; &#123;</span><br><span class="line">    <span class="keyword">match</span> expr &#123;</span><br><span class="line">      PrimaryExpr::This(ex) =&gt; <span class="keyword">self</span>.this_expr(ex),</span><br><span class="line">      PrimaryExpr::Identifier(ex) =&gt; <span class="keyword">self</span>.id_expr(ex),</span><br><span class="line">      PrimaryExpr::Literal(ex) =&gt; <span class="keyword">self</span>.literal(ex),</span><br><span class="line">      PrimaryExpr::ArrayLiteral(ex) =&gt; <span class="keyword">self</span>.array_literal(ex),</span><br><span class="line">      PrimaryExpr::ObjectLiteral(ex) =&gt; <span class="keyword">self</span>.object_literal(ex),</span><br><span class="line">      PrimaryExpr::Parenthesized(ex) =&gt; <span class="keyword">self</span>.paren_expr(ex),</span><br><span class="line">      PrimaryExpr::Function(ex) =&gt; <span class="keyword">self</span>.fn_expr(ex),</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">fn</span> <span class="title">this_expr</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, expr: &amp;ThisExprData) -&gt; <span class="built_in">Result</span>&lt;T, E&gt;;</span><br><span class="line">  <span class="function"><span class="keyword">fn</span> <span class="title">id_expr</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, expr: &amp;IdData) -&gt; <span class="built_in">Result</span>&lt;T, E&gt;;</span><br><span class="line">  <span class="function"><span class="keyword">fn</span> <span class="title">array_literal</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, expr: &amp;ArrayData) -&gt; <span class="built_in">Result</span>&lt;T, E&gt;;</span><br><span class="line">  <span class="function"><span class="keyword">fn</span> <span class="title">object_literal</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, expr: &amp;ObjectData) -&gt; <span class="built_in">Result</span>&lt;T, E&gt;;</span><br><span class="line">  <span class="function"><span class="keyword">fn</span> <span class="title">paren_expr</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, expr: &amp;ParenData) -&gt; <span class="built_in">Result</span>&lt;T, E&gt;;</span><br><span class="line">  <span class="function"><span class="keyword">fn</span> <span class="title">fn_expr</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, expr: &amp;FnDec) -&gt; <span class="built_in">Result</span>&lt;T, E&gt;;</span><br><span class="line">  <span class="function"><span class="keyword">fn</span> <span class="title">literal</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, expr: &amp;Literal) -&gt; <span class="built_in">Result</span>&lt;T, E&gt; &#123;</span><br><span class="line">    <span class="keyword">match</span> expr &#123;</span><br><span class="line">      Literal::RegExp(ex) =&gt; <span class="keyword">self</span>.regexp_expr(ex),</span><br><span class="line">      Literal::Null(ex) =&gt; <span class="keyword">self</span>.null_expr(ex),</span><br><span class="line">      Literal::Undef(ex) =&gt; <span class="keyword">self</span>.undef_expr(ex),</span><br><span class="line">      Literal::<span class="built_in">String</span>(ex) =&gt; <span class="keyword">self</span>.str_expr(ex),</span><br><span class="line">      Literal::Bool(ex) =&gt; <span class="keyword">self</span>.bool_expr(ex),</span><br><span class="line">      Literal::Numeric(ex) =&gt; <span class="keyword">self</span>.num_expr(ex),</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">fn</span> <span class="title">regexp_expr</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, expr: &amp;RegExpData) -&gt; <span class="built_in">Result</span>&lt;T, E&gt;;</span><br><span class="line">  <span class="function"><span class="keyword">fn</span> <span class="title">null_expr</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, expr: &amp;NullData) -&gt; <span class="built_in">Result</span>&lt;T, E&gt;;</span><br><span class="line">  <span class="function"><span class="keyword">fn</span> <span class="title">undef_expr</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, expr: &amp;UndefData) -&gt; <span class="built_in">Result</span>&lt;T, E&gt;;</span><br><span class="line">  <span class="function"><span class="keyword">fn</span> <span class="title">str_expr</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, expr: &amp;StringData) -&gt; <span class="built_in">Result</span>&lt;T, E&gt;;</span><br><span class="line">  <span class="function"><span class="keyword">fn</span> <span class="title">bool_expr</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, expr: &amp;BoolData) -&gt; <span class="built_in">Result</span>&lt;T, E&gt;;</span><br><span class="line">  <span class="function"><span class="keyword">fn</span> <span class="title">num_expr</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, expr: &amp;NumericData) -&gt; <span class="built_in">Result</span>&lt;T, E&gt;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="代码生成"><a href="#代码生成" class="headerlink" title="代码生成"></a>代码生成</h1><p>在编译器前端写完后，接下来我们要来实现我们的编译器后端，它包含代码生成和 vm 两个部分，我们先来实现我们的代码生成的代码，我们的 vm 将会使用寄存器+栈组件实现的，参考了 lua 的实现形式</p>
<h2 id="chunk"><a href="#chunk" class="headerlink" title="chunk"></a>chunk</h2><p>chunk 就是我们的代码块，他包含了源码转义后指令，从而操作栈和寄存器。</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 常量</span></span><br><span class="line"><span class="meta">#[derive(Debug, Clone)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">enum</span> <span class="title">Const</span></span> &#123;</span><br><span class="line">    <span class="built_in">String</span>(<span class="built_in">String</span>),</span><br><span class="line">    Number(<span class="built_in">f64</span>),</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> Const &#123;</span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">new_str</span></span>(s: &amp;<span class="built_in">str</span>) -&gt; <span class="keyword">Self</span> &#123;</span><br><span class="line">        Const::<span class="built_in">String</span>(s.to_string())</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">new_num</span></span>(n: <span class="built_in">f64</span>) -&gt; <span class="keyword">Self</span> &#123;</span><br><span class="line">        Const::Number(n)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">typ_id</span></span>(&amp;<span class="keyword">self</span>) -&gt; <span class="built_in">u8</span> &#123;</span><br><span class="line">        <span class="keyword">match</span> <span class="keyword">self</span> &#123;</span><br><span class="line">            Const::<span class="built_in">String</span>(_) =&gt; <span class="number">0</span>,</span><br><span class="line">            Const::Number(_) =&gt; <span class="number">1</span>,</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">is_str</span></span>(&amp;<span class="keyword">self</span>) -&gt; <span class="built_in">bool</span> &#123;</span><br><span class="line">        <span class="keyword">match</span> <span class="keyword">self</span> &#123;</span><br><span class="line">            Const::<span class="built_in">String</span>(_) =&gt; <span class="literal">true</span>,</span><br><span class="line">            _ =&gt; <span class="literal">false</span>,</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">is_num</span></span>(&amp;<span class="keyword">self</span>) -&gt; <span class="built_in">bool</span> &#123;</span><br><span class="line">        <span class="keyword">match</span> <span class="keyword">self</span> &#123;</span><br><span class="line">            Const::Number(_) =&gt; <span class="literal">true</span>,</span><br><span class="line">            _ =&gt; <span class="literal">false</span>,</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">num</span></span>(&amp;<span class="keyword">self</span>) -&gt; <span class="built_in">f64</span> &#123;</span><br><span class="line">        <span class="keyword">match</span> <span class="keyword">self</span> &#123;</span><br><span class="line">            Const::Number(v) =&gt; *v,</span><br><span class="line">            _ =&gt; <span class="built_in">panic!</span>(),</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">str</span></span>(&amp;<span class="keyword">self</span>) -&gt; &amp;<span class="built_in">str</span> &#123;</span><br><span class="line">        <span class="keyword">match</span> <span class="keyword">self</span> &#123;</span><br><span class="line">            Const::<span class="built_in">String</span>(v) =&gt; v.as_str(),</span><br><span class="line">            _ =&gt; <span class="built_in">panic!</span>(),</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">eq</span></span>(&amp;<span class="keyword">self</span>, c: &amp;Const) -&gt; <span class="built_in">bool</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">self</span>.typ_id() == c.typ_id() &#123;</span><br><span class="line">            <span class="keyword">let</span> eq = <span class="keyword">match</span> <span class="keyword">self</span> &#123;</span><br><span class="line">                Const::Number(v) =&gt; *v == c.num(),</span><br><span class="line">                Const::<span class="built_in">String</span>(v) =&gt; v == c.<span class="built_in">str</span>(),</span><br><span class="line">            &#125;;</span><br><span class="line">            <span class="keyword">return</span> eq;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 一个带上upvalue的函数，是闭包，包含了名称、是否在堆栈上以及索引</span></span><br><span class="line"><span class="meta">#[derive(Debug, Clone)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">struct</span> <span class="title">UpvalDesc</span></span> &#123;</span><br><span class="line">    <span class="keyword">pub</span> name: <span class="built_in">String</span>,</span><br><span class="line">    <span class="keyword">pub</span> in_stack: <span class="built_in">bool</span>,</span><br><span class="line">    <span class="keyword">pub</span> idx: <span class="built_in">u32</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 变量</span></span><br><span class="line"><span class="meta">#[derive(Debug, Clone)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">struct</span> <span class="title">Local</span></span> &#123;</span><br><span class="line">    <span class="keyword">pub</span> name: <span class="built_in">String</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">ABC 操作模式：</span></span><br><span class="line"><span class="comment">参数编码：这种模式的指令编码包括操作码、参数 A、参数 B、参数 C。</span></span><br><span class="line"><span class="comment">参数范围：参数 A、B、C 通常是 8 位（1 字节）的整数，因此每个参数的取值范围是 0 到 255。</span></span><br><span class="line"><span class="comment">用途：ABC 操作模式通常用于执行基本的操作，例如加载、存储、算术运算等。</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">ABx 操作模式：</span></span><br><span class="line"><span class="comment">参数编码：这种模式的指令编码包括操作码、参数 A 和参数 Bx。</span></span><br><span class="line"><span class="comment">参数范围：参数 A 通常是 8 位整数，而参数 Bx 通常是 18 位整数。参数 Bx 的范围更大，可以表示更大的常量索引或其他值。</span></span><br><span class="line"><span class="comment">用途：ABx 操作模式通常用于加载常量、跳转指令等需要较大参数范围的操作。</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">AsBx 操作模式：</span></span><br><span class="line"><span class="comment">参数编码：这种模式的指令编码包括操作码、参数 A 和参数 sBx。</span></span><br><span class="line"><span class="comment">参数范围：参数 A 通常是 8 位整数，而参数 sBx 通常是带符号的 18 位整数，允许正数和负数值。</span></span><br><span class="line"><span class="comment">用途：AsBx 操作模式通常用于有符号跳转指令，例如条件分支等。</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="meta">#[derive(Debug, Eq, PartialEq, Copy, Clone)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">enum</span> <span class="title">OpMode</span></span> &#123;</span><br><span class="line">    ABC,</span><br><span class="line">    ABx,</span><br><span class="line">    AsBx,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[derive(Clone)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">struct</span> <span class="title">Inst</span></span> &#123;</span><br><span class="line">    <span class="keyword">pub</span> raw: <span class="built_in">u32</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> Inst &#123;</span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">new</span></span>() -&gt; <span class="keyword">Self</span> &#123;</span><br><span class="line">        Inst &#123; raw: <span class="number">0</span> &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">new_abc</span></span>(op: OpCode, a: <span class="built_in">u32</span>, b: <span class="built_in">u32</span>, c: <span class="built_in">u32</span>) -&gt; <span class="keyword">Self</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut</span> inst = Inst::new();</span><br><span class="line">        inst.set_op(op);</span><br><span class="line">        inst.set_a(a);</span><br><span class="line">        inst.set_b(b);</span><br><span class="line">        inst.set_c(c);</span><br><span class="line">        inst</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">new_a_bx</span></span>(op: OpCode, a: <span class="built_in">u32</span>, bx: <span class="built_in">u32</span>) -&gt; <span class="keyword">Self</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut</span> inst = Inst::new();</span><br><span class="line">        inst.set_op(op);</span><br><span class="line">        inst.set_a(a);</span><br><span class="line">        inst.set_bx(bx);</span><br><span class="line">        inst</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">new_a_sbx</span></span>(op: OpCode, a: <span class="built_in">u32</span>, sbx: <span class="built_in">i32</span>) -&gt; <span class="keyword">Self</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut</span> inst = Inst::new();</span><br><span class="line">        inst.set_op(op);</span><br><span class="line">        inst.set_a(a);</span><br><span class="line">        inst.set_sbx(sbx);</span><br><span class="line">        inst</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">a</span></span>(&amp;<span class="keyword">self</span>) -&gt; <span class="built_in">u32</span> &#123;</span><br><span class="line">        <span class="comment">// 右移 6 位 (self.raw &gt;&gt; 6)：这将 self.raw 中的参数 A 位移到最低有效位，以便提取。</span></span><br><span class="line">        <span class="comment">// 与 0xff (&amp; 0xff)：它将除参数 A 位之外的其他位都清零，保留参数 A 的值。0xff 是一个 8 位二进制数，所有位都为 1，因此这个操作保留了参数 A 的 8 位值。</span></span><br><span class="line">        (<span class="keyword">self</span>.raw &gt;&gt; <span class="number">6</span>) &amp; <span class="number">0xff</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">b</span></span>(&amp;<span class="keyword">self</span>) -&gt; <span class="built_in">u32</span> &#123;</span><br><span class="line">        <span class="comment">// 右移 23 位 (self.raw &gt;&gt; 23)：这将 self.raw 中的参数 B 位移到最低有效位，以便提取。</span></span><br><span class="line">        <span class="comment">// 与 0x1ff (&amp; 0x1ff)：它将除参数 B 位之外的其他位都清零，保留参数 B 的值。0x1ff 是一个 9 位二进制数，所有位都为 1，因此这个操作保留了参数 B 的 9 位值。</span></span><br><span class="line">        (<span class="keyword">self</span>.raw &gt;&gt; <span class="number">23</span>) &amp; <span class="number">0x1ff</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">c</span></span>(&amp;<span class="keyword">self</span>) -&gt; <span class="built_in">u32</span> &#123;</span><br><span class="line">        <span class="comment">// 右移 14 位 (self.raw &gt;&gt; 14)：这将 self.raw 中的参数 C 位移到最低有效位，以便提取。</span></span><br><span class="line">        <span class="comment">// 与 0x1ff (&amp; 0x1ff)：它将除参数 C 位之外的其他位都清零，保留参数 C 的值。0x1ff 是一个 9 位二进制数，所有位都为 1，因此这个操作保留了参数 C 的 9 位值。</span></span><br><span class="line">        (<span class="keyword">self</span>.raw &gt;&gt; <span class="number">14</span>) &amp; <span class="number">0x1ff</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">bx</span></span>(&amp;<span class="keyword">self</span>) -&gt; <span class="built_in">u32</span> &#123;</span><br><span class="line">        <span class="comment">// 右移 14 位 (self.raw &gt;&gt; 14)：这将 self.raw 中的参数 Bx 位移到最低有效位，以便提取。</span></span><br><span class="line">        <span class="comment">// 与 0x3ffff (&amp; 0x3ffff)：它将除参数 Bx 位之外的其他位都清零，保留参数 Bx 的值。0x3ffff 是一个 18 位二进制数，所有位都为 1，因此这个操作保留了参数 Bx 的 18 位值。</span></span><br><span class="line">        (<span class="keyword">self</span>.raw &gt;&gt; <span class="number">14</span>) &amp; <span class="number">0x3ffff</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">sbx</span></span>(&amp;<span class="keyword">self</span>) -&gt; <span class="built_in">i32</span> &#123;</span><br><span class="line">        <span class="comment">// 右移 14 位 (self.raw &gt;&gt; 14)：这将 self.raw 中的参数 sBx 位移到最低有效位，以便提取。</span></span><br><span class="line">        <span class="comment">// 与 0x3ffff (&amp; 0x3ffff)：它将除参数 sBx 位之外的其他位都清零，保留参数 sBx 的值。0x3ffff 是一个 18 位二进制数，所有位都为 1，因此这个操作保留了参数 sBx 的 18 位值。</span></span><br><span class="line">        <span class="comment">// as i32：这将结果转换为带符号的 32 位整数。</span></span><br><span class="line">        <span class="comment">// - 131071：这个操作是将参数 sBx 转换为有符号整数，因为它是相对于 131071 的偏移值。</span></span><br><span class="line">        <span class="keyword">let</span> t = ((<span class="keyword">self</span>.raw &gt;&gt; <span class="number">14</span>) &amp; <span class="number">0x3ffff</span>) <span class="keyword">as</span> <span class="built_in">i32</span>;</span><br><span class="line">        t - <span class="number">131071</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">op</span></span>(&amp;<span class="keyword">self</span>) -&gt; <span class="built_in">u32</span> &#123;</span><br><span class="line">        <span class="comment">// 与 0x3f (&amp; 0x3f)：它将 self.raw 中的操作码位之外的其他位都清零，保留操作码的值。0x3f 是一个 6 位二进制数，所有位都为 1，因此这个操作保留了操作码的 6 位值。</span></span><br><span class="line">        <span class="keyword">self</span>.raw &amp; <span class="number">0x3f</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">set_op</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, op: OpCode) &#123;</span><br><span class="line">        <span class="comment">// !0x3f 表示对 0x3f 取反，即将 0x3f 中的所有位设为 0，只保留其他位不变。</span></span><br><span class="line">        <span class="comment">// | (op as u32)：将新的操作码值 op 添加到 self.raw 中，从而更新操作码。</span></span><br><span class="line">        <span class="keyword">self</span>.raw = (<span class="keyword">self</span>.raw &amp; !<span class="number">0x3f</span>) | (op <span class="keyword">as</span> <span class="built_in">u32</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">set_a</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, a: <span class="built_in">u32</span>) &#123;</span><br><span class="line">        <span class="comment">// 0xff &lt;&lt; 6 表示将 0xff 左移 6 位，得到一个掩码，用于清除参数 A 的位。</span></span><br><span class="line">        <span class="comment">// !(0xff &lt;&lt; 6) 对这个掩码取反，即将除参数 A 位之外的其他位都清零，保留参数 A 的位。</span></span><br><span class="line">        <span class="comment">// (a &lt;&lt; 6) 将参数 A 的值左移 6 位，以匹配参数 A 在 self.raw 中的位置。</span></span><br><span class="line">        <span class="keyword">self</span>.raw = (<span class="keyword">self</span>.raw &amp; !(<span class="number">0xff</span> &lt;&lt; <span class="number">6</span>)) | (a &lt;&lt; <span class="number">6</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">set_b</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, b: <span class="built_in">u32</span>) &#123;</span><br><span class="line">        <span class="comment">// 0x1ff &lt;&lt; 23 表示将 0x1ff 左移 23 位，得到一个掩码，用于清除参数 B 的位。</span></span><br><span class="line">        <span class="comment">// !(0x1ff &lt;&lt; 23) 对这个掩码取反，即将除参数 B 位之外的其他位都清零，保留参数 B 的位。</span></span><br><span class="line">        <span class="comment">// (b &lt;&lt; 23) 将参数 B 的值左移 23 位，以匹配参数 B 在 self.raw 中的位置。</span></span><br><span class="line">        <span class="keyword">self</span>.raw = (<span class="keyword">self</span>.raw &amp; !(<span class="number">0x1ff</span> &lt;&lt; <span class="number">23</span>)) | (b &lt;&lt; <span class="number">23</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">set_c</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, c: <span class="built_in">u32</span>) &#123;</span><br><span class="line">        <span class="comment">// 0x1ff &lt;&lt; 14 表示将 0x1ff 左移 14 位，得到一个掩码，用于清除参数 C 的位。</span></span><br><span class="line">        <span class="comment">// !(0x1ff &lt;&lt; 14) 对这个掩码取反，即将除参数 C 位之外的其他位都清零，保留参数 C 的位。</span></span><br><span class="line">        <span class="comment">// (c &lt;&lt; 14) 将参数 C 的值左移 14 位，以匹配参数 C 在 self.raw 中的位置。</span></span><br><span class="line">        <span class="keyword">self</span>.raw = (<span class="keyword">self</span>.raw &amp; !(<span class="number">0x1ff</span> &lt;&lt; <span class="number">14</span>)) | (c &lt;&lt; <span class="number">14</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">set_bx</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, bx: <span class="built_in">u32</span>) &#123;</span><br><span class="line">        <span class="comment">// 0x3ffff &lt;&lt; 14 表示将 0x3ffff 左移 14 位，得到一个掩码，用于清除参数 Bx 的位。</span></span><br><span class="line">        <span class="comment">// !(0x3ffff &lt;&lt; 14) 对这个掩码取反，即将除参数 Bx 位之外的其他位都清零，保留参数 Bx 的位。</span></span><br><span class="line">        <span class="comment">// (bx &lt;&lt; 14) 将参数 Bx 的值左移 14 位，以匹配参数 Bx 在 self.raw 中的位置。</span></span><br><span class="line">        <span class="keyword">self</span>.raw = (<span class="keyword">self</span>.raw &amp; !(<span class="number">0x3ffff</span> &lt;&lt; <span class="number">14</span>)) | (bx &lt;&lt; <span class="number">14</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">set_sbx</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, <span class="keyword">mut</span> sbx: <span class="built_in">i32</span>) &#123;</span><br><span class="line">        <span class="comment">// sbx += 131071：这是一个将参数 sbx 增加 131071 的操作。它将参数 sbx 转换为无符号整数并增加 131071，因为虚拟机中的 sBx 参数通常是相对于 131071 的偏移值。</span></span><br><span class="line">        sbx += <span class="number">131071</span>;</span><br><span class="line">        <span class="keyword">let</span> sbx = sbx <span class="keyword">as</span> <span class="built_in">u32</span>;</span><br><span class="line">        <span class="comment">// 0x3ffff &lt;&lt; 14 表示将 0x3ffff 左移 14 位，得到一个掩码，用于清除参数 sbx 的位。</span></span><br><span class="line">        <span class="comment">// !(0x3ffff &lt;&lt; 14) 对这个掩码取反，即将除参数 sbx 位之外的其他位都清零，保留参数 sbx 的位。</span></span><br><span class="line">        <span class="comment">// (sbx &lt;&lt; 14) 将参数 sbx 的值左移 14 位，以匹配参数 sbx 在 self.raw 中的位置。</span></span><br><span class="line">        <span class="keyword">self</span>.raw = (<span class="keyword">self</span>.raw &amp; !(<span class="number">0x3ffff</span> &lt;&lt; <span class="number">14</span>)) | (sbx &lt;&lt; <span class="number">14</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// converts an integer to a "floating point byte"</span></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">int2fb</span></span>(<span class="keyword">mut</span> x: <span class="built_in">u32</span>) -&gt; <span class="built_in">u32</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut</span> e = <span class="number">0</span>; <span class="comment">/* exponent */</span></span><br><span class="line">        <span class="keyword">if</span> x &lt; <span class="number">8</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> x;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">while</span> x &gt;= <span class="number">8</span> &lt;&lt; <span class="number">4</span> &#123;</span><br><span class="line">            <span class="comment">/* coarse steps */</span></span><br><span class="line">            x = (x + <span class="number">0xf</span>) &gt;&gt; <span class="number">4</span>; <span class="comment">/* x = ceil(x / 16) */</span></span><br><span class="line">            e += <span class="number">4</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">while</span> x &gt;= <span class="number">8</span> &lt;&lt; <span class="number">1</span> &#123;</span><br><span class="line">            <span class="comment">/* fine steps */</span></span><br><span class="line">            x = (x + <span class="number">1</span>) &gt;&gt; <span class="number">1</span>; <span class="comment">/* x = ceil(x / 2) */</span></span><br><span class="line">            e += <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        ((e + <span class="number">1</span>) &lt;&lt; <span class="number">3</span>) | (x - <span class="number">8</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">fb2int</span></span>(x: <span class="built_in">u32</span>) -&gt; <span class="built_in">u32</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> x &lt; <span class="number">8</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> x;</span><br><span class="line">        &#125;</span><br><span class="line">        ((x &amp; <span class="number">7</span>) + <span class="number">8</span>) &lt;&lt; ((x &gt;&gt; <span class="number">3</span>) - <span class="number">1</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> fmt::<span class="built_in">Debug</span> <span class="keyword">for</span> Inst &#123;</span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">fmt</span></span>(&amp;<span class="keyword">self</span>, f: &amp;<span class="keyword">mut</span> fmt::Formatter&lt;<span class="symbol">'_</span>&gt;) -&gt; fmt::<span class="built_in">Result</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> op = OpCode::from_u32(<span class="keyword">self</span>.op());</span><br><span class="line">        <span class="keyword">match</span> op.mode() &#123;</span><br><span class="line">            OpMode::ABC =&gt; <span class="built_in">write!</span>(</span><br><span class="line">                f,</span><br><span class="line">                <span class="string">"&#123;:#?&#125;&#123;&#123; A: &#123;&#125;, B: &#123;&#125;, C: &#123;&#125; &#125;&#125;"</span>,</span><br><span class="line">                op,</span><br><span class="line">                <span class="keyword">self</span>.a(),</span><br><span class="line">                <span class="keyword">self</span>.b(),</span><br><span class="line">                <span class="keyword">self</span>.c()</span><br><span class="line">            ),</span><br><span class="line">            OpMode::ABx =&gt; <span class="built_in">write!</span>(f, <span class="string">"&#123;:#?&#125;&#123;&#123; A: &#123;&#125;, Bx: &#123;&#125; &#125;&#125;"</span>, op, <span class="keyword">self</span>.a(), <span class="keyword">self</span>.bx()),</span><br><span class="line">            OpMode::AsBx =&gt; <span class="built_in">write!</span>(f, <span class="string">"&#123;:#?&#125;&#123;&#123; A: &#123;&#125;, sBx: &#123;&#125; &#125;&#125;"</span>, op, <span class="keyword">self</span>.a(), <span class="keyword">self</span>.sbx()),</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 函数模板</span></span><br><span class="line"><span class="meta">#[derive(Debug, Clone)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">struct</span> <span class="title">FnTpl</span></span> &#123;</span><br><span class="line">    <span class="comment">// 参数数量</span></span><br><span class="line">    <span class="keyword">pub</span> param_cnt: <span class="built_in">u8</span>,</span><br><span class="line">    <span class="comment">// 是否支持可变参数</span></span><br><span class="line">    <span class="keyword">pub</span> is_vararg: <span class="built_in">bool</span>,</span><br><span class="line">    <span class="comment">// 指令序列</span></span><br><span class="line">    <span class="keyword">pub</span> code: <span class="built_in">Vec</span>&lt;Inst&gt;,</span><br><span class="line">    <span class="keyword">pub</span> consts: <span class="built_in">Vec</span>&lt;Const&gt;,</span><br><span class="line">    <span class="comment">// 记录函数中引用的上值（外部变量）</span></span><br><span class="line">    <span class="keyword">pub</span> upvals: <span class="built_in">Vec</span>&lt;UpvalDesc&gt;,</span><br><span class="line">    <span class="comment">// 局部变量</span></span><br><span class="line">    <span class="keyword">pub</span> locals: <span class="built_in">Vec</span>&lt;Local&gt;,</span><br><span class="line">    <span class="comment">// 表示在函数内定义的子函数</span></span><br><span class="line">    <span class="keyword">pub</span> fun_tpls: <span class="built_in">Vec</span>&lt;FnTpl&gt;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> FnTpl &#123;</span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">new</span></span>() -&gt; <span class="keyword">Self</span> &#123;</span><br><span class="line">        FnTpl &#123;</span><br><span class="line">            param_cnt: <span class="number">0</span>,</span><br><span class="line">            is_vararg: <span class="literal">false</span>,</span><br><span class="line">            code: <span class="built_in">vec!</span>[],</span><br><span class="line">            consts: <span class="built_in">vec!</span>[],</span><br><span class="line">            upvals: <span class="built_in">vec!</span>[],</span><br><span class="line">            locals: <span class="built_in">vec!</span>[],</span><br><span class="line">            fun_tpls: <span class="built_in">vec!</span>[],</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 代码块</span></span><br><span class="line"><span class="meta">#[derive(Debug)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">struct</span> <span class="title">Chunk</span></span> &#123;</span><br><span class="line">    <span class="keyword">pub</span> sig: &amp;<span class="symbol">'static</span> <span class="built_in">str</span>,</span><br><span class="line">    <span class="keyword">pub</span> ver: <span class="built_in">u64</span>,</span><br><span class="line">    <span class="keyword">pub</span> upval_cnt: <span class="built_in">u8</span>,</span><br><span class="line">    <span class="keyword">pub</span> fun_tpl: FnTpl,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[derive(Debug, Eq, PartialEq, Copy, Clone, Hash)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">enum</span> <span class="title">OpCode</span></span> &#123;</span><br><span class="line">    MOVE,</span><br><span class="line">    LOADK,</span><br><span class="line">    LOADKX,</span><br><span class="line">    LOADBOO,</span><br><span class="line">    LOADNUL,</span><br><span class="line">    LOADUNDEF,</span><br><span class="line">    GETUPVAL,</span><br><span class="line">    GETTABUP,</span><br><span class="line">    GETTABLE,</span><br><span class="line">    SETTABUP,</span><br><span class="line">    SETUPVAL,</span><br><span class="line">    SETTABLE,</span><br><span class="line">    NEWTABLE,</span><br><span class="line">    NEWARRAY,</span><br><span class="line">    INITARRAY,</span><br><span class="line">    THIS,</span><br><span class="line">    ADD,</span><br><span class="line">    SUB,</span><br><span class="line">    MUL,</span><br><span class="line">    MOD,</span><br><span class="line">    DIV,</span><br><span class="line">    LT,</span><br><span class="line">    LE,</span><br><span class="line">    EQ,</span><br><span class="line">    EQS,</span><br><span class="line">    JMP,</span><br><span class="line">    TEST,</span><br><span class="line">    TESTSET,</span><br><span class="line">    BITAND,</span><br><span class="line">    BITOR,</span><br><span class="line">    BITXOR,</span><br><span class="line">    SHL,</span><br><span class="line">    SAR,</span><br><span class="line">    SHR,</span><br><span class="line">    UNM,</span><br><span class="line">    NOT,</span><br><span class="line">    BITNOT,</span><br><span class="line">    CLOSURE,</span><br><span class="line">    CALL,</span><br><span class="line">    RETURN,</span><br><span class="line">    NEW,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">mut</span> OPCODE_NAME: <span class="built_in">Option</span>&lt;HashMap&lt;OpCode, &amp;<span class="symbol">'static</span> <span class="built_in">str</span>&gt;&gt; = <span class="literal">None</span>;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">mut</span> OPCODE_MODE: <span class="built_in">Option</span>&lt;HashMap&lt;OpCode, OpMode&gt;&gt; = <span class="literal">None</span>;</span><br><span class="line"></span><br><span class="line"><span class="built_in">macro_rules!</span> gen_opcode_map &#123;</span><br><span class="line">  ($($op:expr =&gt; $name:expr, $mode:expr)*) =&gt; &#123;</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">let</span> <span class="keyword">mut</span> op_name = HashMap::new();</span><br><span class="line">      <span class="keyword">let</span> <span class="keyword">mut</span> op_mode = HashMap::new();</span><br><span class="line">      $(</span><br><span class="line">        op_name.insert($op, $name);</span><br><span class="line">        op_mode.insert($op, $mode);</span><br><span class="line">      )*</span><br><span class="line">      (<span class="literal">Some</span>(op_name), <span class="literal">Some</span>(op_mode))</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">init_opcodes</span></span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> (op_name, op_mode) = gen_opcode_map! &#123;</span><br><span class="line">      OpCode::MOVE =&gt; <span class="string">"MOVE"</span>, OpMode::ABC</span><br><span class="line">      OpCode::LOADK =&gt; <span class="string">"LOADK"</span>, OpMode::ABx</span><br><span class="line">      OpCode::LOADKX =&gt; <span class="string">"LOADKX"</span>, OpMode::ABx</span><br><span class="line">      OpCode::LOADBOO =&gt; <span class="string">"LOADBOO"</span>, OpMode::ABC</span><br><span class="line">      OpCode::LOADNUL =&gt; <span class="string">"LOADNUL"</span>, OpMode::ABC</span><br><span class="line">      OpCode::LOADUNDEF =&gt; <span class="string">"LOADUNDEF"</span>, OpMode::ABC</span><br><span class="line">      OpCode::GETUPVAL =&gt; <span class="string">"GETUPVAL"</span>, OpMode::ABC</span><br><span class="line">      OpCode::GETTABUP =&gt; <span class="string">"GETTABUP"</span>, OpMode::ABC</span><br><span class="line">      OpCode::GETTABLE =&gt; <span class="string">"GETTABLE"</span>, OpMode::ABC</span><br><span class="line">      OpCode::SETTABUP =&gt; <span class="string">"SETTABUP"</span>, OpMode::ABC</span><br><span class="line">      OpCode::SETUPVAL =&gt; <span class="string">"SETUPVAL"</span>, OpMode::ABC</span><br><span class="line">      OpCode::SETTABLE =&gt; <span class="string">"SETTABLE"</span>, OpMode::ABC</span><br><span class="line">      OpCode::NEWTABLE =&gt; <span class="string">"NEWTABLE"</span>, OpMode::ABC</span><br><span class="line">      OpCode::NEWARRAY =&gt; <span class="string">"NEWARRAY"</span>, OpMode::ABC</span><br><span class="line">      OpCode::INITARRAY =&gt; <span class="string">"INITARRAY"</span>, OpMode::ABC</span><br><span class="line">      OpCode::THIS =&gt; <span class="string">"THIS"</span>, OpMode::ABC</span><br><span class="line">      OpCode::ADD =&gt; <span class="string">"ADD"</span>, OpMode::ABC</span><br><span class="line">      OpCode::SUB =&gt; <span class="string">"SUB"</span>, OpMode::ABC</span><br><span class="line">      OpCode::MUL =&gt; <span class="string">"MUL"</span>, OpMode::ABC</span><br><span class="line">      OpCode::MOD =&gt; <span class="string">"MOD"</span>, OpMode::ABC</span><br><span class="line">      OpCode::DIV =&gt; <span class="string">"DIV"</span>, OpMode::ABC</span><br><span class="line">      OpCode::LT =&gt; <span class="string">"LT"</span>, OpMode::ABC</span><br><span class="line">      OpCode::LE =&gt; <span class="string">"LE"</span>, OpMode::ABC</span><br><span class="line">      OpCode::EQ =&gt; <span class="string">"EQ"</span>, OpMode::ABC</span><br><span class="line">      OpCode::EQS =&gt; <span class="string">"EQS"</span>, OpMode::ABC</span><br><span class="line">      OpCode::JMP =&gt; <span class="string">"JMP"</span>, OpMode::AsBx</span><br><span class="line">      OpCode::TEST =&gt; <span class="string">"TEST"</span>, OpMode::ABC</span><br><span class="line">      OpCode::TESTSET =&gt; <span class="string">"TESTSET"</span>, OpMode::ABC</span><br><span class="line">      OpCode::BITAND =&gt; <span class="string">"BITAND"</span>, OpMode::ABC</span><br><span class="line">      OpCode::BITOR =&gt; <span class="string">"BITOR"</span>, OpMode::ABC</span><br><span class="line">      OpCode::BITXOR =&gt; <span class="string">"BITXOR"</span>, OpMode::ABC</span><br><span class="line">      OpCode::SHL =&gt; <span class="string">"SHL"</span>, OpMode::ABC</span><br><span class="line">      OpCode::SAR =&gt; <span class="string">"SAR"</span>, OpMode::ABC</span><br><span class="line">      OpCode::SHR =&gt; <span class="string">"SHR"</span>, OpMode::ABC</span><br><span class="line">      OpCode::UNM =&gt; <span class="string">"UNM"</span>, OpMode::ABC</span><br><span class="line">      OpCode::NOT =&gt; <span class="string">"NOT"</span>, OpMode::ABC</span><br><span class="line">      OpCode::BITNOT =&gt; <span class="string">"BITNOT"</span>, OpMode::ABC</span><br><span class="line">      OpCode::CLOSURE =&gt; <span class="string">"CLOSURE"</span>, OpMode::ABC</span><br><span class="line">      OpCode::CALL =&gt; <span class="string">"CALL"</span>, OpMode::ABC</span><br><span class="line">      OpCode::RETURN =&gt; <span class="string">"RETURN"</span>, OpMode::ABC</span><br><span class="line">      OpCode::NEW =&gt; <span class="string">"NEW"</span>, OpMode::ABC</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">unsafe</span> &#123;</span><br><span class="line">        OPCODE_NAME = op_name;</span><br><span class="line">        OPCODE_MODE = op_mode;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> INIT_OPCODE_DATA_ONCE: Once = Once::new();</span><br><span class="line"><span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">init_opcode_data</span></span>() &#123;</span><br><span class="line">    INIT_OPCODE_DATA_ONCE.call_once(|| &#123;</span><br><span class="line">        init_opcodes();</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">op_to_name</span></span>(op: &amp;OpCode) -&gt; &amp;<span class="symbol">'static</span> <span class="built_in">str</span> &#123;</span><br><span class="line">    <span class="keyword">unsafe</span> &#123; OPCODE_NAME.as_ref().unwrap().get(op).unwrap() &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">op_to_mode</span></span>(op: &amp;OpCode) -&gt; &amp;<span class="symbol">'static</span> OpMode &#123;</span><br><span class="line">    <span class="keyword">unsafe</span> &#123; OPCODE_MODE.as_ref().unwrap().get(op).unwrap() &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> OpCode &#123;</span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">from_u32</span></span>(x: <span class="built_in">u32</span>) -&gt; <span class="keyword">Self</span> &#123;</span><br><span class="line">        <span class="keyword">unsafe</span> &#123; transmute(x <span class="keyword">as</span> <span class="built_in">u8</span>) &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">mode</span></span>(&amp;<span class="keyword">self</span>) -&gt; OpMode &#123;</span><br><span class="line">        *op_to_mode(<span class="keyword">self</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">eq</span></span>(&amp;<span class="keyword">self</span>, op: <span class="built_in">u32</span>) -&gt; <span class="built_in">bool</span> &#123;</span><br><span class="line">        OpCode::from_u32(op) == *<span class="keyword">self</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="symtab"><a href="#symtab" class="headerlink" title="symtab"></a>symtab</h2><p>symtab 将会储存相关的调用环境，就像我们知道的一样，js 存在作用域和闭包，而 symtab 维护了不同作用域的寄存器及栈，从而保证在 chunk 执行时能准确地获取正确的数据。</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">type</span> <span class="title">ScopePtr</span></span> = *<span class="keyword">mut</span> Scope;</span><br><span class="line"></span><br><span class="line"><span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">as_scope</span></span>(ptr: ScopePtr) -&gt; &amp;<span class="symbol">'static</span> <span class="keyword">mut</span> Scope &#123;</span><br><span class="line">    <span class="keyword">unsafe</span> &#123; &amp;<span class="keyword">mut</span> (*ptr) &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 作用域</span></span><br><span class="line"><span class="meta">#[derive(Debug)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">struct</span> <span class="title">Scope</span></span> &#123;</span><br><span class="line">    <span class="keyword">pub</span> id: <span class="built_in">usize</span>,</span><br><span class="line">    parent: ScopePtr,</span><br><span class="line">    subs: <span class="built_in">Vec</span>&lt;ScopePtr&gt;,</span><br><span class="line">    <span class="keyword">pub</span> params: HashSet&lt;<span class="built_in">String</span>&gt;,</span><br><span class="line">    <span class="keyword">pub</span> bindings: LinkedHashSet&lt;<span class="built_in">String</span>&gt;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> Scope &#123;</span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">new</span></span>(id: <span class="built_in">usize</span>) -&gt; ScopePtr &#123;</span><br><span class="line">        <span class="built_in">Box</span>::into_raw(<span class="built_in">Box</span>::new(Scope &#123;</span><br><span class="line">            id,</span><br><span class="line">            parent: null_mut(),</span><br><span class="line">            subs: <span class="built_in">vec!</span>[],</span><br><span class="line">            params: HashSet::new(),</span><br><span class="line">            bindings: LinkedHashSet::new(),</span><br><span class="line">        &#125;))</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">add_binding</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, n: &amp;<span class="built_in">str</span>) &#123;</span><br><span class="line">        <span class="keyword">self</span>.bindings.insert(n.to_string());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">has_binding</span></span>(&amp;<span class="keyword">self</span>, n: &amp;<span class="built_in">str</span>) -&gt; <span class="built_in">bool</span> &#123;</span><br><span class="line">        <span class="keyword">self</span>.bindings.contains(n)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">add_param</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, n: &amp;<span class="built_in">str</span>) &#123;</span><br><span class="line">        <span class="keyword">self</span>.params.insert(n.to_owned());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">has_param</span></span>(&amp;<span class="keyword">self</span>, n: &amp;<span class="built_in">str</span>) -&gt; <span class="built_in">bool</span> &#123;</span><br><span class="line">        <span class="keyword">self</span>.params.contains(n)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[derive(Debug)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">struct</span> <span class="title">SymTab</span></span> &#123;</span><br><span class="line">    <span class="comment">// 作用域个数</span></span><br><span class="line">    i: <span class="built_in">usize</span>,</span><br><span class="line">    scopes: HashMap&lt;<span class="built_in">usize</span>, ScopePtr&gt;,</span><br><span class="line">    <span class="comment">// 当前作用域</span></span><br><span class="line">    s: ScopePtr,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> SymTab &#123;</span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">new</span></span>() -&gt; SymTab &#123;</span><br><span class="line">        <span class="keyword">let</span> s = Scope::new(<span class="number">0</span>);</span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut</span> scopes = HashMap::new();</span><br><span class="line">        scopes.insert(as_scope(s).id, s);</span><br><span class="line">        SymTab &#123; i: <span class="number">1</span>, scopes, s &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">enter_scope</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) &#123;</span><br><span class="line">        <span class="keyword">let</span> s = Scope::new(<span class="keyword">self</span>.i);</span><br><span class="line">        <span class="keyword">self</span>.scopes.insert(<span class="keyword">self</span>.i, s);</span><br><span class="line">        <span class="keyword">self</span>.i += <span class="number">1</span>;</span><br><span class="line">        as_scope(s).parent = <span class="keyword">self</span>.s;</span><br><span class="line">        as_scope(<span class="keyword">self</span>.s).subs.push(s);</span><br><span class="line">        <span class="keyword">self</span>.s = s;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">leave_scope</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) &#123;</span><br><span class="line">        <span class="keyword">self</span>.s = as_scope(<span class="keyword">self</span>.s).parent;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">add_binding</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, n: &amp;<span class="built_in">str</span>) &#123;</span><br><span class="line">        as_scope(<span class="keyword">self</span>.s).add_binding(n);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">add_param</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, n: &amp;<span class="built_in">str</span>) &#123;</span><br><span class="line">        as_scope(<span class="keyword">self</span>.s).add_param(n);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">get_scope</span></span>(&amp;<span class="keyword">self</span>, i: <span class="built_in">usize</span>) -&gt; ScopePtr &#123;</span><br><span class="line">        *<span class="keyword">self</span>.scopes.get(&amp;i).unwrap()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="built_in">Drop</span> <span class="keyword">for</span> SymTab &#123;</span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">drop</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) &#123;</span><br><span class="line">        <span class="keyword">self</span>.scopes</span><br><span class="line">            .values()</span><br><span class="line">            .for_each(|s| <span class="keyword">unsafe</span> &#123; drop_in_place(*s) &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> AstVisitor&lt;(), ()&gt; <span class="keyword">for</span> SymTab &#123;</span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">prog</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, prog: &amp;Prog) -&gt; <span class="built_in">Result</span>&lt;(), ()&gt; &#123;</span><br><span class="line">        prog.body.iter().for_each(|s| <span class="keyword">self</span>.stmt(s).unwrap());</span><br><span class="line">        <span class="literal">Ok</span>(())</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">block_stmt</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, stmt: &amp;BlockStmt) -&gt; <span class="built_in">Result</span>&lt;(), ()&gt; &#123;</span><br><span class="line">        stmt.body.iter().for_each(|s| <span class="keyword">self</span>.stmt(s).unwrap());</span><br><span class="line">        <span class="literal">Ok</span>(())</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">var_dec_stmt</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, stmt: &amp;VarDec) -&gt; <span class="built_in">Result</span>&lt;(), ()&gt; &#123;</span><br><span class="line">        stmt.decs.iter().for_each(|dec| &#123;</span><br><span class="line">            <span class="keyword">self</span>.add_binding(dec.id.id().name.as_str());</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">let</span> <span class="literal">Some</span>(init) = &amp;dec.init &#123;</span><br><span class="line">                <span class="keyword">self</span>.expr(init).ok();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="literal">Ok</span>(())</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">empty_stmt</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, _stmt: &amp;EmptyStmt) -&gt; <span class="built_in">Result</span>&lt;(), ()&gt; &#123;</span><br><span class="line">        <span class="literal">Ok</span>(())</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">expr_stmt</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, stmt: &amp;ExprStmt) -&gt; <span class="built_in">Result</span>&lt;(), ()&gt; &#123;</span><br><span class="line">        <span class="keyword">self</span>.expr(&amp;stmt.expr).ok();</span><br><span class="line">        <span class="literal">Ok</span>(())</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">if_stmt</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, stmt: &amp;IfStmt) -&gt; <span class="built_in">Result</span>&lt;(), ()&gt; &#123;</span><br><span class="line">        <span class="keyword">self</span>.stmt(&amp;stmt.cons).ok();</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">let</span> <span class="literal">Some</span>(s) = &amp;stmt.alt &#123;</span><br><span class="line">            <span class="keyword">self</span>.stmt(s).ok();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="literal">Ok</span>(())</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">for_stmt</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, stmt: &amp;ForStmt) -&gt; <span class="built_in">Result</span>&lt;(), ()&gt; &#123;</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">let</span> <span class="literal">Some</span>(init) = &amp;stmt.init &#123;</span><br><span class="line">            <span class="keyword">match</span> init &#123;</span><br><span class="line">                ForFirst::VarDec(dec) =&gt; <span class="keyword">self</span>.var_dec_stmt(dec).unwrap(),</span><br><span class="line">                _ =&gt; (),</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">self</span>.stmt(&amp;stmt.body).ok();</span><br><span class="line">        <span class="literal">Ok</span>(())</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">for_in_stmt</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, stmt: &amp;ForInStmt) -&gt; <span class="built_in">Result</span>&lt;(), ()&gt; &#123;</span><br><span class="line">        <span class="keyword">match</span> &amp;stmt.left &#123;</span><br><span class="line">            ForFirst::VarDec(dec) =&gt; <span class="keyword">self</span>.var_dec_stmt(dec).unwrap(),</span><br><span class="line">            _ =&gt; (),</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">self</span>.stmt(&amp;stmt.body).ok();</span><br><span class="line">        <span class="literal">Ok</span>(())</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">do_while_stmt</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, stmt: &amp;DoWhileStmt) -&gt; <span class="built_in">Result</span>&lt;(), ()&gt; &#123;</span><br><span class="line">        <span class="keyword">self</span>.stmt(&amp;stmt.body).ok();</span><br><span class="line">        <span class="literal">Ok</span>(())</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">while_stmt</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, stmt: &amp;WhileStmt) -&gt; <span class="built_in">Result</span>&lt;(), ()&gt; &#123;</span><br><span class="line">        <span class="keyword">self</span>.stmt(&amp;stmt.body).ok();</span><br><span class="line">        <span class="literal">Ok</span>(())</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">cont_stmt</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, _stmt: &amp;ContStmt) -&gt; <span class="built_in">Result</span>&lt;(), ()&gt; &#123;</span><br><span class="line">        <span class="literal">Ok</span>(())</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">break_stmt</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, _stmt: &amp;BreakStmt) -&gt; <span class="built_in">Result</span>&lt;(), ()&gt; &#123;</span><br><span class="line">        <span class="literal">Ok</span>(())</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">ret_stmt</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, stmt: &amp;ReturnStmt) -&gt; <span class="built_in">Result</span>&lt;(), ()&gt; &#123;</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">let</span> <span class="literal">Some</span>(s) = &amp;stmt.argument &#123;</span><br><span class="line">            <span class="keyword">self</span>.expr(s).ok();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="literal">Ok</span>(())</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">with_stmt</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, _stmt: &amp;WithStmt) -&gt; <span class="built_in">Result</span>&lt;(), ()&gt; &#123;</span><br><span class="line">        <span class="literal">Ok</span>(())</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">switch_stmt</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, stmt: &amp;SwitchStmt) -&gt; <span class="built_in">Result</span>&lt;(), ()&gt; &#123;</span><br><span class="line">        stmt.cases</span><br><span class="line">            .iter()</span><br><span class="line">            .for_each(|case| case.cons.iter().for_each(|s| <span class="keyword">self</span>.stmt(s).unwrap()));</span><br><span class="line">        <span class="literal">Ok</span>(())</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">throw_stmt</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, stmt: &amp;ThrowStmt) -&gt; <span class="built_in">Result</span>&lt;(), ()&gt; &#123;</span><br><span class="line">        <span class="literal">Ok</span>(())</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">try_stmt</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, stmt: &amp;TryStmt) -&gt; <span class="built_in">Result</span>&lt;(), ()&gt; &#123;</span><br><span class="line">        <span class="keyword">self</span>.stmt(&amp;stmt.block).ok();</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">let</span> <span class="literal">Some</span>(h) = &amp;stmt.handler &#123;</span><br><span class="line">            <span class="keyword">self</span>.stmt(&amp;h.body).ok();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">let</span> <span class="literal">Some</span>(f) = &amp;stmt.finalizer &#123;</span><br><span class="line">            <span class="keyword">self</span>.stmt(&amp;f).ok();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="literal">Ok</span>(())</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">debug_stmt</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, stmt: &amp;DebugStmt) -&gt; <span class="built_in">Result</span>&lt;(), ()&gt; &#123;</span><br><span class="line">        <span class="literal">Ok</span>(())</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">fn_stmt</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, stmt: &amp;FnDec) -&gt; <span class="built_in">Result</span>&lt;(), ()&gt; &#123;</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">let</span> <span class="literal">Some</span>(id) = &amp;stmt.id &#123;</span><br><span class="line">            <span class="keyword">let</span> f_name = id.id().name.as_str();</span><br><span class="line">            <span class="keyword">self</span>.add_binding(f_name);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">self</span>.enter_scope();</span><br><span class="line">        stmt.params.iter().for_each(|p| &#123;</span><br><span class="line">            <span class="keyword">let</span> n = p.id().name.as_str();</span><br><span class="line">            <span class="keyword">self</span>.add_param(n);</span><br><span class="line">            <span class="keyword">self</span>.add_binding(n);</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="keyword">self</span>.stmt(&amp;stmt.body).ok();</span><br><span class="line">        <span class="keyword">self</span>.leave_scope();</span><br><span class="line">        <span class="literal">Ok</span>(())</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">member_expr</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, expr: &amp;MemberExpr) -&gt; <span class="built_in">Result</span>&lt;(), ()&gt; &#123;</span><br><span class="line">        <span class="keyword">self</span>.expr(&amp;expr.object).ok();</span><br><span class="line">        <span class="keyword">self</span>.expr(&amp;expr.property).ok();</span><br><span class="line">        <span class="literal">Ok</span>(())</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">new_expr</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, expr: &amp;NewExpr) -&gt; <span class="built_in">Result</span>&lt;(), ()&gt; &#123;</span><br><span class="line">        <span class="keyword">self</span>.expr(&amp;expr.callee).ok();</span><br><span class="line">        expr.arguments</span><br><span class="line">            .iter()</span><br><span class="line">            .for_each(|arg| <span class="keyword">self</span>.expr(arg).unwrap());</span><br><span class="line">        <span class="literal">Ok</span>(())</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">call_expr</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, expr: &amp;CallExpr) -&gt; <span class="built_in">Result</span>&lt;(), ()&gt; &#123;</span><br><span class="line">        <span class="keyword">self</span>.expr(&amp;expr.callee).ok();</span><br><span class="line">        expr.arguments</span><br><span class="line">            .iter()</span><br><span class="line">            .for_each(|arg| <span class="keyword">self</span>.expr(arg).unwrap());</span><br><span class="line">        <span class="literal">Ok</span>(())</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">unary_expr</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, expr: &amp;UnaryExpr) -&gt; <span class="built_in">Result</span>&lt;(), ()&gt; &#123;</span><br><span class="line">        <span class="keyword">self</span>.expr(&amp;expr.argument).ok();</span><br><span class="line">        <span class="literal">Ok</span>(())</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">binary_expr</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, expr: &amp;BinaryExpr) -&gt; <span class="built_in">Result</span>&lt;(), ()&gt; &#123;</span><br><span class="line">        <span class="keyword">self</span>.expr(&amp;expr.left).ok();</span><br><span class="line">        <span class="keyword">self</span>.expr(&amp;expr.right).ok();</span><br><span class="line">        <span class="literal">Ok</span>(())</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">assign_expr</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, expr: &amp;AssignExpr) -&gt; <span class="built_in">Result</span>&lt;(), ()&gt; &#123;</span><br><span class="line">        <span class="keyword">self</span>.expr(&amp;expr.left).ok();</span><br><span class="line">        <span class="keyword">self</span>.expr(&amp;expr.right).ok();</span><br><span class="line">        <span class="literal">Ok</span>(())</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">cond_expr</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, expr: &amp;CondExpr) -&gt; <span class="built_in">Result</span>&lt;(), ()&gt; &#123;</span><br><span class="line">        <span class="keyword">self</span>.expr(&amp;expr.test).ok();</span><br><span class="line">        <span class="keyword">self</span>.expr(&amp;expr.cons).ok();</span><br><span class="line">        <span class="keyword">self</span>.expr(&amp;expr.alt).ok();</span><br><span class="line">        <span class="literal">Ok</span>(())</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">seq_expr</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, expr: &amp;SeqExpr) -&gt; <span class="built_in">Result</span>&lt;(), ()&gt; &#123;</span><br><span class="line">        expr.exprs.iter().for_each(|expr| <span class="keyword">self</span>.expr(expr).unwrap());</span><br><span class="line">        <span class="literal">Ok</span>(())</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">this_expr</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, _expr: &amp;ThisExprData) -&gt; <span class="built_in">Result</span>&lt;(), ()&gt; &#123;</span><br><span class="line">        <span class="literal">Ok</span>(())</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">id_expr</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, _expr: &amp;IdData) -&gt; <span class="built_in">Result</span>&lt;(), ()&gt; &#123;</span><br><span class="line">        <span class="literal">Ok</span>(())</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">array_literal</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, expr: &amp;ArrayData) -&gt; <span class="built_in">Result</span>&lt;(), ()&gt; &#123;</span><br><span class="line">        expr.value.iter().for_each(|expr| <span class="keyword">self</span>.expr(expr).unwrap());</span><br><span class="line">        <span class="literal">Ok</span>(())</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">object_literal</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, expr: &amp;ObjectData) -&gt; <span class="built_in">Result</span>&lt;(), ()&gt; &#123;</span><br><span class="line">        expr.properties.iter().for_each(|p| &#123;</span><br><span class="line">            <span class="keyword">self</span>.expr(&amp;p.key).ok();</span><br><span class="line">            <span class="keyword">self</span>.expr(&amp;p.value).ok();</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="literal">Ok</span>(())</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">paren_expr</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, expr: &amp;ParenData) -&gt; <span class="built_in">Result</span>&lt;(), ()&gt; &#123;</span><br><span class="line">        <span class="keyword">self</span>.expr(&amp;expr.value).ok();</span><br><span class="line">        <span class="literal">Ok</span>(())</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">fn_expr</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, expr: &amp;FnDec) -&gt; <span class="built_in">Result</span>&lt;(), ()&gt; &#123;</span><br><span class="line">        <span class="comment">// `var a = function b() &#123;&#125;; b();` -&gt; ReferenceError `b is not defined`</span></span><br><span class="line">        <span class="keyword">self</span>.enter_scope();</span><br><span class="line">        expr.params.iter().for_each(|p| &#123;</span><br><span class="line">            <span class="keyword">let</span> n = p.id().name.as_str();</span><br><span class="line">            <span class="keyword">self</span>.add_param(n);</span><br><span class="line">            <span class="keyword">self</span>.add_binding(n);</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="keyword">self</span>.stmt(&amp;expr.body).ok();</span><br><span class="line">        <span class="keyword">self</span>.leave_scope();</span><br><span class="line">        <span class="literal">Ok</span>(())</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">regexp_expr</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, _expr: &amp;RegExpData) -&gt; <span class="built_in">Result</span>&lt;(), ()&gt; &#123;</span><br><span class="line">        <span class="literal">Ok</span>(())</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">null_expr</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, _expr: &amp;NullData) -&gt; <span class="built_in">Result</span>&lt;(), ()&gt; &#123;</span><br><span class="line">        <span class="literal">Ok</span>(())</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">undef_expr</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, _expr: &amp;UndefData) -&gt; <span class="built_in">Result</span>&lt;(), ()&gt; &#123;</span><br><span class="line">        <span class="literal">Ok</span>(())</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">str_expr</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, _expr: &amp;StringData) -&gt; <span class="built_in">Result</span>&lt;(), ()&gt; &#123;</span><br><span class="line">        <span class="literal">Ok</span>(())</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">bool_expr</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, _expr: &amp;BoolData) -&gt; <span class="built_in">Result</span>&lt;(), ()&gt; &#123;</span><br><span class="line">        <span class="literal">Ok</span>(())</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">num_expr</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, _expr: &amp;NumericData) -&gt; <span class="built_in">Result</span>&lt;(), ()&gt; &#123;</span><br><span class="line">        <span class="literal">Ok</span>(())</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="codegen"><a href="#codegen" class="headerlink" title="codegen"></a>codegen</h2><p>首先我们定义一些简单的指令信息：</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">type</span> <span class="title">FnStatePtr</span></span> = *<span class="keyword">mut</span> FnState;</span><br><span class="line"></span><br><span class="line"><span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">as_fn_state</span></span>(ptr: FnStatePtr) -&gt; &amp;<span class="symbol">'static</span> <span class="keyword">mut</span> FnState &#123;</span><br><span class="line">    <span class="keyword">unsafe</span> &#123; &amp;<span class="keyword">mut</span> (*ptr) &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">const</span> ENV_NAME: &amp;<span class="symbol">'static</span> <span class="built_in">str</span> = <span class="string">"__ENV__"</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[derive(Debug)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">struct</span> <span class="title">LoopInfo</span></span> &#123;</span><br><span class="line">    start: <span class="built_in">i32</span>,</span><br><span class="line">    end: <span class="built_in">i32</span>,</span><br><span class="line">    <span class="comment">// index of break instructions in this loop</span></span><br><span class="line">    brk: <span class="built_in">Vec</span>&lt;<span class="built_in">i32</span>&gt;,</span><br><span class="line">    <span class="comment">// index of continue instructions in this loop</span></span><br><span class="line">    cont: <span class="built_in">Vec</span>&lt;<span class="built_in">i32</span>&gt;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[derive(Debug)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">struct</span> <span class="title">FnState</span></span> &#123;</span><br><span class="line">    id: <span class="built_in">usize</span>,</span><br><span class="line">    tpl: FnTpl,</span><br><span class="line">    parent: FnStatePtr,</span><br><span class="line">    idx_in_parent: <span class="built_in">u32</span>,</span><br><span class="line">    <span class="comment">// 局部变量名称映射到寄存器</span></span><br><span class="line">    local_reg_map: HashMap&lt;<span class="built_in">String</span>, <span class="built_in">u32</span>&gt;,</span><br><span class="line">    subs: <span class="built_in">Vec</span>&lt;FnStatePtr&gt;,</span><br><span class="line">    <span class="comment">// 可用的寄存器编号，用于分配新的寄存器</span></span><br><span class="line">    free_reg: <span class="built_in">u32</span>,</span><br><span class="line">    <span class="comment">// 结果寄存器</span></span><br><span class="line">    res_reg: <span class="built_in">Vec</span>&lt;<span class="built_in">u32</span>&gt;,</span><br><span class="line">    loop_stack: <span class="built_in">Vec</span>&lt;LoopInfo&gt;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">fn_state_to_tpl</span></span>(s: &amp;FnState) -&gt; FnTpl &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut</span> tpl = s.tpl.clone();</span><br><span class="line">    s.subs.iter().for_each(|sp| &#123;</span><br><span class="line">        <span class="keyword">let</span> st = fn_state_to_tpl(as_fn_state(*sp));</span><br><span class="line">        tpl.fun_tpls.push(st);</span><br><span class="line">    &#125;);</span><br><span class="line">    tpl</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> FnState &#123;</span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">new</span></span>(id: <span class="built_in">usize</span>) -&gt; FnStatePtr &#123;</span><br><span class="line">        <span class="built_in">Box</span>::into_raw(<span class="built_in">Box</span>::new(FnState &#123;</span><br><span class="line">            id,</span><br><span class="line">            tpl: FnTpl::new(),</span><br><span class="line">            parent: null_mut(),</span><br><span class="line">            idx_in_parent: <span class="number">0</span>,</span><br><span class="line">            local_reg_map: HashMap::new(),</span><br><span class="line">            subs: <span class="built_in">vec!</span>[],</span><br><span class="line">            free_reg: <span class="number">0</span>,</span><br><span class="line">            res_reg: <span class="built_in">vec!</span>[],</span><br><span class="line">            loop_stack: <span class="built_in">vec!</span>[],</span><br><span class="line">        &#125;))</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 分配新的寄存器编号</span></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">take_reg</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) -&gt; <span class="built_in">u32</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> r = <span class="keyword">self</span>.free_reg;</span><br><span class="line">        <span class="keyword">self</span>.free_reg += <span class="number">1</span>;</span><br><span class="line">        r</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 检查是否存在具有指定名称的局部变量</span></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">has_local</span></span>(&amp;<span class="keyword">self</span>, n: &amp;<span class="built_in">str</span>) -&gt; <span class="built_in">bool</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> v <span class="keyword">in</span> &amp;<span class="keyword">self</span>.tpl.locals &#123;</span><br><span class="line">            <span class="keyword">if</span> v.name.eq(n) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 声明一个新的局部变量并将其映射到寄存器</span></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">def_local</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, n: &amp;<span class="built_in">str</span>, reg: <span class="built_in">u32</span>) &#123;</span><br><span class="line">        <span class="keyword">self</span>.tpl.locals.push(Local &#123;</span><br><span class="line">            name: n.to_string(),</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="keyword">self</span>.local_reg_map.insert(n.to_string(), reg);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取指定局部变量名称对应的寄存器编号</span></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">local2reg</span></span>(&amp;<span class="keyword">self</span>, n: &amp;<span class="built_in">str</span>) -&gt; <span class="built_in">u32</span> &#123;</span><br><span class="line">        *<span class="keyword">self</span>.local_reg_map.get(n).unwrap()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 检查是否存在具有指定名称的上值</span></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">has_upval</span></span>(&amp;<span class="keyword">self</span>, n: &amp;<span class="built_in">str</span>) -&gt; <span class="built_in">bool</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> uv <span class="keyword">in</span> &amp;<span class="keyword">self</span>.tpl.upvals &#123;</span><br><span class="line">            <span class="keyword">if</span> uv.name.eq(n) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">get_upval</span></span>(&amp;<span class="keyword">self</span>, n: &amp;<span class="built_in">str</span>) -&gt; <span class="built_in">Option</span>&lt;&amp;UpvalDesc&gt; &#123;</span><br><span class="line">        <span class="keyword">for</span> uv <span class="keyword">in</span> &amp;<span class="keyword">self</span>.tpl.upvals &#123;</span><br><span class="line">            <span class="keyword">if</span> uv.name.eq(n) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">Some</span>(uv);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="literal">None</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取指定名称的上值在上值数组中的索引</span></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">get_upval_idx</span></span>(&amp;<span class="keyword">self</span>, n: &amp;<span class="built_in">str</span>) -&gt; <span class="built_in">usize</span> &#123;</span><br><span class="line">        <span class="keyword">self</span>.tpl.upvals.iter().position(|uv| uv.name.eq(n)).unwrap()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">add_upval</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, n: &amp;<span class="built_in">str</span>) -&gt; <span class="built_in">bool</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">self</span>.has_upval(n) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">let</span> parent = <span class="keyword">self</span>.parent;</span><br><span class="line">        <span class="keyword">if</span> parent.is_null() &#123;</span><br><span class="line">            <span class="keyword">if</span> !<span class="keyword">self</span>.has_upval(ENV_NAME) &#123;</span><br><span class="line">                <span class="keyword">self</span>.tpl.upvals.push(UpvalDesc &#123;</span><br><span class="line">                    name: ENV_NAME.to_string(),</span><br><span class="line">                    in_stack: <span class="literal">true</span>,</span><br><span class="line">                    idx: <span class="number">0</span>,</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">let</span> parent = as_fn_state(parent);</span><br><span class="line">            <span class="keyword">if</span> parent.has_local(n) &#123;</span><br><span class="line">                <span class="keyword">self</span>.tpl.upvals.push(UpvalDesc &#123;</span><br><span class="line">                    name: n.to_string(),</span><br><span class="line">                    in_stack: <span class="literal">true</span>,</span><br><span class="line">                    idx: parent.local2reg(n),</span><br><span class="line">                &#125;);</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">let</span> is_up = parent.add_upval(n);</span><br><span class="line">                <span class="keyword">if</span> is_up &#123;</span><br><span class="line">                    <span class="keyword">self</span>.tpl.upvals.push(UpvalDesc &#123;</span><br><span class="line">                        name: n.to_string(),</span><br><span class="line">                        in_stack: <span class="literal">false</span>,</span><br><span class="line">                        idx: parent.get_upval_idx(n) <span class="keyword">as</span> <span class="built_in">u32</span>,</span><br><span class="line">                    &#125;);</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">self</span>.add_upval(ENV_NAME);</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">has_const</span></span>(&amp;<span class="keyword">self</span>, c: &amp;Const) -&gt; <span class="built_in">bool</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> c1 <span class="keyword">in</span> &amp;<span class="keyword">self</span>.tpl.consts &#123;</span><br><span class="line">            <span class="keyword">if</span> c1.eq(c) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">add_const</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, c: &amp;Const) &#123;</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">self</span>.has_const(c) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">self</span>.tpl.consts.push(c.clone());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取指定常量在常量数组中的索引</span></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">const2idx</span></span>(&amp;<span class="keyword">self</span>, c: &amp;Const) -&gt; <span class="built_in">usize</span> &#123;</span><br><span class="line">        <span class="keyword">self</span>.tpl.consts.iter().position(|c1| c1.eq(c)).unwrap()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 追加一条指令</span></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">append_inst</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, inst: Inst) &#123;</span><br><span class="line">        <span class="keyword">self</span>.tpl.code.push(inst);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">push_res_reg</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, r: <span class="built_in">u32</span>) &#123;</span><br><span class="line">        <span class="keyword">self</span>.res_reg.push(r);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">pop_res_reg</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) -&gt; (<span class="built_in">u32</span>, <span class="built_in">bool</span>) &#123;</span><br><span class="line">        <span class="keyword">match</span> <span class="keyword">self</span>.res_reg.pop() &#123;</span><br><span class="line">            <span class="literal">Some</span>(r) =&gt; (r, <span class="literal">false</span>),</span><br><span class="line">            <span class="literal">None</span> =&gt; (<span class="keyword">self</span>.take_reg(), <span class="literal">true</span>),</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">push_inst</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, c: Inst) &#123;</span><br><span class="line">        <span class="keyword">self</span>.tpl.code.push(c);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">code_len</span></span>(&amp;<span class="keyword">self</span>) -&gt; <span class="built_in">i32</span> &#123;</span><br><span class="line">        <span class="keyword">self</span>.tpl.code.len() <span class="keyword">as</span> <span class="built_in">i32</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 添加一条跳转指令</span></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">push_jmp</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) -&gt; <span class="built_in">i32</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut</span> jmp = Inst::new();</span><br><span class="line">        jmp.set_op(OpCode::JMP);</span><br><span class="line">        jmp.set_sbx(<span class="keyword">self</span>.code_len() + <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">self</span>.push_inst(jmp);</span><br><span class="line">        <span class="keyword">self</span>.code_len() - <span class="number">1</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//  完成之前添加的跳转指令，设置其跳转目标</span></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">fin_jmp</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, idx: <span class="built_in">i32</span>) &#123;</span><br><span class="line">        <span class="keyword">let</span> cl = <span class="keyword">self</span>.code_len();</span><br><span class="line">        <span class="keyword">let</span> jmp = <span class="keyword">self</span>.tpl.code.get_mut(idx <span class="keyword">as</span> <span class="built_in">usize</span>).unwrap();</span><br><span class="line">        jmp.set_sbx(cl - jmp.sbx());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 完成之前添加的跳转指令，设置其跳转目标为给定的偏移值</span></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">fin_jmp_sbx</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, idx: <span class="built_in">i32</span>, sbx: <span class="built_in">i32</span>) &#123;</span><br><span class="line">        <span class="keyword">let</span> jmp = <span class="keyword">self</span>.tpl.code.get_mut(idx <span class="keyword">as</span> <span class="built_in">usize</span>).unwrap();</span><br><span class="line">        jmp.set_sbx(sbx);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">get_inst</span></span>(&amp;<span class="keyword">self</span>, idx: <span class="built_in">i32</span>) -&gt; &amp;Inst &#123;</span><br><span class="line">        <span class="keyword">self</span>.tpl.code.get(idx <span class="keyword">as</span> <span class="built_in">usize</span>).unwrap()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 设置可用寄存器编号的最大值，以便释放不再需要的寄存器</span></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">free_reg_to</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, r: <span class="built_in">u32</span>) &#123;</span><br><span class="line">        <span class="keyword">self</span>.free_reg = r;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">free_regs</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, rs: &amp;[<span class="built_in">u32</span>]) &#123;</span><br><span class="line">        <span class="keyword">if</span> rs.len() &gt; <span class="number">0</span> &#123;</span><br><span class="line">            <span class="keyword">let</span> <span class="keyword">mut</span> mr = std::<span class="built_in">u32</span>::MAX;</span><br><span class="line">            <span class="keyword">for</span> r <span class="keyword">in</span> rs &#123;</span><br><span class="line">                mr = min(mr, *r);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">self</span>.free_reg_to(mr);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">get_sub</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, idx: <span class="built_in">usize</span>) -&gt; &amp;<span class="symbol">'static</span> FnState &#123;</span><br><span class="line">        as_fn_state(<span class="keyword">self</span>.subs[<span class="number">0</span>])</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">enter_loop</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) &#123;</span><br><span class="line">        <span class="keyword">self</span>.loop_stack.push(LoopInfo &#123;</span><br><span class="line">            start: <span class="keyword">self</span>.code_len(),</span><br><span class="line">            end: <span class="number">0</span>,</span><br><span class="line">            brk: <span class="built_in">vec!</span>[],</span><br><span class="line">            cont: <span class="built_in">vec!</span>[],</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 完成 break 指令的跳转目标</span></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">fin_brk</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">self</span>.loop_stack.last().is_none() &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">let</span> info = <span class="keyword">self</span>.loop_stack.last().unwrap();</span><br><span class="line">        <span class="keyword">let</span> end = info.end;</span><br><span class="line">        <span class="keyword">for</span> brk_idx <span class="keyword">in</span> &amp;info.brk &#123;</span><br><span class="line">            <span class="keyword">let</span> jmp = <span class="keyword">self</span>.get_inst(*brk_idx);</span><br><span class="line">            <span class="keyword">let</span> jmp_pc = jmp.sbx();</span><br><span class="line">            <span class="keyword">let</span> ptr = jmp <span class="keyword">as</span> *<span class="keyword">const</span> Inst <span class="keyword">as</span> *<span class="keyword">mut</span> Inst;</span><br><span class="line">            <span class="keyword">unsafe</span> &#123;</span><br><span class="line">                (*ptr).set_sbx(end - jmp_pc);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 完成 continue 指令的跳转目标</span></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">fin_cont</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">self</span>.loop_stack.last().is_none() &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">let</span> info = <span class="keyword">self</span>.loop_stack.last().unwrap();</span><br><span class="line">        <span class="keyword">let</span> start = info.start;</span><br><span class="line">        <span class="keyword">for</span> cont_idx <span class="keyword">in</span> &amp;info.cont &#123;</span><br><span class="line">            <span class="keyword">let</span> jmp = <span class="keyword">self</span>.get_inst(*cont_idx);</span><br><span class="line">            <span class="keyword">let</span> jmp_pc = jmp.sbx();</span><br><span class="line">            <span class="keyword">let</span> ptr = jmp <span class="keyword">as</span> *<span class="keyword">const</span> Inst <span class="keyword">as</span> *<span class="keyword">mut</span> Inst;</span><br><span class="line">            <span class="keyword">unsafe</span> &#123;</span><br><span class="line">                (*ptr).set_sbx(start - jmp_pc);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 跟踪循环的开始和结束</span></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">leave_loop</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) &#123;</span><br><span class="line">        <span class="keyword">self</span>.loop_stack.last_mut().unwrap().end = <span class="keyword">self</span>.code_len();</span><br><span class="line">        <span class="keyword">self</span>.fin_brk();</span><br><span class="line">        <span class="keyword">self</span>.fin_cont();</span><br><span class="line">        <span class="keyword">self</span>.loop_stack.pop();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// RK 值（Register or Konstant值）是用于表示常量或寄存器的一种值。它的目的是将常量和寄存器引用都表示为RK值，从而减少指令中的操作数数量和字节码的大小。</span></span><br><span class="line"><span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">kst_id_rk</span></span>(id: <span class="built_in">usize</span>) -&gt; <span class="built_in">u32</span> &#123;</span><br><span class="line">    <span class="built_in">assert!</span>(id &lt; <span class="number">256</span>);</span><br><span class="line">    (id | (<span class="number">1</span> &lt;&lt; <span class="number">8</span>)) <span class="keyword">as</span> <span class="built_in">u32</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="built_in">Drop</span> <span class="keyword">for</span> FnState &#123;</span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">drop</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> sub <span class="keyword">in</span> &amp;<span class="keyword">self</span>.subs &#123;</span><br><span class="line">            <span class="keyword">unsafe</span> &#123;</span><br><span class="line">                drop_in_place(*sub);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>接下来我们的 codegen 将会读取 ast，生成好对应的 chunk 及 symtab：</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br><span class="line">650</span><br><span class="line">651</span><br><span class="line">652</span><br><span class="line">653</span><br><span class="line">654</span><br><span class="line">655</span><br><span class="line">656</span><br><span class="line">657</span><br><span class="line">658</span><br><span class="line">659</span><br><span class="line">660</span><br><span class="line">661</span><br><span class="line">662</span><br><span class="line">663</span><br><span class="line">664</span><br><span class="line">665</span><br><span class="line">666</span><br><span class="line">667</span><br><span class="line">668</span><br><span class="line">669</span><br><span class="line">670</span><br><span class="line">671</span><br><span class="line">672</span><br><span class="line">673</span><br><span class="line">674</span><br><span class="line">675</span><br><span class="line">676</span><br><span class="line">677</span><br><span class="line">678</span><br><span class="line">679</span><br><span class="line">680</span><br><span class="line">681</span><br><span class="line">682</span><br><span class="line">683</span><br><span class="line">684</span><br><span class="line">685</span><br><span class="line">686</span><br><span class="line">687</span><br><span class="line">688</span><br><span class="line">689</span><br><span class="line">690</span><br><span class="line">691</span><br><span class="line">692</span><br><span class="line">693</span><br><span class="line">694</span><br><span class="line">695</span><br><span class="line">696</span><br><span class="line">697</span><br><span class="line">698</span><br><span class="line">699</span><br><span class="line">700</span><br><span class="line">701</span><br><span class="line">702</span><br><span class="line">703</span><br><span class="line">704</span><br><span class="line">705</span><br><span class="line">706</span><br><span class="line">707</span><br><span class="line">708</span><br><span class="line">709</span><br><span class="line">710</span><br><span class="line">711</span><br><span class="line">712</span><br><span class="line">713</span><br><span class="line">714</span><br><span class="line">715</span><br><span class="line">716</span><br><span class="line">717</span><br><span class="line">718</span><br><span class="line">719</span><br><span class="line">720</span><br><span class="line">721</span><br><span class="line">722</span><br><span class="line">723</span><br><span class="line">724</span><br><span class="line">725</span><br><span class="line">726</span><br><span class="line">727</span><br><span class="line">728</span><br><span class="line">729</span><br><span class="line">730</span><br><span class="line">731</span><br><span class="line">732</span><br><span class="line">733</span><br><span class="line">734</span><br><span class="line">735</span><br><span class="line">736</span><br><span class="line">737</span><br><span class="line">738</span><br><span class="line">739</span><br><span class="line">740</span><br><span class="line">741</span><br><span class="line">742</span><br><span class="line">743</span><br><span class="line">744</span><br><span class="line">745</span><br><span class="line">746</span><br><span class="line">747</span><br><span class="line">748</span><br><span class="line">749</span><br><span class="line">750</span><br><span class="line">751</span><br><span class="line">752</span><br><span class="line">753</span><br><span class="line">754</span><br><span class="line">755</span><br><span class="line">756</span><br><span class="line">757</span><br><span class="line">758</span><br><span class="line">759</span><br><span class="line">760</span><br><span class="line">761</span><br><span class="line">762</span><br><span class="line">763</span><br><span class="line">764</span><br><span class="line">765</span><br><span class="line">766</span><br><span class="line">767</span><br><span class="line">768</span><br><span class="line">769</span><br><span class="line">770</span><br><span class="line">771</span><br><span class="line">772</span><br><span class="line">773</span><br><span class="line">774</span><br><span class="line">775</span><br><span class="line">776</span><br><span class="line">777</span><br><span class="line">778</span><br><span class="line">779</span><br><span class="line">780</span><br><span class="line">781</span><br><span class="line">782</span><br><span class="line">783</span><br><span class="line">784</span><br><span class="line">785</span><br><span class="line">786</span><br><span class="line">787</span><br><span class="line">788</span><br><span class="line">789</span><br><span class="line">790</span><br><span class="line">791</span><br><span class="line">792</span><br><span class="line">793</span><br><span class="line">794</span><br><span class="line">795</span><br><span class="line">796</span><br><span class="line">797</span><br><span class="line">798</span><br><span class="line">799</span><br><span class="line">800</span><br><span class="line">801</span><br><span class="line">802</span><br><span class="line">803</span><br><span class="line">804</span><br><span class="line">805</span><br><span class="line">806</span><br><span class="line">807</span><br><span class="line">808</span><br><span class="line">809</span><br><span class="line">810</span><br><span class="line">811</span><br><span class="line">812</span><br><span class="line">813</span><br><span class="line">814</span><br><span class="line">815</span><br><span class="line">816</span><br><span class="line">817</span><br><span class="line">818</span><br><span class="line">819</span><br><span class="line">820</span><br><span class="line">821</span><br><span class="line">822</span><br><span class="line">823</span><br><span class="line">824</span><br><span class="line">825</span><br><span class="line">826</span><br><span class="line">827</span><br><span class="line">828</span><br><span class="line">829</span><br><span class="line">830</span><br><span class="line">831</span><br><span class="line">832</span><br><span class="line">833</span><br><span class="line">834</span><br><span class="line">835</span><br><span class="line">836</span><br><span class="line">837</span><br><span class="line">838</span><br><span class="line">839</span><br><span class="line">840</span><br><span class="line">841</span><br><span class="line">842</span><br><span class="line">843</span><br><span class="line">844</span><br><span class="line">845</span><br><span class="line">846</span><br><span class="line">847</span><br><span class="line">848</span><br><span class="line">849</span><br><span class="line">850</span><br><span class="line">851</span><br><span class="line">852</span><br><span class="line">853</span><br><span class="line">854</span><br><span class="line">855</span><br><span class="line">856</span><br><span class="line">857</span><br><span class="line">858</span><br><span class="line">859</span><br><span class="line">860</span><br><span class="line">861</span><br><span class="line">862</span><br><span class="line">863</span><br><span class="line">864</span><br><span class="line">865</span><br><span class="line">866</span><br><span class="line">867</span><br><span class="line">868</span><br><span class="line">869</span><br><span class="line">870</span><br><span class="line">871</span><br><span class="line">872</span><br><span class="line">873</span><br><span class="line">874</span><br><span class="line">875</span><br><span class="line">876</span><br><span class="line">877</span><br><span class="line">878</span><br><span class="line">879</span><br><span class="line">880</span><br><span class="line">881</span><br><span class="line">882</span><br><span class="line">883</span><br><span class="line">884</span><br><span class="line">885</span><br><span class="line">886</span><br><span class="line">887</span><br><span class="line">888</span><br><span class="line">889</span><br><span class="line">890</span><br><span class="line">891</span><br><span class="line">892</span><br><span class="line">893</span><br><span class="line">894</span><br><span class="line">895</span><br><span class="line">896</span><br><span class="line">897</span><br><span class="line">898</span><br><span class="line">899</span><br><span class="line">900</span><br><span class="line">901</span><br><span class="line">902</span><br><span class="line">903</span><br><span class="line">904</span><br><span class="line">905</span><br><span class="line">906</span><br><span class="line">907</span><br><span class="line">908</span><br><span class="line">909</span><br><span class="line">910</span><br><span class="line">911</span><br><span class="line">912</span><br><span class="line">913</span><br><span class="line">914</span><br><span class="line">915</span><br><span class="line">916</span><br><span class="line">917</span><br><span class="line">918</span><br><span class="line">919</span><br><span class="line">920</span><br><span class="line">921</span><br><span class="line">922</span><br><span class="line">923</span><br><span class="line">924</span><br><span class="line">925</span><br><span class="line">926</span><br><span class="line">927</span><br><span class="line">928</span><br><span class="line">929</span><br><span class="line">930</span><br><span class="line">931</span><br><span class="line">932</span><br><span class="line">933</span><br><span class="line">934</span><br><span class="line">935</span><br><span class="line">936</span><br><span class="line">937</span><br><span class="line">938</span><br><span class="line">939</span><br><span class="line">940</span><br><span class="line">941</span><br><span class="line">942</span><br><span class="line">943</span><br><span class="line">944</span><br><span class="line">945</span><br><span class="line">946</span><br><span class="line">947</span><br><span class="line">948</span><br><span class="line">949</span><br><span class="line">950</span><br><span class="line">951</span><br><span class="line">952</span><br><span class="line">953</span><br><span class="line">954</span><br><span class="line">955</span><br><span class="line">956</span><br><span class="line">957</span><br><span class="line">958</span><br><span class="line">959</span><br><span class="line">960</span><br><span class="line">961</span><br><span class="line">962</span><br><span class="line">963</span><br><span class="line">964</span><br><span class="line">965</span><br><span class="line">966</span><br><span class="line">967</span><br><span class="line">968</span><br><span class="line">969</span><br><span class="line">970</span><br><span class="line">971</span><br><span class="line">972</span><br><span class="line">973</span><br><span class="line">974</span><br><span class="line">975</span><br><span class="line">976</span><br><span class="line">977</span><br><span class="line">978</span><br><span class="line">979</span><br><span class="line">980</span><br><span class="line">981</span><br><span class="line">982</span><br><span class="line">983</span><br><span class="line">984</span><br><span class="line">985</span><br><span class="line">986</span><br><span class="line">987</span><br><span class="line">988</span><br><span class="line">989</span><br><span class="line">990</span><br><span class="line">991</span><br><span class="line">992</span><br><span class="line">993</span><br><span class="line">994</span><br><span class="line">995</span><br><span class="line">996</span><br><span class="line">997</span><br><span class="line">998</span><br><span class="line">999</span><br><span class="line">1000</span><br><span class="line">1001</span><br><span class="line">1002</span><br><span class="line">1003</span><br><span class="line">1004</span><br><span class="line">1005</span><br><span class="line">1006</span><br><span class="line">1007</span><br><span class="line">1008</span><br><span class="line">1009</span><br><span class="line">1010</span><br><span class="line">1011</span><br><span class="line">1012</span><br><span class="line">1013</span><br><span class="line">1014</span><br><span class="line">1015</span><br><span class="line">1016</span><br><span class="line">1017</span><br><span class="line">1018</span><br><span class="line">1019</span><br><span class="line">1020</span><br><span class="line">1021</span><br><span class="line">1022</span><br><span class="line">1023</span><br><span class="line">1024</span><br><span class="line">1025</span><br><span class="line">1026</span><br><span class="line">1027</span><br><span class="line">1028</span><br><span class="line">1029</span><br><span class="line">1030</span><br><span class="line">1031</span><br><span class="line">1032</span><br><span class="line">1033</span><br><span class="line">1034</span><br><span class="line">1035</span><br><span class="line">1036</span><br><span class="line">1037</span><br><span class="line">1038</span><br><span class="line">1039</span><br><span class="line">1040</span><br><span class="line">1041</span><br><span class="line">1042</span><br><span class="line">1043</span><br><span class="line">1044</span><br><span class="line">1045</span><br><span class="line">1046</span><br><span class="line">1047</span><br><span class="line">1048</span><br><span class="line">1049</span><br><span class="line">1050</span><br><span class="line">1051</span><br><span class="line">1052</span><br><span class="line">1053</span><br><span class="line">1054</span><br><span class="line">1055</span><br><span class="line">1056</span><br><span class="line">1057</span><br><span class="line">1058</span><br><span class="line">1059</span><br><span class="line">1060</span><br><span class="line">1061</span><br><span class="line">1062</span><br><span class="line">1063</span><br><span class="line">1064</span><br><span class="line">1065</span><br><span class="line">1066</span><br><span class="line">1067</span><br><span class="line">1068</span><br><span class="line">1069</span><br><span class="line">1070</span><br><span class="line">1071</span><br><span class="line">1072</span><br><span class="line">1073</span><br><span class="line">1074</span><br><span class="line">1075</span><br><span class="line">1076</span><br><span class="line">1077</span><br><span class="line">1078</span><br><span class="line">1079</span><br><span class="line">1080</span><br><span class="line">1081</span><br><span class="line">1082</span><br><span class="line">1083</span><br><span class="line">1084</span><br><span class="line">1085</span><br><span class="line">1086</span><br><span class="line">1087</span><br><span class="line">1088</span><br><span class="line">1089</span><br><span class="line">1090</span><br><span class="line">1091</span><br><span class="line">1092</span><br><span class="line">1093</span><br><span class="line">1094</span><br><span class="line">1095</span><br><span class="line">1096</span><br><span class="line">1097</span><br><span class="line">1098</span><br><span class="line">1099</span><br><span class="line">1100</span><br><span class="line">1101</span><br><span class="line">1102</span><br><span class="line">1103</span><br><span class="line">1104</span><br><span class="line">1105</span><br><span class="line">1106</span><br><span class="line">1107</span><br><span class="line">1108</span><br><span class="line">1109</span><br><span class="line">1110</span><br><span class="line">1111</span><br><span class="line">1112</span><br><span class="line">1113</span><br><span class="line">1114</span><br><span class="line">1115</span><br><span class="line">1116</span><br><span class="line">1117</span><br><span class="line">1118</span><br><span class="line">1119</span><br><span class="line">1120</span><br><span class="line">1121</span><br><span class="line">1122</span><br><span class="line">1123</span><br><span class="line">1124</span><br><span class="line">1125</span><br><span class="line">1126</span><br><span class="line">1127</span><br><span class="line">1128</span><br><span class="line">1129</span><br><span class="line">1130</span><br><span class="line">1131</span><br><span class="line">1132</span><br><span class="line">1133</span><br><span class="line">1134</span><br><span class="line">1135</span><br><span class="line">1136</span><br><span class="line">1137</span><br><span class="line">1138</span><br><span class="line">1139</span><br><span class="line">1140</span><br><span class="line">1141</span><br><span class="line">1142</span><br><span class="line">1143</span><br><span class="line">1144</span><br><span class="line">1145</span><br><span class="line">1146</span><br><span class="line">1147</span><br><span class="line">1148</span><br><span class="line">1149</span><br><span class="line">1150</span><br><span class="line">1151</span><br><span class="line">1152</span><br><span class="line">1153</span><br><span class="line">1154</span><br><span class="line">1155</span><br><span class="line">1156</span><br><span class="line">1157</span><br><span class="line">1158</span><br><span class="line">1159</span><br><span class="line">1160</span><br><span class="line">1161</span><br><span class="line">1162</span><br><span class="line">1163</span><br><span class="line">1164</span><br><span class="line">1165</span><br><span class="line">1166</span><br><span class="line">1167</span><br><span class="line">1168</span><br><span class="line">1169</span><br><span class="line">1170</span><br><span class="line">1171</span><br><span class="line">1172</span><br><span class="line">1173</span><br><span class="line">1174</span><br><span class="line">1175</span><br><span class="line">1176</span><br><span class="line">1177</span><br><span class="line">1178</span><br><span class="line">1179</span><br><span class="line">1180</span><br><span class="line">1181</span><br><span class="line">1182</span><br><span class="line">1183</span><br><span class="line">1184</span><br><span class="line">1185</span><br><span class="line">1186</span><br><span class="line">1187</span><br><span class="line">1188</span><br><span class="line">1189</span><br><span class="line">1190</span><br><span class="line">1191</span><br><span class="line">1192</span><br><span class="line">1193</span><br><span class="line">1194</span><br><span class="line">1195</span><br><span class="line">1196</span><br><span class="line">1197</span><br><span class="line">1198</span><br><span class="line">1199</span><br><span class="line">1200</span><br><span class="line">1201</span><br><span class="line">1202</span><br><span class="line">1203</span><br><span class="line">1204</span><br><span class="line">1205</span><br><span class="line">1206</span><br><span class="line">1207</span><br><span class="line">1208</span><br><span class="line">1209</span><br><span class="line">1210</span><br><span class="line">1211</span><br><span class="line">1212</span><br><span class="line">1213</span><br><span class="line">1214</span><br><span class="line">1215</span><br><span class="line">1216</span><br><span class="line">1217</span><br><span class="line">1218</span><br><span class="line">1219</span><br><span class="line">1220</span><br><span class="line">1221</span><br><span class="line">1222</span><br><span class="line">1223</span><br><span class="line">1224</span><br><span class="line">1225</span><br><span class="line">1226</span><br><span class="line">1227</span><br><span class="line">1228</span><br><span class="line">1229</span><br><span class="line">1230</span><br><span class="line">1231</span><br><span class="line">1232</span><br><span class="line">1233</span><br><span class="line">1234</span><br><span class="line">1235</span><br><span class="line">1236</span><br><span class="line">1237</span><br><span class="line">1238</span><br><span class="line">1239</span><br><span class="line">1240</span><br><span class="line">1241</span><br><span class="line">1242</span><br><span class="line">1243</span><br><span class="line">1244</span><br><span class="line">1245</span><br><span class="line">1246</span><br><span class="line">1247</span><br><span class="line">1248</span><br><span class="line">1249</span><br><span class="line">1250</span><br><span class="line">1251</span><br><span class="line">1252</span><br><span class="line">1253</span><br><span class="line">1254</span><br><span class="line">1255</span><br><span class="line">1256</span><br><span class="line">1257</span><br><span class="line">1258</span><br><span class="line">1259</span><br><span class="line">1260</span><br><span class="line">1261</span><br><span class="line">1262</span><br><span class="line">1263</span><br><span class="line">1264</span><br><span class="line">1265</span><br><span class="line">1266</span><br><span class="line">1267</span><br><span class="line">1268</span><br><span class="line">1269</span><br><span class="line">1270</span><br><span class="line">1271</span><br><span class="line">1272</span><br><span class="line">1273</span><br><span class="line">1274</span><br><span class="line">1275</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">struct</span> <span class="title">CodegenError</span></span> &#123;</span><br><span class="line">    msg: <span class="built_in">String</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> CodegenError &#123;</span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">new</span></span>(msg: &amp;<span class="built_in">str</span>) -&gt; <span class="keyword">Self</span> &#123;</span><br><span class="line">        CodegenError &#123;</span><br><span class="line">            msg: msg.to_string(),</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[derive(Debug)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">struct</span> <span class="title">Codegen</span></span> &#123;</span><br><span class="line">    scope_id_seed: <span class="built_in">usize</span>,</span><br><span class="line">    fs: FnStatePtr,</span><br><span class="line">    symtab: SymTab,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> Codegen &#123;</span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">new</span></span>(symtab: SymTab) -&gt; <span class="keyword">Self</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> fs = FnState::new(<span class="number">0</span>);</span><br><span class="line">        Codegen &#123;</span><br><span class="line">            scope_id_seed: <span class="number">1</span>,</span><br><span class="line">            fs,</span><br><span class="line">            symtab,</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">gen</span></span>(code: &amp;<span class="built_in">str</span>) -&gt; Chunk &#123;</span><br><span class="line">        init_codegen_data();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> code = <span class="built_in">String</span>::from(code);</span><br><span class="line">        <span class="keyword">let</span> src = Source::new(&amp;code);</span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut</span> lexer = Lexer::new(src);</span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut</span> parser = Parser::new(&amp;<span class="keyword">mut</span> lexer);</span><br><span class="line">        <span class="keyword">let</span> ast = <span class="keyword">match</span> parser.prog() &#123;</span><br><span class="line">            <span class="literal">Ok</span>(node) =&gt; node,</span><br><span class="line">            <span class="literal">Err</span>(e) =&gt; <span class="built_in">panic!</span>(<span class="string">"&#123;&#125;"</span>, e.msg().to_owned()),</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut</span> symtab = SymTab::new();</span><br><span class="line">        symtab.prog(&amp;ast).unwrap();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut</span> codegen = Codegen::new(symtab);</span><br><span class="line">        codegen.prog(&amp;ast).ok();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> chk = Chunk &#123;</span><br><span class="line">            sig: <span class="string">"js"</span>,</span><br><span class="line">            ver: <span class="number">0x0001</span>,</span><br><span class="line">            upval_cnt: <span class="number">0</span>,</span><br><span class="line">            fun_tpl: fn_state_to_tpl(codegen.fs_ref()),</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        chk</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建一个新的函数状态并将其设置为当前函数状态</span></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">enter_fn_state</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) &#123;</span><br><span class="line">        <span class="keyword">let</span> cfs = <span class="keyword">self</span>.fs_ref();</span><br><span class="line">        <span class="keyword">let</span> fs = as_fn_state(FnState::new(<span class="keyword">self</span>.scope_id_seed));</span><br><span class="line">        <span class="keyword">self</span>.scope_id_seed += <span class="number">1</span>;</span><br><span class="line">        fs.parent = <span class="keyword">self</span>.fs;</span><br><span class="line">        fs.idx_in_parent = cfs.subs.len() <span class="keyword">as</span> <span class="built_in">u32</span>;</span><br><span class="line">        cfs.subs.push(fs);</span><br><span class="line">        <span class="keyword">self</span>.fs = fs;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">leave_fn_state</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) &#123;</span><br><span class="line">        <span class="keyword">self</span>.fs = as_fn_state(<span class="keyword">self</span>.fs).parent;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">fs_ref</span></span>(&amp;<span class="keyword">self</span>) -&gt; &amp;<span class="symbol">'static</span> <span class="keyword">mut</span> FnState &#123;</span><br><span class="line">        as_fn_state(<span class="keyword">self</span>.fs)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">symtab_scope</span></span>(&amp;<span class="keyword">self</span>) -&gt; &amp;<span class="symbol">'static</span> <span class="keyword">mut</span> Scope &#123;</span><br><span class="line">        <span class="keyword">let</span> fs = as_fn_state(<span class="keyword">self</span>.fs);</span><br><span class="line">        as_scope(<span class="keyword">self</span>.symtab.get_scope(fs.id))</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">is_root_scope</span></span>(&amp;<span class="keyword">self</span>) -&gt; <span class="built_in">bool</span> &#123;</span><br><span class="line">        <span class="keyword">self</span>.symtab_scope().id == <span class="number">0</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">has_binding</span></span>(&amp;<span class="keyword">self</span>, n: &amp;<span class="built_in">str</span>) -&gt; <span class="built_in">bool</span> &#123;</span><br><span class="line">        <span class="keyword">self</span>.symtab_scope().has_binding(n)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">bindings</span></span>(&amp;<span class="keyword">self</span>) -&gt; &amp;<span class="symbol">'static</span> LinkedHashSet&lt;<span class="built_in">String</span>&gt; &#123;</span><br><span class="line">        &amp;<span class="keyword">self</span>.symtab_scope().bindings</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 在当前作用域中声明所有绑定，通常在作用域的入口处调用</span></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">declare_bindings</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) &#123;</span><br><span class="line">        <span class="keyword">let</span> fs = <span class="keyword">self</span>.fs_ref();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> bindings = <span class="keyword">self</span>.bindings();</span><br><span class="line">        <span class="keyword">if</span> bindings.len() &gt; <span class="number">0</span> &#123;</span><br><span class="line">            <span class="keyword">let</span> a = fs.take_reg() + <span class="keyword">self</span>.symtab_scope().params.len() <span class="keyword">as</span> <span class="built_in">u32</span>;</span><br><span class="line">            <span class="keyword">let</span> <span class="keyword">mut</span> b = <span class="number">0</span>;</span><br><span class="line">            bindings.iter().for_each(|name| &#123;</span><br><span class="line">                fs.def_local(name.as_str(), b);</span><br><span class="line">                b = fs.take_reg();</span><br><span class="line">            &#125;);</span><br><span class="line">            <span class="keyword">let</span> <span class="keyword">mut</span> inst = Inst::new();</span><br><span class="line">            inst.set_op(OpCode::LOADUNDEF);</span><br><span class="line">            inst.set_a(a);</span><br><span class="line">            inst.set_b(b - <span class="number">1</span>);</span><br><span class="line">            fs.push_inst(inst);</span><br><span class="line">            fs.free_reg_to(b);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 处理一组语句，生成相应的字节码</span></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">stmts</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, stmts: &amp;<span class="built_in">Vec</span>&lt;Stmt&gt;) -&gt; <span class="built_in">Result</span>&lt;(), CodegenError&gt; &#123;</span><br><span class="line">        <span class="keyword">for</span> stmt <span class="keyword">in</span> stmts &#123;</span><br><span class="line">            <span class="keyword">match</span> <span class="keyword">self</span>.stmt(stmt) &#123;</span><br><span class="line">                <span class="literal">Err</span>(e) =&gt; <span class="keyword">return</span> <span class="literal">Err</span>(e),</span><br><span class="line">                _ =&gt; (),</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="literal">Ok</span>(())</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 向当前函数状态的字节码中添加返回指令</span></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">append_ret_inst</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut</span> ret = Inst::new();</span><br><span class="line">        ret.set_op(OpCode::RETURN);</span><br><span class="line">        ret.set_a(<span class="number">0</span>);</span><br><span class="line">        ret.set_b(<span class="number">1</span>);</span><br><span class="line">        <span class="keyword">self</span>.fs_ref().push_inst(ret);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="built_in">Drop</span> <span class="keyword">for</span> Codegen &#123;</span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">drop</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) &#123;</span><br><span class="line">        <span class="keyword">unsafe</span> &#123;</span><br><span class="line">            drop_in_place(<span class="keyword">self</span>.fs);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 将一个值设置为全局变量</span></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">new_set_global_inst</span></span>(fs: &amp;<span class="keyword">mut</span> FnState, field_name: &amp;<span class="built_in">str</span>, val_reg: <span class="built_in">u32</span>) -&gt; Inst &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut</span> inst = Inst::new();</span><br><span class="line">    inst.set_op(OpCode::SETTABUP);</span><br><span class="line">    inst.set_a(fs.get_upval(ENV_NAME).unwrap().idx);</span><br><span class="line">    <span class="keyword">let</span> kst = Const::<span class="built_in">String</span>(field_name.to_string());</span><br><span class="line">    fs.add_const(&amp;kst);</span><br><span class="line">    inst.set_b(kst_id_rk(fs.const2idx(&amp;kst)));</span><br><span class="line">    inst.set_c(val_reg);</span><br><span class="line">    inst</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 处理变量赋值操作,如果目标上值已经存在,生成 SETUPVAL 指令将值分配给上值,否则,会生成 SETTABUP 指令将值分配给表中的元素。</span></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">assign_upval</span></span>(fs: &amp;<span class="keyword">mut</span> FnState, from_reg: <span class="built_in">u32</span>, to_name: &amp;<span class="built_in">str</span>) -&gt; Inst &#123;</span><br><span class="line">    <span class="keyword">let</span> has_def = fs.add_upval(to_name);</span><br><span class="line">    <span class="keyword">if</span> has_def &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut</span> inst = Inst::new();</span><br><span class="line">        inst.set_op(OpCode::SETUPVAL);</span><br><span class="line">        inst.set_b(fs.get_upval(to_name).unwrap().idx);</span><br><span class="line">        inst.set_a(from_reg);</span><br><span class="line">        inst</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut</span> inst = Inst::new();</span><br><span class="line">        inst.set_op(OpCode::SETTABUP);</span><br><span class="line">        inst.set_a(fs.get_upval(ENV_NAME).unwrap().idx);</span><br><span class="line">        <span class="keyword">let</span> kst = Const::<span class="built_in">String</span>(to_name.to_string());</span><br><span class="line">        fs.add_const(&amp;kst);</span><br><span class="line">        inst.set_b(kst_id_rk(fs.const2idx(&amp;kst)));</span><br><span class="line">        inst.set_c(from_reg);</span><br><span class="line">        inst</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 如果在生成某个表达式或语句的过程中生成了一个 LOADK 指令，而后又发现它不再需要，就可以使用这个函数来弹出该指令，以减小生成字节码的冗余</span></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">pop_last_loadk</span></span>(fs: &amp;<span class="keyword">mut</span> FnState) -&gt; <span class="built_in">Option</span>&lt;<span class="built_in">u32</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">let</span> last_inst = fs.tpl.code.last().unwrap();</span><br><span class="line">    <span class="keyword">let</span> last_op = OpCode::from_u32(last_inst.op());</span><br><span class="line">    <span class="keyword">if</span> last_op == OpCode::LOADK &#123;</span><br><span class="line">        <span class="keyword">let</span> last_inst = fs.tpl.code.pop().unwrap();</span><br><span class="line">        <span class="literal">Some</span>(last_inst.bx())</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="literal">None</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 对stmt排序，进行函数声明提升，变量声明提升是通过调用declare_bindings实现的</span></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">hoist</span></span>(stmts: &amp;<span class="built_in">Vec</span>&lt;Stmt&gt;) -&gt; <span class="built_in">Vec</span>&lt;Stmt&gt; &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut</span> not_fn = <span class="built_in">vec!</span>[];</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut</span> fns = <span class="built_in">vec!</span>[];</span><br><span class="line">    stmts.iter().for_each(|stmt| &#123;</span><br><span class="line">        <span class="keyword">if</span> stmt.is_fn() &#123;</span><br><span class="line">            fns.push(stmt.clone());</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            not_fn.push(stmt.clone());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    fns.append(&amp;<span class="keyword">mut</span> not_fn);</span><br><span class="line">    fns</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> AstVisitor&lt;(), CodegenError&gt; <span class="keyword">for</span> Codegen &#123;</span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">prog</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, prog: &amp;Prog) -&gt; <span class="built_in">Result</span>&lt;(), CodegenError&gt; &#123;</span><br><span class="line">        <span class="keyword">unsafe</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> !IS_MOD_INITIALIZED &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">Err</span>(CodegenError::new(</span><br><span class="line">                    <span class="string">"`init_codegen_data` should be called before this method"</span>,</span><br><span class="line">                ));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 这里不使用self.declare_bindings()因为我们不能在根作用域中声明值，根作用域中的值只是全局对象字段的别名</span></span><br><span class="line">        <span class="keyword">let</span> stmts = hoist(&amp;prog.body);</span><br><span class="line">        <span class="keyword">match</span> <span class="keyword">self</span>.stmts(&amp;stmts) &#123;</span><br><span class="line">            <span class="literal">Err</span>(e) =&gt; <span class="keyword">return</span> <span class="literal">Err</span>(e),</span><br><span class="line">            _ =&gt; (),</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">self</span>.append_ret_inst();</span><br><span class="line">        <span class="literal">Ok</span>(())</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">block_stmt</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, stmt: &amp;BlockStmt) -&gt; <span class="built_in">Result</span>&lt;(), CodegenError&gt; &#123;</span><br><span class="line">        <span class="keyword">let</span> stmts = hoist(&amp;stmt.body);</span><br><span class="line">        <span class="keyword">self</span>.stmts(&amp;stmts)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">var_dec_stmt</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, stmt: &amp;VarDec) -&gt; <span class="built_in">Result</span>&lt;(), CodegenError&gt; &#123;</span><br><span class="line">        <span class="keyword">let</span> fs = <span class="keyword">self</span>.fs_ref();</span><br><span class="line">        stmt.decs.iter().for_each(|dec| &#123;</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">let</span> <span class="literal">Some</span>(init) = &amp;dec.init &#123;</span><br><span class="line">                <span class="keyword">let</span> n = dec.id.id().name.as_str();</span><br><span class="line">                <span class="keyword">if</span> fs.has_local(n) &#123;</span><br><span class="line">                    fs.push_res_reg(fs.local2reg(n));</span><br><span class="line">                    <span class="keyword">self</span>.expr(&amp;init).ok();</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">let</span> <span class="keyword">mut</span> tmp_regs = <span class="built_in">vec!</span>[];</span><br><span class="line">                    <span class="keyword">let</span> tmp_reg = fs.take_reg();</span><br><span class="line">                    fs.push_res_reg(tmp_reg);</span><br><span class="line">                    <span class="keyword">self</span>.expr(&amp;init).ok();</span><br><span class="line">                    <span class="keyword">let</span> rk = <span class="keyword">if</span> <span class="keyword">let</span> <span class="literal">Some</span>(r) = pop_last_loadk(fs) &#123;</span><br><span class="line">                        fs.free_reg_to(tmp_reg);</span><br><span class="line">                        r</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        tmp_regs.push(tmp_reg);</span><br><span class="line">                        tmp_reg</span><br><span class="line">                    &#125;;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">let</span> inst = assign_upval(fs, rk, n);</span><br><span class="line">                    fs.push_inst(inst);</span><br><span class="line">                    fs.free_regs(&amp;tmp_regs);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="literal">Ok</span>(())</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">empty_stmt</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, stmt: &amp;EmptyStmt) -&gt; <span class="built_in">Result</span>&lt;(), CodegenError&gt; &#123;</span><br><span class="line">        <span class="literal">Ok</span>(())</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">expr_stmt</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, stmt: &amp;ExprStmt) -&gt; <span class="built_in">Result</span>&lt;(), CodegenError&gt; &#123;</span><br><span class="line">        <span class="keyword">self</span>.expr(&amp;stmt.expr).ok();</span><br><span class="line">        <span class="literal">Ok</span>(())</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">if_stmt</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, stmt: &amp;IfStmt) -&gt; <span class="built_in">Result</span>&lt;(), CodegenError&gt; &#123;</span><br><span class="line">        <span class="keyword">let</span> fs = <span class="keyword">self</span>.fs_ref();</span><br><span class="line">        <span class="keyword">let</span> tr = fs.take_reg();</span><br><span class="line">        fs.push_res_reg(tr);</span><br><span class="line">        <span class="keyword">self</span>.expr(&amp;stmt.test).ok();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut</span> test = Inst::new();</span><br><span class="line">        test.set_op(OpCode::TEST);</span><br><span class="line">        test.set_a(tr);</span><br><span class="line">        test.set_c(<span class="number">1</span>);</span><br><span class="line">        fs.push_inst(test);</span><br><span class="line">        fs.free_reg_to(tr);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// jmp to false</span></span><br><span class="line">        <span class="keyword">let</span> jmp1 = fs.push_jmp();</span><br><span class="line">        <span class="keyword">self</span>.stmt(&amp;stmt.cons).ok();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">let</span> <span class="literal">Some</span>(alt) = &amp;stmt.alt &#123;</span><br><span class="line">            <span class="comment">// jmp over false</span></span><br><span class="line">            <span class="keyword">let</span> jmp2 = fs.push_jmp();</span><br><span class="line">            fs.fin_jmp(jmp1);</span><br><span class="line">            <span class="keyword">self</span>.stmt(&amp;alt).ok();</span><br><span class="line">            fs.fin_jmp(jmp2);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            fs.fin_jmp(jmp1);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="literal">Ok</span>(())</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">for_stmt</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, stmt: &amp;ForStmt) -&gt; <span class="built_in">Result</span>&lt;(), CodegenError&gt; &#123;</span><br><span class="line">        <span class="keyword">let</span> fs = <span class="keyword">self</span>.fs_ref();</span><br><span class="line">        fs.enter_loop();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">let</span> <span class="literal">Some</span>(init) = &amp;stmt.init &#123;</span><br><span class="line">            <span class="keyword">match</span> init &#123;</span><br><span class="line">                ForFirst::VarDec(dec) =&gt; <span class="keyword">self</span>.var_dec_stmt(dec).ok(),</span><br><span class="line">                ForFirst::Expr(expr) =&gt; <span class="keyword">self</span>.expr(expr).ok(),</span><br><span class="line">            &#125;;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> s_len = fs.code_len();</span><br><span class="line">        fs.loop_stack.last_mut().unwrap().start = s_len;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> tr = fs.take_reg();</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">let</span> <span class="literal">Some</span>(test) = &amp;stmt.test &#123;</span><br><span class="line">            fs.push_res_reg(tr);</span><br><span class="line">            <span class="keyword">self</span>.expr(test).ok();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">let</span> <span class="keyword">mut</span> b = Inst::new();</span><br><span class="line">            b.set_op(OpCode::LOADBOO);</span><br><span class="line">            b.set_a(tr);</span><br><span class="line">            b.set_b(<span class="number">1</span>);</span><br><span class="line">            fs.push_inst(b);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut</span> t = Inst::new();</span><br><span class="line">        t.set_op(OpCode::TEST);</span><br><span class="line">        t.set_a(tr);</span><br><span class="line">        t.set_c(<span class="number">1</span>);</span><br><span class="line">        fs.push_inst(t);</span><br><span class="line">        fs.free_reg_to(tr);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// jmp out of loop</span></span><br><span class="line">        <span class="keyword">let</span> jmp1 = fs.push_jmp();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">self</span>.stmt(&amp;stmt.body).ok();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">let</span> <span class="literal">Some</span>(update) = &amp;stmt.update &#123;</span><br><span class="line">            <span class="keyword">self</span>.expr(update).ok();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// jmp to the loop start</span></span><br><span class="line">        <span class="keyword">let</span> jmp2 = fs.push_jmp();</span><br><span class="line">        fs.fin_jmp(jmp1);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> e_len = fs.code_len();</span><br><span class="line">        fs.fin_jmp_sbx(jmp2, s_len - e_len);</span><br><span class="line">        fs.leave_loop();</span><br><span class="line">        <span class="literal">Ok</span>(())</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">for_in_stmt</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, stmt: &amp;ForInStmt) -&gt; <span class="built_in">Result</span>&lt;(), CodegenError&gt; &#123;</span><br><span class="line">        <span class="built_in">unimplemented!</span>()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">do_while_stmt</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, stmt: &amp;DoWhileStmt) -&gt; <span class="built_in">Result</span>&lt;(), CodegenError&gt; &#123;</span><br><span class="line">        <span class="keyword">let</span> fs = <span class="keyword">self</span>.fs_ref();</span><br><span class="line">        fs.enter_loop();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> s_len = fs.code_len();</span><br><span class="line">        <span class="keyword">self</span>.stmt(&amp;stmt.body).ok();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> tr = fs.take_reg();</span><br><span class="line">        fs.push_res_reg(tr);</span><br><span class="line">        <span class="keyword">self</span>.expr(&amp;stmt.test).ok();</span><br><span class="line">        fs.free_reg_to(tr);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut</span> t = Inst::new();</span><br><span class="line">        t.set_op(OpCode::TEST);</span><br><span class="line">        t.set_a(tr);</span><br><span class="line">        t.set_c(<span class="number">0</span>);</span><br><span class="line">        fs.push_inst(t);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// jmp out of loop</span></span><br><span class="line">        <span class="keyword">let</span> jmp1 = fs.push_jmp();</span><br><span class="line">        <span class="keyword">let</span> e_len = fs.code_len();</span><br><span class="line">        fs.fin_jmp_sbx(jmp1, s_len - e_len);</span><br><span class="line">        fs.leave_loop();</span><br><span class="line">        <span class="literal">Ok</span>(())</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">while_stmt</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, stmt: &amp;WhileStmt) -&gt; <span class="built_in">Result</span>&lt;(), CodegenError&gt; &#123;</span><br><span class="line">        <span class="keyword">let</span> fs = <span class="keyword">self</span>.fs_ref();</span><br><span class="line">        fs.enter_loop();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> s_len = fs.code_len();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> tr = fs.take_reg();</span><br><span class="line">        fs.push_res_reg(tr);</span><br><span class="line">        <span class="keyword">self</span>.expr(&amp;stmt.test).ok();</span><br><span class="line">        fs.free_reg_to(tr);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut</span> t = Inst::new();</span><br><span class="line">        t.set_op(OpCode::TEST);</span><br><span class="line">        t.set_a(tr);</span><br><span class="line">        t.set_c(<span class="number">1</span>);</span><br><span class="line">        fs.push_inst(t);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// jmp out of loop</span></span><br><span class="line">        <span class="keyword">let</span> jmp1 = fs.push_jmp();</span><br><span class="line">        <span class="keyword">self</span>.stmt(&amp;stmt.body).ok();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// jmp to the loop start</span></span><br><span class="line">        <span class="keyword">let</span> jmp2 = fs.push_jmp();</span><br><span class="line">        fs.fin_jmp(jmp1);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> e_len = fs.code_len();</span><br><span class="line">        fs.fin_jmp_sbx(jmp2, s_len - e_len);</span><br><span class="line">        fs.leave_loop();</span><br><span class="line">        <span class="literal">Ok</span>(())</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">cont_stmt</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, stmt: &amp;ContStmt) -&gt; <span class="built_in">Result</span>&lt;(), CodegenError&gt; &#123;</span><br><span class="line">        <span class="keyword">let</span> fs = <span class="keyword">self</span>.fs_ref();</span><br><span class="line">        <span class="keyword">let</span> len = fs.code_len();</span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut</span> inst = Inst::new();</span><br><span class="line">        inst.set_op(OpCode::JMP);</span><br><span class="line">        inst.set_sbx(len + <span class="number">1</span>);</span><br><span class="line">        fs.push_inst(inst);</span><br><span class="line">        fs.loop_stack.last_mut().unwrap().cont.push(len);</span><br><span class="line">        <span class="literal">Ok</span>(())</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">break_stmt</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, stmt: &amp;BreakStmt) -&gt; <span class="built_in">Result</span>&lt;(), CodegenError&gt; &#123;</span><br><span class="line">        <span class="keyword">let</span> fs = <span class="keyword">self</span>.fs_ref();</span><br><span class="line">        <span class="keyword">let</span> len = fs.code_len();</span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut</span> inst = Inst::new();</span><br><span class="line">        inst.set_op(OpCode::JMP);</span><br><span class="line">        inst.set_sbx(len + <span class="number">1</span>);</span><br><span class="line">        fs.push_inst(inst);</span><br><span class="line">        fs.loop_stack.last_mut().unwrap().brk.push(len);</span><br><span class="line">        <span class="literal">Ok</span>(())</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">ret_stmt</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, stmt: &amp;ReturnStmt) -&gt; <span class="built_in">Result</span>&lt;(), CodegenError&gt; &#123;</span><br><span class="line">        <span class="keyword">let</span> fs = <span class="keyword">self</span>.fs_ref();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut</span> ret = Inst::new();</span><br><span class="line">        ret.set_op(OpCode::RETURN);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">let</span> <span class="literal">Some</span>(arg) = &amp;stmt.argument &#123;</span><br><span class="line">            <span class="keyword">let</span> tr = fs.take_reg();</span><br><span class="line">            fs.push_res_reg(tr);</span><br><span class="line">            <span class="keyword">self</span>.expr(arg).ok();</span><br><span class="line">            ret.set_a(tr);</span><br><span class="line">            ret.set_b(<span class="number">2</span>);</span><br><span class="line">            fs.free_reg_to(tr);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        fs.push_inst(ret);</span><br><span class="line">        <span class="literal">Ok</span>(())</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">with_stmt</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, stmt: &amp;WithStmt) -&gt; <span class="built_in">Result</span>&lt;(), CodegenError&gt; &#123;</span><br><span class="line">        <span class="built_in">unimplemented!</span>()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">switch_stmt</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, stmt: &amp;SwitchStmt) -&gt; <span class="built_in">Result</span>&lt;(), CodegenError&gt; &#123;</span><br><span class="line">        <span class="built_in">unimplemented!</span>()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">throw_stmt</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, stmt: &amp;ThrowStmt) -&gt; <span class="built_in">Result</span>&lt;(), CodegenError&gt; &#123;</span><br><span class="line">        <span class="built_in">unimplemented!</span>()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">try_stmt</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, stmt: &amp;TryStmt) -&gt; <span class="built_in">Result</span>&lt;(), CodegenError&gt; &#123;</span><br><span class="line">        <span class="built_in">unimplemented!</span>()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">debug_stmt</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, stmt: &amp;DebugStmt) -&gt; <span class="built_in">Result</span>&lt;(), CodegenError&gt; &#123;</span><br><span class="line">        <span class="built_in">unimplemented!</span>()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">fn_stmt</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, stmt: &amp;FnDec) -&gt; <span class="built_in">Result</span>&lt;(), CodegenError&gt; &#123;</span><br><span class="line">        <span class="comment">// 没有 id 的函数是没有意义的，因为它不能稍后调用，所以在这种情况下我们可以跳过生成它的指令</span></span><br><span class="line">        <span class="keyword">if</span> stmt.id.is_none() &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">Ok</span>(());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> id = stmt.id.as_ref().unwrap().id().name.as_str();</span><br><span class="line">        <span class="keyword">let</span> pfs = <span class="keyword">self</span>.fs_ref();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">self</span>.enter_fn_state();</span><br><span class="line">        <span class="keyword">let</span> cfs = <span class="keyword">self</span>.fs_ref();</span><br><span class="line">        <span class="keyword">let</span> ra = <span class="keyword">if</span> pfs.has_local(id) &#123;</span><br><span class="line">            pfs.local2reg(id)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            pfs.take_reg()</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut</span> inst = Inst::new();</span><br><span class="line">        inst.set_op(OpCode::CLOSURE);</span><br><span class="line">        inst.set_a(ra);</span><br><span class="line">        inst.set_bx(cfs.idx_in_parent);</span><br><span class="line">        pfs.push_inst(inst);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> !pfs.has_local(id) &#123;</span><br><span class="line">            <span class="keyword">let</span> inst = assign_upval(pfs, ra, id);</span><br><span class="line">            pfs.push_inst(inst);</span><br><span class="line">            pfs.free_reg_to(ra);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">self</span>.declare_bindings();</span><br><span class="line">        <span class="keyword">self</span>.stmt(&amp;stmt.body).ok();</span><br><span class="line">        <span class="keyword">self</span>.append_ret_inst();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">self</span>.leave_fn_state();</span><br><span class="line">        <span class="literal">Ok</span>(())</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">member_expr</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, expr: &amp;MemberExpr) -&gt; <span class="built_in">Result</span>&lt;(), CodegenError&gt; &#123;</span><br><span class="line">        <span class="keyword">let</span> fs = <span class="keyword">self</span>.fs_ref();</span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut</span> tmp_regs = <span class="built_in">vec!</span>[];</span><br><span class="line">        <span class="keyword">let</span> (res_reg, is_tmp) = fs.pop_res_reg();</span><br><span class="line">        <span class="keyword">if</span> is_tmp &#123;</span><br><span class="line">            tmp_regs.push(res_reg)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut</span> inst = Inst::new();</span><br><span class="line">        <span class="keyword">let</span> tr = fs.take_reg();</span><br><span class="line">        fs.push_res_reg(tr);</span><br><span class="line">        <span class="keyword">self</span>.expr(&amp;expr.object).ok();</span><br><span class="line">        tmp_regs.push(tr);</span><br><span class="line"></span><br><span class="line">        inst.set_op(OpCode::GETTABLE);</span><br><span class="line">        inst.set_a(res_reg);</span><br><span class="line">        inst.set_b(tr);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> expr.computed &#123;</span><br><span class="line">            <span class="keyword">let</span> tr = fs.take_reg();</span><br><span class="line">            fs.push_res_reg(tr);</span><br><span class="line">            <span class="keyword">self</span>.expr(&amp;expr.property).ok();</span><br><span class="line">            tmp_regs.push(tr);</span><br><span class="line">            inst.set_c(tr);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">let</span> n = expr.property.primary().id().name.as_str();</span><br><span class="line">            <span class="keyword">let</span> kst = Const::new_str(n);</span><br><span class="line">            fs.add_const(&amp;kst);</span><br><span class="line">            inst.set_c(kst_id_rk(fs.const2idx(&amp;kst)));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        fs.push_inst(inst);</span><br><span class="line">        fs.free_regs(&amp;tmp_regs);</span><br><span class="line">        <span class="literal">Ok</span>(())</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">new_expr</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, expr: &amp;NewExpr) -&gt; <span class="built_in">Result</span>&lt;(), CodegenError&gt; &#123;</span><br><span class="line">        <span class="keyword">let</span> fs = <span class="keyword">self</span>.fs_ref();</span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut</span> tmp_regs = <span class="built_in">vec!</span>[];</span><br><span class="line">        <span class="keyword">let</span> (res_reg, is_tmp) = fs.pop_res_reg();</span><br><span class="line">        <span class="keyword">if</span> is_tmp &#123;</span><br><span class="line">            tmp_regs.push(res_reg)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> a = fs.take_reg();</span><br><span class="line">        fs.push_res_reg(a);</span><br><span class="line">        <span class="keyword">self</span>.expr(&amp;expr.callee).ok();</span><br><span class="line">        tmp_regs.push(a);</span><br><span class="line"></span><br><span class="line">        expr.arguments.iter().for_each(|arg| &#123;</span><br><span class="line">            <span class="keyword">let</span> r = fs.take_reg();</span><br><span class="line">            fs.push_res_reg(r);</span><br><span class="line">            <span class="keyword">self</span>.expr(arg).ok();</span><br><span class="line">            tmp_regs.push(r);</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut</span> call = Inst::new();</span><br><span class="line">        call.set_op(OpCode::NEW);</span><br><span class="line">        call.set_a(a);</span><br><span class="line">        call.set_b((expr.arguments.len() + <span class="number">1</span>) <span class="keyword">as</span> <span class="built_in">u32</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> ret_num = <span class="keyword">if</span> is_tmp &#123; <span class="number">1</span> &#125; <span class="keyword">else</span> &#123; <span class="number">2</span> &#125;;</span><br><span class="line">        call.set_c(ret_num);</span><br><span class="line">        fs.push_inst(call);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> !is_tmp &amp;&amp; a != res_reg &#123;</span><br><span class="line">            <span class="keyword">let</span> <span class="keyword">mut</span> mov = Inst::new();</span><br><span class="line">            mov.set_op(OpCode::MOVE);</span><br><span class="line">            mov.set_a(res_reg);</span><br><span class="line">            mov.set_b(a);</span><br><span class="line">            fs.push_inst(mov);</span><br><span class="line">        &#125;</span><br><span class="line">        fs.free_regs(&amp;tmp_regs);</span><br><span class="line">        <span class="literal">Ok</span>(())</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">call_expr</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, expr: &amp;CallExpr) -&gt; <span class="built_in">Result</span>&lt;(), CodegenError&gt; &#123;</span><br><span class="line">        <span class="comment">// 与 Lua 不同，JS 不支持多个返回值，也没有 VARARG（直到 ES5，ES6 中的 RestParameter 等于 Lua 中的 VARARG）。然而，这并不意味着 ES5 中 CALL 中的 B 不能为 0</span></span><br><span class="line">        <span class="comment">// 使用这种能力来实现 Function.prototype.apply</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> fs = <span class="keyword">self</span>.fs_ref();</span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut</span> tmp_regs = <span class="built_in">vec!</span>[];</span><br><span class="line">        <span class="keyword">let</span> (res_reg, is_tmp) = fs.pop_res_reg();</span><br><span class="line">        <span class="keyword">if</span> is_tmp &#123;</span><br><span class="line">            tmp_regs.push(res_reg)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> a = fs.take_reg();</span><br><span class="line">        fs.push_res_reg(a);</span><br><span class="line">        <span class="keyword">self</span>.expr(&amp;expr.callee).ok();</span><br><span class="line">        tmp_regs.push(a);</span><br><span class="line"></span><br><span class="line">        expr.arguments.iter().for_each(|arg| &#123;</span><br><span class="line">            <span class="keyword">let</span> r = fs.take_reg();</span><br><span class="line">            fs.push_res_reg(r);</span><br><span class="line">            <span class="keyword">self</span>.expr(arg).ok();</span><br><span class="line">            tmp_regs.push(r);</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut</span> call = Inst::new();</span><br><span class="line">        call.set_op(OpCode::CALL);</span><br><span class="line">        call.set_a(a);</span><br><span class="line">        call.set_b((expr.arguments.len() + <span class="number">1</span>) <span class="keyword">as</span> <span class="built_in">u32</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> ret_num = <span class="keyword">if</span> is_tmp &#123; <span class="number">1</span> &#125; <span class="keyword">else</span> &#123; <span class="number">2</span> &#125;;</span><br><span class="line">        call.set_c(ret_num);</span><br><span class="line">        fs.push_inst(call);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> !is_tmp &amp;&amp; a != res_reg &#123;</span><br><span class="line">            <span class="keyword">let</span> <span class="keyword">mut</span> mov = Inst::new();</span><br><span class="line">            mov.set_op(OpCode::MOVE);</span><br><span class="line">            mov.set_a(res_reg);</span><br><span class="line">            mov.set_b(a);</span><br><span class="line">            fs.push_inst(mov);</span><br><span class="line">        &#125;</span><br><span class="line">        fs.free_regs(&amp;tmp_regs);</span><br><span class="line">        <span class="literal">Ok</span>(())</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 处理一元表达式</span></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">unary_expr</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, expr: &amp;UnaryExpr) -&gt; <span class="built_in">Result</span>&lt;(), CodegenError&gt; &#123;</span><br><span class="line">        <span class="keyword">let</span> fs = <span class="keyword">self</span>.fs_ref();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut</span> tmp_regs = <span class="built_in">vec!</span>[];</span><br><span class="line">        <span class="keyword">let</span> (res_reg, is_tmp) = fs.pop_res_reg();</span><br><span class="line">        <span class="keyword">if</span> is_tmp &#123;</span><br><span class="line">            tmp_regs.push(res_reg)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> sym = expr.op.symbol_data().kind;</span><br><span class="line">        <span class="keyword">match</span> sym &#123;</span><br><span class="line">            Symbol::Sub | Symbol::Not | Symbol::BitNot =&gt; &#123;</span><br><span class="line">                <span class="keyword">let</span> op = <span class="keyword">match</span> sym &#123;</span><br><span class="line">                    Symbol::Sub =&gt; OpCode::UNM,</span><br><span class="line">                    Symbol::Not =&gt; OpCode::NOT,</span><br><span class="line">                    Symbol::BitNot =&gt; OpCode::BITNOT,</span><br><span class="line">                    _ =&gt; <span class="built_in">panic!</span>(),</span><br><span class="line">                &#125;;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">let</span> <span class="keyword">mut</span> inst = Inst::new();</span><br><span class="line">                inst.set_op(op);</span><br><span class="line">                inst.set_a(res_reg);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">let</span> tr = fs.take_reg();</span><br><span class="line">                fs.push_res_reg(tr);</span><br><span class="line">                <span class="keyword">self</span>.expr(&amp;expr.argument).ok();</span><br><span class="line">                <span class="keyword">if</span> <span class="keyword">let</span> <span class="literal">Some</span>(r) = pop_last_loadk(fs) &#123;</span><br><span class="line">                    inst.set_b(r);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    inst.set_b(tr);</span><br><span class="line">                &#125;</span><br><span class="line">                fs.push_inst(inst);</span><br><span class="line">                fs.free_regs(&amp;tmp_regs);</span><br><span class="line">            &#125;</span><br><span class="line">            Symbol::Inc | Symbol::Dec =&gt; &#123;</span><br><span class="line">                <span class="keyword">let</span> op_tok = <span class="keyword">if</span> sym == Symbol::Inc &#123;</span><br><span class="line">                    Token::Symbol(SymbolData &#123;</span><br><span class="line">                        kind: Symbol::AssignAdd,</span><br><span class="line">                        loc: SourceLoc::new(),</span><br><span class="line">                    &#125;)</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    Token::Symbol(SymbolData &#123;</span><br><span class="line">                        kind: Symbol::AssignSub,</span><br><span class="line">                        loc: SourceLoc::new(),</span><br><span class="line">                    &#125;)</span><br><span class="line">                &#125;;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> !expr.prefix &#123;</span><br><span class="line">                    <span class="comment">// 如果 expr 是后缀，我们应该计算参数的值并将计算结果移至结果寄存器</span></span><br><span class="line">                    <span class="keyword">let</span> m_b = fs.take_reg();</span><br><span class="line">                    fs.push_res_reg(m_b);</span><br><span class="line">                    <span class="keyword">self</span>.expr(&amp;expr.argument).ok();</span><br><span class="line">                    tmp_regs.push(m_b);</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> !is_tmp &#123;</span><br><span class="line">                        <span class="keyword">let</span> <span class="keyword">mut</span> mov = Inst::new();</span><br><span class="line">                        mov.set_op(OpCode::MOVE);</span><br><span class="line">                        mov.set_a(res_reg);</span><br><span class="line">                        mov.set_b(m_b);</span><br><span class="line">                        fs.push_inst(mov);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">let</span> assign: Expr = AssignExpr &#123;</span><br><span class="line">                    loc: SourceLoc::new(),</span><br><span class="line">                    op: op_tok,</span><br><span class="line">                    left: expr.argument.clone(),</span><br><span class="line">                    right: PrimaryExpr::Literal(Literal::Numeric(NumericData::new(</span><br><span class="line">                        SourceLoc::new(),</span><br><span class="line">                        <span class="string">"1"</span>.to_owned(),</span><br><span class="line">                    )))</span><br><span class="line">                    .into(),</span><br><span class="line">                &#125;</span><br><span class="line">                .into();</span><br><span class="line"></span><br><span class="line">                <span class="comment">//  如果expr是前缀，我们应该将结果寄存器压入res_reg_stack，让匿名赋值将其结果放入其中</span></span><br><span class="line">                <span class="keyword">if</span> expr.prefix &#123;</span><br><span class="line">                    fs.push_res_reg(res_reg);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">self</span>.expr(&amp;assign).ok();</span><br><span class="line">                fs.free_regs(&amp;tmp_regs);</span><br><span class="line">            &#125;</span><br><span class="line">            _ =&gt; <span class="built_in">panic!</span>(),</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="literal">Ok</span>(())</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">binary_expr</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, expr: &amp;BinaryExpr) -&gt; <span class="built_in">Result</span>&lt;(), CodegenError&gt; &#123;</span><br><span class="line">        <span class="keyword">let</span> fs = <span class="keyword">self</span>.fs_ref();</span><br><span class="line">        <span class="keyword">let</span> op_s = expr.op.symbol_data().kind;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut</span> inst = Inst::new();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut</span> tmp_regs = <span class="built_in">vec!</span>[];</span><br><span class="line">        <span class="keyword">let</span> (res_reg, is_tmp) = fs.pop_res_reg();</span><br><span class="line">        <span class="keyword">if</span> is_tmp &#123;</span><br><span class="line">            tmp_regs.push(res_reg)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        inst.set_a(res_reg);</span><br><span class="line">        <span class="keyword">match</span> symbol_to_opcode(op_s) &#123;</span><br><span class="line">            <span class="literal">Some</span>(op) =&gt; inst.set_op(*op),</span><br><span class="line">            _ =&gt; <span class="built_in">unimplemented!</span>(),</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> r_lhs = fs.take_reg();</span><br><span class="line">        fs.push_res_reg(r_lhs);</span><br><span class="line">        <span class="keyword">self</span>.expr(&amp;expr.left).ok();</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">let</span> <span class="literal">Some</span>(rb) = pop_last_loadk(fs) &#123;</span><br><span class="line">            inst.set_b(rb);</span><br><span class="line">            fs.free_reg_to(r_lhs);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            inst.set_b(r_lhs);</span><br><span class="line">            tmp_regs.push(r_lhs);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> r_rhs = fs.take_reg();</span><br><span class="line">        fs.push_res_reg(r_rhs);</span><br><span class="line">        <span class="keyword">self</span>.expr(&amp;expr.right).ok();</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">let</span> <span class="literal">Some</span>(rc) = pop_last_loadk(fs) &#123;</span><br><span class="line">            inst.set_c(rc);</span><br><span class="line">            fs.free_reg_to(r_rhs);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            inst.set_c(r_rhs);</span><br><span class="line">            tmp_regs.push(r_rhs);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        fs.push_inst(inst);</span><br><span class="line">        fs.free_regs(&amp;tmp_regs);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">match</span> op_s &#123;</span><br><span class="line">            Symbol::LT</span><br><span class="line">            | Symbol::LE</span><br><span class="line">            | Symbol::<span class="built_in">Eq</span></span><br><span class="line">            | Symbol::EqStrict</span><br><span class="line">            | Symbol::GT</span><br><span class="line">            | Symbol::GE</span><br><span class="line">            | Symbol::NotEq</span><br><span class="line">            | Symbol::NotEqStrict =&gt; &#123;</span><br><span class="line">                <span class="keyword">match</span> op_s &#123;</span><br><span class="line">                    Symbol::LT | Symbol::LE | Symbol::<span class="built_in">Eq</span> | Symbol::EqStrict =&gt; &#123;</span><br><span class="line">                        fs.tpl.code.last_mut().unwrap().set_a(<span class="number">1</span>)</span><br><span class="line">                    &#125;</span><br><span class="line">                    _ =&gt; fs.tpl.code.last_mut().unwrap().set_a(<span class="number">0</span>),</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">let</span> <span class="keyword">mut</span> lb1 = Inst::new();</span><br><span class="line">                lb1.set_op(OpCode::LOADBOO);</span><br><span class="line">                lb1.set_a(res_reg);</span><br><span class="line">                lb1.set_b(<span class="number">1</span>);</span><br><span class="line">                lb1.set_c(<span class="number">1</span>);</span><br><span class="line">                fs.push_inst(lb1);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">let</span> <span class="keyword">mut</span> lb2 = Inst::new();</span><br><span class="line">                lb2.set_op(OpCode::LOADBOO);</span><br><span class="line">                lb2.set_a(res_reg);</span><br><span class="line">                lb2.set_b(<span class="number">0</span>);</span><br><span class="line">                fs.push_inst(lb2);</span><br><span class="line">            &#125;</span><br><span class="line">            Symbol::And | Symbol::Or =&gt; &#123;</span><br><span class="line">                <span class="keyword">let</span> test_set = fs.tpl.code.last_mut().unwrap();</span><br><span class="line">                <span class="keyword">let</span> lhs_reg = test_set.b();</span><br><span class="line">                <span class="keyword">let</span> rhs_reg = test_set.c();</span><br><span class="line">                test_set.set_c(<span class="keyword">if</span> op_s == Symbol::And &#123; <span class="number">1</span> &#125; <span class="keyword">else</span> &#123; <span class="number">0</span> &#125;);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">let</span> <span class="keyword">mut</span> jmp = Inst::new();</span><br><span class="line">                jmp.set_op(OpCode::JMP);</span><br><span class="line">                jmp.set_sbx(<span class="number">1</span>);</span><br><span class="line">                fs.push_inst(jmp);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">let</span> <span class="keyword">mut</span> mov = Inst::new();</span><br><span class="line">                mov.set_op(OpCode::MOVE);</span><br><span class="line">                mov.set_a(res_reg);</span><br><span class="line">                mov.set_b(rhs_reg);</span><br><span class="line">                fs.push_inst(mov);</span><br><span class="line">            &#125;</span><br><span class="line">            _ =&gt; (),</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="literal">Ok</span>(())</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">assign_expr</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, expr: &amp;AssignExpr) -&gt; <span class="built_in">Result</span>&lt;(), CodegenError&gt; &#123;</span><br><span class="line">        <span class="keyword">let</span> fs = <span class="keyword">self</span>.fs_ref();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut</span> tmp_regs = <span class="built_in">vec!</span>[];</span><br><span class="line">        <span class="keyword">let</span> (res_reg, is_res_tmp) = fs.pop_res_reg();</span><br><span class="line">        <span class="keyword">if</span> is_res_tmp &#123;</span><br><span class="line">            tmp_regs.push(res_reg)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut</span> rc = fs.take_reg();</span><br><span class="line">        fs.push_res_reg(rc);</span><br><span class="line">        <span class="keyword">self</span>.expr(&amp;expr.right).ok();</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">let</span> <span class="literal">Some</span>(r) = pop_last_loadk(fs) &#123;</span><br><span class="line">            fs.free_reg_to(rc);</span><br><span class="line">            rc = r;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            tmp_regs.push(rc);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut</span> inst = Inst::new();</span><br><span class="line">        <span class="keyword">match</span> &amp;expr.left &#123;</span><br><span class="line">            Expr::Primary(pri) =&gt; &#123;</span><br><span class="line">                <span class="keyword">if</span> !pri.is_id() &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">Err</span>(CodegenError::new(<span class="string">"lhs must be LVal"</span>));</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">let</span> id = pri.id().name.as_str();</span><br><span class="line">                <span class="keyword">if</span> fs.has_local(id) &#123;</span><br><span class="line">                    inst.set_op(OpCode::MOVE);</span><br><span class="line">                    inst.set_a(fs.local2reg(id));</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    inst = assign_upval(fs, <span class="number">0</span>, id);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            Expr::Member(m) =&gt; &#123;</span><br><span class="line">                inst.set_op(OpCode::SETTABLE);</span><br><span class="line">                <span class="keyword">let</span> tr = fs.take_reg();</span><br><span class="line">                fs.push_res_reg(tr);</span><br><span class="line">                <span class="keyword">self</span>.expr(&amp;m.object).ok();</span><br><span class="line">                inst.set_a(tr);</span><br><span class="line">                tmp_regs.push(tr);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> m.computed &#123;</span><br><span class="line">                    <span class="keyword">let</span> rb = fs.take_reg();</span><br><span class="line">                    fs.push_res_reg(rb);</span><br><span class="line">                    <span class="keyword">self</span>.expr(&amp;m.property).ok();</span><br><span class="line">                    tmp_regs.push(rb);</span><br><span class="line">                    inst.set_b(rb);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">let</span> n = m.property.primary().id().name.as_str();</span><br><span class="line">                    <span class="keyword">let</span> kst = Const::new_str(n);</span><br><span class="line">                    fs.add_const(&amp;kst);</span><br><span class="line">                    inst.set_b(kst_id_rk(fs.const2idx(&amp;kst)));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            _ =&gt; <span class="keyword">return</span> <span class="literal">Err</span>(CodegenError::new(<span class="string">"lhs must be LVal"</span>)),</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// is `operator=`</span></span><br><span class="line">        <span class="keyword">if</span> !expr.op.is_symbol_kind(Symbol::Assign) &#123;</span><br><span class="line">            <span class="keyword">let</span> rb = fs.take_reg();</span><br><span class="line">            fs.push_res_reg(rb);</span><br><span class="line">            <span class="keyword">self</span>.expr(&amp;expr.left).ok();</span><br><span class="line">            tmp_regs.push(rb);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">let</span> ra = fs.take_reg();</span><br><span class="line">            <span class="keyword">let</span> <span class="keyword">mut</span> binop = Inst::new();</span><br><span class="line">            binop.set_op(*symbol_to_opcode(expr.op.symbol_data().kind).unwrap());</span><br><span class="line">            binop.set_a(ra);</span><br><span class="line">            binop.set_b(rb);</span><br><span class="line">            binop.set_c(rc);</span><br><span class="line">            fs.push_inst(binop);</span><br><span class="line">            tmp_regs.push(ra);</span><br><span class="line">            rc = ra;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> op = OpCode::from_u32(inst.op());</span><br><span class="line">        <span class="keyword">match</span> op &#123;</span><br><span class="line">            OpCode::MOVE =&gt; inst.set_b(rc),</span><br><span class="line">            OpCode::SETUPVAL =&gt; inst.set_a(rc),</span><br><span class="line">            OpCode::SETTABLE | OpCode::SETTABUP =&gt; inst.set_c(rc),</span><br><span class="line">            _ =&gt; <span class="built_in">panic!</span>(),</span><br><span class="line">        &#125;</span><br><span class="line">        fs.push_inst(inst);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> !is_res_tmp &#123;</span><br><span class="line">            <span class="keyword">let</span> <span class="keyword">mut</span> mov = Inst::new();</span><br><span class="line">            mov.set_op(OpCode::MOVE);</span><br><span class="line">            mov.set_a(res_reg);</span><br><span class="line">            mov.set_b(rc);</span><br><span class="line">            fs.push_inst(mov);</span><br><span class="line">        &#125;</span><br><span class="line">        fs.free_regs(&amp;tmp_regs);</span><br><span class="line">        <span class="literal">Ok</span>(())</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">cond_expr</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, expr: &amp;CondExpr) -&gt; <span class="built_in">Result</span>&lt;(), CodegenError&gt; &#123;</span><br><span class="line">        <span class="keyword">let</span> fs = <span class="keyword">self</span>.fs_ref();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut</span> tmp_regs = <span class="built_in">vec!</span>[];</span><br><span class="line">        <span class="keyword">let</span> (res_reg, is_tmp) = fs.pop_res_reg();</span><br><span class="line">        <span class="keyword">if</span> is_tmp &#123;</span><br><span class="line">            tmp_regs.push(res_reg)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> tr = fs.take_reg();</span><br><span class="line">        fs.push_res_reg(tr);</span><br><span class="line">        <span class="keyword">self</span>.expr(&amp;expr.test).ok();</span><br><span class="line">        tmp_regs.push(tr);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut</span> test = Inst::new();</span><br><span class="line">        test.set_op(OpCode::TESTSET);</span><br><span class="line">        test.set_a(tr);</span><br><span class="line">        test.set_c(<span class="number">0</span>);</span><br><span class="line">        fs.push_inst(test);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> jmp1 = fs.push_jmp();</span><br><span class="line">        fs.push_res_reg(res_reg);</span><br><span class="line">        <span class="keyword">self</span>.expr(&amp;expr.cons).ok();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> jmp2 = fs.push_jmp();</span><br><span class="line">        fs.fin_jmp(jmp1);</span><br><span class="line"></span><br><span class="line">        fs.push_res_reg(res_reg);</span><br><span class="line">        <span class="keyword">self</span>.expr(&amp;expr.alt).ok();</span><br><span class="line">        fs.fin_jmp(jmp2);</span><br><span class="line"></span><br><span class="line">        fs.free_regs(&amp;tmp_regs);</span><br><span class="line">        <span class="literal">Ok</span>(())</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">seq_expr</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, expr: &amp;SeqExpr) -&gt; <span class="built_in">Result</span>&lt;(), CodegenError&gt; &#123;</span><br><span class="line">        <span class="keyword">let</span> fs = <span class="keyword">self</span>.fs_ref();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut</span> tmp_regs = <span class="built_in">vec!</span>[];</span><br><span class="line">        <span class="keyword">let</span> (res_reg, is_tmp) = fs.pop_res_reg();</span><br><span class="line">        <span class="keyword">if</span> is_tmp &#123;</span><br><span class="line">            tmp_regs.push(res_reg)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> len = expr.exprs.len();</span><br><span class="line">        expr.exprs.iter().enumerate().for_each(|(i, expr)| &#123;</span><br><span class="line">            <span class="keyword">if</span> i == len - <span class="number">1</span> &#123;</span><br><span class="line">                fs.push_res_reg(res_reg);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">let</span> tmp_reg = fs.take_reg();</span><br><span class="line">                fs.push_res_reg(tmp_reg);</span><br><span class="line">                tmp_regs.push(tmp_reg);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">self</span>.expr(expr).ok();</span><br><span class="line">        &#125;);</span><br><span class="line">        fs.free_regs(&amp;tmp_regs);</span><br><span class="line">        <span class="literal">Ok</span>(())</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">this_expr</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, expr: &amp;ThisExprData) -&gt; <span class="built_in">Result</span>&lt;(), CodegenError&gt; &#123;</span><br><span class="line">        <span class="keyword">let</span> fs = <span class="keyword">self</span>.fs_ref();</span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut</span> tmp_regs = <span class="built_in">vec!</span>[];</span><br><span class="line">        <span class="keyword">let</span> (res_reg, is_tmp) = fs.pop_res_reg();</span><br><span class="line">        <span class="keyword">if</span> is_tmp &#123;</span><br><span class="line">            tmp_regs.push(res_reg)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut</span> this = Inst::new();</span><br><span class="line">        this.set_op(OpCode::THIS);</span><br><span class="line">        this.set_a(res_reg);</span><br><span class="line">        fs.push_inst(this);</span><br><span class="line">        fs.free_regs(&amp;tmp_regs);</span><br><span class="line">        <span class="literal">Ok</span>(())</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">id_expr</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, expr: &amp;IdData) -&gt; <span class="built_in">Result</span>&lt;(), CodegenError&gt; &#123;</span><br><span class="line">        <span class="keyword">let</span> fs = <span class="keyword">self</span>.fs_ref();</span><br><span class="line">        <span class="keyword">let</span> n = expr.name.as_str();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut</span> tmp_regs = <span class="built_in">vec!</span>[];</span><br><span class="line">        <span class="keyword">let</span> (res_reg, is_tmp) = fs.pop_res_reg();</span><br><span class="line">        <span class="keyword">if</span> is_tmp &#123;</span><br><span class="line">            tmp_regs.push(res_reg)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> fs.has_local(n) &#123;</span><br><span class="line">            <span class="keyword">let</span> <span class="keyword">mut</span> inst = Inst::new();</span><br><span class="line">            inst.set_op(OpCode::MOVE);</span><br><span class="line">            inst.set_a(res_reg);</span><br><span class="line">            inst.set_b(fs.local2reg(n));</span><br><span class="line">            fs.push_inst(inst);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">let</span> has_def = fs.add_upval(n);</span><br><span class="line">            <span class="keyword">if</span> has_def &#123;</span><br><span class="line">                <span class="keyword">let</span> <span class="keyword">mut</span> inst = Inst::new();</span><br><span class="line">                inst.set_op(OpCode::GETUPVAL);</span><br><span class="line">                inst.set_a(res_reg);</span><br><span class="line">                inst.set_b(fs.get_upval_idx(n) <span class="keyword">as</span> <span class="built_in">u32</span>);</span><br><span class="line">                fs.push_inst(inst);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">let</span> kst = Const::<span class="built_in">String</span>(n.to_string());</span><br><span class="line">                fs.add_const(&amp;kst);</span><br><span class="line">                <span class="keyword">let</span> <span class="keyword">mut</span> inst = Inst::new();</span><br><span class="line">                inst.set_op(OpCode::GETTABUP);</span><br><span class="line">                inst.set_a(res_reg);</span><br><span class="line">                inst.set_b(fs.get_upval(ENV_NAME).unwrap().idx);</span><br><span class="line">                inst.set_c(kst_id_rk(fs.const2idx(&amp;kst)));</span><br><span class="line">                fs.push_inst(inst);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        fs.free_regs(&amp;tmp_regs);</span><br><span class="line">        <span class="literal">Ok</span>(())</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">array_literal</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, expr: &amp;ArrayData) -&gt; <span class="built_in">Result</span>&lt;(), CodegenError&gt; &#123;</span><br><span class="line">        <span class="keyword">let</span> fs = <span class="keyword">self</span>.fs_ref();</span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut</span> inst = Inst::new();</span><br><span class="line">        inst.set_op(OpCode::NEWARRAY);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut</span> tmp_regs = <span class="built_in">vec!</span>[];</span><br><span class="line">        <span class="keyword">let</span> (res_reg, is_tmp) = fs.pop_res_reg();</span><br><span class="line">        <span class="keyword">if</span> is_tmp &#123;</span><br><span class="line">            tmp_regs.push(res_reg)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        inst.set_a(res_reg);</span><br><span class="line">        fs.push_inst(inst);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> expr.value.len() &gt; <span class="number">0</span> &#123;</span><br><span class="line">            <span class="keyword">let</span> <span class="keyword">mut</span> i = <span class="number">0</span>;</span><br><span class="line">            expr.value.iter().for_each(|expr| &#123;</span><br><span class="line">                <span class="keyword">let</span> r = fs.take_reg();</span><br><span class="line">                tmp_regs.push(r);</span><br><span class="line">                fs.push_res_reg(r);</span><br><span class="line">                <span class="keyword">self</span>.expr(expr).ok();</span><br><span class="line">                i += <span class="number">1</span>;</span><br><span class="line">            &#125;);</span><br><span class="line">            <span class="keyword">let</span> <span class="keyword">mut</span> inst = Inst::new();</span><br><span class="line">            inst.set_op(OpCode::INITARRAY);</span><br><span class="line">            inst.set_a(res_reg);</span><br><span class="line">            inst.set_b(i);</span><br><span class="line">            fs.push_inst(inst);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        fs.free_regs(&amp;tmp_regs);</span><br><span class="line">        <span class="literal">Ok</span>(())</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">object_literal</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, expr: &amp;ObjectData) -&gt; <span class="built_in">Result</span>&lt;(), CodegenError&gt; &#123;</span><br><span class="line">        <span class="keyword">let</span> fs = <span class="keyword">self</span>.fs_ref();</span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut</span> inst = Inst::new();</span><br><span class="line">        inst.set_op(OpCode::NEWTABLE);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut</span> tmp_regs = <span class="built_in">vec!</span>[];</span><br><span class="line">        <span class="keyword">let</span> (res_reg, is_tmp) = fs.pop_res_reg();</span><br><span class="line">        <span class="keyword">if</span> is_tmp &#123;</span><br><span class="line">            tmp_regs.push(res_reg)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        inst.set_a(res_reg);</span><br><span class="line">        fs.push_inst(inst);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> expr.properties.len() &gt; <span class="number">0</span> &#123;</span><br><span class="line">            expr.properties.iter().for_each(|prop| &#123;</span><br><span class="line">                <span class="keyword">let</span> kst = <span class="keyword">if</span> prop.key.primary().is_id() &#123;</span><br><span class="line">                    Const::<span class="built_in">String</span>(prop.key.primary().id().name.clone())</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    Const::<span class="built_in">String</span>(prop.key.primary().literal().<span class="built_in">str</span>().value.clone())</span><br><span class="line">                &#125;;</span><br><span class="line">                fs.add_const(&amp;kst);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">let</span> <span class="keyword">mut</span> inst = Inst::new();</span><br><span class="line">                inst.set_op(OpCode::SETTABLE);</span><br><span class="line">                inst.set_a(res_reg);</span><br><span class="line">                inst.set_b(kst_id_rk(fs.const2idx(&amp;kst)));</span><br><span class="line"></span><br><span class="line">                <span class="keyword">let</span> r = fs.take_reg();</span><br><span class="line">                tmp_regs.push(r);</span><br><span class="line">                fs.push_res_reg(r);</span><br><span class="line">                inst.set_c(r);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">self</span>.expr(&amp;prop.value).ok();</span><br><span class="line">                fs.push_inst(inst);</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        fs.free_regs(&amp;tmp_regs);</span><br><span class="line">        <span class="literal">Ok</span>(())</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">paren_expr</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, expr: &amp;ParenData) -&gt; <span class="built_in">Result</span>&lt;(), CodegenError&gt; &#123;</span><br><span class="line">        <span class="keyword">self</span>.expr(&amp;expr.value).ok();</span><br><span class="line">        <span class="literal">Ok</span>(())</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">fn_expr</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, expr: &amp;FnDec) -&gt; <span class="built_in">Result</span>&lt;(), CodegenError&gt; &#123;</span><br><span class="line">        <span class="keyword">let</span> pfs = <span class="keyword">self</span>.fs_ref();</span><br><span class="line">        <span class="keyword">let</span> (res_reg, is_tmp) = pfs.pop_res_reg();</span><br><span class="line">        <span class="built_in">assert!</span>(!is_tmp);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">self</span>.enter_fn_state();</span><br><span class="line">        <span class="keyword">let</span> cfs = <span class="keyword">self</span>.fs_ref();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut</span> inst = Inst::new();</span><br><span class="line">        inst.set_op(OpCode::CLOSURE);</span><br><span class="line">        inst.set_a(res_reg);</span><br><span class="line">        inst.set_bx(cfs.idx_in_parent);</span><br><span class="line">        pfs.push_inst(inst);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">self</span>.declare_bindings();</span><br><span class="line">        <span class="keyword">self</span>.stmt(&amp;expr.body).ok();</span><br><span class="line">        <span class="keyword">self</span>.append_ret_inst();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">self</span>.leave_fn_state();</span><br><span class="line">        <span class="literal">Ok</span>(())</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">regexp_expr</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, expr: &amp;RegExpData) -&gt; <span class="built_in">Result</span>&lt;(), CodegenError&gt; &#123;</span><br><span class="line">        <span class="built_in">unimplemented!</span>()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">null_expr</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, expr: &amp;NullData) -&gt; <span class="built_in">Result</span>&lt;(), CodegenError&gt; &#123;</span><br><span class="line">        <span class="keyword">let</span> fs = <span class="keyword">self</span>.fs_ref();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut</span> tmp_regs = <span class="built_in">vec!</span>[];</span><br><span class="line">        <span class="keyword">let</span> (res_reg, is_tmp) = fs.pop_res_reg();</span><br><span class="line">        <span class="keyword">if</span> is_tmp &#123;</span><br><span class="line">            tmp_regs.push(res_reg)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut</span> inst = Inst::new();</span><br><span class="line">        inst.set_op(OpCode::LOADNUL);</span><br><span class="line">        inst.set_a(res_reg);</span><br><span class="line">        fs.push_inst(inst);</span><br><span class="line">        fs.free_regs(&amp;tmp_regs);</span><br><span class="line">        <span class="literal">Ok</span>(())</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">undef_expr</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, expr: &amp;UndefData) -&gt; <span class="built_in">Result</span>&lt;(), CodegenError&gt; &#123;</span><br><span class="line">        <span class="keyword">let</span> fs = <span class="keyword">self</span>.fs_ref();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut</span> tmp_regs = <span class="built_in">vec!</span>[];</span><br><span class="line">        <span class="keyword">let</span> (res_reg, is_tmp) = fs.pop_res_reg();</span><br><span class="line">        <span class="keyword">if</span> is_tmp &#123;</span><br><span class="line">            tmp_regs.push(res_reg)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut</span> inst = Inst::new();</span><br><span class="line">        inst.set_op(OpCode::LOADUNDEF);</span><br><span class="line">        inst.set_a(res_reg);</span><br><span class="line">        fs.push_inst(inst);</span><br><span class="line">        fs.free_regs(&amp;tmp_regs);</span><br><span class="line">        <span class="literal">Ok</span>(())</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">str_expr</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, expr: &amp;StringData) -&gt; <span class="built_in">Result</span>&lt;(), CodegenError&gt; &#123;</span><br><span class="line">        <span class="keyword">let</span> fs = <span class="keyword">self</span>.fs_ref();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut</span> tmp_regs = <span class="built_in">vec!</span>[];</span><br><span class="line">        <span class="keyword">let</span> (res_reg, is_tmp) = fs.pop_res_reg();</span><br><span class="line">        <span class="keyword">if</span> is_tmp &#123;</span><br><span class="line">            tmp_regs.push(res_reg)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> kst = Const::<span class="built_in">String</span>(expr.value.clone());</span><br><span class="line">        fs.add_const(&amp;kst);</span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut</span> inst = Inst::new();</span><br><span class="line">        inst.set_op(OpCode::LOADK);</span><br><span class="line">        inst.set_a(res_reg);</span><br><span class="line">        inst.set_bx(kst_id_rk(fs.const2idx(&amp;kst)));</span><br><span class="line">        fs.push_inst(inst);</span><br><span class="line">        fs.free_regs(&amp;tmp_regs);</span><br><span class="line">        <span class="literal">Ok</span>(())</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">bool_expr</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, expr: &amp;BoolData) -&gt; <span class="built_in">Result</span>&lt;(), CodegenError&gt; &#123;</span><br><span class="line">        <span class="keyword">let</span> fs = <span class="keyword">self</span>.fs_ref();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut</span> tmp_regs = <span class="built_in">vec!</span>[];</span><br><span class="line">        <span class="keyword">let</span> (res_reg, is_tmp) = fs.pop_res_reg();</span><br><span class="line">        <span class="keyword">if</span> is_tmp &#123;</span><br><span class="line">            tmp_regs.push(res_reg)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut</span> inst = Inst::new();</span><br><span class="line">        inst.set_op(OpCode::LOADBOO);</span><br><span class="line">        inst.set_a(res_reg);</span><br><span class="line">        inst.set_b(<span class="keyword">if</span> expr.value &#123; <span class="number">1</span> &#125; <span class="keyword">else</span> &#123; <span class="number">0</span> &#125;);</span><br><span class="line">        fs.push_inst(inst);</span><br><span class="line">        fs.free_regs(&amp;tmp_regs);</span><br><span class="line">        <span class="literal">Ok</span>(())</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">num_expr</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, expr: &amp;NumericData) -&gt; <span class="built_in">Result</span>&lt;(), CodegenError&gt; &#123;</span><br><span class="line">        <span class="keyword">let</span> fs = <span class="keyword">self</span>.fs_ref();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut</span> tmp_regs = <span class="built_in">vec!</span>[];</span><br><span class="line">        <span class="keyword">let</span> (res_reg, is_tmp) = fs.pop_res_reg();</span><br><span class="line">        <span class="keyword">if</span> is_tmp &#123;</span><br><span class="line">            tmp_regs.push(res_reg)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> kst = Const::Number(expr.value.parse().ok().unwrap());</span><br><span class="line">        fs.add_const(&amp;kst);</span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut</span> inst = Inst::new();</span><br><span class="line">        inst.set_op(OpCode::LOADK);</span><br><span class="line">        inst.set_a(res_reg);</span><br><span class="line">        inst.set_bx(kst_id_rk(fs.const2idx(&amp;kst)));</span><br><span class="line">        fs.push_inst(inst);</span><br><span class="line">        fs.free_regs(&amp;tmp_regs);</span><br><span class="line">        <span class="literal">Ok</span>(())</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">mut</span> SYMBOL_OPCODE_MAP: <span class="built_in">Option</span>&lt;HashMap&lt;Symbol, OpCode&gt;&gt; = <span class="literal">None</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">symbol_to_opcode</span></span>(s: Symbol) -&gt; <span class="built_in">Option</span>&lt;&amp;<span class="symbol">'static</span> OpCode&gt; &#123;</span><br><span class="line">    <span class="keyword">unsafe</span> &#123; SYMBOL_OPCODE_MAP.as_ref().unwrap().get(&amp;s) &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">init_symbol_opcode_map</span></span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut</span> map = HashMap::new();</span><br><span class="line">    map.insert(Symbol::Add, OpCode::ADD);</span><br><span class="line">    map.insert(Symbol::Sub, OpCode::SUB);</span><br><span class="line">    map.insert(Symbol::Mul, OpCode::MUL);</span><br><span class="line">    map.insert(Symbol::Mod, OpCode::MOD);</span><br><span class="line">    map.insert(Symbol::Div, OpCode::DIV);</span><br><span class="line">    map.insert(Symbol::LT, OpCode::LT);</span><br><span class="line">    map.insert(Symbol::GT, OpCode::LE);</span><br><span class="line">    map.insert(Symbol::LE, OpCode::LE);</span><br><span class="line">    map.insert(Symbol::GE, OpCode::LT);</span><br><span class="line">    map.insert(Symbol::<span class="built_in">Eq</span>, OpCode::EQ);</span><br><span class="line">    map.insert(Symbol::NotEq, OpCode::EQ);</span><br><span class="line">    map.insert(Symbol::EqStrict, OpCode::EQS);</span><br><span class="line">    map.insert(Symbol::NotEqStrict, OpCode::EQS);</span><br><span class="line">    map.insert(Symbol::BitAnd, OpCode::BITAND);</span><br><span class="line">    map.insert(Symbol::BitOr, OpCode::BITOR);</span><br><span class="line">    map.insert(Symbol::BitNot, OpCode::BITNOT);</span><br><span class="line">    map.insert(Symbol::SHL, OpCode::SHL);</span><br><span class="line">    map.insert(Symbol::SAR, OpCode::SAR);</span><br><span class="line">    map.insert(Symbol::SHR, OpCode::SHR);</span><br><span class="line">    map.insert(Symbol::And, OpCode::TESTSET);</span><br><span class="line">    map.insert(Symbol::Or, OpCode::TESTSET);</span><br><span class="line">    map.insert(Symbol::AssignAdd, OpCode::ADD);</span><br><span class="line">    map.insert(Symbol::AssignSub, OpCode::SUB);</span><br><span class="line">    map.insert(Symbol::AssignMul, OpCode::MUL);</span><br><span class="line">    map.insert(Symbol::AssignDiv, OpCode::DIV);</span><br><span class="line">    map.insert(Symbol::AssignMod, OpCode::MOD);</span><br><span class="line">    map.insert(Symbol::AssignSHL, OpCode::SHL);</span><br><span class="line">    map.insert(Symbol::AssignSAR, OpCode::SAR);</span><br><span class="line">    map.insert(Symbol::AssignSHR, OpCode::SHR);</span><br><span class="line">    map.insert(Symbol::AssignBitAnd, OpCode::BITAND);</span><br><span class="line">    map.insert(Symbol::AssignBitOr, OpCode::BITOR);</span><br><span class="line">    map.insert(Symbol::AssignBitXor, OpCode::BITXOR);</span><br><span class="line">    <span class="keyword">unsafe</span> &#123;</span><br><span class="line">        SYMBOL_OPCODE_MAP = <span class="literal">Some</span>(map);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">mut</span> IS_MOD_INITIALIZED: <span class="built_in">bool</span> = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> INIT_CODEGEN_DATA_ONCE: Once = Once::new();</span><br><span class="line"><span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">init_codegen_data</span></span>() &#123;</span><br><span class="line">    INIT_CODEGEN_DATA_ONCE.call_once(|| &#123;</span><br><span class="line">        init_token_data();</span><br><span class="line">        init_opcode_data();</span><br><span class="line">        init_symbol_opcode_map();</span><br><span class="line">        <span class="keyword">unsafe</span> &#123;</span><br><span class="line">            IS_MOD_INITIALIZED = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其中这里的操作符（+ - * / ..），我们这里使用了爬山算法，即，如果这个操作符的权重小于前一个，则将之前的先进行计算。</p>
<h1 id="vm"><a href="#vm" class="headerlink" title="vm"></a>vm</h1><h2 id="gc"><a href="#gc" class="headerlink" title="gc"></a>gc</h2><p>gc 在 js 引擎中是必不可少的，我们的实现是将每一个 js 的量都是包装成一个 GcObj，他将会记录引用计数，然后在 gc 执行时判断是否需要手动执行析构函数。</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">type</span> <span class="title">GcObjPtr</span></span> = *<span class="keyword">mut</span> GcObj;</span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">type</span> <span class="title">JsObj</span></span> = GcObj;</span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">type</span> <span class="title">JsObjPtr</span></span> = GcObjPtr;</span><br><span class="line"></span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">type</span> <span class="title">JsStrPtr</span></span> = *<span class="keyword">mut</span> JsString;</span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">type</span> <span class="title">JsNumPtr</span></span> = *<span class="keyword">mut</span> JsNumber;</span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">type</span> <span class="title">JsBoolPtr</span></span> = *<span class="keyword">mut</span> JsBoolean;</span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">type</span> <span class="title">JsArrPtr</span></span> = *<span class="keyword">mut</span> JsArray;</span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">type</span> <span class="title">JsDictPtr</span></span> = *<span class="keyword">mut</span> JsDict;</span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">type</span> <span class="title">JsFunPtr</span></span> = *<span class="keyword">mut</span> JsFunction;</span><br><span class="line"></span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">type</span> <span class="title">UpValPtr</span></span> = *<span class="keyword">mut</span> UpVal;</span><br><span class="line"></span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">type</span> <span class="title">GcPtr</span></span> = *<span class="keyword">mut</span> Gc;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[inline(always)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">as_obj_ptr</span></span>&lt;T&gt;(ptr: *<span class="keyword">mut</span> T) -&gt; JsObjPtr &#123;</span><br><span class="line">    ptr <span class="keyword">as</span> JsObjPtr</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[inline(always)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">as_obj</span></span>&lt;T&gt;(ptr: *<span class="keyword">mut</span> T) -&gt; &amp;<span class="symbol">'static</span> <span class="keyword">mut</span> GcObj &#123;</span><br><span class="line">    <span class="keyword">unsafe</span> &#123; &amp;<span class="keyword">mut</span> (*(ptr <span class="keyword">as</span> GcObjPtr)) &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[inline(always)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">as_str</span></span>&lt;T&gt;(ptr: *<span class="keyword">mut</span> T) -&gt; &amp;<span class="symbol">'static</span> <span class="keyword">mut</span> JsString &#123;</span><br><span class="line">    <span class="keyword">unsafe</span> &#123; &amp;<span class="keyword">mut</span> (*(ptr <span class="keyword">as</span> JsStrPtr)) &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[inline(always)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">as_num</span></span>&lt;T&gt;(ptr: *<span class="keyword">mut</span> T) -&gt; &amp;<span class="symbol">'static</span> <span class="keyword">mut</span> JsNumber &#123;</span><br><span class="line">    <span class="keyword">unsafe</span> &#123; &amp;<span class="keyword">mut</span> (*(ptr <span class="keyword">as</span> JsNumPtr)) &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[inline(always)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">as_bool</span></span>&lt;T&gt;(ptr: *<span class="keyword">mut</span> T) -&gt; &amp;<span class="symbol">'static</span> <span class="keyword">mut</span> JsBoolean &#123;</span><br><span class="line">    <span class="keyword">unsafe</span> &#123; &amp;<span class="keyword">mut</span> (*(ptr <span class="keyword">as</span> JsBoolPtr)) &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[inline(always)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">as_arr</span></span>&lt;T&gt;(ptr: *<span class="keyword">mut</span> T) -&gt; &amp;<span class="symbol">'static</span> <span class="keyword">mut</span> JsArray &#123;</span><br><span class="line">    <span class="keyword">unsafe</span> &#123; &amp;<span class="keyword">mut</span> (*(ptr <span class="keyword">as</span> JsArrPtr)) &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[inline(always)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">as_dict</span></span>&lt;T&gt;(ptr: *<span class="keyword">mut</span> T) -&gt; &amp;<span class="symbol">'static</span> <span class="keyword">mut</span> JsDict &#123;</span><br><span class="line">    <span class="keyword">unsafe</span> &#123; &amp;<span class="keyword">mut</span> (*(ptr <span class="keyword">as</span> JsDictPtr)) &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[inline(always)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">as_fun</span></span>&lt;T&gt;(ptr: *<span class="keyword">mut</span> T) -&gt; &amp;<span class="symbol">'static</span> <span class="keyword">mut</span> JsFunction &#123;</span><br><span class="line">    <span class="keyword">unsafe</span> &#123; &amp;<span class="keyword">mut</span> (*(ptr <span class="keyword">as</span> JsFunPtr)) &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[inline(always)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">as_uv</span></span>&lt;T&gt;(ptr: *<span class="keyword">mut</span> T) -&gt; &amp;<span class="symbol">'static</span> <span class="keyword">mut</span> UpVal &#123;</span><br><span class="line">    <span class="keyword">unsafe</span> &#123; &amp;<span class="keyword">mut</span> (*(ptr <span class="keyword">as</span> UpValPtr)) &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[inline(always)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">as_gc</span></span>&lt;T&gt;(ptr: *<span class="keyword">mut</span> T) -&gt; &amp;<span class="symbol">'static</span> <span class="keyword">mut</span> Gc &#123;</span><br><span class="line">    <span class="keyword">unsafe</span> &#123; &amp;<span class="keyword">mut</span> (*(ptr <span class="keyword">as</span> GcPtr)) &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[repr(C)]</span></span><br><span class="line"><span class="meta">#[derive(Debug, Eq, PartialEq, Copy, Clone)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">enum</span> <span class="title">GcObjKind</span></span> &#123;</span><br><span class="line">    <span class="built_in">String</span>,</span><br><span class="line">    Number,</span><br><span class="line"></span><br><span class="line">    Array,</span><br><span class="line">    Dict,</span><br><span class="line">    Function,</span><br><span class="line"></span><br><span class="line">    UpVal,</span><br><span class="line"></span><br><span class="line">    Boolean,</span><br><span class="line">    Null,</span><br><span class="line">    Undef,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">type</span> <span class="title">Deinit</span></span> = <span class="function"><span class="keyword">fn</span></span>(ptr: JsObjPtr);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">default_deinit</span></span>(ptr: JsObjPtr) &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[repr(C)]</span></span><br><span class="line"><span class="meta">#[derive(Debug, Clone)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">struct</span> <span class="title">GcObj</span></span> &#123;</span><br><span class="line">    <span class="comment">// 引用计数</span></span><br><span class="line">    ref_cnt: <span class="built_in">usize</span>,</span><br><span class="line">    <span class="keyword">pub</span> kind: GcObjKind,</span><br><span class="line">    gc: GcPtr,</span><br><span class="line">    <span class="comment">// 手动析构函数</span></span><br><span class="line">    deinit: Deinit,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> GcObj &#123;</span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">inc</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) &#123;</span><br><span class="line">        <span class="keyword">self</span>.ref_cnt += <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">dec</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) &#123;</span><br><span class="line">        as_gc(<span class="keyword">self</span>.gc).dec(<span class="keyword">self</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">gc</span></span>(&amp;<span class="keyword">self</span>) -&gt; GcPtr &#123;</span><br><span class="line">        <span class="keyword">self</span>.gc</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[repr(C)]</span></span><br><span class="line"><span class="meta">#[derive(Debug, Clone)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">struct</span> <span class="title">JsString</span></span> &#123;</span><br><span class="line">    base: GcObj,</span><br><span class="line">    <span class="keyword">pub</span> d: <span class="built_in">String</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">js_str_deinit</span></span>(ptr: JsObjPtr) &#123;</span><br><span class="line">    <span class="keyword">let</span> r = as_str(ptr);</span><br><span class="line">    <span class="keyword">let</span> s = mem::size_of_val(r);</span><br><span class="line">    <span class="keyword">unsafe</span> &#123;</span><br><span class="line">        drop_in_place(r);</span><br><span class="line">    &#125;</span><br><span class="line">    as_gc(r.base.gc).heap_size -= s;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> JsString &#123;</span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">new</span></span>(gc: &amp;<span class="keyword">mut</span> Gc, is_root: <span class="built_in">bool</span>) -&gt; JsStrPtr &#123;</span><br><span class="line">        <span class="keyword">let</span> ptr = <span class="built_in">Box</span>::into_raw(<span class="built_in">Box</span>::new(JsString &#123;</span><br><span class="line">            base: GcObj &#123;</span><br><span class="line">                ref_cnt: <span class="number">1</span>,</span><br><span class="line">                kind: GcObjKind::<span class="built_in">String</span>,</span><br><span class="line">                gc,</span><br><span class="line">                deinit: js_str_deinit,</span><br><span class="line">            &#125;,</span><br><span class="line">            d: <span class="string">""</span>.to_owned(),</span><br><span class="line">        &#125;));</span><br><span class="line">        gc.register(as_obj_ptr(ptr), is_root);</span><br><span class="line">        ptr</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[repr(C)]</span></span><br><span class="line"><span class="meta">#[derive(Debug, Clone)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">struct</span> <span class="title">JsNumber</span></span> &#123;</span><br><span class="line">    base: GcObj,</span><br><span class="line">    <span class="keyword">pub</span> d: <span class="built_in">f64</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">js_num_deinit</span></span>(ptr: JsObjPtr) &#123;</span><br><span class="line">    <span class="keyword">let</span> r = as_num(ptr);</span><br><span class="line">    <span class="keyword">let</span> s = mem::size_of_val(r);</span><br><span class="line">    <span class="keyword">unsafe</span> &#123;</span><br><span class="line">        drop_in_place(r);</span><br><span class="line">    &#125;</span><br><span class="line">    as_gc(r.base.gc).heap_size -= s;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> JsNumber &#123;</span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">new</span></span>(gc: &amp;<span class="keyword">mut</span> Gc, is_root: <span class="built_in">bool</span>) -&gt; JsNumPtr &#123;</span><br><span class="line">        <span class="keyword">let</span> ptr = <span class="built_in">Box</span>::into_raw(<span class="built_in">Box</span>::new(JsNumber &#123;</span><br><span class="line">            base: GcObj &#123;</span><br><span class="line">                ref_cnt: <span class="number">1</span>,</span><br><span class="line">                kind: GcObjKind::Number,</span><br><span class="line">                deinit: js_num_deinit,</span><br><span class="line">                gc,</span><br><span class="line">            &#125;,</span><br><span class="line">            d: <span class="number">0.0</span>,</span><br><span class="line">        &#125;));</span><br><span class="line">        gc.register(as_obj_ptr(ptr), is_root);</span><br><span class="line">        ptr</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[repr(C)]</span></span><br><span class="line"><span class="meta">#[derive(Debug, Clone)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">struct</span> <span class="title">JsBoolean</span></span> &#123;</span><br><span class="line">    base: GcObj,</span><br><span class="line">    <span class="keyword">pub</span> d: <span class="built_in">bool</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[repr(C)]</span></span><br><span class="line"><span class="meta">#[derive(Debug, Clone)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">struct</span> <span class="title">JsArray</span></span> &#123;</span><br><span class="line">    base: GcObj,</span><br><span class="line">    d: <span class="built_in">Vec</span>&lt;JsObjPtr&gt;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">js_arr_deinit</span></span>(ptr: JsObjPtr) &#123;</span><br><span class="line">    <span class="keyword">let</span> r = as_arr(ptr);</span><br><span class="line">    <span class="keyword">let</span> s = mem::size_of_val(r);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> gc = as_gc(r.base.gc);</span><br><span class="line">    <span class="keyword">for</span> pp <span class="keyword">in</span> &amp;r.d &#123;</span><br><span class="line">        gc.dec(*pp);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">unsafe</span> &#123;</span><br><span class="line">        drop_in_place(r);</span><br><span class="line">    &#125;</span><br><span class="line">    gc.heap_size -= s;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> JsArray &#123;</span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">new</span></span>(gc: &amp;<span class="keyword">mut</span> Gc, is_root: <span class="built_in">bool</span>) -&gt; JsArrPtr &#123;</span><br><span class="line">        <span class="keyword">let</span> ptr = <span class="built_in">Box</span>::into_raw(<span class="built_in">Box</span>::new(JsArray &#123;</span><br><span class="line">            base: GcObj &#123;</span><br><span class="line">                ref_cnt: <span class="number">1</span>,</span><br><span class="line">                kind: GcObjKind::Array,</span><br><span class="line">                deinit: js_arr_deinit,</span><br><span class="line">                gc,</span><br><span class="line">            &#125;,</span><br><span class="line">            d: <span class="built_in">vec!</span>[],</span><br><span class="line">        &#125;));</span><br><span class="line">        gc.register(as_obj_ptr(ptr), is_root);</span><br><span class="line">        ptr</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[repr(C)]</span></span><br><span class="line"><span class="meta">#[derive(Debug, Clone)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">struct</span> <span class="title">JsDict</span></span> &#123;</span><br><span class="line">    base: GcObj,</span><br><span class="line">    <span class="keyword">pub</span> d: HashMap&lt;<span class="built_in">String</span>, JsObjPtr&gt;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">js_dict_deinit</span></span>(ptr: JsObjPtr) &#123;</span><br><span class="line">    <span class="keyword">let</span> r = as_dict(ptr);</span><br><span class="line">    <span class="keyword">let</span> s = mem::size_of_val(r);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> gc = as_gc(r.base.gc);</span><br><span class="line">    <span class="keyword">for</span> (_, pp) <span class="keyword">in</span> &amp;r.d &#123;</span><br><span class="line">        gc.dec(*pp);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">unsafe</span> &#123;</span><br><span class="line">        drop_in_place(r);</span><br><span class="line">    &#125;</span><br><span class="line">    gc.heap_size -= s;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> JsDict &#123;</span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">new</span></span>(gc: &amp;<span class="keyword">mut</span> Gc, is_root: <span class="built_in">bool</span>) -&gt; JsDictPtr &#123;</span><br><span class="line">        <span class="keyword">let</span> ptr = <span class="built_in">Box</span>::into_raw(<span class="built_in">Box</span>::new(JsDict &#123;</span><br><span class="line">            base: GcObj &#123;</span><br><span class="line">                ref_cnt: <span class="number">1</span>,</span><br><span class="line">                kind: GcObjKind::Dict,</span><br><span class="line">                deinit: js_dict_deinit,</span><br><span class="line">                gc,</span><br><span class="line">            &#125;,</span><br><span class="line">            d: HashMap::new(),</span><br><span class="line">        &#125;));</span><br><span class="line">        gc.register(as_obj_ptr(ptr), is_root);</span><br><span class="line">        ptr</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">insert</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, k: &amp;<span class="built_in">str</span>, v: JsObjPtr) &#123;</span><br><span class="line">        <span class="keyword">self</span>.d.insert(k.to_owned(), v);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[repr(C)]</span></span><br><span class="line"><span class="meta">#[derive(Debug, Clone)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">struct</span> <span class="title">UpVal</span></span> &#123;</span><br><span class="line">    base: GcObj,</span><br><span class="line">    <span class="keyword">pub</span> v: JsObjPtr,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">upval_deinit</span></span>(ptr: JsObjPtr) &#123;</span><br><span class="line">    <span class="keyword">let</span> r = as_uv(ptr);</span><br><span class="line">    <span class="keyword">let</span> s = mem::size_of_val(r);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> gc = as_gc(r.base.gc);</span><br><span class="line">    gc.dec(r.v);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">unsafe</span> &#123;</span><br><span class="line">        drop_in_place(r);</span><br><span class="line">    &#125;</span><br><span class="line">    gc.heap_size -= s;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> UpVal &#123;</span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">new</span></span>(gc: &amp;<span class="keyword">mut</span> Gc, v: JsObjPtr, is_root: <span class="built_in">bool</span>) -&gt; UpValPtr &#123;</span><br><span class="line">        as_obj(v).inc();</span><br><span class="line">        <span class="keyword">let</span> ptr = <span class="built_in">Box</span>::into_raw(<span class="built_in">Box</span>::new(UpVal &#123;</span><br><span class="line">            base: GcObj &#123;</span><br><span class="line">                ref_cnt: <span class="number">1</span>,</span><br><span class="line">                kind: GcObjKind::UpVal,</span><br><span class="line">                deinit: upval_deinit,</span><br><span class="line">                gc,</span><br><span class="line">            &#125;,</span><br><span class="line">            v,</span><br><span class="line">        &#125;));</span><br><span class="line">        gc.register(as_obj_ptr(ptr), is_root);</span><br><span class="line">        ptr</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[repr(C)]</span></span><br><span class="line"><span class="meta">#[derive(Debug, Clone)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">struct</span> <span class="title">JsFunction</span></span> &#123;</span><br><span class="line">    base: GcObj,</span><br><span class="line">    <span class="keyword">pub</span> f: *<span class="keyword">const</span> c_void,</span><br><span class="line">    <span class="keyword">pub</span> is_native: <span class="built_in">bool</span>,</span><br><span class="line">    <span class="keyword">pub</span> upvals: <span class="built_in">Vec</span>&lt;UpValPtr&gt;,</span><br><span class="line">    <span class="keyword">pub</span> prototype: JsObjPtr,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">js_fun_deinit</span></span>(ptr: JsObjPtr) &#123;</span><br><span class="line">    <span class="keyword">let</span> r = as_fun(ptr);</span><br><span class="line">    <span class="keyword">let</span> s = mem::size_of_val(r);</span><br><span class="line"></span><br><span class="line">    r.upvals.iter().for_each(|uv| as_obj(*uv).dec());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">unsafe</span> &#123;</span><br><span class="line">        drop_in_place(r);</span><br><span class="line">    &#125;</span><br><span class="line">    as_gc(r.base.gc).heap_size -= s;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> JsFunction &#123;</span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">new</span></span>(gc: &amp;<span class="keyword">mut</span> Gc, is_root: <span class="built_in">bool</span>) -&gt; JsFunPtr &#123;</span><br><span class="line">        <span class="keyword">let</span> ptr = <span class="built_in">Box</span>::into_raw(<span class="built_in">Box</span>::new(JsFunction &#123;</span><br><span class="line">            base: GcObj &#123;</span><br><span class="line">                ref_cnt: <span class="number">1</span>,</span><br><span class="line">                kind: GcObjKind::Function,</span><br><span class="line">                deinit: js_fun_deinit,</span><br><span class="line">                gc,</span><br><span class="line">            &#125;,</span><br><span class="line">            f: null(),</span><br><span class="line">            is_native: <span class="literal">false</span>,</span><br><span class="line">            upvals: <span class="built_in">vec!</span>[],</span><br><span class="line">            prototype: null_mut(),</span><br><span class="line">        &#125;));</span><br><span class="line">        gc.register(as_obj_ptr(ptr), is_root);</span><br><span class="line">        ptr</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[repr(C)]</span></span><br><span class="line"><span class="meta">#[derive(Debug)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">struct</span> <span class="title">Gc</span></span> &#123;</span><br><span class="line">    heap_size: <span class="built_in">usize</span>,</span><br><span class="line">    max_heap_size: <span class="built_in">usize</span>,</span><br><span class="line">    <span class="comment">// 存储对象指针，以便进行垃圾回收</span></span><br><span class="line">    obj_list: LinkedHashSet&lt;GcObjPtr&gt;,</span><br><span class="line">    <span class="comment">// 用于存储根对象的指针，以确保它们不被垃圾回收</span></span><br><span class="line">    roots: HashSet&lt;GcObjPtr&gt;,</span><br><span class="line">    <span class="comment">// 存储标记阶段中需要标记的对象</span></span><br><span class="line">    marked: <span class="built_in">Vec</span>&lt;GcObjPtr&gt;,</span><br><span class="line">    js_null_: JsObjPtr,</span><br><span class="line">    js_undef_: JsObjPtr,</span><br><span class="line">    js_true_: JsBoolPtr,</span><br><span class="line">    js_false_: JsBoolPtr,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> INIT_GC_DATA_ONCE: Once = Once::new();</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> Gc &#123;</span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">new</span></span>(max_heap_size: <span class="built_in">usize</span>) -&gt; <span class="built_in">Box</span>&lt;<span class="keyword">Self</span>&gt; &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut</span> gc = <span class="built_in">Box</span>::new(Gc &#123;</span><br><span class="line">            heap_size: <span class="number">0</span>,</span><br><span class="line">            max_heap_size,</span><br><span class="line">            obj_list: LinkedHashSet::new(),</span><br><span class="line">            roots: HashSet::new(),</span><br><span class="line">            marked: <span class="built_in">vec!</span>[],</span><br><span class="line">            js_null_: null_mut(),</span><br><span class="line">            js_undef_: null_mut(),</span><br><span class="line">            js_true_: null_mut(),</span><br><span class="line">            js_false_: null_mut(),</span><br><span class="line">        &#125;);</span><br><span class="line">        gc.init_data();</span><br><span class="line">        gc</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">init_data</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) &#123;</span><br><span class="line">        <span class="keyword">self</span>.js_null_ = <span class="built_in">Box</span>::into_raw(<span class="built_in">Box</span>::new(GcObj &#123;</span><br><span class="line">            ref_cnt: <span class="number">1</span>,</span><br><span class="line">            kind: GcObjKind::Null,</span><br><span class="line">            gc: <span class="keyword">self</span> <span class="keyword">as</span> GcPtr,</span><br><span class="line">            deinit: default_deinit,</span><br><span class="line">        &#125;));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">self</span>.js_undef_ = <span class="built_in">Box</span>::into_raw(<span class="built_in">Box</span>::new(GcObj &#123;</span><br><span class="line">            ref_cnt: <span class="number">1</span>,</span><br><span class="line">            kind: GcObjKind::Undef,</span><br><span class="line">            gc: <span class="keyword">self</span> <span class="keyword">as</span> GcPtr,</span><br><span class="line">            deinit: default_deinit,</span><br><span class="line">        &#125;));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">self</span>.js_true_ = <span class="built_in">Box</span>::into_raw(<span class="built_in">Box</span>::new(JsBoolean &#123;</span><br><span class="line">            base: GcObj &#123;</span><br><span class="line">                ref_cnt: <span class="number">1</span>,</span><br><span class="line">                kind: GcObjKind::Boolean,</span><br><span class="line">                gc: <span class="keyword">self</span> <span class="keyword">as</span> GcPtr,</span><br><span class="line">                deinit: default_deinit,</span><br><span class="line">            &#125;,</span><br><span class="line">            d: <span class="literal">true</span>,</span><br><span class="line">        &#125;));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">self</span>.js_false_ = <span class="built_in">Box</span>::into_raw(<span class="built_in">Box</span>::new(JsBoolean &#123;</span><br><span class="line">            base: GcObj &#123;</span><br><span class="line">                ref_cnt: <span class="number">1</span>,</span><br><span class="line">                kind: GcObjKind::Boolean,</span><br><span class="line">                gc: <span class="keyword">self</span> <span class="keyword">as</span> GcPtr,</span><br><span class="line">                deinit: default_deinit,</span><br><span class="line">            &#125;,</span><br><span class="line">            d: <span class="literal">false</span>,</span><br><span class="line">        &#125;));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">js_null</span></span>(&amp;<span class="keyword">self</span>) -&gt; JsObjPtr &#123;</span><br><span class="line">        <span class="keyword">self</span>.js_null_</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">js_undef</span></span>(&amp;<span class="keyword">self</span>) -&gt; JsObjPtr &#123;</span><br><span class="line">        <span class="keyword">self</span>.js_undef_</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">js_true</span></span>(&amp;<span class="keyword">self</span>) -&gt; JsBoolPtr &#123;</span><br><span class="line">        <span class="keyword">self</span>.js_true_</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">js_false</span></span>(&amp;<span class="keyword">self</span>) -&gt; JsBoolPtr &#123;</span><br><span class="line">        <span class="keyword">self</span>.js_false_</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">new_str</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, is_root: <span class="built_in">bool</span>) -&gt; JsStrPtr &#123;</span><br><span class="line">        <span class="keyword">let</span> need = mem::size_of::&lt;JsString&gt;();</span><br><span class="line">        <span class="keyword">self</span>.xgc(need);</span><br><span class="line">        <span class="keyword">self</span>.heap_size += need;</span><br><span class="line">        JsString::new(<span class="keyword">self</span>, is_root)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">new_str_from_kst</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, kst: &amp;Const, is_root: <span class="built_in">bool</span>) -&gt; JsStrPtr &#123;</span><br><span class="line">        <span class="keyword">let</span> s = <span class="keyword">self</span>.new_str(is_root);</span><br><span class="line">        as_str(s).d = kst.<span class="built_in">str</span>().to_owned();</span><br><span class="line">        s</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">new_obj_from_kst</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, kst: &amp;Const, is_root: <span class="built_in">bool</span>) -&gt; JsObjPtr &#123;</span><br><span class="line">        <span class="keyword">match</span> kst &#123;</span><br><span class="line">            Const::<span class="built_in">String</span>(_) =&gt; as_obj_ptr(<span class="keyword">self</span>.new_str_from_kst(kst, is_root)),</span><br><span class="line">            Const::Number(_) =&gt; as_obj_ptr(<span class="keyword">self</span>.new_num_from_kst(kst, is_root)),</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">new_num</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, is_root: <span class="built_in">bool</span>) -&gt; JsNumPtr &#123;</span><br><span class="line">        <span class="keyword">let</span> need = mem::size_of::&lt;JsNumber&gt;();</span><br><span class="line">        <span class="keyword">self</span>.xgc(need);</span><br><span class="line">        <span class="keyword">self</span>.heap_size += need;</span><br><span class="line">        JsNumber::new(<span class="keyword">self</span>, is_root)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">new_num_from_kst</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, kst: &amp;Const, is_root: <span class="built_in">bool</span>) -&gt; JsNumPtr &#123;</span><br><span class="line">        <span class="keyword">let</span> n = <span class="keyword">self</span>.new_num(is_root);</span><br><span class="line">        as_num(n).d = kst.num();</span><br><span class="line">        n</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">new_arr</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, is_root: <span class="built_in">bool</span>) -&gt; JsArrPtr &#123;</span><br><span class="line">        <span class="keyword">let</span> need = mem::size_of::&lt;JsArray&gt;();</span><br><span class="line">        <span class="keyword">self</span>.xgc(need);</span><br><span class="line">        <span class="keyword">self</span>.heap_size += need;</span><br><span class="line">        JsArray::new(<span class="keyword">self</span>, is_root)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">new_dict</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, is_root: <span class="built_in">bool</span>) -&gt; JsDictPtr &#123;</span><br><span class="line">        <span class="keyword">let</span> need = mem::size_of::&lt;JsDict&gt;();</span><br><span class="line">        <span class="keyword">self</span>.xgc(need);</span><br><span class="line">        <span class="keyword">self</span>.heap_size += need;</span><br><span class="line">        JsDict::new(<span class="keyword">self</span>, is_root)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">new_fun</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, is_root: <span class="built_in">bool</span>) -&gt; JsFunPtr &#123;</span><br><span class="line">        <span class="keyword">let</span> need = mem::size_of::&lt;JsFunction&gt;();</span><br><span class="line">        <span class="keyword">self</span>.xgc(need);</span><br><span class="line">        <span class="keyword">self</span>.heap_size += need;</span><br><span class="line">        JsFunction::new(<span class="keyword">self</span>, is_root)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">new_upval</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, v: JsObjPtr, is_root: <span class="built_in">bool</span>) -&gt; UpValPtr &#123;</span><br><span class="line">        <span class="keyword">let</span> need = mem::size_of::&lt;UpVal&gt;();</span><br><span class="line">        <span class="keyword">self</span>.xgc(need);</span><br><span class="line">        <span class="keyword">self</span>.heap_size += need;</span><br><span class="line">        UpVal::new(<span class="keyword">self</span>, v, is_root)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">register</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, ptr: JsObjPtr, is_root: <span class="built_in">bool</span>) &#123;</span><br><span class="line">        <span class="keyword">self</span>.obj_list.insert(ptr);</span><br><span class="line">        <span class="keyword">if</span> is_root &#123;</span><br><span class="line">            <span class="keyword">self</span>.roots.insert(ptr);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">remove_root</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, ptr: JsObjPtr) &#123;</span><br><span class="line">        <span class="keyword">self</span>.roots.remove(&amp;as_obj_ptr(ptr));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">append_root</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, ptr: JsObjPtr) &#123;</span><br><span class="line">        <span class="keyword">self</span>.roots.insert(ptr);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">inc</span></span>&lt;T&gt;(&amp;<span class="keyword">self</span>, ptr: *<span class="keyword">mut</span> T) &#123;</span><br><span class="line">        as_obj(ptr).ref_cnt += <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">dec</span></span>&lt;T&gt;(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, ptr: *<span class="keyword">mut</span> T) &#123;</span><br><span class="line">        <span class="keyword">let</span> ptr = ptr <span class="keyword">as</span> JsObjPtr;</span><br><span class="line">        <span class="keyword">if</span> !<span class="keyword">self</span>.obj_list.contains(&amp;ptr) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> obj = as_obj(ptr);</span><br><span class="line">        <span class="keyword">match</span> obj.kind &#123;</span><br><span class="line">            GcObjKind::Null | GcObjKind::Undef | GcObjKind::Boolean =&gt; <span class="keyword">return</span>,</span><br><span class="line">            _ =&gt; (),</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">let</span> em = <span class="built_in">format!</span>(<span class="string">"dropping dangling object &#123;:#?&#125; &#123;:#?&#125;"</span>, ptr, obj);</span><br><span class="line">        <span class="built_in">assert!</span>(obj.ref_cnt &gt; <span class="number">0</span>, <span class="string">"&#123;&#125;"</span>, em);</span><br><span class="line">        obj.ref_cnt -= <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">if</span> obj.ref_cnt == <span class="number">0</span> &#123;</span><br><span class="line">            <span class="keyword">self</span>.<span class="built_in">drop</span>(ptr);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">drop</span></span>&lt;T&gt;(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, ptr: *<span class="keyword">mut</span> T) &#123;</span><br><span class="line">        <span class="keyword">let</span> ptr = ptr <span class="keyword">as</span> JsObjPtr;</span><br><span class="line">        <span class="keyword">let</span> obj = as_obj(ptr);</span><br><span class="line">        <span class="keyword">self</span>.obj_list.remove(&amp;ptr);</span><br><span class="line">        <span class="keyword">self</span>.roots.remove(&amp;ptr);</span><br><span class="line">        (obj.deinit)(obj);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">xgc</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, need: <span class="built_in">usize</span>) &#123;</span><br><span class="line">        <span class="keyword">let</span> s = <span class="keyword">self</span>.heap_size + need;</span><br><span class="line">        <span class="keyword">if</span> s &gt;= <span class="keyword">self</span>.max_heap_size &#123;</span><br><span class="line">            <span class="keyword">self</span>.gc();</span><br><span class="line">            <span class="built_in">assert!</span>(<span class="keyword">self</span>.heap_size + need &lt;= <span class="keyword">self</span>.max_heap_size);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">reset_all_ref_cnt</span></span>(&amp;<span class="keyword">self</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> pp <span class="keyword">in</span> &amp;<span class="keyword">self</span>.obj_list &#123;</span><br><span class="line">            as_obj(*pp).ref_cnt = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">mark_phase</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) &#123;</span><br><span class="line">        <span class="comment">// 标记根对象</span></span><br><span class="line">        <span class="keyword">for</span> root <span class="keyword">in</span> &amp;<span class="keyword">self</span>.roots &#123;</span><br><span class="line">            <span class="keyword">self</span>.marked.push(*root);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 递归标记</span></span><br><span class="line">        <span class="keyword">while</span> <span class="keyword">let</span> <span class="literal">Some</span>(ptr) = <span class="keyword">self</span>.marked.pop() &#123;</span><br><span class="line">            <span class="keyword">let</span> obj = as_obj(ptr);</span><br><span class="line">            obj.ref_cnt += <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">if</span> obj.ref_cnt == <span class="number">1</span> &#123;</span><br><span class="line">                <span class="keyword">match</span> obj.kind &#123;</span><br><span class="line">                    GcObjKind::<span class="built_in">String</span></span><br><span class="line">                    | GcObjKind::Number</span><br><span class="line">                    | GcObjKind::Boolean</span><br><span class="line">                    | GcObjKind::Undef</span><br><span class="line">                    | GcObjKind::Null =&gt; (),</span><br><span class="line">                    GcObjKind::Array =&gt; &#123;</span><br><span class="line">                        <span class="keyword">for</span> pp <span class="keyword">in</span> &amp;as_arr(obj).d &#123;</span><br><span class="line">                            <span class="keyword">self</span>.marked.push(*pp)</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    GcObjKind::Dict =&gt; &#123;</span><br><span class="line">                        <span class="keyword">for</span> (_, pp) <span class="keyword">in</span> &amp;as_dict(obj).d &#123;</span><br><span class="line">                            <span class="keyword">self</span>.marked.push(*pp)</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    GcObjKind::UpVal =&gt; &#123;</span><br><span class="line">                        <span class="keyword">self</span>.marked.push(as_uv(obj).v);</span><br><span class="line">                    &#125;</span><br><span class="line">                    GcObjKind::Function =&gt; &#123;</span><br><span class="line">                        <span class="keyword">for</span> pp <span class="keyword">in</span> &amp;as_fun(obj).upvals &#123;</span><br><span class="line">                            <span class="keyword">self</span>.marked.push(as_obj_ptr(*pp))</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 垃圾回收</span></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">sweep_phase</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut</span> cc = <span class="built_in">vec!</span>[];</span><br><span class="line">        <span class="keyword">for</span> pp <span class="keyword">in</span> &amp;<span class="keyword">self</span>.obj_list &#123;</span><br><span class="line">            <span class="keyword">let</span> ptr = *pp;</span><br><span class="line">            <span class="keyword">if</span> as_obj(ptr).ref_cnt == <span class="number">0</span> &#123;</span><br><span class="line">                cc.push(ptr);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        cc.iter().for_each(|ptr| &#123;</span><br><span class="line">            <span class="keyword">self</span>.<span class="built_in">drop</span>(*ptr);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">gc</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) &#123;</span><br><span class="line">        <span class="keyword">self</span>.reset_all_ref_cnt();</span><br><span class="line">        <span class="keyword">self</span>.mark_phase();</span><br><span class="line">        <span class="keyword">self</span>.sweep_phase();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="built_in">Drop</span> <span class="keyword">for</span> Gc &#123;</span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">drop</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> p <span class="keyword">in</span> <span class="keyword">self</span>.obj_list.clone() &#123;</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">self</span>.obj_list.contains(&amp;p) &#123;</span><br><span class="line">                <span class="keyword">self</span>.dec(p);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">struct</span> <span class="title">LocalScope</span></span> &#123;</span><br><span class="line">    vals: HashSet&lt;JsObjPtr&gt;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> LocalScope &#123;</span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">new</span></span>() -&gt; <span class="keyword">Self</span> &#123;</span><br><span class="line">        LocalScope &#123;</span><br><span class="line">            vals: HashSet::new(),</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">reg</span></span>&lt;T&gt;(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, v: *<span class="keyword">mut</span> T) -&gt; JsObjPtr &#123;</span><br><span class="line">        <span class="keyword">let</span> v = v <span class="keyword">as</span> JsObjPtr;</span><br><span class="line">        <span class="keyword">self</span>.vals.insert(v);</span><br><span class="line">        v</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="built_in">Drop</span> <span class="keyword">for</span> LocalScope &#123;</span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">drop</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) &#123;</span><br><span class="line">        <span class="keyword">self</span>.vals.iter().for_each(|v| as_obj(*v).dec())</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="GcObj-相关方法"><a href="#GcObj-相关方法" class="headerlink" title="GcObj 相关方法"></a>GcObj 相关方法</h2><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">impl</span> GcObj &#123;</span><br><span class="line">    <span class="comment">// 判断对象是否支持通过值传递,字符串或数字,它们支持通过值传递</span></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">pass_by_value</span></span>(&amp;<span class="keyword">self</span>) -&gt; <span class="built_in">bool</span> &#123;</span><br><span class="line">        <span class="keyword">match</span> <span class="keyword">self</span>.kind &#123;</span><br><span class="line">            GcObjKind::<span class="built_in">String</span> | GcObjKind::Number =&gt; <span class="literal">true</span>,</span><br><span class="line">            _ =&gt; <span class="literal">false</span>,</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 是否可以强制转换</span></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">check_coercible</span></span>(&amp;<span class="keyword">self</span>) -&gt; <span class="built_in">bool</span> &#123;</span><br><span class="line">        <span class="keyword">match</span> <span class="keyword">self</span>.kind &#123;</span><br><span class="line">            GcObjKind::Undef | GcObjKind::Null =&gt; <span class="literal">false</span>,</span><br><span class="line">            _ =&gt; <span class="literal">true</span>,</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 值传递，将对象的值复制到一个新对象中</span></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">x_pass_by_value</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) -&gt; JsObjPtr &#123;</span><br><span class="line">        <span class="keyword">let</span> gc = as_gc(<span class="keyword">self</span>.gc());</span><br><span class="line">        <span class="keyword">match</span> <span class="keyword">self</span>.kind &#123;</span><br><span class="line">            GcObjKind::<span class="built_in">String</span> =&gt; &#123;</span><br><span class="line">                <span class="keyword">let</span> v = gc.new_str(<span class="literal">false</span>);</span><br><span class="line">                as_str(v).d = as_str(<span class="keyword">self</span>).d.clone();</span><br><span class="line">                as_obj_ptr(v)</span><br><span class="line">            &#125;</span><br><span class="line">            GcObjKind::Number =&gt; &#123;</span><br><span class="line">                <span class="keyword">let</span> v = gc.new_num(<span class="literal">false</span>);</span><br><span class="line">                as_num(v).d = as_num(<span class="keyword">self</span>).d;</span><br><span class="line">                as_obj_ptr(v)</span><br><span class="line">            &#125;</span><br><span class="line">            _ =&gt; <span class="built_in">panic!</span>(),</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">eqs_true</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) -&gt; <span class="built_in">bool</span> &#123;</span><br><span class="line">        <span class="keyword">self</span>.kind == GcObjKind::Boolean &amp;&amp; as_bool(<span class="keyword">self</span>).d</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">eqs_false</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) -&gt; <span class="built_in">bool</span> &#123;</span><br><span class="line">        <span class="keyword">self</span>.kind == GcObjKind::Boolean &amp;&amp; !as_bool(<span class="keyword">self</span>).d</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ToPrimitive</span></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">t_pri</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) -&gt; JsObjPtr &#123;</span><br><span class="line">        as_obj(<span class="keyword">self</span>).inc();</span><br><span class="line">        as_obj_ptr(<span class="keyword">self</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ToNumber</span></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">t_num</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) -&gt; JsNumPtr &#123;</span><br><span class="line">        <span class="keyword">let</span> gc = as_gc(<span class="keyword">self</span>.gc());</span><br><span class="line">        <span class="keyword">match</span> <span class="keyword">self</span>.kind &#123;</span><br><span class="line">            GcObjKind::Undef =&gt; &#123;</span><br><span class="line">                <span class="keyword">let</span> n = gc.new_num(<span class="literal">false</span>);</span><br><span class="line">                as_num(n).d = <span class="built_in">f64</span>::NAN;</span><br><span class="line">                n</span><br><span class="line">            &#125;</span><br><span class="line">            GcObjKind::Null =&gt; gc.new_num(<span class="literal">false</span>),</span><br><span class="line">            GcObjKind::Boolean =&gt; &#123;</span><br><span class="line">                <span class="keyword">let</span> n = gc.new_num(<span class="literal">false</span>);</span><br><span class="line">                <span class="keyword">let</span> is_true = as_obj(<span class="keyword">self</span>).eqs_true();</span><br><span class="line">                as_num(n).d = <span class="keyword">if</span> is_true &#123; <span class="number">1.0</span> &#125; <span class="keyword">else</span> &#123; <span class="number">0.0</span> &#125;;</span><br><span class="line">                n</span><br><span class="line">            &#125;</span><br><span class="line">            GcObjKind::Number =&gt; &#123;</span><br><span class="line">                <span class="keyword">self</span>.inc();</span><br><span class="line">                as_obj_ptr(<span class="keyword">self</span>) <span class="keyword">as</span> JsNumPtr</span><br><span class="line">            &#125;</span><br><span class="line">            GcObjKind::<span class="built_in">String</span> =&gt; &#123;</span><br><span class="line">                <span class="keyword">let</span> n = gc.new_num(<span class="literal">false</span>);</span><br><span class="line">                as_num(n).set_v_str(as_str(<span class="keyword">self</span>));</span><br><span class="line">                n</span><br><span class="line">            &#125;</span><br><span class="line">            _ =&gt; as_obj(<span class="keyword">self</span>.t_pri()).t_num(),</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ToBoolean</span></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">t_bool</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) -&gt; JsBoolPtr &#123;</span><br><span class="line">        <span class="keyword">let</span> gc = as_gc(<span class="keyword">self</span>.gc());</span><br><span class="line">        <span class="keyword">match</span> <span class="keyword">self</span>.kind &#123;</span><br><span class="line">            GcObjKind::Undef =&gt; gc.js_false(),</span><br><span class="line">            GcObjKind::Null =&gt; gc.js_false(),</span><br><span class="line">            GcObjKind::Boolean =&gt; as_obj_ptr(<span class="keyword">self</span>) <span class="keyword">as</span> JsBoolPtr,</span><br><span class="line">            GcObjKind::Number =&gt; &#123;</span><br><span class="line">                <span class="keyword">let</span> n = as_num(<span class="keyword">self</span>);</span><br><span class="line">                <span class="keyword">if</span> n.d == <span class="number">0.0</span> || n.d.is_nan() &#123;</span><br><span class="line">                    <span class="keyword">return</span> gc.js_false();</span><br><span class="line">                &#125;</span><br><span class="line">                gc.js_true()</span><br><span class="line">            &#125;</span><br><span class="line">            GcObjKind::<span class="built_in">String</span> =&gt; &#123;</span><br><span class="line">                <span class="keyword">let</span> s = as_str(<span class="keyword">self</span>);</span><br><span class="line">                <span class="keyword">if</span> s.d.len() == <span class="number">0</span> &#123;</span><br><span class="line">                    <span class="keyword">return</span> gc.js_false();</span><br><span class="line">                &#125;</span><br><span class="line">                gc.js_true()</span><br><span class="line">            &#125;</span><br><span class="line">            _ =&gt; gc.js_true(),</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 是否为非基本类型</span></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">is_compound</span></span>(&amp;<span class="keyword">self</span>) -&gt; <span class="built_in">bool</span> &#123;</span><br><span class="line">        <span class="keyword">match</span> <span class="keyword">self</span>.kind &#123;</span><br><span class="line">            GcObjKind::<span class="built_in">String</span></span><br><span class="line">            | GcObjKind::Number</span><br><span class="line">            | GcObjKind::Boolean</span><br><span class="line">            | GcObjKind::Null</span><br><span class="line">            | GcObjKind::Undef =&gt; <span class="literal">false</span>,</span><br><span class="line">            _ =&gt; <span class="literal">true</span>,</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">eq</span></span>(a: JsObjPtr, b: JsObjPtr) -&gt; <span class="built_in">bool</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> gc = as_gc(as_obj(a).gc());</span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut</span> local_scope = LocalScope::new();</span><br><span class="line">        <span class="keyword">let</span> ta = as_obj(a).kind;</span><br><span class="line">        <span class="keyword">let</span> tb = as_obj(b).kind;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ta == tb &#123;</span><br><span class="line">            <span class="keyword">if</span> ta == GcObjKind::Undef &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> ta == GcObjKind::Null &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> ta == GcObjKind::Number &#123;</span><br><span class="line">                <span class="keyword">let</span> av = as_num(a).d;</span><br><span class="line">                <span class="keyword">let</span> bv = as_num(b).d;</span><br><span class="line">                <span class="keyword">if</span> av.is_nan() &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> bv.is_nan() &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> av == bv;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> ta == GcObjKind::<span class="built_in">String</span> &#123;</span><br><span class="line">                <span class="keyword">let</span> av = &amp;as_str(a).d;</span><br><span class="line">                <span class="keyword">let</span> bv = &amp;as_str(b).d;</span><br><span class="line">                <span class="keyword">return</span> av == bv;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> ta == GcObjKind::Boolean &#123;</span><br><span class="line">                <span class="keyword">return</span> a == b;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> ta == GcObjKind::Undef &amp;&amp; tb == GcObjKind::Null</span><br><span class="line">                || ta == GcObjKind::Null &amp;&amp; tb == GcObjKind::Undef</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> ta == GcObjKind::Number &amp;&amp; tb == GcObjKind::<span class="built_in">String</span> &#123;</span><br><span class="line">                <span class="keyword">let</span> nb = gc.new_num(<span class="literal">false</span>);</span><br><span class="line">                local_scope.reg(nb);</span><br><span class="line">                as_num(nb).set_v_str(as_str(b));</span><br><span class="line">                <span class="keyword">return</span> as_num(a).eq(nb);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> ta == GcObjKind::<span class="built_in">String</span> &amp;&amp; tb == GcObjKind::Number &#123;</span><br><span class="line">                <span class="keyword">let</span> na = gc.new_num(<span class="literal">false</span>);</span><br><span class="line">                local_scope.reg(na);</span><br><span class="line">                as_num(na).set_v_str(as_str(a));</span><br><span class="line">                <span class="keyword">return</span> as_num(b).eq(na);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> ta == GcObjKind::Boolean &#123;</span><br><span class="line">                <span class="keyword">let</span> na = gc.new_num(<span class="literal">false</span>);</span><br><span class="line">                local_scope.reg(na);</span><br><span class="line">                as_num(na).set_v_bool(a);</span><br><span class="line">                <span class="keyword">return</span> GcObj::eq(as_obj_ptr(na), b);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> tb == GcObjKind::Boolean &#123;</span><br><span class="line">                <span class="keyword">let</span> nb = gc.new_num(<span class="literal">false</span>);</span><br><span class="line">                local_scope.reg(nb);</span><br><span class="line">                as_num(nb).set_v_bool(b);</span><br><span class="line">                <span class="keyword">return</span> GcObj::eq(a, as_obj_ptr(nb));</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (ta == GcObjKind::Number || ta == GcObjKind::<span class="built_in">String</span>) &amp;&amp; as_obj(b).is_compound() &#123;</span><br><span class="line">                <span class="keyword">let</span> pri = as_obj(b).t_pri();</span><br><span class="line">                local_scope.reg(pri);</span><br><span class="line">                <span class="keyword">return</span> GcObj::eq(a, pri);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (tb == GcObjKind::Number || tb == GcObjKind::<span class="built_in">String</span>) &amp;&amp; as_obj(a).is_compound() &#123;</span><br><span class="line">                <span class="keyword">let</span> pri = as_obj(a).t_pri();</span><br><span class="line">                local_scope.reg(pri);</span><br><span class="line">                <span class="keyword">return</span> GcObj::eq(b, pri);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">lt</span></span>(a: JsObjPtr, b: JsObjPtr) -&gt; <span class="built_in">bool</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut</span> local_scope = LocalScope::new();</span><br><span class="line">        <span class="keyword">let</span> gc = as_gc(as_obj(a).gc());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> pa = as_obj(a).t_pri();</span><br><span class="line">        local_scope.reg(a);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> pb = as_obj(b).t_pri();</span><br><span class="line">        local_scope.reg(b);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> ta = as_obj(pa).kind;</span><br><span class="line">        <span class="keyword">let</span> tb = as_obj(pb).kind;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> !(ta == GcObjKind::<span class="built_in">String</span> &amp;&amp; tb == GcObjKind::<span class="built_in">String</span>) &#123;</span><br><span class="line">            <span class="keyword">let</span> na = as_obj(pa).t_num();</span><br><span class="line">            local_scope.reg(na);</span><br><span class="line">            <span class="keyword">let</span> nb = as_obj(pb).t_num();</span><br><span class="line">            local_scope.reg(nb);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// NaN 的任何比较都会返回 false</span></span><br><span class="line">            <span class="comment">// 这返回false以保持LE只返回一种类型值</span></span><br><span class="line">            <span class="keyword">if</span> as_num(na).d.is_nan() &#123;</span><br><span class="line">                <span class="comment">// return gc.js_undef();</span></span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> as_num(nb).d.is_nan() &#123;</span><br><span class="line">                <span class="comment">// return gc.js_undef();</span></span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> as_num(na).d == as_num(nb).d &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> as_num(na).d &lt; as_num(nb).d &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> sa = as_str(pa);</span><br><span class="line">        <span class="keyword">let</span> sb = as_str(pb);</span><br><span class="line">        <span class="keyword">if</span> sa.d.starts_with(sb.d.as_str()) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> sb.d.starts_with(sa.d.as_str()) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> cbs = sb.d.chars().collect::&lt;<span class="built_in">Vec</span>&lt;_&gt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> ca <span class="keyword">in</span> sa.d.chars().enumerate() &#123;</span><br><span class="line">            <span class="keyword">let</span> cb = *cbs.get(ca.<span class="number">0</span>).unwrap();</span><br><span class="line">            <span class="keyword">if</span> ca.<span class="number">1</span> &lt; cb &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> ca.<span class="number">1</span> &gt; cb &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">le</span></span>(a: JsObjPtr, b: JsObjPtr) -&gt; <span class="built_in">bool</span> &#123;</span><br><span class="line">        GcObj::lt(a, b) || GcObj::eq(a, b)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> JsNumber &#123;</span><br><span class="line">  <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">add</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, b: JsNumPtr) -&gt; JsNumPtr &#123;</span><br><span class="line">    <span class="keyword">let</span> gc = as_gc(as_obj(<span class="keyword">self</span>).gc());</span><br><span class="line">    <span class="keyword">let</span> n = gc.new_num(<span class="literal">false</span>);</span><br><span class="line">    <span class="keyword">let</span> a = <span class="keyword">self</span>.d;</span><br><span class="line">    <span class="keyword">let</span> b = as_num(b).d;</span><br><span class="line">    as_num(n).d = a + b;</span><br><span class="line">    n</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">sub</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, b: JsNumPtr) -&gt; JsNumPtr &#123;</span><br><span class="line">    <span class="keyword">let</span> gc = as_gc(as_obj(<span class="keyword">self</span>).gc());</span><br><span class="line">    <span class="keyword">let</span> n = gc.new_num(<span class="literal">false</span>);</span><br><span class="line">    <span class="keyword">let</span> a = <span class="keyword">self</span>.d;</span><br><span class="line">    <span class="keyword">let</span> b = as_num(b).d;</span><br><span class="line">    as_num(n).d = a - b;</span><br><span class="line">    n</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">mul</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, b: JsNumPtr) -&gt; JsNumPtr &#123;</span><br><span class="line">    <span class="keyword">let</span> gc = as_gc(as_obj(<span class="keyword">self</span>).gc());</span><br><span class="line">    <span class="keyword">let</span> n = gc.new_num(<span class="literal">false</span>);</span><br><span class="line">    <span class="keyword">let</span> a = <span class="keyword">self</span>.d;</span><br><span class="line">    <span class="keyword">let</span> b = as_num(b).d;</span><br><span class="line">    as_num(n).d = a * b;</span><br><span class="line">    n</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">div</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, b: JsNumPtr) -&gt; JsNumPtr &#123;</span><br><span class="line">    <span class="keyword">let</span> gc = as_gc(as_obj(<span class="keyword">self</span>).gc());</span><br><span class="line">    <span class="keyword">let</span> n = gc.new_num(<span class="literal">false</span>);</span><br><span class="line">    <span class="keyword">let</span> a = <span class="keyword">self</span>.d;</span><br><span class="line">    <span class="keyword">let</span> b = as_num(b).d;</span><br><span class="line">    as_num(n).d = a / b;</span><br><span class="line">    n</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">modulo</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, b: JsNumPtr) -&gt; JsNumPtr &#123;</span><br><span class="line">    <span class="keyword">let</span> gc = as_gc(as_obj(<span class="keyword">self</span>).gc());</span><br><span class="line">    <span class="keyword">let</span> n = gc.new_num(<span class="literal">false</span>);</span><br><span class="line">    <span class="keyword">let</span> a = <span class="keyword">self</span>.d;</span><br><span class="line">    <span class="keyword">let</span> b = as_num(b).d;</span><br><span class="line">    as_num(n).d = a % b;</span><br><span class="line">    n</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">eq</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, b: JsNumPtr) -&gt; <span class="built_in">bool</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> a = <span class="keyword">self</span>.d;</span><br><span class="line">    <span class="keyword">let</span> b = as_num(b).d;</span><br><span class="line">    a == b</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">set_v_str</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, b: JsStrPtr) &#123;</span><br><span class="line">    <span class="keyword">self</span>.d = <span class="keyword">match</span> as_str(b).d.parse().ok() &#123;</span><br><span class="line">      <span class="literal">Some</span>(v) =&gt; v,</span><br><span class="line">      _ =&gt; <span class="built_in">f64</span>::NAN,</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">set_v_bool</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, b: JsObjPtr) &#123;</span><br><span class="line">    <span class="keyword">let</span> gc = as_gc(as_obj(<span class="keyword">self</span>).gc());</span><br><span class="line">    <span class="keyword">let</span> b = b <span class="keyword">as</span> JsBoolPtr;</span><br><span class="line">    <span class="keyword">self</span>.d = <span class="keyword">if</span> b == gc.js_true() &#123; <span class="number">1.0</span> &#125; <span class="keyword">else</span> &#123; <span class="number">0.0</span> &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> JsDict &#123;</span><br><span class="line">  <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">set</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, k: JsObjPtr, v: JsObjPtr) &#123;</span><br><span class="line">    <span class="keyword">let</span> k = as_str(k).d.as_str();</span><br><span class="line">    as_obj(v).inc();</span><br><span class="line">    <span class="keyword">match</span> <span class="keyword">self</span>.d.get(k) &#123;</span><br><span class="line">      <span class="literal">Some</span>(old) =&gt; as_obj(*old).dec(),</span><br><span class="line">      _ =&gt; (),</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">self</span>.d.insert(k.to_owned(), v);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">get</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, k: JsObjPtr) -&gt; JsObjPtr &#123;</span><br><span class="line">    <span class="keyword">let</span> gc = as_gc(as_obj(<span class="keyword">self</span>).gc());</span><br><span class="line">    <span class="keyword">let</span> k = as_str(k).d.as_str();</span><br><span class="line">    <span class="keyword">match</span> <span class="keyword">self</span>.d.get(k) &#123;</span><br><span class="line">      <span class="literal">Some</span>(v) =&gt; *v,</span><br><span class="line">      <span class="literal">None</span> =&gt; gc.js_undef(),</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="exec"><a href="#exec" class="headerlink" title="exec"></a>exec</h2><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br><span class="line">650</span><br><span class="line">651</span><br><span class="line">652</span><br><span class="line">653</span><br><span class="line">654</span><br><span class="line">655</span><br><span class="line">656</span><br><span class="line">657</span><br><span class="line">658</span><br><span class="line">659</span><br><span class="line">660</span><br><span class="line">661</span><br><span class="line">662</span><br><span class="line">663</span><br><span class="line">664</span><br><span class="line">665</span><br><span class="line">666</span><br><span class="line">667</span><br><span class="line">668</span><br><span class="line">669</span><br><span class="line">670</span><br><span class="line">671</span><br><span class="line">672</span><br><span class="line">673</span><br><span class="line">674</span><br><span class="line">675</span><br><span class="line">676</span><br><span class="line">677</span><br><span class="line">678</span><br><span class="line">679</span><br><span class="line">680</span><br><span class="line">681</span><br><span class="line">682</span><br><span class="line">683</span><br><span class="line">684</span><br><span class="line">685</span><br><span class="line">686</span><br><span class="line">687</span><br><span class="line">688</span><br><span class="line">689</span><br><span class="line">690</span><br><span class="line">691</span><br><span class="line">692</span><br><span class="line">693</span><br><span class="line">694</span><br><span class="line">695</span><br><span class="line">696</span><br><span class="line">697</span><br><span class="line">698</span><br><span class="line">699</span><br><span class="line">700</span><br><span class="line">701</span><br><span class="line">702</span><br><span class="line">703</span><br><span class="line">704</span><br><span class="line">705</span><br><span class="line">706</span><br><span class="line">707</span><br><span class="line">708</span><br><span class="line">709</span><br><span class="line">710</span><br><span class="line">711</span><br><span class="line">712</span><br><span class="line">713</span><br><span class="line">714</span><br><span class="line">715</span><br><span class="line">716</span><br><span class="line">717</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">#[derive(Debug)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">struct</span> <span class="title">RuntimeError</span></span> &#123;</span><br><span class="line">    <span class="keyword">pub</span> msg: <span class="built_in">String</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> RuntimeError &#123;</span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">new</span></span>(msg: &amp;<span class="built_in">str</span>) -&gt; <span class="keyword">Self</span> &#123;</span><br><span class="line">        RuntimeError &#123;</span><br><span class="line">            msg: msg.to_owned(),</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">type</span> <span class="title">CallInfoPtr</span></span> = *<span class="keyword">mut</span> CallInfo;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[inline(always)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">as_ci</span></span>&lt;T&gt;(ptr: *<span class="keyword">mut</span> T) -&gt; &amp;<span class="symbol">'static</span> <span class="keyword">mut</span> CallInfo &#123;</span><br><span class="line">    <span class="keyword">unsafe</span> &#123; &amp;<span class="keyword">mut</span> (*(ptr <span class="keyword">as</span> CallInfoPtr)) &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[repr(C)]</span></span><br><span class="line"><span class="meta">#[derive(Debug, Clone)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">struct</span> <span class="title">CallInfo</span></span> &#123;</span><br><span class="line">    prev: CallInfoPtr,</span><br><span class="line">    next: CallInfoPtr,</span><br><span class="line">    pc: <span class="built_in">u32</span>,</span><br><span class="line">    fun: <span class="built_in">u32</span>,</span><br><span class="line">    base: <span class="built_in">u32</span>,</span><br><span class="line">    is_native: <span class="built_in">bool</span>,</span><br><span class="line">    open_upvals: HashMap&lt;<span class="built_in">u32</span>, UpValPtr&gt;,</span><br><span class="line">    is_new: <span class="built_in">bool</span>,</span><br><span class="line">    this: JsObjPtr,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> CallInfo &#123;</span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">new</span></span>() -&gt; CallInfoPtr &#123;</span><br><span class="line">        <span class="built_in">Box</span>::into_raw(<span class="built_in">Box</span>::new(CallInfo &#123;</span><br><span class="line">            prev: null_mut(),</span><br><span class="line">            next: null_mut(),</span><br><span class="line">            pc: <span class="number">0</span>,</span><br><span class="line">            fun: <span class="number">0</span>,</span><br><span class="line">            base: <span class="number">0</span>,</span><br><span class="line">            is_native: <span class="literal">false</span>,</span><br><span class="line">            open_upvals: HashMap::new(),</span><br><span class="line">            is_new: <span class="literal">false</span>,</span><br><span class="line">            this: null_mut(),</span><br><span class="line">        &#125;))</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">set_this</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, this: JsObjPtr) &#123;</span><br><span class="line">        <span class="keyword">if</span> !<span class="keyword">self</span>.this.is_null() &#123;</span><br><span class="line">            as_obj(<span class="keyword">self</span>.this).dec();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> !this.is_null() &#123;</span><br><span class="line">            as_obj(this).inc();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">self</span>.this = this;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="built_in">Drop</span> <span class="keyword">for</span> CallInfo &#123;</span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">drop</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> !<span class="keyword">self</span>.this.is_null() &#123;</span><br><span class="line">            as_obj(<span class="keyword">self</span>.this).dec();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">enum</span> <span class="title">RKValue</span></span> &#123;</span><br><span class="line">    Kst(&amp;<span class="symbol">'static</span> Const),</span><br><span class="line">    JsObj(JsObjPtr),</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">type</span> <span class="title">VmPtr</span></span> = *<span class="keyword">mut</span> Vm;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[inline(always)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">as_vm</span></span>&lt;T&gt;(ptr: *<span class="keyword">mut</span> T) -&gt; &amp;<span class="symbol">'static</span> <span class="keyword">mut</span> Vm &#123;</span><br><span class="line">    <span class="keyword">unsafe</span> &#123; &amp;<span class="keyword">mut</span> (*(ptr <span class="keyword">as</span> VmPtr)) &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">struct</span> <span class="title">Vm</span></span> &#123;</span><br><span class="line">    gc: <span class="built_in">Box</span>&lt;Gc&gt;,</span><br><span class="line">    c: Chunk,</span><br><span class="line">    ci: CallInfoPtr,</span><br><span class="line">    s: <span class="built_in">Vec</span>&lt;GcObjPtr&gt;,</span><br><span class="line">    <span class="keyword">pub</span> env: JsDictPtr,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> JsFunction &#123;</span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">tpl</span></span>(&amp;<span class="keyword">self</span>) -&gt; &amp;FnTpl &#123;</span><br><span class="line">        <span class="keyword">unsafe</span> &#123; &amp;(*(<span class="keyword">self</span>.f <span class="keyword">as</span> *<span class="keyword">const</span> FnTpl)) &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> Gc &#123;</span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">new_fun_native</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, f: NativeFn, is_root: <span class="built_in">bool</span>) -&gt; JsFunPtr &#123;</span><br><span class="line">        <span class="keyword">let</span> nf = <span class="keyword">self</span>.new_fun(is_root);</span><br><span class="line">        as_fun(nf).is_native = <span class="literal">true</span>;</span><br><span class="line">        as_fun(nf).f = f <span class="keyword">as</span> *<span class="keyword">const</span> c_void;</span><br><span class="line">        nf</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">type</span> <span class="title">NativeFn</span></span> = <span class="function"><span class="keyword">fn</span></span>(vm: VmPtr);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">print_obj</span></span>(vm: VmPtr) &#123;</span><br><span class="line">    <span class="keyword">let</span> args = as_vm(vm).get_args();</span><br><span class="line">    args.iter().for_each(|arg| <span class="keyword">match</span> as_obj(*arg).kind &#123;</span><br><span class="line">        GcObjKind::Undef =&gt; <span class="built_in">println!</span>(<span class="string">"undefined"</span>),</span><br><span class="line">        GcObjKind::Number =&gt; <span class="built_in">println!</span>(<span class="string">"&#123;:#?&#125;"</span>, as_num(*arg).d),</span><br><span class="line">        GcObjKind::<span class="built_in">String</span> =&gt; <span class="built_in">println!</span>(<span class="string">"&#123;:#?&#125;"</span>, as_str(*arg).d),</span><br><span class="line">        GcObjKind::Function =&gt; <span class="built_in">println!</span>(<span class="string">"&#123;:#?&#125;"</span>, as_fun(*arg)),</span><br><span class="line">        _ =&gt; (),</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> Vm &#123;</span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">new</span></span>(c: Chunk, max_heap_size: <span class="built_in">usize</span>) -&gt; <span class="built_in">Box</span>&lt;<span class="keyword">Self</span>&gt; &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut</span> v = <span class="built_in">Box</span>::new(Vm &#123;</span><br><span class="line">            gc: Gc::new(max_heap_size),</span><br><span class="line">            c,</span><br><span class="line">            ci: CallInfo::new(),</span><br><span class="line">            s: <span class="built_in">vec!</span>[],</span><br><span class="line">            env: null_mut(),</span><br><span class="line">        &#125;);</span><br><span class="line">        v.env = v.gc.new_dict(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> print_fn = v.gc.new_fun(<span class="literal">false</span>);</span><br><span class="line">        as_fun(print_fn).is_native = <span class="literal">true</span>;</span><br><span class="line">        as_fun(print_fn).f = print_obj <span class="keyword">as</span> *<span class="keyword">const</span> c_void;</span><br><span class="line">        as_obj(print_fn).inc();</span><br><span class="line">        as_dict(v.env).insert(<span class="string">"print"</span>, as_obj_ptr(print_fn));</span><br><span class="line"></span><br><span class="line">        v.s.push(v.env <span class="keyword">as</span> GcObjPtr);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> f = v.gc.new_fun(<span class="literal">true</span>);</span><br><span class="line">        <span class="keyword">let</span> fr = as_fun(f);</span><br><span class="line">        fr.f = &amp;v.c.fun_tpl <span class="keyword">as</span> *<span class="keyword">const</span> FnTpl <span class="keyword">as</span> *<span class="keyword">const</span> c_void;</span><br><span class="line">        fr.is_native = <span class="literal">false</span>;</span><br><span class="line">        v.s.push(f <span class="keyword">as</span> GcObjPtr);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> uv = v.gc.new_upval(as_obj_ptr(v.env), <span class="literal">false</span>);</span><br><span class="line">        as_ci(v.ci).fun = <span class="number">1</span>;</span><br><span class="line">        as_ci(v.ci).base = <span class="number">2</span>;</span><br><span class="line">        as_ci(v.ci).open_upvals.insert(<span class="number">0</span>, uv);</span><br><span class="line"></span><br><span class="line">        as_obj(uv).inc();</span><br><span class="line">        fr.upvals.insert(<span class="number">0</span>, uv);</span><br><span class="line"></span><br><span class="line">        v</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">set_stack_slot</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, i: <span class="built_in">u32</span>, v: JsObjPtr) &#123;</span><br><span class="line">        <span class="keyword">self</span>.gc.inc(v);</span><br><span class="line">        <span class="keyword">let</span> i = i <span class="keyword">as</span> <span class="built_in">usize</span>;</span><br><span class="line">        <span class="comment">// 之前栈上已经有一个旧值，则需要适当地处理旧值，包括从根集中移除和减少旧值的引用计数</span></span><br><span class="line">        <span class="keyword">if</span> i &gt; <span class="keyword">self</span>.s.len() - <span class="number">1</span> &#123;</span><br><span class="line">            <span class="keyword">self</span>.s.resize(i + <span class="number">1</span>, <span class="keyword">self</span>.gc.js_undef());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">match</span> <span class="keyword">self</span>.s.get(i) &#123;</span><br><span class="line">            <span class="literal">Some</span>(old) =&gt; &#123;</span><br><span class="line">                <span class="keyword">if</span> !(*old).is_null() &#123;</span><br><span class="line">                    <span class="keyword">self</span>.gc.remove_root(*old);</span><br><span class="line">                    <span class="keyword">self</span>.gc.dec(*old);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            _ =&gt; (),</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">self</span>.gc.append_root(v);</span><br><span class="line">        <span class="keyword">self</span>.s[i] = v;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">get_fn</span></span>(&amp;<span class="keyword">self</span>) -&gt; <span class="built_in">Option</span>&lt;JsFunPtr&gt; &#123;</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">self</span>.ci.is_null() &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">None</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">let</span> fi = as_ci(<span class="keyword">self</span>.ci).fun <span class="keyword">as</span> <span class="built_in">usize</span>;</span><br><span class="line">        <span class="keyword">match</span> <span class="keyword">self</span>.s.get(fi) &#123;</span><br><span class="line">            <span class="literal">Some</span>(f) =&gt; <span class="literal">Some</span>(*f <span class="keyword">as</span> JsFunPtr),</span><br><span class="line">            _ =&gt; <span class="literal">None</span>,</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">fetch</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) -&gt; <span class="built_in">Result</span>&lt;<span class="built_in">Option</span>&lt;&amp;Inst&gt;, RuntimeError&gt; &#123;</span><br><span class="line">        <span class="keyword">let</span> f = <span class="keyword">match</span> <span class="keyword">self</span>.get_fn() &#123;</span><br><span class="line">            <span class="literal">Some</span>(f) =&gt; f,</span><br><span class="line">            _ =&gt; <span class="keyword">return</span> <span class="literal">Ok</span>(<span class="literal">None</span>),</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">let</span> f = as_fun(f);</span><br><span class="line">        <span class="keyword">if</span> f.is_native &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">Err</span>(RuntimeError::new(<span class="string">"using native fun as js"</span>));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">let</span> pc = as_ci(<span class="keyword">self</span>.ci).pc <span class="keyword">as</span> <span class="built_in">usize</span>;</span><br><span class="line">        as_ci(<span class="keyword">self</span>.ci).pc += <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">let</span> code = &amp;f.tpl().code;</span><br><span class="line">        <span class="literal">Ok</span>(code.get(pc))</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">exec</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) -&gt; <span class="built_in">Result</span>&lt;(), RuntimeError&gt; &#123;</span><br><span class="line">        <span class="keyword">loop</span> &#123;</span><br><span class="line">            <span class="keyword">let</span> i = <span class="keyword">match</span> <span class="keyword">self</span>.fetch() &#123;</span><br><span class="line">                <span class="literal">Err</span>(e) =&gt; <span class="keyword">return</span> <span class="literal">Err</span>(e),</span><br><span class="line">                <span class="literal">Ok</span>(inst) =&gt; <span class="keyword">match</span> inst &#123;</span><br><span class="line">                    <span class="literal">None</span> =&gt; <span class="keyword">break</span>,</span><br><span class="line">                    <span class="literal">Some</span>(i) =&gt; i.clone(),</span><br><span class="line">                &#125;,</span><br><span class="line">            &#125;;</span><br><span class="line">            <span class="keyword">match</span> <span class="keyword">self</span>.dispatch(i) &#123;</span><br><span class="line">                <span class="literal">Err</span>(e) =&gt; <span class="keyword">return</span> <span class="literal">Err</span>(e),</span><br><span class="line">                <span class="literal">Ok</span>(_) =&gt; (),</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="literal">Ok</span>(())</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">get_kst</span></span>(&amp;<span class="keyword">self</span>, r: <span class="built_in">u32</span>) -&gt; <span class="built_in">Option</span>&lt;&amp;<span class="symbol">'static</span> Const&gt; &#123;</span><br><span class="line">        <span class="keyword">let</span> r = r <span class="keyword">as</span> <span class="built_in">usize</span>;</span><br><span class="line">        <span class="keyword">let</span> mask = <span class="number">1</span> &lt;&lt; <span class="number">8</span>;</span><br><span class="line">        <span class="keyword">let</span> is_k = r &amp; mask == <span class="number">256</span>;</span><br><span class="line">        <span class="keyword">if</span> !is_k &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">None</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">let</span> f = <span class="keyword">self</span>.get_fn().unwrap();</span><br><span class="line">        <span class="keyword">let</span> cs = &amp;as_fun(f).tpl().consts;</span><br><span class="line">        <span class="literal">Some</span>(&amp;cs[r - <span class="number">256</span>])</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">rk</span></span>(&amp;<span class="keyword">self</span>, base: <span class="built_in">u32</span>, r: <span class="built_in">u32</span>) -&gt; RKValue &#123;</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">let</span> <span class="literal">Some</span>(k) = <span class="keyword">self</span>.get_kst(r) &#123;</span><br><span class="line">            <span class="keyword">return</span> RKValue::Kst(k);</span><br><span class="line">        &#125;</span><br><span class="line">        RKValue::JsObj(<span class="keyword">self</span>.get_stack_item(base + r))</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">x_rk</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, base: <span class="built_in">u32</span>, r: <span class="built_in">u32</span>) -&gt; (JsObjPtr, <span class="built_in">bool</span>) &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut</span> is_new = <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">let</span> v = <span class="keyword">match</span> <span class="keyword">self</span>.rk(base, r) &#123;</span><br><span class="line">            RKValue::Kst(kst) =&gt; &#123;</span><br><span class="line">                is_new = <span class="literal">true</span>;</span><br><span class="line">                <span class="keyword">self</span>.gc.new_obj_from_kst(kst, <span class="literal">false</span>)</span><br><span class="line">            &#125;</span><br><span class="line">            RKValue::JsObj(k) =&gt; k,</span><br><span class="line">        &#125;;</span><br><span class="line">        (v, is_new)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">get_args</span></span>(&amp;<span class="keyword">self</span>) -&gt; <span class="built_in">Vec</span>&lt;JsObjPtr&gt; &#123;</span><br><span class="line">        <span class="keyword">let</span> ci = as_ci(<span class="keyword">self</span>.ci);</span><br><span class="line">        <span class="keyword">let</span> len = ci.base - ci.fun - <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut</span> args = <span class="built_in">vec!</span>[];</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="number">1</span>..=len &#123;</span><br><span class="line">            args.push(<span class="keyword">self</span>.get_stack_item(ci.fun + i));</span><br><span class="line">        &#125;</span><br><span class="line">        args</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">set_return</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, ret: JsObjPtr) &#123;</span><br><span class="line">        <span class="keyword">self</span>.set_stack_slot(as_ci(<span class="keyword">self</span>.ci).fun, ret);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">get_stack_item</span></span>(&amp;<span class="keyword">self</span>, i: <span class="built_in">u32</span>) -&gt; JsObjPtr &#123;</span><br><span class="line">        <span class="keyword">match</span> <span class="keyword">self</span>.s.get(i <span class="keyword">as</span> <span class="built_in">usize</span>) &#123;</span><br><span class="line">            <span class="literal">Some</span>(v) =&gt; &#123;</span><br><span class="line">                <span class="keyword">if</span> v.is_null() &#123;</span><br><span class="line">                    <span class="keyword">self</span>.gc.js_undef()</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    *v</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            _ =&gt; <span class="keyword">self</span>.gc.js_undef(),</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">get_upval</span></span>(&amp;<span class="keyword">self</span>, i: <span class="built_in">u32</span>) -&gt; UpValPtr &#123;</span><br><span class="line">        <span class="keyword">let</span> f = as_fun(<span class="keyword">self</span>.get_fn().unwrap());</span><br><span class="line">        *f.upvals.get(i <span class="keyword">as</span> <span class="built_in">usize</span>).unwrap()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">get_fn_tpl</span></span>(&amp;<span class="keyword">self</span>, i: <span class="built_in">u32</span>) -&gt; *<span class="keyword">const</span> FnTpl &#123;</span><br><span class="line">        <span class="keyword">let</span> cf = <span class="keyword">self</span>.get_fn().unwrap();</span><br><span class="line">        <span class="keyword">let</span> tpl = &amp;as_fun(cf).tpl().fun_tpls[i <span class="keyword">as</span> <span class="built_in">usize</span>];</span><br><span class="line">        tpl <span class="keyword">as</span> *<span class="keyword">const</span> FnTpl</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">find_upvals</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, uv_desc: &amp;UpvalDesc) -&gt; UpValPtr &#123;</span><br><span class="line">        <span class="keyword">let</span> ci = as_ci(<span class="keyword">self</span>.ci);</span><br><span class="line">        <span class="keyword">let</span> i = ci.base + uv_desc.idx;</span><br><span class="line">        <span class="keyword">let</span> open = <span class="keyword">match</span> as_ci(<span class="keyword">self</span>.ci).open_upvals.get(&amp;i) &#123;</span><br><span class="line">            <span class="literal">Some</span>(uv) =&gt; *uv,</span><br><span class="line">            <span class="literal">None</span> =&gt; &#123;</span><br><span class="line">                <span class="keyword">let</span> v = <span class="keyword">self</span>.get_stack_item(i);</span><br><span class="line">                <span class="keyword">let</span> uv = <span class="keyword">self</span>.gc.new_upval(v, <span class="literal">false</span>);</span><br><span class="line">                as_ci(<span class="keyword">self</span>.ci).open_upvals.insert(i, uv);</span><br><span class="line">                uv</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        open</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">close_upvals</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) &#123;</span><br><span class="line">        <span class="keyword">let</span> ci = as_ci(<span class="keyword">self</span>.ci);</span><br><span class="line">        <span class="keyword">if</span> ci.is_native &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (i, uv) <span class="keyword">in</span> &amp;ci.open_upvals &#123;</span><br><span class="line">            as_obj(ci.open_upvals[&amp;i]).dec();</span><br><span class="line">        &#125;</span><br><span class="line">        ci.open_upvals.clear();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">clean_ci_stack</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, ret_num: <span class="built_in">u32</span>) &#123;</span><br><span class="line">        <span class="keyword">let</span> f = as_ci(<span class="keyword">self</span>.ci).fun + ret_num;</span><br><span class="line">        <span class="keyword">let</span> len = <span class="keyword">self</span>.s.len() <span class="keyword">as</span> <span class="built_in">u32</span>;</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> f..len &#123;</span><br><span class="line">            <span class="keyword">self</span>.set_stack_slot(i, <span class="keyword">self</span>.gc.js_undef());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">post_call</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, ret_num: <span class="built_in">u32</span>) &#123;</span><br><span class="line">        <span class="keyword">self</span>.close_upvals();</span><br><span class="line">        <span class="keyword">self</span>.clean_ci_stack(ret_num);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> cci = <span class="keyword">self</span>.ci;</span><br><span class="line">        <span class="keyword">let</span> pci = as_ci(cci).prev;</span><br><span class="line">        <span class="keyword">if</span> !pci.is_null() &#123;</span><br><span class="line">            as_ci(pci).next = null_mut();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">self</span>.ci = pci;</span><br><span class="line">        <span class="keyword">unsafe</span> &#123;</span><br><span class="line">            drop_in_place(cci);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">dispatch</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, i: Inst) -&gt; <span class="built_in">Result</span>&lt;(), RuntimeError&gt; &#123;</span><br><span class="line">        <span class="keyword">let</span> op = OpCode::from_u32(i.op());</span><br><span class="line">        <span class="keyword">match</span> op &#123;</span><br><span class="line">            OpCode::GETTABUP =&gt; &#123;</span><br><span class="line">                <span class="keyword">let</span> <span class="keyword">mut</span> ls = LocalScope::new();</span><br><span class="line">                <span class="keyword">let</span> ra = i.a();</span><br><span class="line">                <span class="keyword">let</span> rc = i.c();</span><br><span class="line">                <span class="keyword">let</span> base = as_ci(<span class="keyword">self</span>.ci).base;</span><br><span class="line">                <span class="keyword">let</span> (k, is_new) = <span class="keyword">self</span>.x_rk(base, i.c());</span><br><span class="line">                <span class="keyword">if</span> is_new &#123;</span><br><span class="line">                    ls.reg(k);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">let</span> uv = as_uv(<span class="keyword">self</span>.get_upval(i.b()));</span><br><span class="line">                <span class="keyword">let</span> v = as_dict(uv.v).get(k);</span><br><span class="line">                <span class="keyword">self</span>.set_stack_slot(as_ci(<span class="keyword">self</span>.ci).base + ra, v);</span><br><span class="line">            &#125;</span><br><span class="line">            OpCode::SETTABUP =&gt; &#123;</span><br><span class="line">                <span class="keyword">let</span> <span class="keyword">mut</span> ls = LocalScope::new();</span><br><span class="line">                <span class="keyword">let</span> base = as_ci(<span class="keyword">self</span>.ci).base;</span><br><span class="line">                <span class="keyword">let</span> (k, is_new) = <span class="keyword">self</span>.x_rk(base, i.b());</span><br><span class="line">                <span class="keyword">if</span> is_new &#123;</span><br><span class="line">                    ls.reg(k);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">let</span> (v, is_new) = <span class="keyword">self</span>.x_rk(base, i.c());</span><br><span class="line">                <span class="keyword">if</span> is_new &#123;</span><br><span class="line">                    ls.reg(v);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">let</span> uv = as_uv(<span class="keyword">self</span>.get_upval(i.a()));</span><br><span class="line">                as_dict(uv.v).set(k, v);</span><br><span class="line">            &#125;</span><br><span class="line">            OpCode::LOADK =&gt; &#123;</span><br><span class="line">                <span class="keyword">let</span> <span class="keyword">mut</span> ls = LocalScope::new();</span><br><span class="line">                <span class="keyword">let</span> ra = i.a();</span><br><span class="line">                <span class="keyword">let</span> (v, is_new) = <span class="keyword">self</span>.x_rk(<span class="number">0</span>, i.bx());</span><br><span class="line">                <span class="keyword">if</span> is_new &#123;</span><br><span class="line">                    ls.reg(v);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">self</span>.set_stack_slot(as_ci(<span class="keyword">self</span>.ci).base + ra, v);</span><br><span class="line">            &#125;</span><br><span class="line">            OpCode::GETUPVAL =&gt; &#123;</span><br><span class="line">                <span class="keyword">let</span> f = <span class="keyword">self</span>.get_fn().unwrap();</span><br><span class="line">                <span class="keyword">let</span> uvs = &amp;as_fun(f).upvals;</span><br><span class="line">                <span class="keyword">let</span> uv = uvs[i.b() <span class="keyword">as</span> <span class="built_in">usize</span>];</span><br><span class="line">                <span class="keyword">self</span>.set_stack_slot(as_ci(<span class="keyword">self</span>.ci).base + i.a(), as_uv(uv).v);</span><br><span class="line">            &#125;</span><br><span class="line">            OpCode::CLOSURE =&gt; &#123;</span><br><span class="line">                <span class="keyword">let</span> <span class="keyword">mut</span> ls = LocalScope::new();</span><br><span class="line">                <span class="keyword">let</span> f = <span class="keyword">self</span>.gc.new_fun(<span class="literal">false</span>);</span><br><span class="line">                as_fun(f).f = <span class="keyword">self</span>.get_fn_tpl(i.bx()) <span class="keyword">as</span> *<span class="keyword">const</span> c_void;</span><br><span class="line">                ls.reg(f);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">let</span> uv_desc = &amp;as_fun(f).tpl().upvals;</span><br><span class="line">                uv_desc.iter().for_each(|uvd| &#123;</span><br><span class="line">                    <span class="keyword">if</span> uvd.in_stack &#123;</span><br><span class="line">                        <span class="keyword">let</span> uv = <span class="keyword">self</span>.find_upvals(uvd);</span><br><span class="line">                        as_obj(uv).inc();</span><br><span class="line">                        as_fun(f).upvals.push(uv);</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="keyword">let</span> cf = <span class="keyword">self</span>.get_fn().unwrap();</span><br><span class="line">                        <span class="keyword">let</span> uvs = &amp;as_fun(cf).upvals;</span><br><span class="line">                        <span class="keyword">let</span> uv = *uvs.get(uvd.idx <span class="keyword">as</span> <span class="built_in">usize</span>).unwrap();</span><br><span class="line">                        <span class="keyword">let</span> uv = <span class="keyword">self</span>.gc.new_upval(as_uv(uv).v, <span class="literal">false</span>);</span><br><span class="line">                        as_fun(f).upvals.push(uv);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">self</span>.set_stack_slot(as_ci(<span class="keyword">self</span>.ci).base + i.a(), as_obj_ptr(f));</span><br><span class="line">            &#125;</span><br><span class="line">            OpCode::MOVE =&gt; &#123;</span><br><span class="line">                <span class="keyword">let</span> base = as_ci(<span class="keyword">self</span>.ci).base;</span><br><span class="line">                <span class="keyword">let</span> v = <span class="keyword">self</span>.get_stack_item(base + i.b());</span><br><span class="line">                <span class="keyword">self</span>.set_stack_slot(base + i.a(), v);</span><br><span class="line">            &#125;</span><br><span class="line">            OpCode::TEST =&gt; &#123;</span><br><span class="line">                <span class="keyword">let</span> base = as_ci(<span class="keyword">self</span>.ci).base;</span><br><span class="line">                <span class="keyword">let</span> v = <span class="keyword">self</span>.get_stack_item(base + i.a());</span><br><span class="line">                <span class="keyword">let</span> b = as_obj(v).t_bool();</span><br><span class="line">                <span class="keyword">let</span> com = <span class="keyword">if</span> as_obj(b).eqs_true() &#123; <span class="number">1</span> &#125; <span class="keyword">else</span> &#123; <span class="number">0</span> &#125;;</span><br><span class="line">                <span class="keyword">let</span> eq = com == i.c();</span><br><span class="line">                <span class="keyword">if</span> eq &#123;</span><br><span class="line">                    as_ci(<span class="keyword">self</span>.ci).pc += <span class="number">1</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            OpCode::TESTSET =&gt; &#123;</span><br><span class="line">                <span class="keyword">let</span> base = as_ci(<span class="keyword">self</span>.ci).base;</span><br><span class="line">                <span class="keyword">let</span> b = <span class="keyword">self</span>.get_stack_item(base + i.b());</span><br><span class="line">                <span class="keyword">let</span> tb = as_obj(b).t_bool();</span><br><span class="line">                <span class="keyword">let</span> com = <span class="keyword">if</span> as_obj(tb).eqs_true() &#123; <span class="number">1</span> &#125; <span class="keyword">else</span> &#123; <span class="number">0</span> &#125;;</span><br><span class="line">                <span class="keyword">let</span> eq = com == i.c();</span><br><span class="line">                <span class="keyword">if</span> eq &#123;</span><br><span class="line">                    as_ci(<span class="keyword">self</span>.ci).pc += <span class="number">1</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">self</span>.set_stack_slot(base + i.a(), b);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            OpCode::JMP =&gt; &#123;</span><br><span class="line">                <span class="keyword">let</span> pc = as_ci(<span class="keyword">self</span>.ci).pc <span class="keyword">as</span> <span class="built_in">i32</span>;</span><br><span class="line">                as_ci(<span class="keyword">self</span>.ci).pc = (pc + i.sbx()) <span class="keyword">as</span> <span class="built_in">u32</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            OpCode::LOADBOO =&gt; &#123;</span><br><span class="line">                <span class="keyword">let</span> base = as_ci(<span class="keyword">self</span>.ci).base;</span><br><span class="line">                <span class="keyword">let</span> b = <span class="keyword">if</span> i.b() == <span class="number">1</span> &#123;</span><br><span class="line">                    <span class="keyword">self</span>.gc.js_true()</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">self</span>.gc.js_false()</span><br><span class="line">                &#125;;</span><br><span class="line">                <span class="keyword">self</span>.set_stack_slot(base + i.a(), as_obj_ptr(b));</span><br><span class="line">                <span class="keyword">if</span> i.c() == <span class="number">1</span> &#123;</span><br><span class="line">                    as_ci(<span class="keyword">self</span>.ci).pc += <span class="number">1</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            OpCode::EQ | OpCode::LT | OpCode::LE =&gt; &#123;</span><br><span class="line">                <span class="keyword">let</span> <span class="keyword">mut</span> ls = LocalScope::new();</span><br><span class="line">                <span class="keyword">let</span> base = as_ci(<span class="keyword">self</span>.ci).base;</span><br><span class="line">                <span class="keyword">let</span> b = <span class="keyword">self</span>.get_stack_item(base + i.b());</span><br><span class="line">                <span class="keyword">let</span> (b, is_new) = <span class="keyword">self</span>.x_rk(base, i.b());</span><br><span class="line">                <span class="keyword">if</span> is_new &#123;</span><br><span class="line">                    ls.reg(b);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">let</span> (c, is_new) = <span class="keyword">self</span>.x_rk(base, i.c());</span><br><span class="line">                <span class="keyword">if</span> is_new &#123;</span><br><span class="line">                    ls.reg(c);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">let</span> com = <span class="keyword">match</span> op &#123;</span><br><span class="line">                    OpCode::EQ =&gt; GcObj::eq(b, c),</span><br><span class="line">                    OpCode::LT =&gt; GcObj::lt(b, c),</span><br><span class="line">                    OpCode::LE =&gt; GcObj::le(b, c),</span><br><span class="line">                    _ =&gt; <span class="built_in">unimplemented!</span>(),</span><br><span class="line">                &#125;;</span><br><span class="line">                <span class="keyword">let</span> com = <span class="keyword">if</span> com &#123; <span class="number">1</span> &#125; <span class="keyword">else</span> &#123; <span class="number">0</span> &#125;;</span><br><span class="line">                <span class="keyword">if</span> com != i.a() &#123;</span><br><span class="line">                    as_ci(<span class="keyword">self</span>.ci).pc += <span class="number">1</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            OpCode::ADD | OpCode::SUB | OpCode::MUL | OpCode::DIV | OpCode::MOD =&gt; &#123;</span><br><span class="line">                <span class="keyword">let</span> <span class="keyword">mut</span> ls = LocalScope::new();</span><br><span class="line">                <span class="keyword">let</span> base = as_ci(<span class="keyword">self</span>.ci).base;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">let</span> (a, is_new) = <span class="keyword">self</span>.x_rk(base, i.b());</span><br><span class="line">                <span class="keyword">if</span> is_new &#123;</span><br><span class="line">                    ls.reg(a);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">let</span> a = as_obj(a).t_num();</span><br><span class="line">                ls.reg(a);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">let</span> (b, is_new) = <span class="keyword">self</span>.x_rk(base, i.c());</span><br><span class="line">                <span class="keyword">if</span> is_new &#123;</span><br><span class="line">                    ls.reg(b);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">let</span> b = as_obj(b).t_num();</span><br><span class="line">                ls.reg(b);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">let</span> v = <span class="keyword">match</span> op &#123;</span><br><span class="line">                    OpCode::ADD =&gt; as_num(a).add(as_num(b)),</span><br><span class="line">                    OpCode::SUB =&gt; as_num(a).sub(as_num(b)),</span><br><span class="line">                    OpCode::MUL =&gt; as_num(a).mul(as_num(b)),</span><br><span class="line">                    OpCode::DIV =&gt; as_num(a).div(as_num(b)),</span><br><span class="line">                    OpCode::MOD =&gt; as_num(a).modulo(as_num(b)),</span><br><span class="line">                    _ =&gt; <span class="built_in">panic!</span>(),</span><br><span class="line">                &#125;;</span><br><span class="line">                ls.reg(v);</span><br><span class="line">                <span class="keyword">self</span>.set_stack_slot(as_ci(<span class="keyword">self</span>.ci).base + i.a(), as_obj_ptr(v));</span><br><span class="line">            &#125;</span><br><span class="line">            OpCode::NEWTABLE =&gt; &#123;</span><br><span class="line">                <span class="keyword">let</span> <span class="keyword">mut</span> ls = LocalScope::new();</span><br><span class="line">                <span class="keyword">let</span> base = as_ci(<span class="keyword">self</span>.ci).base;</span><br><span class="line">                <span class="keyword">let</span> v = <span class="keyword">self</span>.gc.new_dict(<span class="literal">false</span>);</span><br><span class="line">                ls.reg(v);</span><br><span class="line">                <span class="keyword">self</span>.set_stack_slot(base + i.a(), as_obj_ptr(v));</span><br><span class="line">            &#125;</span><br><span class="line">            OpCode::SETTABLE =&gt; &#123;</span><br><span class="line">                <span class="keyword">let</span> <span class="keyword">mut</span> ls = LocalScope::new();</span><br><span class="line">                <span class="keyword">let</span> base = as_ci(<span class="keyword">self</span>.ci).base;</span><br><span class="line">                <span class="keyword">let</span> tb = <span class="keyword">self</span>.get_stack_item(base + i.a());</span><br><span class="line">                <span class="keyword">if</span> !as_obj(tb).check_coercible() &#123;</span><br><span class="line">                    <span class="built_in">panic!</span>(<span class="string">"TypeError"</span>)</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">let</span> tb = as_dict(tb);</span><br><span class="line">                <span class="keyword">let</span> (k, is_new) = <span class="keyword">self</span>.x_rk(base, i.b());</span><br><span class="line">                <span class="keyword">if</span> is_new &#123;</span><br><span class="line">                    ls.reg(k);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">let</span> (v, is_new) = <span class="keyword">self</span>.x_rk(base, i.c());</span><br><span class="line">                <span class="keyword">if</span> is_new &#123;</span><br><span class="line">                    ls.reg(v);</span><br><span class="line">                &#125;</span><br><span class="line">                tb.set(k, v);</span><br><span class="line">            &#125;</span><br><span class="line">            OpCode::GETTABLE =&gt; &#123;</span><br><span class="line">                <span class="keyword">let</span> <span class="keyword">mut</span> ls = LocalScope::new();</span><br><span class="line">                <span class="keyword">let</span> base = as_ci(<span class="keyword">self</span>.ci).base;</span><br><span class="line">                <span class="keyword">let</span> tb = <span class="keyword">self</span>.get_stack_item(base + i.b());</span><br><span class="line">                <span class="keyword">if</span> !as_obj(tb).check_coercible() &#123;</span><br><span class="line">                    <span class="built_in">panic!</span>(<span class="string">"TypeError"</span>)</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// <span class="doctag">TODO:</span>: dispatch to various prop resolve handler(number, string, array)</span></span><br><span class="line">                <span class="keyword">let</span> tb = as_dict(tb);</span><br><span class="line">                <span class="keyword">let</span> (k, is_new) = <span class="keyword">self</span>.x_rk(base, i.c());</span><br><span class="line">                <span class="keyword">if</span> is_new &#123;</span><br><span class="line">                    ls.reg(k);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">let</span> v = tb.get(k);</span><br><span class="line">                <span class="keyword">self</span>.set_stack_slot(base + i.a(), v);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// set this for calling function on object</span></span><br><span class="line">                as_ci(<span class="keyword">self</span>.ci).set_this(as_obj_ptr(tb));</span><br><span class="line">            &#125;</span><br><span class="line">            OpCode::RETURN =&gt; &#123;</span><br><span class="line">                <span class="keyword">let</span> b = i.b();</span><br><span class="line">                <span class="keyword">let</span> <span class="keyword">mut</span> ret_num = b - <span class="number">1</span>;</span><br><span class="line">                <span class="keyword">if</span> as_ci(<span class="keyword">self</span>.ci).is_new &#123;</span><br><span class="line">                    ret_num = <span class="number">1</span>;</span><br><span class="line">                    <span class="keyword">let</span> ret = as_ci(<span class="keyword">self</span>.ci).this;</span><br><span class="line">                    <span class="keyword">self</span>.set_stack_slot(as_ci(<span class="keyword">self</span>.ci).fun, ret);</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> ret_num == <span class="number">1</span> &#123;</span><br><span class="line">                    <span class="keyword">let</span> ret = <span class="keyword">self</span>.get_stack_item(as_ci(<span class="keyword">self</span>.ci).base + i.a());</span><br><span class="line">                    <span class="keyword">self</span>.set_stack_slot(as_ci(<span class="keyword">self</span>.ci).fun, ret);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">self</span>.post_call(ret_num);</span><br><span class="line">            &#125;</span><br><span class="line">            OpCode::CALL =&gt; &#123;</span><br><span class="line">                <span class="keyword">let</span> fi = as_ci(<span class="keyword">self</span>.ci).base + i.a();</span><br><span class="line">                <span class="keyword">let</span> fp = <span class="keyword">self</span>.get_stack_item(fi);</span><br><span class="line">                <span class="built_in">assert_eq!</span>(</span><br><span class="line">                    as_obj(fp).kind,</span><br><span class="line">                    GcObjKind::Function,</span><br><span class="line">                    <span class="string">"Uncaught TypeError: not a function"</span></span><br><span class="line">                );</span><br><span class="line">                <span class="keyword">let</span> f = as_fun(fp);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">let</span> ci = CallInfo::new();</span><br><span class="line">                as_ci(ci).fun = fi;</span><br><span class="line">                as_ci(ci).base = fi + i.b();</span><br><span class="line"></span><br><span class="line">                as_ci(ci).prev = <span class="keyword">self</span>.ci;</span><br><span class="line">                <span class="keyword">let</span> cci = <span class="keyword">self</span>.ci;</span><br><span class="line">                as_ci(cci).next = ci;</span><br><span class="line">                as_ci(ci).set_this(as_ci(cci).this);</span><br><span class="line">                <span class="keyword">self</span>.ci = ci;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> f.is_native &#123;</span><br><span class="line">                    as_ci(ci).is_native = <span class="literal">true</span>;</span><br><span class="line">                    <span class="keyword">unsafe</span> &#123;</span><br><span class="line">                        <span class="keyword">let</span> f = std::mem::transmute::&lt;*<span class="keyword">const</span> c_void, NativeFn&gt;(f.f);</span><br><span class="line">                        f(<span class="keyword">self</span>)</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">self</span>.post_call(i.c() - <span class="number">1</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">let</span> <span class="keyword">mut</span> ls = LocalScope::new();</span><br><span class="line">                    <span class="keyword">let</span> n_args = i.b() - <span class="number">1</span>;</span><br><span class="line">                    <span class="keyword">let</span> r_arg = as_ci(<span class="keyword">self</span>.ci).fun + <span class="number">1</span>;</span><br><span class="line">                    <span class="keyword">let</span> t_arg = as_ci(<span class="keyword">self</span>.ci).base;</span><br><span class="line">                    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="number">0</span>..n_args &#123;</span><br><span class="line">                        <span class="keyword">let</span> <span class="keyword">mut</span> v = <span class="keyword">self</span>.get_stack_item(r_arg + i);</span><br><span class="line">                        <span class="keyword">if</span> as_obj(v).pass_by_value() &#123;</span><br><span class="line">                            v = as_obj(v).x_pass_by_value();</span><br><span class="line">                            ls.reg(v);</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">self</span>.set_stack_slot(t_arg + i, v);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">self</span>.exec();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            OpCode::THIS =&gt; &#123;</span><br><span class="line">                <span class="keyword">let</span> base = as_ci(<span class="keyword">self</span>.ci).base;</span><br><span class="line">                <span class="keyword">let</span> this = as_ci(<span class="keyword">self</span>.ci).this;</span><br><span class="line">                <span class="keyword">self</span>.set_stack_slot(base + i.a(), this);</span><br><span class="line">            &#125;</span><br><span class="line">            OpCode::NEW =&gt; &#123;</span><br><span class="line">                <span class="keyword">let</span> fi = as_ci(<span class="keyword">self</span>.ci).base + i.a();</span><br><span class="line">                <span class="keyword">let</span> fp = <span class="keyword">self</span>.get_stack_item(fi);</span><br><span class="line">                <span class="built_in">assert_eq!</span>(</span><br><span class="line">                    as_obj(fp).kind,</span><br><span class="line">                    GcObjKind::Function,</span><br><span class="line">                    <span class="string">"Uncaught TypeError: not a function"</span></span><br><span class="line">                );</span><br><span class="line">                <span class="keyword">let</span> f = as_fun(fp);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">let</span> ci = CallInfo::new();</span><br><span class="line">                as_ci(ci).fun = fi;</span><br><span class="line">                as_ci(ci).base = fi + i.b();</span><br><span class="line"></span><br><span class="line">                as_ci(ci).prev = <span class="keyword">self</span>.ci;</span><br><span class="line">                <span class="keyword">let</span> cci = <span class="keyword">self</span>.ci;</span><br><span class="line">                as_ci(cci).next = ci;</span><br><span class="line">                <span class="keyword">self</span>.ci = ci;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// we'll implement this later</span></span><br><span class="line">                <span class="keyword">if</span> f.is_native &#123;</span><br><span class="line">                    <span class="built_in">unimplemented!</span>()</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">let</span> <span class="keyword">mut</span> ls = LocalScope::new();</span><br><span class="line">                <span class="keyword">let</span> this = <span class="keyword">self</span>.gc.new_dict(<span class="literal">false</span>);</span><br><span class="line">                ls.reg(this);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">let</span> n_args = i.b() - <span class="number">1</span>;</span><br><span class="line">                <span class="keyword">let</span> r_arg = as_ci(<span class="keyword">self</span>.ci).fun + <span class="number">1</span>;</span><br><span class="line">                <span class="keyword">let</span> t_arg = as_ci(<span class="keyword">self</span>.ci).base;</span><br><span class="line">                <span class="keyword">for</span> i <span class="keyword">in</span> <span class="number">0</span>..n_args &#123;</span><br><span class="line">                    <span class="keyword">let</span> <span class="keyword">mut</span> v = <span class="keyword">self</span>.get_stack_item(r_arg + i);</span><br><span class="line">                    <span class="keyword">if</span> as_obj(v).pass_by_value() &#123;</span><br><span class="line">                        v = as_obj(v).x_pass_by_value();</span><br><span class="line">                        ls.reg(v);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">self</span>.set_stack_slot(t_arg + i, v);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                as_ci(<span class="keyword">self</span>.ci).set_this(as_obj_ptr(this));</span><br><span class="line">                as_ci(<span class="keyword">self</span>.ci).is_new = <span class="literal">true</span>;</span><br><span class="line">                <span class="keyword">self</span>.exec();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// <span class="doctag">TODO:</span>:</span></span><br><span class="line">            _ =&gt; (),</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="literal">Ok</span>(())</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> Vm &#123;</span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">register_native_fn</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, name: &amp;<span class="built_in">str</span>, nf: NativeFn) &#123;</span><br><span class="line">        <span class="keyword">let</span> f = <span class="keyword">self</span>.gc.new_fun_native(nf, <span class="literal">false</span>);</span><br><span class="line">        as_dict(<span class="keyword">self</span>.env).insert(name, as_obj_ptr(f));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[cfg(test)]</span></span><br><span class="line"><span class="keyword">mod</span> exec_tests &#123;</span><br><span class="line">    <span class="keyword">use</span> super::*;</span><br><span class="line">    <span class="keyword">use</span> crate::asm::codegen::*;</span><br><span class="line"></span><br><span class="line">    <span class="meta">#[test]</span></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">exec_init_test</span></span>() &#123;</span><br><span class="line">        <span class="keyword">let</span> chk = Codegen::gen(</span><br><span class="line">            <span class="string">"var a = 1</span></span><br><span class="line"><span class="string">    print(a)</span></span><br><span class="line"><span class="string">    assert(1, a)</span></span><br><span class="line"><span class="string">    print(native_fn())</span></span><br><span class="line"><span class="string">    "</span>,</span><br><span class="line">        );</span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut</span> vm = Vm::new(chk, <span class="number">1024</span>);</span><br><span class="line"></span><br><span class="line">        vm.register_native_fn(<span class="string">"assert"</span>, |vm: VmPtr| &#123;</span><br><span class="line">            <span class="keyword">let</span> args = as_vm(vm).get_args();</span><br><span class="line">            <span class="built_in">assert_eq!</span>(args.len(), <span class="number">2</span>);</span><br><span class="line">            <span class="keyword">let</span> a = args[<span class="number">0</span>];</span><br><span class="line">            <span class="keyword">let</span> b = args[<span class="number">1</span>];</span><br><span class="line">            <span class="built_in">assert_eq!</span>(as_num(a).d, as_num(b).d);</span><br><span class="line">            <span class="built_in">println!</span>(<span class="string">"assert ok"</span>);</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        vm.register_native_fn(<span class="string">"native_fn"</span>, |vm: VmPtr| &#123;</span><br><span class="line">            <span class="keyword">let</span> <span class="keyword">mut</span> ls = LocalScope::new();</span><br><span class="line">            <span class="keyword">let</span> ret = as_vm(vm).gc.new_str(<span class="literal">false</span>);</span><br><span class="line">            ls.reg(ret);</span><br><span class="line">            as_str(ret).d.push_str(<span class="string">"return from native call"</span>);</span><br><span class="line">            as_vm(vm).set_return(as_obj_ptr(ret));</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        vm.exec();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">new_vm</span></span>(chk: Chunk) -&gt; <span class="built_in">Box</span>&lt;Vm&gt; &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut</span> vm = Vm::new(chk, <span class="number">1</span> &lt;&lt; <span class="number">20</span>);</span><br><span class="line"></span><br><span class="line">        vm.register_native_fn(<span class="string">"assert_str_eq"</span>, |vm: VmPtr| &#123;</span><br><span class="line">            <span class="keyword">let</span> args = as_vm(vm).get_args();</span><br><span class="line">            <span class="built_in">assert_eq!</span>(args.len(), <span class="number">2</span>);</span><br><span class="line">            <span class="keyword">let</span> a = args[<span class="number">0</span>];</span><br><span class="line">            <span class="keyword">let</span> b = args[<span class="number">1</span>];</span><br><span class="line">            <span class="built_in">assert_eq!</span>(as_str(a).d, as_str(b).d);</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        vm.register_native_fn(<span class="string">"assert_num_eq"</span>, |vm: VmPtr| &#123;</span><br><span class="line">            <span class="keyword">let</span> args = as_vm(vm).get_args();</span><br><span class="line">            <span class="built_in">assert_eq!</span>(args.len(), <span class="number">2</span>);</span><br><span class="line">            <span class="keyword">let</span> a = args[<span class="number">0</span>];</span><br><span class="line">            <span class="keyword">let</span> b = args[<span class="number">1</span>];</span><br><span class="line">            <span class="built_in">assert_eq!</span>(as_num(a).d, as_num(b).d);</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        vm</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/rust/" rel="tag"># rust</a>
          
            <a href="/tags/javascript-engine/" rel="tag"># javascript engine</a>
          
            <a href="/tags/编译原理/" rel="tag"># 编译原理</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2022/05/17/200行代码实现极简deno/" rel="next" title="200行代码实现极简deno">
                <i class="fa fa-chevron-left"></i> 200行代码实现极简deno
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2022/06/08/使用Rust+WebAssembly来辅助你的JavaScript/" rel="prev" title="使用Rust+WebAssembly来辅助你的JavaScript">
                使用Rust+WebAssembly来辅助你的JavaScript <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>


  </div>


          </div>
          

  
    <div class="comments" id="comments">
      
        <div id="gitment-container"></div>
      
    </div>

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/images/v2-e386393694cb08152bb316fa79bba113_hd.jpg" alt="Akita Summer">
            
              <p class="site-author-name" itemprop="name">Akita Summer</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">23</span>
                    <span class="site-state-item-name">日志</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  <a href="/categories/index.html">
                    
                    
                      
                    
                    <span class="site-state-item-count">1</span>
                    <span class="site-state-item-name">分类</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  <a href="/tags/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">35</span>
                    <span class="site-state-item-name">标签</span>
                  </a>
                </div>
              
            </nav>
          

          

          
            <div class="links-of-author motion-element">
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                    
                  
                  <a href="https://github.com/akitaSummer" title="GitHub &rarr; https://github.com/akitaSummer" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a>
                </span>
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                    
                  
                  <a href="mailto:644171127@qq.com" title="E-Mail &rarr; mailto:644171127@qq.com" rel="noopener" target="_blank"><i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                </span>
              
            </div>
          

          

          
          

          
            
          
          

        </div>
      </div>

      
      <!--noindex-->
        <div class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
            
            
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#前言"><span class="nav-number">1.</span> <span class="nav-text">前言</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#设计"><span class="nav-number">2.</span> <span class="nav-text">设计</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#词法解析"><span class="nav-number">3.</span> <span class="nav-text">词法解析</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#token-设计"><span class="nav-number">3.1.</span> <span class="nav-text">token 设计</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#字符流处理"><span class="nav-number">3.2.</span> <span class="nav-text">字符流处理</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#lexer"><span class="nav-number">3.3.</span> <span class="nav-text">lexer</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#语法解析"><span class="nav-number">4.</span> <span class="nav-text">语法解析</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#AST"><span class="nav-number">4.1.</span> <span class="nav-text">AST</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#parser"><span class="nav-number">4.2.</span> <span class="nav-text">parser</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Visitor"><span class="nav-number">4.3.</span> <span class="nav-text">Visitor</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#代码生成"><span class="nav-number">5.</span> <span class="nav-text">代码生成</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#chunk"><span class="nav-number">5.1.</span> <span class="nav-text">chunk</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#symtab"><span class="nav-number">5.2.</span> <span class="nav-text">symtab</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#codegen"><span class="nav-number">5.3.</span> <span class="nav-text">codegen</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#vm"><span class="nav-number">6.</span> <span class="nav-text">vm</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#gc"><span class="nav-number">6.1.</span> <span class="nav-text">gc</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#GcObj-相关方法"><span class="nav-number">6.2.</span> <span class="nav-text">GcObj 相关方法</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#exec"><span class="nav-number">6.3.</span> <span class="nav-text">exec</span></a></li></ol></li></ol></div>
            

          </div>
        </div>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2023</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Akita Summer</span>

  

  
</div>

<!--
  <div class="powered-by">由 <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> 强力驱动 v3.8.0</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 – <a href="https://theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a> v7.0.0</div>
-->



        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

    

    
  </div>

  

<script>
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  <script src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>


  


  <script src="/js/src/utils.js?v=7.0.0"></script>

  <script src="/js/src/motion.js?v=7.0.0"></script>



  
  


  <script src="/js/src/affix.js?v=7.0.0"></script>

  <script src="/js/src/schemes/pisces.js?v=7.0.0"></script>



  
  <script src="/js/src/scrollspy.js?v=7.0.0"></script>
<script src="/js/src/post-details.js?v=7.0.0"></script>



  


  <script src="/js/src/bootstrap.js?v=7.0.0"></script>



  


  
    <!-- LOCAL: You can save these files to your site and update links -->

  
  <script src="https://cdn.jsdelivr.net/gh/theme-next/theme-next-gitment@1/gitmint.browser.js"></script>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/theme-next/theme-next-gitment@1/default.css">
<!-- END LOCAL -->

<style>
#gitment-container a {
  border-bottom: none;
}

</style>

<script>
  function renderGitment() {
    var gitment = new Gitmint({
      id: window.location.pathname,
      owner: 'akitaSummer',
      repo: 'blogComment',
      
        lang: '' || navigator.language || navigator.systemLanguage || navigator.userLanguage,
      
      oauth: {
      
      
        client_secret: '624f365dba9bccb32867a185a2cf65556335f06e',
      
        client_id: 'f433f680d31e0d644e2c'
      }
    });
    gitment.render('gitment-container');
  }

  
    renderGitment();
  
</script>

  


  





  

  

  

  

  

  

  

  

  

  

  

  

  

</body>
</html>
