<!DOCTYPE html>












  


<html class="theme-next pisces use-motion" lang="zh-CN">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">


























<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2">

<link rel="stylesheet" href="/css/main.css?v=7.0.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=7.0.0">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=7.0.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=7.0.0">


  <link rel="mask-icon" href="/images/logo.svg?v=7.0.0" color="#222">







<script id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '7.0.0',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="前言本文是在 ollama 使用之后，对其内部实现进行的简易解析。 ollama 的项目目录如下：123456789101112131415161718192021222324252627282930.├── api // go api client├── app // 桌面应用程序├── auth // 鉴权├── cmd // 命令和相关的处理程序├── convert├── docs├──">
<meta name="keywords" content="golang,ollama,llama.cpp">
<meta property="og:type" content="article">
<meta property="og:title" content="ollama源码浅析">
<meta property="og:url" content="https://akitaSummer.github.io/2024/07/21/ollama源码浅析/index.html">
<meta property="og:site_name" content="Akita Summer&#39;s Blog">
<meta property="og:description" content="前言本文是在 ollama 使用之后，对其内部实现进行的简易解析。 ollama 的项目目录如下：123456789101112131415161718192021222324252627282930.├── api // go api client├── app // 桌面应用程序├── auth // 鉴权├── cmd // 命令和相关的处理程序├── convert├── docs├──">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="https://akitasummer.github.io/image/ollama/ollama.png">
<meta property="og:updated_time" content="2024-07-21T21:06:51.897Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="ollama源码浅析">
<meta name="twitter:description" content="前言本文是在 ollama 使用之后，对其内部实现进行的简易解析。 ollama 的项目目录如下：123456789101112131415161718192021222324252627282930.├── api // go api client├── app // 桌面应用程序├── auth // 鉴权├── cmd // 命令和相关的处理程序├── convert├── docs├──">
<meta name="twitter:image" content="https://akitasummer.github.io/image/ollama/ollama.png">






  <link rel="canonical" href="https://akitaSummer.github.io/2024/07/21/ollama源码浅析/">



<script id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>ollama源码浅析 | Akita Summer's Blog</title>
  












  <noscript>
  <style>
  .use-motion .motion-element,
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-title { opacity: initial; }

  .use-motion .logo,
  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>


</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"><a href="https://github.com/akitaSummer" class="github-corner" aria-label="View source on GitHub"><svg width="80" height="80" viewbox="0 0 250 250" style="fill:#151513; color:#fff; position: absolute; top: 0; border: 0; right: 0;" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"/><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"/><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"/></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Akita Summer's Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="切换导航栏">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">

    
    
    
      
    

    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br>首页</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">

    
    
    
      
    

    

    <a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i> <br>标签</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-categories">

    
    
    
      
    

    

    <a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i> <br>分类</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">

    
    
    
      
    

    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br>归档</a>

  </li>

      
      
    </ul>
  

  

  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
            

          
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://akitaSummer.github.io/2024/07/21/ollama源码浅析/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Akita Summer">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/v2-e386393694cb08152bb316fa79bba113_hd.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Akita Summer's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">ollama源码浅析

              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2024-07-21 23:37:35" itemprop="dateCreated datePublished" datetime="2024-07-21T23:37:35+08:00">2024-07-21</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2024-07-22 05:06:51" itemprop="dateModified" datetime="2024-07-22T05:06:51+08:00">2024-07-22</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/学习笔记/" itemprop="url" rel="index"><span itemprop="name">学习笔记</span></a></span>

                
                
              
            </span>
          

          
            
            
              
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
            
                <a href="/2024/07/21/ollama源码浅析/#comments" itemprop="discussionUrl">
                  <span class="post-meta-item-text">评论数：</span> <span class="post-comments-count gitment-comments-count" data-xid="/2024/07/21/ollama源码浅析/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>本文是在 ollama 使用之后，对其内部实现进行的简易解析。</p>
<p>ollama 的项目目录如下：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">.</span><br><span class="line">├── api // go api client</span><br><span class="line">├── app // 桌面应用程序</span><br><span class="line">├── auth // 鉴权</span><br><span class="line">├── cmd // 命令和相关的处理程序</span><br><span class="line">├── convert</span><br><span class="line">├── docs</span><br><span class="line">├── envconfig</span><br><span class="line">├── examples</span><br><span class="line">├── format</span><br><span class="line">├── gpu // GPU 的检测</span><br><span class="line">├── integration // 集成测试</span><br><span class="line">├── llm // 用于运行 llama.cpp 的实现</span><br><span class="line">├── macapp // mac 桌面应用程序</span><br><span class="line">├── openai // 用于 ollama 的 OpenAI API 兼容封装</span><br><span class="line">├── parser // Modelfile 解析器</span><br><span class="line">├── progress // 显示加载进度</span><br><span class="line">├── readline // 从终端读取输入</span><br><span class="line">├── scripts // 构建和发布的脚本</span><br><span class="line">├── server // go web server</span><br><span class="line">├── template</span><br><span class="line">├── types</span><br><span class="line">├── util</span><br><span class="line">├── version</span><br><span class="line">├── main.go // 入口</span><br><span class="line">├── Dockerfile</span><br><span class="line">├── LICENSE</span><br><span class="line">├── README.md</span><br><span class="line">├── go.mod</span><br><span class="line">└── go.sum</span><br></pre></td></tr></table></figure></p>
<p>ollama 的架构简单图<br><img src="/image/ollama/ollama.png" alt="architecture"></p>
<h1 id="APIs"><a href="#APIs" class="headerlink" title="APIs"></a>APIs</h1><p>go项目的入口一般是 <code>main.go</code> , ollama 的非常简单，就是注册命令行</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">"context"</span></span><br><span class="line"></span><br><span class="line">	<span class="string">"github.com/ollama/ollama/cmd"</span></span><br><span class="line">	<span class="string">"github.com/spf13/cobra"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	cobra.CheckErr(cmd.NewCLI().ExecuteContext(context.Background()))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们可以在 <code>cmd/</code> 下找到 NewCLI 的实现<br><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewCLI</span><span class="params">()</span> *<span class="title">cobra</span>.<span class="title">Command</span></span> &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">	createCmd := &amp;cobra.Command&#123;</span><br><span class="line">		Use:     <span class="string">"create MODEL"</span>,</span><br><span class="line">		Short:   <span class="string">"Create a model from a Modelfile"</span>,</span><br><span class="line">		Args:    cobra.ExactArgs(<span class="number">1</span>),</span><br><span class="line">		PreRunE: checkServerHeartbeat,</span><br><span class="line">		RunE:    CreateHandler,</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	createCmd.Flags().StringP(<span class="string">"file"</span>, <span class="string">"f"</span>, <span class="string">"Modelfile"</span>, <span class="string">"Name of the Modelfile"</span>)</span><br><span class="line">	createCmd.Flags().StringP(<span class="string">"quantize"</span>, <span class="string">"q"</span>, <span class="string">""</span>, <span class="string">"Quantize model to this level (e.g. q4_0)"</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">	runCmd := &amp;cobra.Command&#123;</span><br><span class="line">		Use:     <span class="string">"run MODEL [PROMPT]"</span>,</span><br><span class="line">		Short:   <span class="string">"Run a model"</span>,</span><br><span class="line">		Args:    cobra.MinimumNArgs(<span class="number">1</span>),</span><br><span class="line">		PreRunE: checkServerHeartbeat,</span><br><span class="line">		RunE:    RunHandler,</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	runCmd.Flags().String(<span class="string">"keepalive"</span>, <span class="string">""</span>, <span class="string">"Duration to keep a model loaded (e.g. 5m)"</span>)</span><br><span class="line">	runCmd.Flags().Bool(<span class="string">"verbose"</span>, <span class="literal">false</span>, <span class="string">"Show timings for response"</span>)</span><br><span class="line">	runCmd.Flags().Bool(<span class="string">"insecure"</span>, <span class="literal">false</span>, <span class="string">"Use an insecure registry"</span>)</span><br><span class="line">	runCmd.Flags().Bool(<span class="string">"nowordwrap"</span>, <span class="literal">false</span>, <span class="string">"Don't wrap words to the next line automatically"</span>)</span><br><span class="line">	runCmd.Flags().String(<span class="string">"format"</span>, <span class="string">""</span>, <span class="string">"Response format (e.g. json)"</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">	rootCmd.AddCommand(</span><br><span class="line">		serveCmd,</span><br><span class="line">		createCmd,</span><br><span class="line">		showCmd,</span><br><span class="line">		runCmd,</span><br><span class="line">		pullCmd,</span><br><span class="line">		pushCmd,</span><br><span class="line">		listCmd,</span><br><span class="line">		psCmd,</span><br><span class="line">		copyCmd,</span><br><span class="line">		deleteCmd,</span><br><span class="line">	)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> rootCmd</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>我们来看下最常用的 create 和 run 方法<br><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">CreateHandler</span><span class="params">(cmd *cobra.Command, args []<span class="keyword">string</span>)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">        <span class="comment">// 创建与 golang server 通信的 client</span></span><br><span class="line">	client, err := api.ClientFromEnvironment()</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">        <span class="comment">// 读 modelfile</span></span><br><span class="line">	f, err := os.Open(filename)</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">	modelfile, err := parser.ParseFile(f)</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">	<span class="keyword">for</span> i := <span class="keyword">range</span> modelfile.Commands &#123;</span><br><span class="line">		<span class="keyword">switch</span> modelfile.Commands[i].Name &#123;</span><br><span class="line">		<span class="keyword">case</span> <span class="string">"model"</span>, <span class="string">"adapter"</span>:</span><br><span class="line">			path := modelfile.Commands[i].Args</span><br><span class="line">                        <span class="comment">// ...</span></span><br><span class="line">                        <span class="comment">// 计算 model 文件 hash 以及将其内容上传给 server</span></span><br><span class="line">			digest, err := createBlob(cmd, client, path)</span><br><span class="line">			<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">				<span class="keyword">return</span> err</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			modelfile.Commands[i].Args = <span class="string">"@"</span> + digest</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">	request := api.CreateRequest&#123;Name: args[<span class="number">0</span>], Modelfile: modelfile.String(), Quantize: quantize&#125;</span><br><span class="line">	<span class="keyword">if</span> err := client.Create(cmd.Context(), &amp;request, fn); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">createBlob</span><span class="params">(cmd *cobra.Command, client *api.Client, path <span class="keyword">string</span>)</span> <span class="params">(<span class="keyword">string</span>, error)</span></span> &#123;</span><br><span class="line">	bin, err := os.Open(path)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="string">""</span>, err</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">defer</span> bin.Close()</span><br><span class="line"></span><br><span class="line">	hash := sha256.New()</span><br><span class="line">	<span class="keyword">if</span> _, err := io.Copy(hash, bin); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="string">""</span>, err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> _, err := bin.Seek(<span class="number">0</span>, io.SeekStart); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="string">""</span>, err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	digest := fmt.Sprintf(<span class="string">"sha256:%x"</span>, hash.Sum(<span class="literal">nil</span>))</span><br><span class="line">	<span class="keyword">if</span> err = client.CreateBlob(cmd.Context(), digest, bin); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="string">""</span>, err</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> digest, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>create 方法做的事情就是将 model 文件注册上传到 server<br><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">RunHandler</span><span class="params">(cmd *cobra.Command, args []<span class="keyword">string</span>)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	interactive := <span class="literal">true</span></span><br><span class="line">	<span class="comment">// 初始化选项和变量</span></span><br><span class="line">	opts := runOptions&#123;</span><br><span class="line">		Model:    args[<span class="number">0</span>],</span><br><span class="line">		WordWrap: os.Getenv(<span class="string">"TERM"</span>) == <span class="string">"xterm-256color"</span>,</span><br><span class="line">		Options:  <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">interface</span>&#123;&#125;&#123;&#125;,</span><br><span class="line">	&#125;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">        <span class="comment">// 从 server 获取模型信息</span></span><br><span class="line">	name := args[<span class="number">0</span>]</span><br><span class="line">	info, err := <span class="function"><span class="keyword">func</span><span class="params">()</span> <span class="params">(*api.ShowResponse, error)</span></span> &#123;</span><br><span class="line">		showReq := &amp;api.ShowRequest&#123;Name: name&#125;</span><br><span class="line">		info, err := client.Show(cmd.Context(), showReq)</span><br><span class="line">		<span class="keyword">var</span> se api.StatusError</span><br><span class="line">                <span class="comment">// 没有就 pull 下来</span></span><br><span class="line">		<span class="keyword">if</span> errors.As(err, &amp;se) &amp;&amp; se.StatusCode == http.StatusNotFound &#123;</span><br><span class="line">			<span class="keyword">if</span> err := PullHandler(cmd, []<span class="keyword">string</span>&#123;name&#125;); err != <span class="literal">nil</span> &#123;</span><br><span class="line">				<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">return</span> client.Show(cmd.Context(), &amp;api.ShowRequest&#123;Name: name&#125;)</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> info, err</span><br><span class="line">	&#125;()</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	opts.MultiModal = slices.Contains(info.Details.Families, <span class="string">"clip"</span>)</span><br><span class="line">	opts.ParentModel = info.Details.ParentModel</span><br><span class="line">	opts.Messages = <span class="built_in">append</span>(opts.Messages, info.Messages...)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> interactive &#123;</span><br><span class="line">		<span class="keyword">return</span> generateInteractive(cmd, opts)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> generate(cmd, opts)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">generate</span><span class="params">(cmd *cobra.Command, opts runOptions)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">	sigChan := <span class="built_in">make</span>(<span class="keyword">chan</span> os.Signal, <span class="number">1</span>)</span><br><span class="line">	signal.Notify(sigChan, syscall.SIGINT)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">		&lt;-sigChan</span><br><span class="line">		cancel()</span><br><span class="line">	&#125;()</span><br><span class="line"></span><br><span class="line">	<span class="keyword">var</span> state *displayResponseState = &amp;displayResponseState&#123;&#125;</span><br><span class="line"></span><br><span class="line">	fn := <span class="function"><span class="keyword">func</span><span class="params">(response api.GenerateResponse)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">		p.StopAndClear()</span><br><span class="line"></span><br><span class="line">		latest = response</span><br><span class="line">		content := response.Response</span><br><span class="line"></span><br><span class="line">		displayResponse(content, opts.WordWrap, state)</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> opts.MultiModal &#123;</span><br><span class="line">		opts.Prompt, opts.Images, err = extractFileData(opts.Prompt)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> err</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	request := api.GenerateRequest&#123;</span><br><span class="line">		Model:     opts.Model,</span><br><span class="line">		Prompt:    opts.Prompt,</span><br><span class="line">		Context:   generateContext,</span><br><span class="line">		Images:    opts.Images,</span><br><span class="line">		Format:    opts.Format,</span><br><span class="line">		System:    opts.System,</span><br><span class="line">		Options:   opts.Options,</span><br><span class="line">		KeepAlive: opts.KeepAlive,</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 让 server 处理， 得到返回值后调用 fn</span></span><br><span class="line">	<span class="keyword">if</span> err := client.Generate(ctx, &amp;request, fn); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">if</span> errors.Is(err, context.Canceled) &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h1 id="Go-server"><a href="#Go-server" class="headerlink" title="Go server"></a>Go server</h1><p>与 APIs 通信的 server 代码都在 <code>server/*</code> 文件夹下，它使用了 Gin 作为 server 端<br><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Serve</span><span class="params">(ln net.Listener)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">        <span class="comment">// 日志</span></span><br><span class="line">	level := slog.LevelInfo</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">        <span class="comment">// 二进制文件夹</span></span><br><span class="line">	blobsDir, err := GetBlobsPath(<span class="string">""</span>)</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">	ctx, done := context.WithCancel(context.Background())</span><br><span class="line">	schedCtx, schedDone := context.WithCancel(ctx)</span><br><span class="line">        <span class="comment">// 调度器，加载模型创建 llm server ，处理请求</span></span><br><span class="line">	sched := InitScheduler(schedCtx)</span><br><span class="line">	s := &amp;Server&#123;addr: ln.Addr(), sched: sched&#125;</span><br><span class="line">        <span class="comment">// 路由注册</span></span><br><span class="line">	http.Handle(<span class="string">"/"</span>, s.GenerateRoutes())</span><br><span class="line"></span><br><span class="line">	slog.Info(fmt.Sprintf(<span class="string">"Listening on %s (version %s)"</span>, ln.Addr(), version.Version))</span><br><span class="line">	srvr := &amp;http.Server&#123;</span><br><span class="line">		<span class="comment">// Use http.DefaultServeMux so we get net/http/pprof for</span></span><br><span class="line">		<span class="comment">// free.</span></span><br><span class="line">		<span class="comment">//</span></span><br><span class="line">		<span class="comment">// TODO(bmizerany): Decide if we want to make this</span></span><br><span class="line">		<span class="comment">// configurable so it is not exposed by default, or allow</span></span><br><span class="line">		<span class="comment">// users to bind it to a different port. This was a quick</span></span><br><span class="line">		<span class="comment">// and easy way to get pprof, but it may not be the best</span></span><br><span class="line">		<span class="comment">// way.</span></span><br><span class="line">		Handler: <span class="literal">nil</span>,</span><br><span class="line">	&#125;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 启动 llm server</span></span><br><span class="line">	<span class="keyword">if</span> err := llm.Init(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> fmt.Errorf(<span class="string">"unable to initialize llm library %w"</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line">        <span class="comment">// 启两个协程，processPending 和 processCompleted</span></span><br><span class="line">        <span class="comment">// processPending 待处理请求，确定是否需要加载新的模型或使用已加载的模型。它会根据当前的GPU使用情况和模型加载状态，决定是否需要卸载某个已加载的模型以腾出空间。</span></span><br><span class="line">        <span class="comment">// processCompleted 已完成的请求，更新模型的引用计数，并根据模型的会话持续时间决定是否设置一个过期定时器以便在会话结束后卸载模型。</span></span><br><span class="line">	s.sched.Run(schedCtx)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// At startup we retrieve GPU information so we can get log messages before loading a model</span></span><br><span class="line">	<span class="comment">// This will log warnings to the log in case we have problems with detected GPUs</span></span><br><span class="line">	gpus := gpu.GetGPUInfo()</span><br><span class="line">	gpus.LogDetails()</span><br><span class="line"></span><br><span class="line">	err = srvr.Serve(ln)</span><br><span class="line">	<span class="comment">// If server is closed from the signal handler, wait for the ctx to be done</span></span><br><span class="line">	<span class="comment">// otherwise error out quickly</span></span><br><span class="line">	<span class="keyword">if</span> !errors.Is(err, http.ErrServerClosed) &#123;</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line">	&lt;-ctx.Done()</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>接下来我们还是以 create 和 run 为例<br><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *Server)</span> <span class="title">CreateModelHandler</span><span class="params">(c *gin.Context)</span></span> &#123;</span><br><span class="line">	<span class="keyword">var</span> r api.CreateRequest</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">	f, err := parser.ParseFile(sr)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		c.AbortWithStatusJSON(http.StatusBadRequest, gin.H&#123;<span class="string">"error"</span>: err.Error()&#125;)</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	ch := <span class="built_in">make</span>(<span class="keyword">chan</span> any)</span><br><span class="line">	<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">		<span class="keyword">defer</span> <span class="built_in">close</span>(ch)</span><br><span class="line">		fn := <span class="function"><span class="keyword">func</span><span class="params">(resp api.ProgressResponse)</span></span> &#123;</span><br><span class="line">			ch &lt;- resp</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		ctx, cancel := context.WithCancel(c.Request.Context())</span><br><span class="line">		<span class="keyword">defer</span> cancel()</span><br><span class="line"></span><br><span class="line">		quantization := cmp.Or(r.Quantize, r.Quantization)</span><br><span class="line">                <span class="comment">// 创建模型</span></span><br><span class="line">		<span class="keyword">if</span> err := CreateModel(ctx, name, filepath.Dir(r.Path), strings.ToUpper(quantization), f, fn); err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">if</span> errors.Is(err, errBadTemplate) &#123;</span><br><span class="line">			  ch &lt;- gin.H&#123;<span class="string">"error"</span>: err.Error(), <span class="string">"status"</span>: http.StatusBadRequest&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			ch &lt;- gin.H&#123;<span class="string">"error"</span>: err.Error()&#125;</span><br><span class="line">		  &#125;</span><br><span class="line">	&#125;()</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> r.Stream != <span class="literal">nil</span> &amp;&amp; !*r.Stream &#123;</span><br><span class="line">		waitForStream(c, ch)</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	streamResponse(c, ch)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 解析 modelfile 创建每一层，每层生成一个 hash 二进制，生成一个 manifest 记录信息</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">CreateModel</span><span class="params">(ctx context.Context, name model.Name, modelFileDir, quantization <span class="keyword">string</span>, modelfile *parser.File, fn <span class="keyword">func</span>(resp api.ProgressResponse)</span>) <span class="params">(err error)</span></span> &#123;</span><br><span class="line">	config := ConfigV2&#123;</span><br><span class="line">		OS:           <span class="string">"linux"</span>,</span><br><span class="line">		Architecture: <span class="string">"amd64"</span>,</span><br><span class="line">		RootFS: RootFS&#123;</span><br><span class="line">			Type: <span class="string">"layers"</span>,</span><br><span class="line">		&#125;,</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">var</span> messages []*api.Message</span><br><span class="line">	parameters := <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">string</span>]any)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">var</span> layers []*Layer</span><br><span class="line">	<span class="keyword">for</span> _, c := <span class="keyword">range</span> modelfile.Commands &#123;</span><br><span class="line">		mediatype := fmt.Sprintf(<span class="string">"application/vnd.ollama.image.%s"</span>, c.Name)</span><br><span class="line"></span><br><span class="line">		<span class="keyword">switch</span> c.Name &#123;</span><br><span class="line">		<span class="keyword">case</span> <span class="string">"model"</span>, <span class="string">"adapter"</span>:</span><br><span class="line">                        <span class="comment">// ...</span></span><br><span class="line">		<span class="keyword">case</span> <span class="string">"license"</span>, <span class="string">"template"</span>, <span class="string">"system"</span>:</span><br><span class="line">                        <span class="comment">// ...</span></span><br><span class="line">		<span class="keyword">case</span> <span class="string">"message"</span>:</span><br><span class="line">			role, content, ok := strings.Cut(c.Args, <span class="string">": "</span>)</span><br><span class="line">			<span class="keyword">if</span> !ok &#123;</span><br><span class="line">				<span class="keyword">return</span> fmt.Errorf(<span class="string">"invalid message: %s"</span>, c.Args)</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			messages = <span class="built_in">append</span>(messages, &amp;api.Message&#123;Role: role, Content: content&#125;)</span><br><span class="line">		<span class="keyword">default</span>:</span><br><span class="line">			ps, err := api.FormatParams(<span class="keyword">map</span>[<span class="keyword">string</span>][]<span class="keyword">string</span>&#123;c.Name: &#123;c.Args&#125;&#125;)</span><br><span class="line">			<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">				<span class="keyword">return</span> err</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="keyword">for</span> k, v := <span class="keyword">range</span> ps &#123;</span><br><span class="line">				<span class="keyword">if</span> ks, ok := parameters[k].([]<span class="keyword">string</span>); ok &#123;</span><br><span class="line">					parameters[k] = <span class="built_in">append</span>(ks, v.([]<span class="keyword">string</span>)...)</span><br><span class="line">				&#125; <span class="keyword">else</span> <span class="keyword">if</span> vs, ok := v.([]<span class="keyword">string</span>); ok &#123;</span><br><span class="line">					parameters[k] = vs</span><br><span class="line">				&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">					parameters[k] = v</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">var</span> err2 error</span><br><span class="line">	layers = slices.DeleteFunc(layers, <span class="function"><span class="keyword">func</span><span class="params">(layer *Layer)</span> <span class="title">bool</span></span> &#123;</span><br><span class="line">                <span class="comment">// ...</span></span><br><span class="line">	&#125;)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> err2 != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> err2</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(messages) &gt; <span class="number">0</span> &#123;</span><br><span class="line">		<span class="keyword">var</span> b bytes.Buffer</span><br><span class="line">		<span class="keyword">if</span> err := json.NewEncoder(&amp;b).Encode(messages); err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> err</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		layer, err := NewLayer(&amp;b, <span class="string">"application/vnd.ollama.image.messages"</span>)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> err</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		layers = <span class="built_in">append</span>(layers, layer)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(parameters) &gt; <span class="number">0</span> &#123;</span><br><span class="line">		<span class="keyword">var</span> b bytes.Buffer</span><br><span class="line">		<span class="keyword">if</span> err := json.NewEncoder(&amp;b).Encode(parameters); err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> err</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		layer, err := NewLayer(&amp;b, <span class="string">"application/vnd.ollama.image.params"</span>)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> err</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		layers = <span class="built_in">append</span>(layers, layer)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	digests := <span class="built_in">make</span>([]<span class="keyword">string</span>, <span class="built_in">len</span>(layers))</span><br><span class="line">	<span class="keyword">for</span> i, layer := <span class="keyword">range</span> layers &#123;</span><br><span class="line">		digests[i] = layer.Digest</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	config.RootFS.DiffIDs = digests</span><br><span class="line"></span><br><span class="line">	<span class="keyword">var</span> b bytes.Buffer</span><br><span class="line">	<span class="keyword">if</span> err := json.NewEncoder(&amp;b).Encode(config); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	layer, err := NewLayer(&amp;b, <span class="string">"application/vnd.docker.container.image.v1+json"</span>)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> _, layer := <span class="keyword">range</span> <span class="built_in">append</span>(layers, layer) &#123;</span><br><span class="line">		<span class="keyword">if</span> layer.status != <span class="string">""</span> &#123;</span><br><span class="line">			fn(api.ProgressResponse&#123;Status: layer.status&#125;)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	old, _ := ParseNamedManifest(name)</span><br><span class="line"></span><br><span class="line">	fn(api.ProgressResponse&#123;Status: <span class="string">"writing manifest"</span>&#125;)</span><br><span class="line">	<span class="keyword">if</span> err := WriteManifest(name, layer, layers); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> !envconfig.NoPrune &amp;&amp; old != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">if</span> err := old.RemoveLayers(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> err</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	fn(api.ProgressResponse&#123;Status: <span class="string">"success"</span>&#125;)</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>create 逻辑比较简单，即解析 modelfile 后，形成层结构，每一层保存，通过 manifest 记录<br><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *Server)</span> <span class="title">GenerateHandler</span><span class="params">(c *gin.Context)</span></span> &#123;</span><br><span class="line">	checkpointStart := time.Now()</span><br><span class="line">	<span class="keyword">var</span> req api.GenerateRequest</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">	caps := []Capability&#123;CapabilityCompletion&#125;</span><br><span class="line">	<span class="keyword">if</span> req.Suffix != <span class="string">""</span> &#123;</span><br><span class="line">		caps = <span class="built_in">append</span>(caps, CapabilityInsert)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 调度一个 llm.LlamaServer 实例</span></span><br><span class="line">	r, m, opts, err := s.scheduleRunner(c.Request.Context(), req.Model, caps, req.Options, req.KeepAlive)</span><br><span class="line">	<span class="keyword">if</span> errors.Is(err, errCapabilityCompletion) &#123;</span><br><span class="line">		c.JSON(http.StatusBadRequest, gin.H&#123;<span class="string">"error"</span>: fmt.Sprintf(<span class="string">"%q does not support generate"</span>, req.Model)&#125;)</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		handleScheduleError(c, req.Model, err)</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">	images := <span class="built_in">make</span>([]llm.ImageData, <span class="built_in">len</span>(req.Images))</span><br><span class="line">	<span class="keyword">for</span> i := <span class="keyword">range</span> req.Images &#123;</span><br><span class="line">		images[i] = llm.ImageData&#123;ID: i, Data: req.Images[i]&#125;</span><br><span class="line">	&#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 生成提示词</span></span><br><span class="line">	prompt := req.Prompt</span><br><span class="line">	<span class="keyword">if</span> !req.Raw &#123;</span><br><span class="line">		tmpl := m.Template</span><br><span class="line">                <span class="comment">// ...</span></span><br><span class="line">                <span class="comment">// 用了 template 包处理</span></span><br><span class="line">		prompt = b.String()</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	slog.Debug(<span class="string">"generate request"</span>, <span class="string">"prompt"</span>, prompt, <span class="string">"images"</span>, images)</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 跟 LlamaServer  通信，获取 Completion 结果</span></span><br><span class="line">	ch := <span class="built_in">make</span>(<span class="keyword">chan</span> any)</span><br><span class="line">	<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">		<span class="comment">// TODO (jmorganca): avoid building the response twice both here and below</span></span><br><span class="line">		<span class="keyword">var</span> sb strings.Builder</span><br><span class="line">		<span class="keyword">defer</span> <span class="built_in">close</span>(ch)</span><br><span class="line">		<span class="keyword">if</span> err := r.Completion(c.Request.Context(), llm.CompletionRequest&#123;</span><br><span class="line">			Prompt:  prompt,</span><br><span class="line">			Images:  images,</span><br><span class="line">			Format:  req.Format,</span><br><span class="line">			Options: opts,</span><br><span class="line">		&#125;, <span class="function"><span class="keyword">func</span><span class="params">(cr llm.CompletionResponse)</span></span> &#123;</span><br><span class="line">			res := api.GenerateResponse&#123;</span><br><span class="line">				Model:      req.Model,</span><br><span class="line">				CreatedAt:  time.Now().UTC(),</span><br><span class="line">				Response:   cr.Content,</span><br><span class="line">				Done:       cr.Done,</span><br><span class="line">				DoneReason: cr.DoneReason,</span><br><span class="line">				Metrics: api.Metrics&#123;</span><br><span class="line">					PromptEvalCount:    cr.PromptEvalCount,</span><br><span class="line">					PromptEvalDuration: cr.PromptEvalDuration,</span><br><span class="line">					EvalCount:          cr.EvalCount,</span><br><span class="line">					EvalDuration:       cr.EvalDuration,</span><br><span class="line">				&#125;,</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="keyword">if</span> _, err := sb.WriteString(cr.Content); err != <span class="literal">nil</span> &#123;</span><br><span class="line">				ch &lt;- gin.H&#123;<span class="string">"error"</span>: err.Error()&#125;</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="keyword">if</span> cr.Done &#123;</span><br><span class="line">				res.TotalDuration = time.Since(checkpointStart)</span><br><span class="line">				res.LoadDuration = checkpointLoaded.Sub(checkpointStart)</span><br><span class="line"></span><br><span class="line">				<span class="keyword">if</span> !req.Raw &#123;</span><br><span class="line">					tokens, err := r.Tokenize(c.Request.Context(), prompt+sb.String())</span><br><span class="line">					<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">						ch &lt;- gin.H&#123;<span class="string">"error"</span>: err.Error()&#125;</span><br><span class="line">						<span class="keyword">return</span></span><br><span class="line">					&#125;</span><br><span class="line">					res.Context = <span class="built_in">append</span>(req.Context, tokens...)</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			ch &lt;- res</span><br><span class="line">		&#125;); err != <span class="literal">nil</span> &#123;</span><br><span class="line">			ch &lt;- gin.H&#123;<span class="string">"error"</span>: err.Error()&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;()</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 将 response 返回</span></span><br><span class="line">	<span class="keyword">if</span> req.Stream != <span class="literal">nil</span> &amp;&amp; !*req.Stream &#123;</span><br><span class="line">		<span class="keyword">var</span> r api.GenerateResponse</span><br><span class="line">		<span class="keyword">var</span> sb strings.Builder</span><br><span class="line">		<span class="keyword">for</span> rr := <span class="keyword">range</span> ch &#123;</span><br><span class="line">			<span class="keyword">switch</span> t := rr.(<span class="keyword">type</span>) &#123;</span><br><span class="line">			<span class="keyword">case</span> api.GenerateResponse:</span><br><span class="line">				sb.WriteString(t.Response)</span><br><span class="line">				r = t</span><br><span class="line">			<span class="keyword">case</span> gin.H:</span><br><span class="line">				msg, ok := t[<span class="string">"error"</span>].(<span class="keyword">string</span>)</span><br><span class="line">				<span class="keyword">if</span> !ok &#123;</span><br><span class="line">					msg = <span class="string">"unexpected error format in response"</span></span><br><span class="line">				&#125;</span><br><span class="line"></span><br><span class="line">				c.JSON(http.StatusInternalServerError, gin.H&#123;<span class="string">"error"</span>: msg&#125;)</span><br><span class="line">				<span class="keyword">return</span></span><br><span class="line">			<span class="keyword">default</span>:</span><br><span class="line">				c.JSON(http.StatusInternalServerError, gin.H&#123;<span class="string">"error"</span>: <span class="string">"unexpected response"</span>&#125;)</span><br><span class="line">				<span class="keyword">return</span></span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		r.Response = sb.String()</span><br><span class="line">		c.JSON(http.StatusOK, r)</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	streamResponse(c, ch)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *Scheduler)</span> <span class="title">processPending</span><span class="params">(ctx context.Context)</span></span> &#123;</span><br><span class="line">	<span class="keyword">for</span> &#123;</span><br><span class="line">		<span class="keyword">select</span> &#123;</span><br><span class="line">		<span class="keyword">case</span> &lt;-ctx.Done():</span><br><span class="line">			<span class="comment">// 如果上下文被取消，记录日志并退出循环</span></span><br><span class="line">			slog.Debug(<span class="string">"shutting down scheduler pending loop"</span>)</span><br><span class="line">			<span class="keyword">return</span></span><br><span class="line">		<span class="keyword">case</span> pending := &lt;-s.pendingReqCh:</span><br><span class="line">			<span class="comment">// 从挂起请求通道中获取挂起请求</span></span><br><span class="line">			<span class="comment">// 阻止其他请求，直到这个挂起请求被处理</span></span><br><span class="line">			pending.schedAttempts++</span><br><span class="line">			<span class="keyword">if</span> pending.origNumCtx == <span class="number">0</span> &#123;</span><br><span class="line">				pending.origNumCtx = pending.opts.NumCtx</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="comment">// 检查请求的上下文是否已取消</span></span><br><span class="line">			<span class="keyword">if</span> pending.ctx.Err() != <span class="literal">nil</span> &#123;</span><br><span class="line">				slog.Debug(<span class="string">"pending request cancelled or timed out, skipping scheduling"</span>)</span><br><span class="line">				<span class="keyword">continue</span></span><br><span class="line">			&#125;</span><br><span class="line">			numParallel := envconfig.NumParallel</span><br><span class="line">			<span class="comment">// TODO (jmorganca): multimodal models don't support parallel yet</span></span><br><span class="line">			<span class="comment">// see https://github.com/ollama/ollama/issues/4165</span></span><br><span class="line">			<span class="keyword">if</span> <span class="built_in">len</span>(pending.model.ProjectorPaths) &gt; <span class="number">0</span> &amp;&amp; numParallel != <span class="number">1</span> &#123;</span><br><span class="line">				numParallel = <span class="number">1</span></span><br><span class="line">				slog.Warn(<span class="string">"multimodal models don't support parallel requests yet"</span>)</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="comment">// 内部循环，尝试加载模型并处理请求</span></span><br><span class="line">			<span class="keyword">for</span> &#123;</span><br><span class="line">				<span class="keyword">var</span> runnerToExpire *runnerRef</span><br><span class="line">				s.loadedMu.Lock()</span><br><span class="line">				runner := s.loaded[pending.model.ModelPath]</span><br><span class="line">				loadedCount := <span class="built_in">len</span>(s.loaded)</span><br><span class="line">				s.loadedMu.Unlock()</span><br><span class="line">				<span class="keyword">if</span> runner != <span class="literal">nil</span> &#123;</span><br><span class="line">					<span class="comment">// 如果运行器存在且需要重新加载，将其标记为需要过期</span></span><br><span class="line">					<span class="keyword">if</span> runner.needsReload(ctx, pending) &#123;</span><br><span class="line">						runnerToExpire = runner</span><br><span class="line">					&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">						<span class="comment">// 如果运行器可用，使用它处理请求</span></span><br><span class="line">						pending.useLoadedRunner(runner, s.finishedReqCh)</span><br><span class="line">						<span class="keyword">break</span></span><br><span class="line">					&#125;</span><br><span class="line">				&#125; <span class="keyword">else</span> <span class="keyword">if</span> envconfig.MaxRunners &gt; <span class="number">0</span> &amp;&amp; loadedCount &gt;= envconfig.MaxRunners &#123;</span><br><span class="line">					<span class="comment">// 如果已达到最大运行器数量，尝试卸载一个现有的运行器</span></span><br><span class="line">					slog.Debug(<span class="string">"max runners achieved, unloading one to make room"</span>, <span class="string">"runner_count"</span>, loadedCount)</span><br><span class="line">					runnerToExpire = s.findRunnerToUnload()</span><br><span class="line">				&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">					<span class="comment">// 获取最新的 GPU 列表</span></span><br><span class="line">					<span class="keyword">var</span> gpus gpu.GpuInfoList</span><br><span class="line">					<span class="keyword">if</span> pending.opts.NumGPU == <span class="number">0</span> &#123;</span><br><span class="line">						gpus = s.getCpuFn()</span><br><span class="line">					&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">						gpus = s.getGpuFn()</span><br><span class="line">					&#125;</span><br><span class="line"></span><br><span class="line">					<span class="comment">// 根据系统内存情况决定是否卸载其他模型以腾出空间</span></span><br><span class="line">					<span class="keyword">if</span> envconfig.MaxRunners &lt;= <span class="number">0</span> &#123;</span><br><span class="line">						<span class="comment">// 如果未指定 MaxRunners，根据 GPU 的可靠性自动设置</span></span><br><span class="line">						allReliable := <span class="literal">true</span></span><br><span class="line">						<span class="keyword">for</span> _, gpu := <span class="keyword">range</span> gpus &#123;</span><br><span class="line">							<span class="keyword">if</span> gpu.UnreliableFreeMemory &#123;</span><br><span class="line">								allReliable = <span class="literal">false</span></span><br><span class="line">								<span class="keyword">break</span></span><br><span class="line">							&#125;</span><br><span class="line">						&#125;</span><br><span class="line">						<span class="keyword">if</span> allReliable &#123;</span><br><span class="line">							envconfig.MaxRunners = defaultModelsPerGPU * <span class="built_in">len</span>(gpus)</span><br><span class="line">							slog.Debug(<span class="string">"updating default concurrency"</span>, <span class="string">"OLLAMA_MAX_LOADED_MODELS"</span>, envconfig.MaxRunners, <span class="string">"gpu_count"</span>, <span class="built_in">len</span>(gpus))</span><br><span class="line">						&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">							slog.Info(<span class="string">"one or more GPUs detected that are unable to accurately report free memory - disabling default concurrency"</span>)</span><br><span class="line">							envconfig.MaxRunners = <span class="built_in">len</span>(gpus)</span><br><span class="line">						&#125;</span><br><span class="line">					&#125;</span><br><span class="line"></span><br><span class="line">					<span class="comment">// 加载模型</span></span><br><span class="line">					ggml, err := llm.LoadModel(pending.model.ModelPath, <span class="number">0</span>)</span><br><span class="line">					<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">						pending.errCh &lt;- err</span><br><span class="line">						<span class="keyword">break</span></span><br><span class="line">					&#125;</span><br><span class="line"></span><br><span class="line">					<span class="comment">// 检查模型是否适合在系统内存中加载，或者是否需要先卸载一个模型</span></span><br><span class="line">					<span class="keyword">if</span> <span class="built_in">len</span>(gpus) == <span class="number">1</span> &amp;&amp; gpus[<span class="number">0</span>].Library == <span class="string">"cpu"</span> &#123;</span><br><span class="line">						<span class="keyword">if</span> numParallel &lt;= <span class="number">0</span> &#123;</span><br><span class="line">							numParallel = defaultParallel</span><br><span class="line">						&#125;</span><br><span class="line"></span><br><span class="line">						pending.opts.NumCtx = pending.origNumCtx * numParallel</span><br><span class="line"></span><br><span class="line">						<span class="keyword">if</span> loadedCount == <span class="number">0</span> &#123;</span><br><span class="line">							slog.Debug(<span class="string">"cpu mode with first model, loading"</span>)</span><br><span class="line">							s.loadFn(pending, ggml, gpus, numParallel)</span><br><span class="line">							<span class="keyword">break</span></span><br><span class="line">						&#125;</span><br><span class="line">						runnerToExpire = s.maybeFindCPURunnerToUnload(pending, ggml, gpus)</span><br><span class="line">						<span class="keyword">if</span> runnerToExpire == <span class="literal">nil</span> &#123;</span><br><span class="line">							slog.Debug(<span class="string">"cpu mode with available system memory or first model, loading"</span>)</span><br><span class="line">							s.loadFn(pending, ggml, gpus, numParallel)</span><br><span class="line">							<span class="keyword">break</span></span><br><span class="line">						&#125;</span><br><span class="line">					&#125; <span class="keyword">else</span> <span class="keyword">if</span> loadedCount == <span class="number">0</span> &#123;</span><br><span class="line">						<span class="comment">// 如果没有加载的模型，加载新模型并选择最佳适配的 GPU</span></span><br><span class="line">						slog.Debug(<span class="string">"loading first model"</span>, <span class="string">"model"</span>, pending.model.ModelPath)</span><br><span class="line">						g := pickBestFitGPUs(pending, ggml, gpus, &amp;numParallel)</span><br><span class="line">						<span class="keyword">if</span> g != <span class="literal">nil</span> &#123;</span><br><span class="line">							gpus = g</span><br><span class="line">						&#125;</span><br><span class="line">						s.loadFn(pending, ggml, gpus, numParallel)</span><br><span class="line">						<span class="keyword">break</span></span><br><span class="line">					&#125;</span><br><span class="line"></span><br><span class="line">					<span class="keyword">if</span> runnerToExpire == <span class="literal">nil</span> &#123;</span><br><span class="line">						<span class="comment">// 检查新模型是否适合在现有的 GPU 上加载</span></span><br><span class="line">						availGpus := s.filterGPUsWithoutLoadingModels(gpus)</span><br><span class="line">						s.updateFreeSpace(availGpus)</span><br><span class="line">						fitGpus := pickBestFitGPUs(pending, ggml, availGpus, &amp;numParallel)</span><br><span class="line">						<span class="keyword">if</span> fitGpus != <span class="literal">nil</span> &#123;</span><br><span class="line">							slog.Debug(<span class="string">"new model fits with existing models, loading"</span>)</span><br><span class="line">							s.loadFn(pending, ggml, fitGpus, numParallel)</span><br><span class="line">							<span class="keyword">break</span></span><br><span class="line">						&#125;</span><br><span class="line"></span><br><span class="line">						<span class="comment">// 如果找不到适合的新 GPU，推迟请求处理并重新排队</span></span><br><span class="line">						<span class="keyword">if</span> <span class="built_in">len</span>(availGpus) &lt; <span class="built_in">len</span>(gpus) &#123;</span><br><span class="line">							<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">								slog.Debug(<span class="string">"delaying scheduling while other models finish loading"</span>, <span class="string">"attempts"</span>, pending.schedAttempts, <span class="string">"model"</span>, pending.model.ModelPath)</span><br><span class="line">								time.Sleep(s.reschedDelay)</span><br><span class="line">								s.pendingReqCh &lt;- pending</span><br><span class="line">							&#125;()</span><br><span class="line">							<span class="keyword">break</span></span><br><span class="line">						&#125;</span><br><span class="line">						runnerToExpire = s.findRunnerToUnload()</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line"></span><br><span class="line">				<span class="keyword">if</span> runnerToExpire == <span class="literal">nil</span> &#123;</span><br><span class="line">					slog.Error(<span class="string">"runner to expire was nil!"</span>)</span><br><span class="line">					<span class="keyword">continue</span></span><br><span class="line">				&#125;</span><br><span class="line">				<span class="comment">// 触发过期以卸载运行器</span></span><br><span class="line">				runnerToExpire.refMu.Lock()</span><br><span class="line">				slog.Debug(<span class="string">"resetting model to expire immediately to make room"</span>, <span class="string">"modelPath"</span>, runnerToExpire.modelPath, <span class="string">"refCount"</span>, runnerToExpire.refCount)</span><br><span class="line">				<span class="keyword">if</span> runnerToExpire.expireTimer != <span class="literal">nil</span> &#123;</span><br><span class="line">					runnerToExpire.expireTimer.Stop()</span><br><span class="line">					runnerToExpire.expireTimer = <span class="literal">nil</span></span><br><span class="line">				&#125;</span><br><span class="line">				runnerToExpire.sessionDuration = <span class="number">0</span></span><br><span class="line">				<span class="keyword">if</span> runnerToExpire.refCount &lt;= <span class="number">0</span> &#123;</span><br><span class="line">					s.expiredCh &lt;- runnerToExpire</span><br><span class="line">				&#125;</span><br><span class="line">				runnerToExpire.refMu.Unlock()</span><br><span class="line">				<span class="comment">// 等待卸载完成</span></span><br><span class="line">				slog.Debug(<span class="string">"waiting for pending requests to complete and unload to occur"</span>, <span class="string">"modelPath"</span>, runnerToExpire.modelPath)</span><br><span class="line">				<span class="keyword">select</span> &#123;</span><br><span class="line">				<span class="keyword">case</span> &lt;-ctx.Done():</span><br><span class="line">					slog.Debug(<span class="string">"shutting down scheduler pending loop"</span>)</span><br><span class="line">					<span class="keyword">return</span></span><br><span class="line">				<span class="keyword">case</span> &lt;-s.unloadedCh:</span><br><span class="line">					slog.Debug(<span class="string">"unload completed"</span>, <span class="string">"modelPath"</span>, runnerToExpire.modelPath)</span><br><span class="line">					<span class="keyword">continue</span></span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		<span class="keyword">case</span> &lt;-s.unloadedCh:</span><br><span class="line">			<span class="comment">// 如果没有挂起请求，忽略卸载事件</span></span><br><span class="line">			slog.Debug(<span class="string">"ignoring unload event with no pending requests"</span>)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>run 主要是根据用户的 req 使用调度器，获取到对应的 llm server ，将 llm server 生成的数据返回</p>
<h1 id="llm-server"><a href="#llm-server" class="headerlink" title="llm server"></a>llm server</h1><p>ollama 中运行 LLM 的核心是 <a href="https://github.com/ggerganov/llama.cpp" target="_blank" rel="noopener">llama.cpp</a>，是开发者 Georgi Gerganov 基于 Meta 的 LLaMA 模型 手写的纯 C/C++ 版本：支持CPU推理,当然也支持CUDA/OpenCL推理、具有 FP16 和 FP32 的混合精度、支持8-bit/4bit量化…</p>
<p>如果想更深入了解可以看看<a href="https://zhuanlan.zhihu.com/p/649756898" target="_blank" rel="noopener">Llama 2详解</a>和<a href="https://zhuanlan.zhihu.com/p/665027154" target="_blank" rel="noopener">llama.cpp源码解析–CUDA流程版本</a></p>
<p>本文仅分析 ollama 中如何使用。</p>
<p><code>llama.cpp</code> 与常见 C 或 C++ 项目一样使用 <code>cmake</code> 来处理编译、链接等工作。但是 <code>ollama</code> 本身是一个 go 项目，使用的是 go 构建系统编译、链接和打包其余部分，以生成 <code>ollama</code> 的应用程序和 cli。</p>
<p>通过利用 <a href="https://go.dev/blog/generate" target="_blank" rel="noopener">go generate</a>，让 go 编译系统还可以运行调用 cmake 的命令来构建 <code>llama.cpp</code>。代码位于 <code>llm/generate/*</code> 下，比如 macos：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> generate</span><br><span class="line"></span><br><span class="line"><span class="comment">//go:generate bash ./gen_darwin.sh</span></span><br></pre></td></tr></table></figure></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># gen_common.sh</span></span><br><span class="line"><span class="comment"># common logic across linux and darwin</span></span><br><span class="line"><span class="function"><span class="title">init_vars</span></span>() &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">"<span class="variable">$&#123;GOARCH&#125;</span>"</span> <span class="keyword">in</span></span><br><span class="line">    <span class="string">"amd64"</span>)</span><br><span class="line">        ARCH=<span class="string">"x86_64"</span></span><br><span class="line">        ;;</span><br><span class="line">    <span class="string">"arm64"</span>)</span><br><span class="line">        ARCH=<span class="string">"arm64"</span></span><br><span class="line">        ;;</span><br><span class="line">    *)</span><br><span class="line">        ARCH=$(uname -m | sed -e <span class="string">"s/aarch64/arm64/g"</span>)</span><br><span class="line">    <span class="keyword">esac</span></span><br><span class="line">    <span class="comment"># 设置 LLAMACPP 目录和 CMake 默认定义</span></span><br><span class="line">    LLAMACPP_DIR=../llama.cpp</span><br><span class="line">    CMAKE_DEFS=<span class="string">""</span></span><br><span class="line">    CMAKE_TARGETS=<span class="string">"--target ollama_llama_server"</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 根据 CGO_CFLAGS 中是否包含 -g 设置 CMake 构建类型</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">echo</span> <span class="string">"<span class="variable">$&#123;CGO_CFLAGS&#125;</span>"</span> | grep -- <span class="string">'-g'</span> &gt;/dev/null; <span class="keyword">then</span></span><br><span class="line">        CMAKE_DEFS=<span class="string">"-DCMAKE_BUILD_TYPE=RelWithDebInfo -DCMAKE_VERBOSE_MAKEFILE=on -DLLAMA_GPROF=on -DLLAMA_SERVER_VERBOSE=on <span class="variable">$&#123;CMAKE_DEFS&#125;</span>"</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        CMAKE_DEFS=<span class="string">"-DCMAKE_BUILD_TYPE=Release -DLLAMA_SERVER_VERBOSE=off <span class="variable">$&#123;CMAKE_DEFS&#125;</span>"</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 根据系统类型设置库扩展名和编译选项</span></span><br><span class="line">    <span class="keyword">case</span> $(uname -s) <span class="keyword">in</span></span><br><span class="line">    <span class="string">"Darwin"</span>)</span><br><span class="line">        LIB_EXT=<span class="string">"dylib"</span></span><br><span class="line">        WHOLE_ARCHIVE=<span class="string">"-Wl,-force_load"</span></span><br><span class="line">        NO_WHOLE_ARCHIVE=<span class="string">""</span></span><br><span class="line">        GCC_ARCH=<span class="string">"-arch <span class="variable">$&#123;ARCH&#125;</span>"</span></span><br><span class="line">        ;;</span><br><span class="line">    <span class="string">"Linux"</span>)</span><br><span class="line">        LIB_EXT=<span class="string">"so"</span></span><br><span class="line">        WHOLE_ARCHIVE=<span class="string">"-Wl,--whole-archive"</span></span><br><span class="line">        NO_WHOLE_ARCHIVE=<span class="string">"-Wl,--no-whole-archive"</span></span><br><span class="line">        GCC_ARCH=<span class="string">""</span></span><br><span class="line">        ;;</span><br><span class="line">    *)</span><br><span class="line">        ;;</span><br><span class="line">    <span class="keyword">esac</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 设置 CUDA 架构</span></span><br><span class="line">    <span class="keyword">if</span> [ -z <span class="string">"<span class="variable">$&#123;CMAKE_CUDA_ARCHITECTURES&#125;</span>"</span> ] ; <span class="keyword">then</span></span><br><span class="line">        CMAKE_CUDA_ARCHITECTURES=<span class="string">"50;52;61;70;75;80"</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">git_module_setup</span></span>() &#123;</span><br><span class="line">    <span class="keyword">if</span> [ -n <span class="string">"<span class="variable">$&#123;OLLAMA_SKIP_PATCHING&#125;</span>"</span> ]; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">"Skipping submodule initialization"</span></span><br><span class="line">        <span class="built_in">return</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 如果存在旧的子模块目录，先删除</span></span><br><span class="line">    <span class="keyword">if</span> [ -d <span class="string">"<span class="variable">$&#123;LLAMACPP_DIR&#125;</span>/gguf"</span> ]; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">"Cleaning up old submodule"</span></span><br><span class="line">        rm -rf <span class="variable">$&#123;LLAMACPP_DIR&#125;</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 初始化并更新子模块</span></span><br><span class="line">    git submodule init</span><br><span class="line">    git submodule update --force <span class="variable">$&#123;LLAMACPP_DIR&#125;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">apply_patches</span></span>() &#123;</span><br><span class="line">    <span class="comment"># 修改 CMakeLists.txt 文件，添加子目录</span></span><br><span class="line">    <span class="keyword">if</span> ! grep ollama <span class="variable">$&#123;LLAMACPP_DIR&#125;</span>/CMakeLists.txt; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">'add_subdirectory(../ext_server ext_server) # ollama'</span> &gt;&gt;<span class="variable">$&#123;LLAMACPP_DIR&#125;</span>/CMakeLists.txt</span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 如果存在补丁文件，应用这些补丁</span></span><br><span class="line">    <span class="keyword">if</span> [ -n <span class="string">"<span class="variable">$(ls -A ../patches/*.diff)</span>"</span> ]; <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">for</span> patch <span class="keyword">in</span> ../patches/*.diff; <span class="keyword">do</span></span><br><span class="line">            <span class="keyword">for</span> file <span class="keyword">in</span> $(grep <span class="string">"^+++ "</span> <span class="variable">$&#123;patch&#125;</span> | cut -f2 -d<span class="string">' '</span> | cut -f2- -d/); <span class="keyword">do</span></span><br><span class="line">                (<span class="built_in">cd</span> <span class="variable">$&#123;LLAMACPP_DIR&#125;</span>; git checkout <span class="variable">$&#123;file&#125;</span>)</span><br><span class="line">            <span class="keyword">done</span></span><br><span class="line">        <span class="keyword">done</span></span><br><span class="line">        <span class="keyword">for</span> patch <span class="keyword">in</span> ../patches/*.diff; <span class="keyword">do</span></span><br><span class="line">            (<span class="built_in">cd</span> <span class="variable">$&#123;LLAMACPP_DIR&#125;</span> &amp;&amp; git apply <span class="variable">$&#123;patch&#125;</span>)</span><br><span class="line">        <span class="keyword">done</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">build</span></span>() &#123;</span><br><span class="line">    cmake -S <span class="variable">$&#123;LLAMACPP_DIR&#125;</span> -B <span class="variable">$&#123;BUILD_DIR&#125;</span> <span class="variable">$&#123;CMAKE_DEFS&#125;</span></span><br><span class="line">    cmake --build <span class="variable">$&#123;BUILD_DIR&#125;</span> <span class="variable">$&#123;CMAKE_TARGETS&#125;</span> -j8</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="title">compress</span></span>() &#123;</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"Compressing payloads to reduce overall binary size..."</span></span><br><span class="line">    pids=<span class="string">""</span></span><br><span class="line">    rm -rf <span class="variable">$&#123;BUILD_DIR&#125;</span>/bin/*.gz</span><br><span class="line">    <span class="keyword">for</span> f <span class="keyword">in</span> <span class="variable">$&#123;BUILD_DIR&#125;</span>/bin/* ; <span class="keyword">do</span></span><br><span class="line">        gzip -n --best -f <span class="variable">$&#123;f&#125;</span> &amp;</span><br><span class="line">        pids+=<span class="string">" $!"</span></span><br><span class="line">    <span class="keyword">done</span></span><br><span class="line">    <span class="comment"># 检查 lib 目录并压缩其中的文件</span></span><br><span class="line">    <span class="keyword">if</span> [ -d <span class="variable">$&#123;BUILD_DIR&#125;</span>/lib ]; <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">for</span> f <span class="keyword">in</span> <span class="variable">$&#123;BUILD_DIR&#125;</span>/lib/* ; <span class="keyword">do</span></span><br><span class="line">            gzip -n --best -f <span class="variable">$&#123;f&#125;</span> &amp;</span><br><span class="line">            pids+=<span class="string">" $!"</span></span><br><span class="line">        <span class="keyword">done</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">    <span class="built_in">echo</span></span><br><span class="line">    <span class="keyword">for</span> pid <span class="keyword">in</span> <span class="variable">$&#123;pids&#125;</span>; <span class="keyword">do</span></span><br><span class="line">        <span class="built_in">wait</span> <span class="variable">$pid</span></span><br><span class="line">    <span class="keyword">done</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"Finished compression"</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Keep the local tree clean after we're done with the build</span></span><br><span class="line"><span class="function"><span class="title">cleanup</span></span>() &#123;</span><br><span class="line">    (<span class="built_in">cd</span> <span class="variable">$&#123;LLAMACPP_DIR&#125;</span>/ &amp;&amp; git checkout CMakeLists.txt)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> [ -n <span class="string">"<span class="variable">$(ls -A ../patches/*.diff)</span>"</span> ]; <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">for</span> patch <span class="keyword">in</span> ../patches/*.diff; <span class="keyword">do</span></span><br><span class="line">            <span class="keyword">for</span> file <span class="keyword">in</span> $(grep <span class="string">"^+++ "</span> <span class="variable">$&#123;patch&#125;</span> | cut -f2 -d<span class="string">' '</span> | cut -f2- -d/); <span class="keyword">do</span></span><br><span class="line">                (<span class="built_in">cd</span> <span class="variable">$&#123;LLAMACPP_DIR&#125;</span>; git checkout <span class="variable">$&#123;file&#125;</span>)</span><br><span class="line">            <span class="keyword">done</span></span><br><span class="line">        <span class="keyword">done</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># gen_darwin.sh</span></span><br><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment"># This script is intended to run inside the go generate</span></span><br><span class="line"><span class="comment"># working directory must be ./llm/generate/</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># TODO - add hardening to detect missing tools (cmake, etc.)</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">set</span> -ex</span><br><span class="line"><span class="comment"># 打开错误检测和命令显示模式，以及命令管道失败检测</span></span><br><span class="line"><span class="built_in">set</span> -o pipefail</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"Starting darwin generate script"</span></span><br><span class="line"><span class="comment"># 引入通用的生成脚本</span></span><br><span class="line"><span class="built_in">source</span> $(dirname <span class="variable">$0</span>)/gen_common.sh</span><br><span class="line"><span class="comment"># 初始化变量</span></span><br><span class="line">init_vars</span><br><span class="line"><span class="comment"># 设置 Git 子模块</span></span><br><span class="line">git_module_setup</span><br><span class="line"><span class="comment"># 应用补丁</span></span><br><span class="line">apply_patches</span><br><span class="line"></span><br><span class="line"><span class="comment"># 签名函数，如果 APPLE_IDENTITY 环境变量被设置，就会对生成的文件进行代码签名</span></span><br><span class="line"><span class="function"><span class="title">sign</span></span>() &#123;</span><br><span class="line">    <span class="keyword">if</span> [ -n <span class="string">"<span class="variable">$APPLE_IDENTITY</span>"</span> ]; <span class="keyword">then</span></span><br><span class="line">        codesign -f --timestamp --deep --options=runtime --sign <span class="string">"<span class="variable">$APPLE_IDENTITY</span>"</span> --identifier ai.ollama.ollama <span class="variable">$1</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 定义通用的 macOS 构建选项</span></span><br><span class="line">COMMON_DARWIN_DEFS=<span class="string">"-DBUILD_SHARED_LIBS=off -DCMAKE_OSX_DEPLOYMENT_TARGET=11.3 -DLLAMA_METAL_MACOSX_VERSION_MIN=11.3 -DCMAKE_SYSTEM_NAME=Darwin -DGGML_METAL_EMBED_LIBRARY=on -DGGML_OPENMP=off"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 根据 GOARCH 变量选择构建架构</span></span><br><span class="line"><span class="keyword">case</span> <span class="string">"<span class="variable">$&#123;GOARCH&#125;</span>"</span> <span class="keyword">in</span></span><br><span class="line"><span class="string">"amd64"</span>)</span><br><span class="line">    <span class="comment"># 定义 amd64 架构的通用选项</span></span><br><span class="line">    COMMON_CPU_DEFS=<span class="string">"<span class="variable">$&#123;COMMON_DARWIN_DEFS&#125;</span> -DCMAKE_SYSTEM_PROCESSOR=<span class="variable">$&#123;ARCH&#125;</span> -DCMAKE_OSX_ARCHITECTURES=<span class="variable">$&#123;ARCH&#125;</span> -DGGML_METAL=off -DGGML_NATIVE=off"</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 静态链接构建，用于 Go 二进制文件的链接</span></span><br><span class="line">    init_vars</span><br><span class="line">    CMAKE_TARGETS=<span class="string">"--target llama --target ggml"</span></span><br><span class="line">    CMAKE_DEFS=<span class="string">"<span class="variable">$&#123;COMMON_CPU_DEFS&#125;</span> -DGGML_BLAS=off -DGGML_ACCELERATE=off -DGGML_AVX=off -DGGML_AVX2=off -DGGML_AVX512=off -DGGML_FMA=off -DGGML_F16C=off <span class="variable">$&#123;CMAKE_DEFS&#125;</span>"</span></span><br><span class="line">    BUILD_DIR=<span class="string">"../build/darwin/<span class="variable">$&#123;ARCH&#125;</span>_static"</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"Building static library"</span></span><br><span class="line">    build</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> [ -z <span class="string">"<span class="variable">$OLLAMA_SKIP_CPU_GENERATE</span>"</span> ]; <span class="keyword">then</span></span><br><span class="line">        <span class="comment"># 构建最低要求 CPU 版本，确保最大兼容性（包括 Rosetta）</span></span><br><span class="line">        init_vars</span><br><span class="line">        CMAKE_DEFS=<span class="string">"<span class="variable">$&#123;COMMON_CPU_DEFS&#125;</span> -DGGML_ACCELERATE=off -DGGML_BLAS=off -DGGML_AVX=off -DGGML_AVX2=off -DGGML_AVX512=off -DGGML_FMA=off -DGGML_F16C=off <span class="variable">$&#123;CMAKE_DEFS&#125;</span>"</span></span><br><span class="line">        BUILD_DIR=<span class="string">"../build/darwin/<span class="variable">$&#123;ARCH&#125;</span>/cpu"</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">"Building LCD CPU"</span></span><br><span class="line">        build</span><br><span class="line">        sign <span class="variable">$&#123;BUILD_DIR&#125;</span>/bin/ollama_llama_server</span><br><span class="line">        compress</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 构建支持 AVX 指令集的版本，提高性能</span></span><br><span class="line">        init_vars</span><br><span class="line">        CMAKE_DEFS=<span class="string">"<span class="variable">$&#123;COMMON_CPU_DEFS&#125;</span> -DGGML_ACCELERATE=off -DGGML_BLAS=off -DGGML_AVX=on -DGGML_AVX2=off -DGGML_AVX512=off -DGGML_FMA=off -DGGML_F16C=off <span class="variable">$&#123;CMAKE_DEFS&#125;</span>"</span></span><br><span class="line">        BUILD_DIR=<span class="string">"../build/darwin/<span class="variable">$&#123;ARCH&#125;</span>/cpu_avx"</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">"Building AVX CPU"</span></span><br><span class="line">        build</span><br><span class="line">        sign <span class="variable">$&#123;BUILD_DIR&#125;</span>/bin/ollama_llama_server</span><br><span class="line">        compress</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 构建支持 AVX2 和其他指令集的版本，进一步提高性能</span></span><br><span class="line">        init_vars</span><br><span class="line">        CMAKE_DEFS=<span class="string">"<span class="variable">$&#123;COMMON_CPU_DEFS&#125;</span> -DGGML_ACCELERATE=on -DGGML_BLAS=off -DGGML_AVX=on -DGGML_AVX2=on -DGGML_AVX512=off -DGGML_FMA=on -DGGML_F16C=on <span class="variable">$&#123;CMAKE_DEFS&#125;</span>"</span></span><br><span class="line">        BUILD_DIR=<span class="string">"../build/darwin/<span class="variable">$&#123;ARCH&#125;</span>/cpu_avx2"</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">"Building AVX2 CPU"</span></span><br><span class="line">        EXTRA_LIBS=<span class="string">"<span class="variable">$&#123;EXTRA_LIBS&#125;</span> -framework Accelerate -framework Foundation"</span></span><br><span class="line">        build</span><br><span class="line">        sign <span class="variable">$&#123;BUILD_DIR&#125;</span>/bin/ollama_llama_server</span><br><span class="line">        compress</span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">    ;;</span><br><span class="line"><span class="string">"arm64"</span>)</span><br><span class="line">    <span class="comment"># 静态链接构建，用于 Go 二进制文件的链接</span></span><br><span class="line">    init_vars</span><br><span class="line">    CMAKE_TARGETS=<span class="string">"--target llama --target ggml"</span></span><br><span class="line">    CMAKE_DEFS=<span class="string">"<span class="variable">$&#123;COMMON_DARWIN_DEFS&#125;</span> -DCMAKE_OSX_DEPLOYMENT_TARGET=11.3 -DCMAKE_SYSTEM_NAME=Darwin -DCMAKE_SYSTEM_PROCESSOR=<span class="variable">$&#123;ARCH&#125;</span> -DCMAKE_OSX_ARCHITECTURES=<span class="variable">$&#123;ARCH&#125;</span> <span class="variable">$&#123;CMAKE_DEFS&#125;</span>"</span></span><br><span class="line">    BUILD_DIR=<span class="string">"../build/darwin/<span class="variable">$&#123;ARCH&#125;</span>_static"</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"Building static library"</span></span><br><span class="line">    build</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> [ -z <span class="string">"<span class="variable">$OLLAMA_SKIP_METAL_GENERATE</span>"</span> ]; <span class="keyword">then</span></span><br><span class="line">        <span class="comment"># 构建支持 Metal 框架的版本，提高性能</span></span><br><span class="line">        init_vars</span><br><span class="line">        CMAKE_DEFS=<span class="string">"<span class="variable">$&#123;COMMON_DARWIN_DEFS&#125;</span> -DCMAKE_SYSTEM_PROCESSOR=<span class="variable">$&#123;ARCH&#125;</span> -DCMAKE_OSX_ARCHITECTURES=<span class="variable">$&#123;ARCH&#125;</span> <span class="variable">$&#123;CMAKE_DEFS&#125;</span>"</span></span><br><span class="line">        BUILD_DIR=<span class="string">"../build/darwin/<span class="variable">$&#123;ARCH&#125;</span>/metal"</span></span><br><span class="line">        EXTRA_LIBS=<span class="string">"<span class="variable">$&#123;EXTRA_LIBS&#125;</span> -framework Accelerate -framework Foundation -framework Metal -framework MetalKit -framework MetalPerformanceShaders"</span></span><br><span class="line">        build</span><br><span class="line">        sign <span class="variable">$&#123;BUILD_DIR&#125;</span>/bin/ollama_llama_server</span><br><span class="line">        compress</span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">    ;;</span><br><span class="line">*)</span><br><span class="line">    <span class="comment"># 如果未设置 GOARCH 或设置了不支持的值，输出错误并退出</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"GOARCH must be set"</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"this script is meant to be run from within go generate"</span></span><br><span class="line">    <span class="built_in">exit</span> 1</span><br><span class="line">    ;;</span><br><span class="line"><span class="keyword">esac</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 清理临时文件和目录</span></span><br><span class="line">cleanup</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"go generate completed.  LLM runners: <span class="variable">$(cd $&#123;BUILD_DIR&#125;/..; echo *)</span>"</span></span><br></pre></td></tr></table></figure>
<p>简单来说，就是</p>
<ul>
<li>初始化变量，为编译做准备</li>
<li>CMAKE_TARGETS 将把构建目标设置为 ext_server</li>
<li>执行 build 调用 cmake</li>
</ul>
<p>cmake 编译后，它将生成一个 ollama_llama_server 动态链接库（.dll/.so/.dylib）,将作为可执行二进制文件嵌入 go 程序。</p>
<p>我们先看下 ollama_llama_server 做了什么<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// own arguments required by this example</span></span><br><span class="line">    gpt_params params;</span><br><span class="line">    server_params sparams;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// struct that contains llama context and inference</span></span><br><span class="line">    llama_server_context llama;</span><br><span class="line"></span><br><span class="line">    server_params_parse(argc, argv, sparams, params);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (params.model_alias == <span class="string">"unknown"</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        params.model_alias = params.model;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 初始化 AVX/CUDA ...</span></span><br><span class="line">    llama_backend_init();</span><br><span class="line">    <span class="comment">// 初始化 NUMA</span></span><br><span class="line">    llama_numa_init(params.numa);</span><br><span class="line"></span><br><span class="line">    httplib::Server svr;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">std</span>::atomic&lt;server_state&gt; state&#123;SERVER_STATE_LOADING_MODEL&#125;;</span><br><span class="line"></span><br><span class="line">    svr.set_default_headers(&#123;&#123;<span class="string">"Server"</span>, <span class="string">"llama.cpp"</span>&#125;&#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// CORS preflight</span></span><br><span class="line">    svr.Options(<span class="string">R"(.*)"</span>, [](<span class="keyword">const</span> httplib::Request &amp;req, httplib::Response &amp;res) &#123;</span><br><span class="line">        res.set_header(<span class="string">"Access-Control-Allow-Origin"</span>, req.get_header_value(<span class="string">"Origin"</span>));</span><br><span class="line">        res.set_header(<span class="string">"Access-Control-Allow-Credentials"</span>, <span class="string">"true"</span>);</span><br><span class="line">        res.set_header(<span class="string">"Access-Control-Allow-Methods"</span>, <span class="string">"POST"</span>);</span><br><span class="line">        res.set_header(<span class="string">"Access-Control-Allow-Headers"</span>, <span class="string">"*"</span>);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    svr.Get(<span class="string">"/health"</span>, [&amp;](<span class="keyword">const</span> httplib::Request&amp; req, httplib::Response&amp; res) &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ... 错误中间件注册</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!svr.bind_to_port(sparams.hostname, sparams.port))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"\ncouldn't bind to server socket: hostname=%s port=%d\n\n"</span>, sparams.hostname.c_str(), sparams.port);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Set the base directory for serving static files</span></span><br><span class="line">    svr.set_base_dir(sparams.public_path);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ... 日志设置</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// run the HTTP server in a thread - see comment below</span></span><br><span class="line">    <span class="built_in">std</span>::<span class="function">thread <span class="title">t</span><span class="params">([&amp;]()</span></span></span><br><span class="line"><span class="function"><span class="params">            &#123;</span></span></span><br><span class="line"><span class="function"><span class="params">                <span class="keyword">if</span> (!svr.listen_after_bind())</span></span></span><br><span class="line"><span class="function"><span class="params">                &#123;</span></span></span><br><span class="line"><span class="function"><span class="params">                    state.store(SERVER_STATE_ERROR);</span></span></span><br><span class="line"><span class="function"><span class="params">                    <span class="keyword">return</span> <span class="number">1</span>;</span></span></span><br><span class="line"><span class="function"><span class="params">                &#125;</span></span></span><br><span class="line"><span class="function"><span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">                <span class="keyword">return</span> <span class="number">0</span>;</span></span></span><br><span class="line"><span class="function"><span class="params">            &#125;)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// load the model</span></span><br><span class="line">    params.progress_callback = update_load_progress;</span><br><span class="line">    params.progress_callback_user_data = (<span class="keyword">void</span>*)&amp;llama;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 使用参数加载模型</span></span><br><span class="line">    <span class="keyword">if</span> (!llama.load_model(params))</span><br><span class="line">    &#123;</span><br><span class="line">        state.store(SERVER_STATE_ERROR);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 初始化</span></span><br><span class="line">        llama.initialize();</span><br><span class="line">        state.store(SERVER_STATE_READY);</span><br><span class="line">        LOG_INFO(<span class="string">"model loaded"</span>, &#123;&#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">auto</span> model_meta = llama.model_meta();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ... api key 中间件</span></span><br><span class="line"></span><br><span class="line">    svr.Post(<span class="string">"/completion"</span>, [&amp;llama, &amp;validate_api_key](<span class="keyword">const</span> httplib::Request &amp;req, httplib::Response &amp;res)</span><br><span class="line">            &#123;</span><br><span class="line">                res.set_header(<span class="string">"Access-Control-Allow-Origin"</span>, req.get_header_value(<span class="string">"Origin"</span>));</span><br><span class="line">                <span class="keyword">if</span> (!validate_api_key(req, res)) &#123;</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                json data = json::parse(req.body);</span><br><span class="line">                <span class="comment">// 创建新的任务</span></span><br><span class="line">                <span class="keyword">const</span> <span class="keyword">int</span> task_id = llama.queue_tasks.get_new_id();</span><br><span class="line">                llama.queue_results.add_waiting_task_id(task_id);</span><br><span class="line">                llama.request_completion(task_id, data, <span class="literal">false</span>, <span class="number">-1</span>);</span><br><span class="line">                <span class="keyword">if</span> (!json_value(data, <span class="string">"stream"</span>, <span class="literal">false</span>)) &#123;</span><br><span class="line">                <span class="comment">// 非流式处理</span></span><br><span class="line">                    <span class="built_in">std</span>::<span class="built_in">string</span> completion_text;</span><br><span class="line">                    <span class="comment">// 等待任务结果 </span></span><br><span class="line">                    task_result result = llama.queue_results.recv(task_id);</span><br><span class="line">                    <span class="keyword">if</span> (!result.error &amp;&amp; result.stop) &#123;</span><br><span class="line">                        res.set_content(result.result_json.dump(<span class="number">-1</span>, <span class="string">' '</span>, <span class="literal">false</span>, json::<span class="keyword">error_handler_t</span>::replace), <span class="string">"application/json; charset=utf-8"</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">else</span></span><br><span class="line">                    &#123;</span><br><span class="line">                        res.status = <span class="number">404</span>;</span><br><span class="line">                        res.set_content(result.result_json[<span class="string">"content"</span>], <span class="string">"text/plain; charset=utf-8"</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                    llama.queue_results.remove_waiting_task_id(task_id);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">const</span> <span class="keyword">auto</span> chunked_content_provider = [task_id, &amp;llama](<span class="keyword">size_t</span>, httplib::DataSink &amp; sink)</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="keyword">while</span> (<span class="literal">true</span>)</span><br><span class="line">                        &#123;</span><br><span class="line">                            task_result result = llama.queue_results.recv(task_id);</span><br><span class="line">                            <span class="keyword">if</span> (!result.error) &#123;</span><br><span class="line">                                <span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span> str =</span><br><span class="line">                                    <span class="string">"data: "</span> +</span><br><span class="line">                                    result.result_json.dump(<span class="number">-1</span>, <span class="string">' '</span>, <span class="literal">false</span>, json::<span class="keyword">error_handler_t</span>::replace) +</span><br><span class="line">                                    <span class="string">"\n\n"</span>;</span><br><span class="line">                                LOG_VERBOSE(<span class="string">"data stream"</span>, &#123;</span><br><span class="line">                                    &#123; <span class="string">"to_send"</span>, str &#125;</span><br><span class="line">                                &#125;);</span><br><span class="line">                                <span class="keyword">if</span> (!sink.write(str.c_str(), str.size()))</span><br><span class="line">                                &#123;</span><br><span class="line">                                    llama.queue_results.remove_waiting_task_id(task_id);</span><br><span class="line">                                    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">                                &#125;</span><br><span class="line">                                <span class="keyword">if</span> (result.stop) &#123;</span><br><span class="line">                                    <span class="keyword">break</span>;</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                                <span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span> str =</span><br><span class="line">                                    <span class="string">"error: "</span> +</span><br><span class="line">                                    result.result_json.dump(<span class="number">-1</span>, <span class="string">' '</span>, <span class="literal">false</span>, json::<span class="keyword">error_handler_t</span>::replace) +</span><br><span class="line">                                    <span class="string">"\n\n"</span>;</span><br><span class="line">                                LOG_VERBOSE(<span class="string">"data stream"</span>, &#123;</span><br><span class="line">                                    &#123; <span class="string">"to_send"</span>, str &#125;</span><br><span class="line">                                &#125;);</span><br><span class="line">                                <span class="keyword">if</span> (!sink.write(str.c_str(), str.size()))</span><br><span class="line">                                &#123;</span><br><span class="line">                                    llama.queue_results.remove_waiting_task_id(task_id);</span><br><span class="line">                                    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">                                &#125;</span><br><span class="line">                                <span class="keyword">break</span>;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        llama.queue_results.remove_waiting_task_id(task_id);</span><br><span class="line">                        sink.done();</span><br><span class="line">                        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">                    &#125;;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">auto</span> on_complete = [task_id, &amp;llama] (<span class="keyword">bool</span>)</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="comment">// cancel</span></span><br><span class="line">                        llama.request_cancel(task_id);</span><br><span class="line">                        llama.queue_results.remove_waiting_task_id(task_id);</span><br><span class="line">                    &#125;;</span><br><span class="line"></span><br><span class="line">                    res.set_chunked_content_provider(<span class="string">"text/event-stream"</span>, chunked_content_provider, on_complete);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ... 路由注册</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 新任务加入队列时 process_single_task 处理该任务</span></span><br><span class="line">    llama.queue_tasks.on_new_task(<span class="built_in">std</span>::bind(</span><br><span class="line">        &amp;llama_server_context::process_single_task, &amp;llama, <span class="built_in">std</span>::placeholders::_1));</span><br><span class="line">    <span class="comment">// 多任务处理完成 on_finish_multitask 处理相关逻辑</span></span><br><span class="line">    llama.queue_tasks.on_finish_multitask(<span class="built_in">std</span>::bind(</span><br><span class="line">        &amp;llama_server_context::on_finish_multitask, &amp;llama, <span class="built_in">std</span>::placeholders::_1));</span><br><span class="line">    llama.queue_tasks.on_run_slots(<span class="built_in">std</span>::bind(</span><br><span class="line">        &amp;llama_server_context::update_slots, &amp;llama));</span><br><span class="line">    <span class="comment">// 多任务更新</span></span><br><span class="line">    llama.queue_results.on_multitask_update(<span class="built_in">std</span>::bind(</span><br><span class="line">        &amp;llama_server_queue::update_multitask,</span><br><span class="line">        &amp;llama.queue_tasks,</span><br><span class="line">        <span class="built_in">std</span>::placeholders::_1,</span><br><span class="line">        <span class="built_in">std</span>::placeholders::_2,</span><br><span class="line">        <span class="built_in">std</span>::placeholders::_3</span><br><span class="line">    ));</span><br><span class="line"></span><br><span class="line">    shutdown_handler = [&amp;](<span class="keyword">int</span>) &#123;</span><br><span class="line">        llama.queue_tasks.terminate();</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// llama 开始处理列队信息</span></span><br><span class="line">    llama.queue_tasks.start_loop();</span><br><span class="line">    svr.stop();</span><br><span class="line">    t.join();</span><br><span class="line"></span><br><span class="line">    llama_backend_free();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>接下来来看看 go 的部分<br><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewLlamaServer</span><span class="params">(gpus gpu.GpuInfoList, model <span class="keyword">string</span>, ggml *GGML, adapters, projectors []<span class="keyword">string</span>, opts api.Options, numParallel <span class="keyword">int</span>)</span> <span class="params">(LlamaServer, error)</span></span> &#123;</span><br><span class="line">	<span class="keyword">var</span> err error</span><br><span class="line">	<span class="keyword">var</span> cpuRunner <span class="keyword">string</span></span><br><span class="line">	<span class="keyword">var</span> estimate MemoryEstimate</span><br><span class="line">	<span class="keyword">var</span> systemTotalMemory <span class="keyword">uint64</span></span><br><span class="line">	<span class="keyword">var</span> systemFreeMemory <span class="keyword">uint64</span></span><br><span class="line">	<span class="keyword">var</span> systemSwapFreeMemory <span class="keyword">uint64</span></span><br><span class="line"></span><br><span class="line">	systemMemInfo, err := gpu.GetCPUMem()</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		slog.Error(<span class="string">"failed to lookup system memory"</span>, <span class="string">"error"</span>, err)</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		systemTotalMemory = systemMemInfo.TotalMemory</span><br><span class="line">		systemFreeMemory = systemMemInfo.FreeMemory</span><br><span class="line">		systemSwapFreeMemory = systemMemInfo.FreeSwap</span><br><span class="line">		slog.Debug(<span class="string">"system memory"</span>, <span class="string">"total"</span>, format.HumanBytes2(systemTotalMemory), <span class="string">"free"</span>, format.HumanBytes2(systemFreeMemory), <span class="string">"free_swap"</span>, format.HumanBytes2(systemSwapFreeMemory))</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// ... gpu 信息获取</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 获取可用的 llm server</span></span><br><span class="line">	availableServers := getAvailableServers()</span><br><span class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(availableServers) == <span class="number">0</span> &#123;</span><br><span class="line">		<span class="keyword">if</span> runtime.GOOS != <span class="string">"windows"</span> &#123;</span><br><span class="line">			slog.Warn(<span class="string">"llama server binary disappeared, reinitializing payloads"</span>)</span><br><span class="line">			err = Init()</span><br><span class="line">			<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">				slog.Warn(<span class="string">"failed to reinitialize payloads"</span>, <span class="string">"error"</span>, err)</span><br><span class="line">				<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">			&#125;</span><br><span class="line">			availableServers = getAvailableServers()</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">nil</span>, finalErr</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// 根据 CPU/GPU 选择合适的 server path</span></span><br><span class="line">	<span class="keyword">var</span> servers []<span class="keyword">string</span></span><br><span class="line">	<span class="keyword">if</span> cpuRunner != <span class="string">""</span> &#123;</span><br><span class="line">		servers = []<span class="keyword">string</span>&#123;cpuRunner&#125;</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		servers = serversForGpu(gpus[<span class="number">0</span>]) <span class="comment">// All GPUs in the list are matching Library and Variant</span></span><br><span class="line">	&#125;</span><br><span class="line">	demandLib := envconfig.LLMLibrary</span><br><span class="line">	<span class="keyword">if</span> demandLib != <span class="string">""</span> &#123;</span><br><span class="line">		serverPath := availableServers[demandLib]</span><br><span class="line">		<span class="keyword">if</span> serverPath == <span class="string">""</span> &#123;</span><br><span class="line">			slog.Info(fmt.Sprintf(<span class="string">"Invalid OLLAMA_LLM_LIBRARY %s - not found"</span>, demandLib))</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			slog.Info(<span class="string">"user override"</span>, <span class="string">"OLLAMA_LLM_LIBRARY"</span>, demandLib, <span class="string">"path"</span>, serverPath)</span><br><span class="line">			servers = []<span class="keyword">string</span>&#123;demandLib&#125;</span><br><span class="line">			<span class="keyword">if</span> strings.HasPrefix(demandLib, <span class="string">"cpu"</span>) &#123;</span><br><span class="line">				<span class="comment">// Omit the GPU flag to silence the warning</span></span><br><span class="line">				opts.NumGPU = <span class="number">-1</span></span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	params := []<span class="keyword">string</span>&#123;</span><br><span class="line">		<span class="string">"--model"</span>, model,</span><br><span class="line">		<span class="string">"--ctx-size"</span>, fmt.Sprintf(<span class="string">"%d"</span>, opts.NumCtx),</span><br><span class="line">		<span class="string">"--batch-size"</span>, fmt.Sprintf(<span class="string">"%d"</span>, opts.NumBatch),</span><br><span class="line">		<span class="string">"--embedding"</span>,</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// .. params 各种拼接</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> i := <span class="keyword">range</span> <span class="built_in">len</span>(servers) &#123;</span><br><span class="line">		dir := availableServers[servers[i]]</span><br><span class="line">                <span class="comment">// ... 检查路径是否存在</span></span><br><span class="line"></span><br><span class="line">		<span class="comment">// 查找可用端口</span></span><br><span class="line">		port := <span class="number">0</span></span><br><span class="line">		<span class="keyword">if</span> a, err := net.ResolveTCPAddr(<span class="string">"tcp"</span>, <span class="string">"localhost:0"</span>); </span><br><span class="line">                <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">                <span class="comment">// 设置环境变量</span></span><br><span class="line">		pathEnv := <span class="string">"LD_LIBRARY_PATH"</span></span><br><span class="line">		<span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">		server := filepath.Join(dir, <span class="string">"ollama_llama_server"</span>)</span><br><span class="line">		<span class="keyword">if</span> runtime.GOOS == <span class="string">"windows"</span> &#123;</span><br><span class="line">			server += <span class="string">".exe"</span></span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">		s := &amp;llmServer&#123;</span><br><span class="line">			port:        port,</span><br><span class="line">			cmd:         exec.Command(server, finalParams...),</span><br><span class="line">			status:      NewStatusWriter(os.Stderr),</span><br><span class="line">			options:     opts,</span><br><span class="line">			estimate:    estimate,</span><br><span class="line">			sem:         semaphore.NewWeighted(<span class="keyword">int64</span>(numParallel)),</span><br><span class="line">			totalLayers: ggml.KV().BlockCount() + <span class="number">1</span>,</span><br><span class="line">			gpus:        gpus,</span><br><span class="line">			done:        <span class="built_in">make</span>(<span class="keyword">chan</span> error, <span class="number">1</span>),</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		s.cmd.Env = os.Environ()</span><br><span class="line">		s.cmd.Stdout = os.Stdout</span><br><span class="line">		s.cmd.Stderr = s.status</span><br><span class="line"></span><br><span class="line">                <span class="comment">// .. 拼接 cmd</span></span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> err = s.cmd.Start(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="comment">// Detect permission denied and augment them essage about noexec</span></span><br><span class="line">			<span class="keyword">if</span> errors.Is(err, os.ErrPermission) &#123;</span><br><span class="line">				finalErr = fmt.Errorf(<span class="string">"unable to start server %w.  %s may have noexec set.  Set OLLAMA_TMPDIR for server to a writable executable directory"</span>, err, dir)</span><br><span class="line">				<span class="keyword">continue</span></span><br><span class="line">			&#125;</span><br><span class="line">			msg := <span class="string">""</span></span><br><span class="line">			<span class="keyword">if</span> s.status != <span class="literal">nil</span> &amp;&amp; s.status.LastErrMsg != <span class="string">""</span> &#123;</span><br><span class="line">				msg = s.status.LastErrMsg</span><br><span class="line">			&#125;</span><br><span class="line">			err = fmt.Errorf(<span class="string">"error starting the external llama server: %v %s"</span>, err, msg)</span><br><span class="line">			finalErr = err</span><br><span class="line">			<span class="keyword">continue</span></span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// reap subprocess when it exits</span></span><br><span class="line">		<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">			s.done &lt;- s.cmd.Wait()</span><br><span class="line">		&#125;()</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> s, <span class="literal">nil</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	slog.Error(<span class="string">"unable to load any llama server"</span>, <span class="string">"error"</span>, finalErr)</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span>, finalErr</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>最后我们来看看 Completion<br><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">type</span> CompletionRequest <span class="keyword">struct</span> &#123;</span><br><span class="line">	Prompt  <span class="keyword">string</span></span><br><span class="line">	Format  <span class="keyword">string</span></span><br><span class="line">	Images  []ImageData</span><br><span class="line">	Options *api.Options</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> CompletionResponse <span class="keyword">struct</span> &#123;</span><br><span class="line">	Content            <span class="keyword">string</span></span><br><span class="line">	DoneReason         <span class="keyword">string</span></span><br><span class="line">	Done               <span class="keyword">bool</span></span><br><span class="line">	PromptEvalCount    <span class="keyword">int</span></span><br><span class="line">	PromptEvalDuration time.Duration</span><br><span class="line">	EvalCount          <span class="keyword">int</span></span><br><span class="line">	EvalDuration       time.Duration</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *llmServer)</span> <span class="title">Completion</span><span class="params">(ctx context.Context, req CompletionRequest, fn <span class="keyword">func</span>(CompletionResponse)</span>) <span class="title">error</span></span> &#123;</span><br><span class="line">	<span class="keyword">if</span> err := s.sem.Acquire(ctx, <span class="number">1</span>); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		slog.Error(<span class="string">"Failed to acquire semaphore"</span>, <span class="string">"error"</span>, err)</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">defer</span> s.sem.Release(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 设置 NumPredict 上限，防止模型运行时间过长</span></span><br><span class="line">	<span class="keyword">if</span> req.Options.NumPredict &lt; <span class="number">0</span> || req.Options.NumPredict &gt; <span class="number">10</span>*s.options.NumCtx &#123;</span><br><span class="line">		req.Options.NumPredict = <span class="number">10</span> * s.options.NumCtx</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	request := <span class="keyword">map</span>[<span class="keyword">string</span>]any&#123;</span><br><span class="line">		<span class="string">"prompt"</span>:            req.Prompt,</span><br><span class="line">		<span class="string">"stream"</span>:            <span class="literal">true</span>,</span><br><span class="line">		<span class="string">"n_predict"</span>:         req.Options.NumPredict,</span><br><span class="line">		<span class="string">"n_keep"</span>:            req.Options.NumKeep,</span><br><span class="line">		<span class="string">"main_gpu"</span>:          req.Options.MainGPU,</span><br><span class="line">		<span class="string">"temperature"</span>:       req.Options.Temperature,</span><br><span class="line">		<span class="string">"top_k"</span>:             req.Options.TopK,</span><br><span class="line">		<span class="string">"top_p"</span>:             req.Options.TopP,</span><br><span class="line">		<span class="string">"tfs_z"</span>:             req.Options.TFSZ,</span><br><span class="line">		<span class="string">"typical_p"</span>:         req.Options.TypicalP,</span><br><span class="line">		<span class="string">"repeat_last_n"</span>:     req.Options.RepeatLastN,</span><br><span class="line">		<span class="string">"repeat_penalty"</span>:    req.Options.RepeatPenalty,</span><br><span class="line">		<span class="string">"presence_penalty"</span>:  req.Options.PresencePenalty,</span><br><span class="line">		<span class="string">"frequency_penalty"</span>: req.Options.FrequencyPenalty,</span><br><span class="line">		<span class="string">"mirostat"</span>:          req.Options.Mirostat,</span><br><span class="line">		<span class="string">"mirostat_tau"</span>:      req.Options.MirostatTau,</span><br><span class="line">		<span class="string">"mirostat_eta"</span>:      req.Options.MirostatEta,</span><br><span class="line">		<span class="string">"penalize_nl"</span>:       req.Options.PenalizeNewline,</span><br><span class="line">		<span class="string">"seed"</span>:              req.Options.Seed,</span><br><span class="line">		<span class="string">"stop"</span>:              req.Options.Stop,</span><br><span class="line">		<span class="string">"image_data"</span>:        req.Images,</span><br><span class="line">		<span class="string">"cache_prompt"</span>:      <span class="literal">true</span>,</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 检查服务器状态</span></span><br><span class="line">	status, err := s.getServerStatusRetry(ctx)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> status != ServerStatusReady &#123;</span><br><span class="line">		<span class="keyword">return</span> fmt.Errorf(<span class="string">"unexpected server status: %s"</span>, status.ToString())</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// json</span></span><br><span class="line">	<span class="keyword">if</span> req.Format == <span class="string">"json"</span> &#123;</span><br><span class="line">		request[<span class="string">"grammar"</span>] = jsonGrammar</span><br><span class="line">		<span class="keyword">if</span> !strings.Contains(strings.ToLower(req.Prompt), <span class="string">"json"</span>) &#123;</span><br><span class="line">			slog.Warn(<span class="string">"Prompt does not specify that the LLM should response in JSON, but JSON format is expected. For best results specify that JSON is expected in the system prompt."</span>)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Handling JSON marshaling with special characters unescaped.</span></span><br><span class="line">	buffer := &amp;bytes.Buffer&#123;&#125;</span><br><span class="line">	enc := json.NewEncoder(buffer)</span><br><span class="line">	enc.SetEscapeHTML(<span class="literal">false</span>)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> err := enc.Encode(request); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> fmt.Errorf(<span class="string">"failed to marshal data: %v"</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	endpoint := fmt.Sprintf(<span class="string">"http://127.0.0.1:%d/completion"</span>, s.port)</span><br><span class="line">	serverReq, err := http.NewRequestWithContext(ctx, http.MethodPost, endpoint, buffer)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> fmt.Errorf(<span class="string">"error creating POST request: %v"</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line">	serverReq.Header.Set(<span class="string">"Content-Type"</span>, <span class="string">"application/json"</span>)</span><br><span class="line"></span><br><span class="line">	res, err := http.DefaultClient.Do(serverReq)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> fmt.Errorf(<span class="string">"POST predict: %v"</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">defer</span> res.Body.Close()</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> res.StatusCode &gt;= <span class="number">400</span> &#123;</span><br><span class="line">		bodyBytes, err := io.ReadAll(res.Body)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> fmt.Errorf(<span class="string">"failed reading llm error response: %w"</span>, err)</span><br><span class="line">		&#125;</span><br><span class="line">		log.Printf(<span class="string">"llm predict error: %s"</span>, bodyBytes)</span><br><span class="line">		<span class="keyword">return</span> fmt.Errorf(<span class="string">"%s"</span>, bodyBytes)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	scanner := bufio.NewScanner(res.Body)</span><br><span class="line">	buf := <span class="built_in">make</span>([]<span class="keyword">byte</span>, <span class="number">0</span>, maxBufferSize)</span><br><span class="line">	scanner.Buffer(buf, maxBufferSize)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// keep track of the last token generated, this is used to abort if the model starts looping</span></span><br><span class="line">	<span class="keyword">var</span> lastToken <span class="keyword">string</span></span><br><span class="line">	<span class="keyword">var</span> tokenRepeat <span class="keyword">int</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> scanner.Scan() &#123;</span><br><span class="line">		<span class="keyword">select</span> &#123;</span><br><span class="line">		<span class="keyword">case</span> &lt;-ctx.Done():</span><br><span class="line">			<span class="comment">// This handles the request cancellation</span></span><br><span class="line">			<span class="keyword">return</span> ctx.Err()</span><br><span class="line">		<span class="keyword">default</span>:</span><br><span class="line">			<span class="comment">// 逐行读取响应数据</span></span><br><span class="line">			line := scanner.Bytes()</span><br><span class="line">			<span class="keyword">if</span> <span class="built_in">len</span>(line) == <span class="number">0</span> &#123;</span><br><span class="line">				<span class="keyword">continue</span></span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			evt, ok := bytes.CutPrefix(line, []<span class="keyword">byte</span>(<span class="string">"data: "</span>))</span><br><span class="line">			<span class="keyword">if</span> !ok &#123;</span><br><span class="line">				<span class="keyword">return</span> fmt.Errorf(<span class="string">"error parsing llm response stream: %s"</span>, line)</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="keyword">var</span> c completion</span><br><span class="line">			<span class="keyword">if</span> err := json.Unmarshal(evt, &amp;c); err != <span class="literal">nil</span> &#123;</span><br><span class="line">				<span class="keyword">return</span> fmt.Errorf(<span class="string">"error unmarshalling llm prediction response: %v"</span>, err)</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="keyword">switch</span> &#123;</span><br><span class="line">			<span class="keyword">case</span> strings.TrimSpace(c.Content) == lastToken:</span><br><span class="line">				tokenRepeat++</span><br><span class="line">			<span class="keyword">default</span>:</span><br><span class="line">				lastToken = strings.TrimSpace(c.Content)</span><br><span class="line">				tokenRepeat = <span class="number">0</span></span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="comment">// 30 picked as an arbitrary max token repeat limit, modify as needed</span></span><br><span class="line">			<span class="keyword">if</span> tokenRepeat &gt; <span class="number">30</span> &#123;</span><br><span class="line">				slog.Debug(<span class="string">"prediction aborted, token repeat limit reached"</span>)</span><br><span class="line">				<span class="keyword">return</span> ctx.Err()</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="comment">// 解析并处理每行数据，将结果通过回调函数返回</span></span><br><span class="line">			<span class="keyword">if</span> c.Content != <span class="string">""</span> &#123;</span><br><span class="line">				fn(CompletionResponse&#123;</span><br><span class="line">					Content: c.Content,</span><br><span class="line">				&#125;)</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="keyword">if</span> c.Stop &#123;</span><br><span class="line">				doneReason := <span class="string">"stop"</span></span><br><span class="line">				<span class="keyword">if</span> c.StoppedLimit &#123;</span><br><span class="line">					doneReason = <span class="string">"length"</span></span><br><span class="line">				&#125;</span><br><span class="line"></span><br><span class="line">				fn(CompletionResponse&#123;</span><br><span class="line">					Done:               <span class="literal">true</span>,</span><br><span class="line">					DoneReason:         doneReason,</span><br><span class="line">					PromptEvalCount:    c.Timings.PromptN,</span><br><span class="line">					PromptEvalDuration: parseDurationMs(c.Timings.PromptMS),</span><br><span class="line">					EvalCount:          c.Timings.PredictedN,</span><br><span class="line">					EvalDuration:       parseDurationMs(c.Timings.PredictedMS),</span><br><span class="line">				&#125;)</span><br><span class="line">				<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> err := scanner.Err(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">if</span> strings.Contains(err.Error(), <span class="string">"unexpected EOF"</span>) &#123;</span><br><span class="line">			s.Close()</span><br><span class="line">			msg := <span class="string">""</span></span><br><span class="line">			<span class="keyword">if</span> s.status != <span class="literal">nil</span> &amp;&amp; s.status.LastErrMsg != <span class="string">""</span> &#123;</span><br><span class="line">				msg = s.status.LastErrMsg</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">return</span> fmt.Errorf(<span class="string">"an unknown error was encountered while running the model %s"</span>, msg)</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> fmt.Errorf(<span class="string">"error reading llm response: %v"</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>

      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/golang/" rel="tag"># golang</a>
          
            <a href="/tags/ollama/" rel="tag"># ollama</a>
          
            <a href="/tags/llama-cpp/" rel="tag"># llama.cpp</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2024/03/30/Rolldown源码学习/" rel="next" title="Rolldown源码学习">
                <i class="fa fa-chevron-left"></i> Rolldown源码学习
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>


  </div>


          </div>
          

  
    <div class="comments" id="comments">
      
        <div id="gitment-container"></div>
      
    </div>

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/images/v2-e386393694cb08152bb316fa79bba113_hd.jpg" alt="Akita Summer">
            
              <p class="site-author-name" itemprop="name">Akita Summer</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">25</span>
                    <span class="site-state-item-name">日志</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  <a href="/categories/index.html">
                    
                    
                      
                    
                    <span class="site-state-item-count">1</span>
                    <span class="site-state-item-name">分类</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  <a href="/tags/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">38</span>
                    <span class="site-state-item-name">标签</span>
                  </a>
                </div>
              
            </nav>
          

          

          
            <div class="links-of-author motion-element">
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                    
                  
                  <a href="https://github.com/akitaSummer" title="GitHub &rarr; https://github.com/akitaSummer" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a>
                </span>
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                    
                  
                  <a href="mailto:644171127@qq.com" title="E-Mail &rarr; mailto:644171127@qq.com" rel="noopener" target="_blank"><i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                </span>
              
            </div>
          

          

          
          

          
            
          
          

        </div>
      </div>

      
      <!--noindex-->
        <div class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
            
            
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#前言"><span class="nav-number">1.</span> <span class="nav-text">前言</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#APIs"><span class="nav-number">2.</span> <span class="nav-text">APIs</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Go-server"><span class="nav-number">3.</span> <span class="nav-text">Go server</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#llm-server"><span class="nav-number">4.</span> <span class="nav-text">llm server</span></a></li></ol></div>
            

          </div>
        </div>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2024</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Akita Summer</span>

  

  
</div>

<!--
  <div class="powered-by">由 <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> 强力驱动 v3.8.0</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 – <a href="https://theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a> v7.0.0</div>
-->



        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

    

    
  </div>

  

<script>
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  <script src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>


  


  <script src="/js/src/utils.js?v=7.0.0"></script>

  <script src="/js/src/motion.js?v=7.0.0"></script>



  
  


  <script src="/js/src/affix.js?v=7.0.0"></script>

  <script src="/js/src/schemes/pisces.js?v=7.0.0"></script>



  
  <script src="/js/src/scrollspy.js?v=7.0.0"></script>
<script src="/js/src/post-details.js?v=7.0.0"></script>



  


  <script src="/js/src/bootstrap.js?v=7.0.0"></script>



  


  
    <!-- LOCAL: You can save these files to your site and update links -->

  
  <script src="https://cdn.jsdelivr.net/gh/theme-next/theme-next-gitment@1/gitmint.browser.js"></script>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/theme-next/theme-next-gitment@1/default.css">
<!-- END LOCAL -->

<style>
#gitment-container a {
  border-bottom: none;
}

</style>

<script>
  function renderGitment() {
    var gitment = new Gitmint({
      id: window.location.pathname,
      owner: 'akitaSummer',
      repo: 'blogComment',
      
        lang: '' || navigator.language || navigator.systemLanguage || navigator.userLanguage,
      
      oauth: {
      
      
        client_secret: '624f365dba9bccb32867a185a2cf65556335f06e',
      
        client_id: 'f433f680d31e0d644e2c'
      }
    });
    gitment.render('gitment-container');
  }

  
    renderGitment();
  
</script>

  


  





  

  

  

  

  

  

  

  

  

  

  

  

  

</body>
</html>
